# V9.13 - Filtro Storico Convocazioni

## üéØ Obiettivo
Aggiungere un filtro nella pagina dello storico convocazioni per visualizzare le convocazioni per settimana o mese corrente. Di default, quando si apre lo storico, mostra solo il mese corrente.

## ‚ú® Nuove Funzionalit√†

### 1. Filtro Periodo Storico Convocazioni
- **Dropdown** con 3 opzioni di filtro:
  - Tutti i periodi
  - Settimana corrente
  - Mese corrente (DEFAULT)
- **Indicatore visivo** del filtro attivo
- **UI intuitiva** con etichetta chiara

## üìã Implementazione Tecnica

### File Modificato: `index.html`

#### 1. Modifiche HTML (righe 674-698)
```html
<div id="history-view" class="hidden">
    <button id="top-back-from-history-button">Indietro</button>
    <h2>Storico Convocazioni</h2>
    
    <!-- NUOVO: Period Filter -->
    <div class="mb-4">
        <label for="history-period-select">Filtra per periodo:</label>
        <select id="history-period-select">
            <option value="all">Tutti i periodi</option>
            <option value="week">Settimana corrente</option>
            <option value="month" selected>Mese corrente</option>
        </select>
    </div>
    
    <!-- NUOVO: Filter Indicator -->
    <div class="bg-blue-50 border border-blue-200 rounded p-3">
        <strong>‚ÑπÔ∏è Filtro attivo:</strong> 
        <span id="history-filter-display">Mese corrente</span>
    </div>
    
    <div id="history-list"></div>
    <button id="back-from-history-button">Indietro</button>
</div>
```

#### 2. Nuova Variabile JavaScript (riga ~2046)
```javascript
let allConvocationHistory = []; // store all unfiltered history items
```

#### 3. Funzione `loadHistory()` Modificata (righe ~3443-3477)
```javascript
function loadHistory(querySnapshot) {
    convocationHistory = [];
    allConvocationHistory = []; // NUOVO: reset all history data
    
    if (querySnapshot.empty) {
        historyList.innerHTML = '<p>Nessuna convocazione registrata.</p>';
        updateAttendanceTables();
        return;
    }
    
    const history = [];
    querySnapshot.forEach(doc => {
        const data = doc.data();
        const historyItem = { ...data, id: doc.id };
        history.push(historyItem);
        convocationHistory.push(historyItem);
    });
    
    history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    // NUOVO: Store all unfiltered history
    allConvocationHistory = history;
    
    // NUOVO: Render with default filter (month)
    renderFilteredHistory();
    
    updateAttendanceTables();
    
    if (userRole === 'mister') {
        renderPlayers();
    }
}
```

#### 4. Nuova Funzione `filterHistoryByPeriod()` (righe ~3479-3533)
```javascript
function filterHistoryByPeriod(history, period) {
    if (period === 'all') {
        return history;
    }
    
    const now = new Date();
    return history.filter(item => {
        const matchDateStr = item.details.data;
        
        // Use match date if available, otherwise fall back to createdAt
        const dateToCheck = matchDateStr && matchDateStr !== 'N/D' 
            ? new Date(matchDateStr + 'T00:00:00')
            : new Date(item.createdAt);
        
        if (period === 'week') {
            // Calculate start of week (Monday)
            const startOfWeek = new Date(now);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);
            
            return dateToCheck >= startOfWeek && dateToCheck <= endOfWeek;
        } else if (period === 'month') {
            return dateToCheck.getMonth() === now.getMonth() && 
                   dateToCheck.getFullYear() === now.getFullYear();
        }
        
        return true;
    });
}
```

#### 5. Nuova Funzione `renderFilteredHistory()` (righe ~3535-3614)
```javascript
function renderFilteredHistory() {
    const periodSelect = document.getElementById('history-period-select');
    const selectedPeriod = periodSelect ? periodSelect.value : 'month';
    const filterDisplay = document.getElementById('history-filter-display');
    
    // Update filter display text
    if (filterDisplay) {
        const filterTexts = {
            'all': 'Tutti i periodi',
            'week': 'Settimana corrente',
            'month': 'Mese corrente'
        };
        filterDisplay.textContent = filterTexts[selectedPeriod] || 'Mese corrente';
    }
    
    // Filter history
    const filteredHistory = filterHistoryByPeriod(allConvocationHistory, selectedPeriod);
    
    // Clear and render
    historyList.innerHTML = '';
    
    if (filteredHistory.length === 0) {
        historyList.innerHTML = '<p>Nessuna convocazione trovata per il periodo selezionato.</p>';
        return;
    }
    
    // Render each history item (stesso codice di prima)
    filteredHistory.forEach(data => {
        // ... rendering logic ...
    });
    
    // Attach event listeners (stesso codice di prima)
    // ... edit, delete, share, distinta buttons ...
}
```

#### 6. Event Listener per il Filtro (righe ~8925-8932)
```javascript
// History period filter event listener
const historyPeriodSelect = document.getElementById('history-period-select');
if (historyPeriodSelect) {
    historyPeriodSelect.addEventListener('change', () => {
        renderFilteredHistory();
    });
}
```

## üé® Comportamento UI

### All'apertura della pagina Storico Convocazioni:
1. **Filtro preimpostato**: "Mese corrente" (selezionato di default)
2. **Visualizzazione**: Mostra solo le convocazioni del mese corrente
3. **Indicatore**: Badge blu mostra "Filtro attivo: Mese corrente"

### Quando l'utente cambia il filtro:
1. **Aggiornamento istantaneo**: La lista si aggiorna senza ricaricare la pagina
2. **Indicatore aggiornato**: Il badge blu mostra il nuovo filtro attivo
3. **Messaggio vuoto**: Se non ci sono risultati, mostra "Nessuna convocazione trovata per il periodo selezionato"

## üìä Logica di Filtro

### Settimana Corrente
- Dalla **Luned√¨** della settimana corrente
- Fino alla **Domenica** della settimana corrente
- Usa la data della partita per il filtro
- Fallback sulla data di creazione se la data della partita non √® disponibile

### Mese Corrente
- Stesso **mese** e **anno** della data corrente
- Usa la data della partita per il filtro
- Fallback sulla data di creazione se la data della partita non √® disponibile

### Tutti i Periodi
- Mostra tutte le convocazioni storiche
- Nessun filtro applicato

## ‚úÖ Compatibilit√†

### Funzionalit√† Mantenute:
- ‚úÖ Pulsanti "Modifica" (per Mister/Dirigente)
- ‚úÖ Pulsanti "Condividi" 
- ‚úÖ Pulsanti "Distinta"
- ‚úÖ Pulsanti "Elimina" (per Dirigente)
- ‚úÖ Aggiornamento tabelle presenze
- ‚úÖ Rendering giocatori (already-called-today styling)

### Integrazioni:
- ‚úÖ Firestore listeners continuano a funzionare
- ‚úÖ Navigation stack preservato
- ‚úÖ Session storage per edit origin preservato

## üß™ Testing

### Test Manuale Consigliato:
1. ‚úÖ Aprire la pagina Storico Convocazioni
2. ‚úÖ Verificare che il filtro sia su "Mese corrente"
3. ‚úÖ Verificare che vengano mostrate solo le convocazioni del mese corrente
4. ‚úÖ Cambiare filtro a "Settimana corrente"
5. ‚úÖ Verificare che vengano mostrate solo le convocazioni della settimana
6. ‚úÖ Cambiare filtro a "Tutti i periodi"
7. ‚úÖ Verificare che vengano mostrate tutte le convocazioni
8. ‚úÖ Verificare che l'indicatore "Filtro attivo" si aggiorni correttamente
9. ‚úÖ Testare i pulsanti Modifica/Condividi/Distinta/Elimina con il filtro attivo

### File di Test Creato:
- `test_history_filter.html` - Demo interattiva con dati di esempio

## üìù Note Implementative

### Scelte di Design:
1. **Default "Mese corrente"** - Scelta perch√© tipicamente l'utente √® interessato alle convocazioni recenti
2. **Filtro sulla data partita** - Pi√π logico per l'utente rispetto alla data di creazione
3. **Fallback su createdAt** - Garantisce che le convocazioni senza data partita siano comunque filtrabili
4. **Settimana Luned√¨-Domenica** - Convenzione italiana standard

### Performance:
- Filtro applicato in memoria (nessuna query Firestore aggiuntiva)
- Rendering istantaneo (no page reload)
- Array `allConvocationHistory` mantiene i dati originali

## üöÄ Miglioramenti Futuri Possibili

1. **Filtro per anno specifico**: Aggiungere opzione per selezionare un anno specifico
2. **Filtro per tipo partita**: Campionato, Torneo, Amichevole
3. **Filtro combinato**: Mese + tipo partita
4. **Salvataggio preferenza**: Ricordare l'ultimo filtro selezionato (localStorage)
5. **Indicatore conteggio**: Mostrare "3 di 15 convocazioni" nell'indicatore

## üì∏ Screenshots

### Filtro Default - Mese Corrente
- Mostra dropdown con "Mese corrente" selezionato
- Indicatore badge blu con "Filtro attivo: Mese corrente"
- Lista delle convocazioni del mese corrente

### Filtro - Settimana Corrente
- Dropdown cambiato a "Settimana corrente"
- Indicatore aggiornato: "Filtro attivo: Settimana corrente"
- Lista aggiornata con solo convocazioni della settimana

### Filtro - Tutti i Periodi
- Dropdown su "Tutti i periodi"
- Indicatore: "Filtro attivo: Tutti i periodi"
- Lista completa di tutte le convocazioni storiche
