# V9.25 - Fix Aggiornamento Frecce Settimanali

## 📋 Panoramica
La versione 9.25 risolve un bug critico nella logica di aggiornamento delle frecce di classifica (🔼🔽) nel Report Presenze Allenamenti e nel Riepilogo Totale.

---

## 🐛 Problema Risolto

### Bug Originale
Le frecce di classifica si aggiornavano **ogni volta che veniva salvata una sessione di allenamento** invece di aggiornarsi **solo una volta a settimana** come previsto.

**Requisito originale:** "Le frecce NON devono cambiare ogni volta che viene salvata una sessione di allenamento, ma solo in base al confronto settimanale. Mantieni il confronto tra settimane (lunedì-domenica) e mostra le frecce solo una volta a settimana, anche se i dati vengono aggiornati più volte."

### Causa del Bug
La condizione `(now.getDay() > lastUpdate.getDay())` nel codice causava aggiornamenti multipli durante la stessa settimana:
- **Lunedì:** Frecce aggiornate ✅
- **Martedì:** Salvando un allenamento, le frecce si aggiornavano di nuovo ❌
- **Mercoledì:** Salvando un allenamento, le frecce si aggiornavano ancora ❌
- **Risultato:** Le frecce non erano affidabili, cambiavano troppo frequentemente

---

## ✅ Soluzione Implementata

### Nuova Logica di Confronto Settimanale

**Logica Vecchia (Buggy):**
```javascript
const daysSinceUpdate = Math.floor((now - lastUpdate) / (1000 * 60 * 60 * 24));
const isMonday = now.getDay() === 1;
const lastUpdateWasBeforeThisWeek = daysSinceUpdate >= 7 || 
    (isMonday && lastUpdate.getDay() !== 1) ||
    (now.getDay() > lastUpdate.getDay());  // 🐛 BUG: si attiva più volte a settimana!

if (lastUpdateWasBeforeThisWeek) {
    shouldUpdate = true;
}
```

**Logica Nuova (Corretta):**
```javascript
// Helper function per ottenere il lunedì di una data settimana
const getMondayOfWeek = (date) => {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // aggiusta per domenica
    d.setDate(diff);
    d.setHours(0, 0, 0, 0);
    return d;
};

const lastUpdate = new Date(lastUpdateStr);
const currentWeekMonday = getMondayOfWeek(now);
const lastUpdateWeekMonday = getMondayOfWeek(lastUpdate);

// Aggiorna SOLO se siamo in una settimana diversa (confronta i lunedì)
if (currentWeekMonday.getTime() !== lastUpdateWeekMonday.getTime()) {
    shouldUpdate = true;
}
```

---

## 🎯 Comportamento Atteso

### Scenario Tipico Durante la Settimana:

**Lunedì 6 Gennaio 2025 - Ore 09:00:**
- 📊 Report caricato
- ✅ Frecce aggiornate (nuova settimana)
- 💾 Salvato: `lastRankingUpdateTraining = 2025-01-06T09:00:00.000Z`

**Martedì 7 Gennaio 2025 - Ore 14:00:**
- 💾 Salvata sessione allenamento
- 📊 Report ricaricato
- ❌ **Frecce NON aggiornate** (stessa settimana)
- ✅ Confronto: Lunedì 06/01 == Lunedì 06/01

**Mercoledì 8 Gennaio 2025 - Ore 18:00:**
- 💾 Salvata sessione allenamento
- 📊 Report ricaricato
- ❌ **Frecce NON aggiornate** (stessa settimana)
- ✅ Confronto: Lunedì 06/01 == Lunedì 06/01

**Lunedì 13 Gennaio 2025 - Ore 09:00:**
- 📊 Report caricato
- ✅ **Frecce aggiornate** (nuova settimana!)
- ✅ Confronto: Lunedì 13/01 ≠ Lunedì 06/01
- 💾 Salvato: `lastRankingUpdateTraining = 2025-01-13T09:00:00.000Z`

---

## 📊 Dettagli Tecnici

### Modifiche al Codice

**File Modificato:** `index.html`

**Funzioni Modificate:**
1. **`loadAllenamentiReport()`** (circa righe 7131-7156)
   - Report Presenze Allenamenti
   - Chiavi localStorage: `lastWeekRankingTraining`, `lastRankingUpdateTraining`

2. **`loadAttendance()`** (circa righe 4442-4468)
   - Riepilogo Totale Partite
   - Chiavi localStorage: `lastWeekRanking`, `lastRankingUpdate`

### Logica di Aggiornamento

**Quando le frecce vengono aggiornate:**
1. ✅ **Prima volta:** Al primo caricamento (nessun dato precedente)
2. ✅ **Nuova settimana:** Quando si passa da una settimana all'altra
3. ❌ **Durante la settimana:** MAI, anche salvando sessioni

**Come funziona il confronto:**
```javascript
// Calcola il lunedì della settimana corrente
const currentWeekMonday = getMondayOfWeek(now);
// Esempio: Mercoledì 8 Gennaio → Lunedì 6 Gennaio 00:00

// Calcola il lunedì della settimana dell'ultimo aggiornamento
const lastUpdateWeekMonday = getMondayOfWeek(lastUpdate);
// Esempio: Martedì 7 Gennaio → Lunedì 6 Gennaio 00:00

// Confronta i timestamp
if (currentWeekMonday.getTime() !== lastUpdateWeekMonday.getTime()) {
    // Settimane diverse → aggiorna le frecce
    shouldUpdate = true;
}
```

---

## 🧪 Test di Verifica

### Scenario 1: Stesso Giorno (Lunedì Mattina → Lunedì Pomeriggio)
**Setup:**
- Ultimo aggiornamento: Lunedì 6 Gennaio 2025, ore 09:00
- Adesso: Lunedì 6 Gennaio 2025, ore 15:00

**Risultato Atteso:**
- ❌ Frecce NON aggiornate
- ✅ Stessa settimana (Lunedì 06/01 == Lunedì 06/01)

### Scenario 2: Stessa Settimana (Lunedì → Martedì)
**Setup:**
- Ultimo aggiornamento: Lunedì 6 Gennaio 2025, ore 10:00
- Adesso: Martedì 7 Gennaio 2025, ore 14:00

**Risultato Atteso:**
- ❌ Frecce NON aggiornate
- ✅ Stessa settimana (Lunedì 06/01 == Lunedì 06/01)
- ✅ **FIX PRINCIPALE:** Con la vecchia logica si sarebbero aggiornate!

### Scenario 3: Stessa Settimana (Martedì → Mercoledì)
**Setup:**
- Ultimo aggiornamento: Martedì 7 Gennaio 2025, ore 10:00
- Adesso: Mercoledì 8 Gennaio 2025, ore 14:00

**Risultato Atteso:**
- ❌ Frecce NON aggiornate
- ✅ Stessa settimana (Lunedì 06/01 == Lunedì 06/01)

### Scenario 4: Nuova Settimana (Domenica → Lunedì)
**Setup:**
- Ultimo aggiornamento: Domenica 5 Gennaio 2025, ore 22:00
- Adesso: Lunedì 6 Gennaio 2025, ore 09:00

**Risultato Atteso:**
- ✅ Frecce aggiornate
- ✅ Settimane diverse (Lunedì 30/12 ≠ Lunedì 06/01)

### Scenario 5: Nuova Settimana (Venerdì → Lunedì)
**Setup:**
- Ultimo aggiornamento: Venerdì 3 Gennaio 2025, ore 18:00
- Adesso: Lunedì 6 Gennaio 2025, ore 09:00

**Risultato Atteso:**
- ✅ Frecce aggiornate
- ✅ Settimane diverse (Lunedì 30/12 ≠ Lunedì 06/01)

### Scenario 6: Due Settimane Dopo
**Setup:**
- Ultimo aggiornamento: Lunedì 6 Gennaio 2025, ore 10:00
- Adesso: Lunedì 20 Gennaio 2025, ore 14:00

**Risultato Atteso:**
- ✅ Frecce aggiornate
- ✅ Settimane diverse (Lunedì 06/01 ≠ Lunedì 20/01)

---

## 🎯 Impatto e Benefici

### Prima del Fix (V9.24):
- ❌ Frecce cambiavano ogni volta che si salvava un allenamento
- ❌ Confronto inaffidabile (non realmente settimanale)
- ❌ Difficile capire chi era davvero migliorato nella settimana
- ❌ Bug: `(now.getDay() > lastUpdate.getDay())` causava aggiornamenti multipli

### Dopo il Fix (V9.25):
- ✅ Frecce cambiano SOLO una volta a settimana (nuovo lunedì)
- ✅ Confronto affidabile tra settimane
- ✅ Dirigenti possono capire i miglioramenti settimanali reali
- ✅ Fix: Confronto corretto basato sul lunedì della settimana

---

## 📝 Test Interattivo

È disponibile un file di test interattivo per verificare la correzione:

**File:** `test_weekly_arrow_fix.html`

**Cosa testa:**
- ✅ Stessa settimana → NON aggiorna
- ✅ Nuova settimana → aggiorna
- ✅ Confronto vecchia vs nuova logica
- ✅ Tutti i 6 scenari di test

**Come usarlo:**
1. Aprire `test_weekly_arrow_fix.html` nel browser
2. Cliccare "Run Tests"
3. Verificare che tutti i test passano con la nuova logica
4. Confrontare con i fallimenti della vecchia logica

---

## ✅ Risultati

### Correzioni Applicate:
1. ✅ **Report Presenze Allenamenti:** Frecce aggiornate solo settimanalmente
2. ✅ **Riepilogo Totale Partite:** Frecce aggiornate solo settimanalmente
3. ✅ **Logica uniforme:** Stessa implementazione in entrambi i report
4. ✅ **Test completo:** Suite di test per validare la correzione
5. ✅ **Versione aggiornata:** V9.24 → V9.25

### Comportamento Garantito:
- 🔼 Frecce verdi/rosse cambiano SOLO quando si passa a una nuova settimana
- 📅 Settimana definita come Lunedì-Domenica
- 💾 Salvare sessioni durante la settimana NON cambia le frecce
- 🔄 Primo accesso del lunedì aggiorna le frecce

---

## 🔍 Verifica Manuale

### Come Verificare in Produzione:

1. **Lunedì mattina:**
   - Aprire pagina Allenamenti
   - Notare le frecce attuali
   - Aprire Console: verificare messaggio "📊 [V9.17] Updated weekly training ranking snapshot"

2. **Durante la settimana (Mar-Dom):**
   - Salvare una o più sessioni di allenamento
   - Ricaricare la pagina
   - ✅ Verificare che le frecce NON cambiano
   - Console: NON dovrebbe apparire messaggio di aggiornamento

3. **Lunedì successivo:**
   - Aprire pagina Allenamenti
   - ✅ Verificare che le frecce sono state aggiornate
   - Console: verificare messaggio "📊 [V9.17] Updated weekly training ranking snapshot"

---

## 📦 File Modificati

- `index.html`: Logica aggiornamento frecce in 2 funzioni
- `manifest.json`: Versione aggiornata a V9.25
- `test_weekly_arrow_fix.html`: Nuovo file di test (creato)

---

## 🎉 Conclusione

La V9.25 risolve completamente il problema delle frecce che si aggiornavano troppo frequentemente. Ora il sistema fornisce un confronto settimanale affidabile e coerente, permettendo ai dirigenti di monitorare i reali miglioramenti o peggioramenti dei giocatori su base settimanale.

**Requisito soddisfatto:** ✅ "Le frecce NON devono cambiare ogni volta che viene salvata una sessione di allenamento, ma solo in base al confronto settimanale."
