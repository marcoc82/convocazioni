# ğŸš€ V9.52 Quick Reference - Firebase Cloud Messaging

## ğŸ“‹ Cosa Ã¨ stato aggiunto

### Nuovi File
1. **firebase-messaging-sw.js** (root directory)
   - Service worker per notifiche in background
   - Gestisce notifiche quando app Ã¨ chiusa
   - Click handler per aprire app

2. **CHANGELOG_V9.52.md**
   - Documentazione completa delle modifiche
   - Esempi codice backend
   - Guide troubleshooting

3. **test_v952_fcm_implementation.html**
   - Pagina test per verificare implementazione
   - Check browser support
   - Test permessi e token

### File Modificati
1. **index.html**
   - Import Firebase Messaging SDK
   - Script FCM completo (~180 righe)
   - Funzioni: requestNotificationPermission, getFCMToken, saveFCMTokenToDatabase
   - Handler foreground notifications

2. **service-worker.js**
   - Cache version: v9.52
   - Aggiunto firebase-messaging-sw.js alla cache

3. **manifest.json**
   - Version: V9.52

4. **PWA_DOCUMENTATION.md**
   - Nuova sezione: ğŸ”” Notifiche Push (V9.52)
   - ~300 righe documentazione
   - Esempi Cloud Function e REST API

## ğŸ¯ Come Funziona

### Flusso Completo

```
1. Utente fa login
   â†“
2. App richiede permesso notifiche
   â†“
3. Utente accetta
   â†“
4. App genera token FCM
   â†“
5. Token salvato in Firestore: fcm_tokens/{companyCode}/tokens/{userId}
   â†“
6. Backend (Cloud Function) invia notifica quando nuova convocazione
   â†“
7. Firebase Cloud Messaging distribuisce a dispositivi
   â†“
8. firebase-messaging-sw.js mostra notifica (se app chiusa)
   oppure
   onMessage handler mostra notifica (se app aperta)
```

## âš™ï¸ Setup Richiesto

### 1. VAPID Key (Obbligatorio)
**File:** `index.html` linea ~13115

```javascript
const token = await window.getToken(window.messaging, {
    vapidKey: 'YOUR_VAPID_KEY_HERE', // â† Sostituisci qui
    serviceWorkerRegistration: registration
});
```

**Come ottenerla:**
1. [Firebase Console](https://console.firebase.google.com/)
2. Progetto: polis-2013
3. Impostazioni Progetto â†’ Cloud Messaging
4. Web Push certificates â†’ Genera o copia

### 2. Cloud Function (Raccomandato)
**File:** `functions/index.js` (nuovo)

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
admin.initializeApp();

exports.sendConvocationNotification = functions.firestore
    .document('convocations_history/{convocationId}')
    .onCreate(async (snap, context) => {
        const convocation = snap.data();
        const companyCode = convocation.companyCode;
        
        // Get tokens
        const tokensSnapshot = await admin.firestore()
            .collection('fcm_tokens')
            .doc(companyCode)
            .collection('tokens')
            .get();
        
        const tokens = tokensSnapshot.docs.map(doc => doc.data().token);
        
        // Send
        const response = await admin.messaging().sendMulticast({
            notification: {
                title: 'Nuova Convocazione',
                body: `${convocation.matchType} - ${convocation.formattedDate}`,
            },
            data: {
                convocationId: context.params.convocationId,
                type: 'new_convocation'
            },
            tokens: tokens
        });
        
        console.log(`âœ… ${response.successCount}/${tokens.length} sent`);
        return response;
    });
```

**Deploy:**
```bash
cd functions
npm install firebase-admin firebase-functions
cd ..
firebase deploy --only functions
```

## ğŸ§ª Test Rapido

### 1. Test Browser Console
```javascript
// Check permission
console.log(Notification.permission); // "granted", "denied", o "default"

// Request permission
await window.requestNotificationPermission();

// Get token
const token = await window.getFCMToken();
console.log(token);

// Test local notification
window.testNotification();
```

### 2. Test Firebase Console
1. Firebase Console â†’ Cloud Messaging
2. "Send your first message"
3. Titolo: "Test"
4. Testo: "Notifica di test"
5. "Send test message"
6. Incolla token FCM
7. "Test"

### 3. Test Page
Apri: `test_v952_fcm_implementation.html`
- Verifica browser support
- Test permission flow
- Check file versions
- View logs

## ğŸ“± Browser Support

| Browser | Desktop | Mobile | Note |
|---------|---------|--------|------|
| Chrome  | âœ… | âœ… | Full support |
| Firefox | âœ… | âœ… | Full support |
| Edge    | âœ… | âœ… | Full support |
| Safari  | âš ï¸ | âŒ | Limited desktop, no mobile |
| Opera   | âœ… | âœ… | Full support |

## ğŸ”‘ Funzioni Globali

```javascript
// Request permission and get token
window.requestNotificationPermission()

// Get FCM token only
window.getFCMToken()

// Initialize after login
window.initializePushNotifications()

// Test notification
window.testNotification()
```

## ğŸ“‚ Struttura Database

```
Firestore
â””â”€â”€ fcm_tokens/
    â””â”€â”€ {companyCode}/
        â””â”€â”€ tokens/
            â””â”€â”€ {userId}
                â”œâ”€â”€ token: "eJ3f...xyz"
                â”œâ”€â”€ timestamp: Timestamp
                â”œâ”€â”€ userAgent: "Mozilla/5.0..."
                â””â”€â”€ companyCode: "POLIS"
```

## ğŸš¨ Troubleshooting

### Token non generato
- âœ… VAPID key configurata?
- âœ… Permesso notifiche concesso?
- âœ… Service worker registrato?
- âœ… HTTPS o localhost?

### Notifiche non arrivano
- âœ… Token salvato in database?
- âœ… Cloud Function deployata?
- âœ… Backend invia a FCM?
- âœ… App in foreground o background?

### Service worker error
- âœ… firebase-messaging-sw.js esiste?
- âœ… Firebase config corretta?
- âœ… ImportScripts URLs corretti?
- âœ… Console errors?

## ğŸ“ Link Utili

- **Documentazione completa:** `PWA_DOCUMENTATION.md` (sezione ğŸ”” Notifiche Push)
- **Changelog dettagliato:** `CHANGELOG_V9.52.md`
- **Test page:** `test_v952_fcm_implementation.html`
- **Firebase Console:** https://console.firebase.google.com/
- **FCM Docs:** https://firebase.google.com/docs/cloud-messaging

## âœ… Checklist Implementazione

- [x] firebase-messaging-sw.js creato
- [x] Firebase Messaging SDK integrato
- [x] Permission request implementato
- [x] Token generation implementato
- [x] Foreground handler implementato
- [x] Background handler implementato
- [x] Database structure preparata
- [x] Documentazione completa
- [x] Test page creata
- [ ] VAPID key configurata (richiede Firebase Console)
- [ ] Cloud Function deployata (richiede backend)
- [ ] Test su dispositivi reali
- [ ] Regole Firestore configurate

## ğŸ¯ Next Steps

1. **Configura VAPID Key**
   - Firebase Console â†’ Cloud Messaging
   - Copia chiave VAPID
   - Sostituisci in index.html

2. **Deploy Cloud Function**
   - Crea functions/index.js
   - Deploy: `firebase deploy --only functions`

3. **Test Completo**
   - Test su Android Chrome
   - Test su Desktop Chrome/Firefox
   - Test iOS (verificare limitazioni)
   - Test end-to-end: login â†’ permission â†’ token â†’ notification

4. **Production**
   - Monitor Firebase Console metrics
   - Track delivery rates
   - Cleanup invalid tokens
   - User feedback

---

**Versione:** V9.52  
**Data:** 12 Gennaio 2025  
**Status:** âœ… Ready (Backend setup required)
