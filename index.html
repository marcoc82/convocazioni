<!DOCTYPE html>
<!-- Version: V9.35 - Fixed modal close button ID collision, added match type display, verified last 5 convocations ordering -->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rosterkick</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="192x192" href="favicon-192x192.png">
    <meta name="msapplication-TileImage" content="favicon-192x192.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Chart.js for statistics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- CONFIGURAZIONE FIREBASE -->
    <script type="module">
  import { cercaSocietaDaCodice } from './cercaSocietaDaCodice.js';
  window.cercaSocietaDaCodice = cercaSocietaDaCodice;
</script>
    <!-- debug -->
    <script>
    window.__firebase_config = JSON.stringify({
      apiKey: "AIzaSyD87fLjZfQO1gDOzqJZAdvlqSthBYN3XSU",
      authDomain: "polis-2013.firebaseapp.com",
      projectId: "polis-2013",
      storageBucket: "polis-2013.appspot.com",
      messagingSenderId: "607738543737",
      appId: "1:607738543737:web:9b108502b8f1b61ef4dea8",
      measurementId: "G-94FT2YQNBM"
    });
    </script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc, increment, deleteDoc, getDocs, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Espone le funzioni Firebase Auth globalmente per evitare ReferenceError
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getAuth = getAuth;

        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app, db, auth;
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.onSnapshot = onSnapshot;
            window.collection = collection;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.doc = doc;
            window.getDoc = getDoc;
            window.setDoc = setDoc;
            window.increment = increment;
            window.deleteDoc = deleteDoc;
            window.arrayUnion = arrayUnion;
            window.getDocs = getDocs;
        } else {
            console.error("Firebase configuration not available. Some features will not work.");
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        html, body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* V9.15: Disable pull-to-refresh navigation on mobile - just reload the page instead */
            overscroll-behavior-y: contain;
        }
        .player-item {
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease-in-out, background-color 0.2s;
        }
        .player-item.selected-mister {
            background-color: #d1e5f4;
            color: #1e40af;
            font-weight: bold;
            border-color: #3b82f6;
        }
        /* V7.5: Unavailable player called up by Mister - distinctive blue border */
        .player-item.selected-mister.unavailable-forced {
            border: 3px solid #3b82f6;
            border-color: #3b82f6;
        }
        .player-item.selected-marco {
            background-color: #fecaca;
            color: #b91c1c;
            font-weight: bold;
            border-color: #ef4444;
        }
        .player-item.selected-marco-orange {
            background-color: #fed7aa;
            color: #ea580c;
            font-weight: bold;
            border-color: #f97316;
        }
        .player-item.selected-marco-black {
            background-color: #1f2937;
            color: #ffffff;
            font-weight: bold;
            border-color: #374151;
        }
        .player-item.selected-marco-purple {
            background-color: #8b5cf6;
            color: #ffffff;
            font-weight: bold;
            border-color: #7c3aed;
        }
        /* V9.7: New color classes for updated player status logic */
        .player-item.selected-marco-blue-dark {
            background-color: #1e3a8a;
            color: #ffffff;
            font-weight: bold;
            border-color: #1e40af;
        }
        .player-item.selected-marco-red {
            background-color: #dc2626;
            color: #ffffff;
            font-weight: bold;
            border-color: #b91c1c;
        }
        .player-item.selected-marco-white {
            background-color: #ffffff;
            color: #1f2937;
            font-weight: bold;
            border-color: #d1d5db;
        }
        /* V9.10: Yellow color class for Squalificato status */
        .player-item.selected-marco-yellow {
            background-color: #fbbf24;
            color: #1f2937;
            font-weight: bold;
            border-color: #f59e0b;
        }
        /* Multi-status gradient styles */
        .player-item.multi-status {
            font-weight: bold;
            color: #ffffff;
        }
        .player-item.already-called-today {
            background-color: #d1d5db;
            color: #6b7280;
            font-weight: normal;
            border-color: #9ca3af;
        }
        .player-item:hover:not(.selected-mister):not(.selected-marco):not(.selected-marco-orange):not(.selected-marco-black):not(.selected-marco-purple):not(.selected-marco-blue-dark):not(.selected-marco-red):not(.selected-marco-white):not(.selected-marco-yellow):not(.already-called-today):not(.multi-status) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .player-item.already-called-today:hover {
            background-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Login Animations */
        @keyframes dropBounce {
            0% {
                transform: translateY(-100px);
                opacity: 0;
            }
            50% {
                transform: translateY(10px);
                opacity: 1;
            }
            65% {
                transform: translateY(-5px);
            }
            80% {
                transform: translateY(2px);
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            0% {
                transform: translateX(50px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInLeft {
            0% {
                transform: translateX(-50px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animate-drop-bounce {
            animation: dropBounce 1.2s ease-out forwards;
        }
        
        .animate-slide-in-right {
            animation: slideInRight 0.8s ease-out forwards;
        }
        
        .animate-slide-in-left {
            animation: slideInLeft 0.8s ease-out forwards;
        }
        
        /* V9.28: Wow Effects - Progress bars, top player badge, count-up animation */
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 1.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            animation: progressFill 1.5s ease-out;
        }
        
        @keyframes progressFill {
            0% {
                width: 0 !important;
            }
        }
        
        .progress-bar.high {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .progress-bar.medium {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }
        
        .progress-bar.low {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        
        .top-player-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #78350f;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.4);
            animation: badgePulse 2s ease-in-out infinite;
            margin-left: 8px;
        }
        
        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 4px rgba(251, 191, 36, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 8px rgba(251, 191, 36, 0.6);
            }
        }
        
        .count-up {
            display: inline-block;
            transition: all 0.3s ease-out;
        }
        
        /* V9.30: Modal Styling */
        .player-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease-in-out;
        }

        .player-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .player-modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }

        .player-modal.show .player-modal-content {
            transform: scale(1);
        }

        /* Make clickable name highlighted */
        .player-name-clickable {
            color: #2563eb;
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
            transition: all 0.2s;
        }

        .player-name-clickable:hover {
            color: #1d4ed8;
            text-decoration-style: solid;
        }

        /* Chart styling */
        .mini-chart {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 50px;
            padding: 6px;
            background: white;
            border-radius: 6px;
        }

        .mini-chart-bar {
            flex: 1;
            background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 3px 3px 0 0;
            transition: all 0.3s;
            min-height: 8px;
        }

        .mini-chart-bar:hover {
            background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
            transform: scaleY(1.1);
        }

        /* Trend badges */
        .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .trend-badge.positive {
            background: #dcfce7;
            color: #166534;
        }

        .trend-badge.neutral {
            background: #fef3c7;
            color: #92400e;
        }

        .trend-badge.negative {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Recent callups list */
        .recent-callup {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: white;
            border-radius: 6px;
            border-left: 2px solid;
            font-size: 0.65rem;
        }

        .recent-callup.presente {
            border-color: #10b981;
        }

        .recent-callup.assente {
            border-color: #ef4444;
        }

        .recent-callup.non-convocato {
            border-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center justify-center">

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-2xl">
        
        <!-- Company Code Entry Screen -->
        <div id="company-entry-screen" class="hidden">
            <!-- Animated Logo - larger and positioned above title -->
            <div class="flex justify-center mb-6">
                <img id="animated-logo" src="logo Rosterkick.png" alt="Rosterkick Logo" class="w-32 h-32 object-contain opacity-0 transform translate-y-[-100px]">
            </div>
            <!-- Animated Title -->
            <h1 id="animated-title" class="text-4xl font-bold text-gray-800 text-center mb-2 opacity-0 transform translate-x-full">Rosterkick</h1>
            <!-- Animated Subtitle -->
            <h2 id="animated-subtitle" class="text-xl font-semibold text-center text-gray-700 mb-6 opacity-0 transform translate-x-full">Inserisci il codice societ√†</h2>
            <!-- Animated Form -->
            <div id="animated-form" class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200 opacity-0 transform translate-x-[-50px]">
                <div class="flex flex-col gap-4">
                    <input type="text" id="company-code-input" placeholder="Codice societ√† o codice ospite" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-company" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-company" class="text-gray-700">Ricorda codice</label>
                    </div>
                    <button id="verify-company-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Verifica
                    </button>
                </div>
            </div>
            <div id="company-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
            
            <!-- Application Version - Only visible on login screen -->
            <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                <span class="text-sm font-semibold text-gray-500 bg-gray-100 px-3 py-1 rounded-full">V 9.27</span>
            </div>
        </div>

        <!-- Company Welcome Screen -->
        <div id="company-welcome-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Benvenuto</h2>
            <!-- Guest Role Indicator -->
            <div id="guest-role-indicator" class="mb-4 p-3 bg-yellow-100 border border-yellow-200 rounded-lg text-yellow-800 text-sm font-medium text-center hidden">
                üë§ Accesso Ospite - Funzionalit√† Limitate
            </div>
            <div class="p-6 bg-blue-50 rounded-xl mb-6 shadow-sm border border-blue-200 text-center">
                <h3 id="company-name-display" class="text-lg font-bold text-blue-800 mb-2"></h3>
                <div id="company-details" class="text-sm text-blue-600 mb-4 hidden">
                    <div>ID: <span id="company-document-id" class="font-mono bg-blue-100 px-2 py-1 rounded"></span></div>
                    <div>Codice: <span id="company-code-display" class="font-mono bg-blue-100 px-2 py-1 rounded"></span></div>
                </div>
                <!-- Normal login buttons (hidden for guests) -->
                <div id="normal-login-buttons" class="grid grid-cols-1 gap-3 mb-4">
                    <button id="enter-mister-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra come Mister
                    </button>
                    <button id="enter-dirigente-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra come Dirigente
                    </button>
                </div>
                <!-- Guest buttons (shown for both normal and guest users, but restricted for guests) -->
                <div id="guest-allowed-buttons" class="grid grid-cols-1 gap-3 mb-4">
                    <button id="view-history-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Storico Convocazioni
                    </button>
                    <button id="welcome-attendance-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Riepilogo Convocazioni
                    </button>
                    <!-- V9.10: Removed "Presenze Allenamenti" button - no longer needed -->
                    <!-- <button id="training-attendance-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                        Presenze Allenamenti
                    </button> -->
                    <button id="allenamenti-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        üèÉ Allenamenti
                    </button>
                </div>
                <!-- Campionato button (shown for POLIS PIEVE 2010 regardless of login type) -->
                <div id="campionato-container" class="grid grid-cols-1 gap-3 mb-4">
                    <button id="campionato-button" class="w-full bg-purple-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                        ‚öΩ Campionato
                    </button>
                </div>
                <!-- Risultati button (always visible to all users, positioned after Campionato button) -->
                <div id="area-polis2013-container" class="grid grid-cols-1 gap-3 mb-4">
                    <button id="area-polis2013-button" class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                       ‚öΩ Risultati
                    </button>
                </div>
                <!-- Admin buttons (hidden for guests) -->
                <div id="admin-buttons" class="grid grid-cols-1 gap-3">
                    <button id="manage-players-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Gestione Squadra
                    </button>
                </div>
                <button id="company-logout-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mt-3">
                    Logout
                </button>
            </div>
        </div>

        <!-- Password Entry Screen -->
        <div id="password-entry-screen" class="hidden">
            <div class="flex justify-center mb-4">
                <img src="logo Rosterkick.png" alt="Rosterkick Logo" class="w-20 h-20 object-contain">
            </div>
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Inserisci la password</h2>
            <!-- Biometric Authentication Button (shown only for returning users with biometric enrolled) -->
            <div id="biometric-login-container" class="hidden mb-6">
                <button type="button" id="biometric-login-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"></path>
                    </svg>
                    <span>Accedi con impronta digitale</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-2">oppure inserisci la password manualmente</p>
            </div>
            <form id="password-form" class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4">
                    <p id="role-prompt" class="text-center text-gray-600"></p>
                    <input type="text" id="username-input" autocomplete="username" style="display: none;" aria-hidden="true">
                    <input type="password" id="password-input" placeholder="Password" autocomplete="current-password" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex gap-2">
                        <button type="submit" id="confirm-password-button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                            Conferma
                        </button>
                        <button type="button" id="cancel-password-button" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                            Annulla
                        </button>
                    </div>
                </div>
            </form>
            <div id="password-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Player Management Screen -->
        <div id="player-management-screen" class="hidden">
            <button id="top-back-from-players-button" class="w-full mb-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Gestione Squadra</h2>
            
            <!-- Team Category Section -->
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Categoria Squadra</h3>
                <div class="mb-4">
                    <label for="team-categoria" class="block text-sm font-medium text-gray-700">üèÜ Categoria</label>
                    <input type="text" id="team-categoria" placeholder="Inserisci categoria (es. Juniores, Senior, etc.)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
            </div>

            <!-- Company Information Section -->
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Informazioni Societ√†</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="company-ragione-sociale" class="block text-sm font-medium text-gray-700">üè¢ Ragione Sociale</label>
                        <input type="text" id="company-ragione-sociale" placeholder="Nome completo della societ√†" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="company-indirizzo" class="block text-sm font-medium text-gray-700">üìç Indirizzo</label>
                        <input type="text" id="company-indirizzo" placeholder="Via, Citt√†, CAP" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="company-telefono" class="block text-sm font-medium text-gray-700">üìû Telefono</label>
                        <input type="tel" id="company-telefono" placeholder="+39 123 456 7890" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="company-mail" class="block text-sm font-medium text-gray-700">üìß Email</label>
                        <input type="email" id="company-mail" placeholder="info@societa.it" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="company-partita-iva" class="block text-sm font-medium text-gray-700">üÜî Partita IVA</label>
                        <input type="text" id="company-partita-iva" placeholder="IT12345678901" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                </div>
                <button id="save-company-info-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mb-4">
                    Salva Informazioni Societ√†
                </button>
                <div id="save-company-message-area" class="mt-2 mb-4 text-center text-sm font-medium text-gray-600 hidden"></div>
            </div>

            <!-- Player Management Section -->
            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors mb-3" id="players-section-header">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-700">Gestione Giocatori (<span id="players-count">0</span>)</h3>
                    <svg class="w-6 h-6 text-gray-600 transform transition-transform" id="players-expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <div id="players-content" class="hidden p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="player-numero" class="block text-sm font-medium text-gray-700">üî¢ Numero</label>
                        <input type="number" id="player-numero" placeholder="10" min="1" max="99" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="player-nome" class="block text-sm font-medium text-gray-700">üë§ Nome</label>
                        <input type="text" id="player-nome" placeholder="ROSSI MARIO" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="player-data-nascita" class="block text-sm font-medium text-gray-700">üìÖ Data di Nascita</label>
                        <input type="date" id="player-data-nascita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="player-matricola" class="block text-sm font-medium text-gray-700">üÜî Matricola</label>
                        <input type="text" id="player-matricola" placeholder="ABC123456" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                </div>
                <button id="add-player-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mb-4">
                    Aggiungi Giocatore
                </button>
                <div id="company-players-list" class="space-y-2">
                    <!-- Company players will be loaded here -->
                </div>
            </div>
            <div id="players-buttons-section" class="hidden mb-6">
            <button id="save-players-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mb-4 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Salva Giocatori
            </button>
            <div id="save-players-message-area" class="mt-2 mb-4 text-center text-sm font-medium text-gray-600 hidden"></div>
            </div>
            
            <!-- Coach Management Section -->
            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors mb-3" id="coaches-section-header">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-700">Gestione Mister (<span id="coaches-count">0</span>)</h3>
                    <svg class="w-6 h-6 text-gray-600 transform transition-transform" id="coaches-expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <div id="coaches-content" class="hidden p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4 mb-4">
                    <input type="text" id="new-coach-input" placeholder="Nome mister" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <input type="text" id="new-coach-matricola-input" placeholder="Matricola mister" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="add-coach-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Aggiungi Mister
                    </button>
                </div>
                <div id="company-coaches-list" class="space-y-2 mb-4">
                    <!-- Company coaches will be loaded here -->
                </div>
                <button id="save-coaches-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Salva Mister
                </button>
                <div id="save-coaches-message-area" class="mt-2 text-center text-sm font-medium text-gray-600 hidden"></div>
            </div>
            
            <!-- Directors Management Section -->
            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors mb-3" id="directors-section-header">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-700">Gestione Dirigenti (<span id="directors-count">0</span>)</h3>
                    <svg class="w-6 h-6 text-gray-600 transform transition-transform" id="directors-expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <div id="directors-content" class="hidden p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4 mb-4">
                    <input type="text" id="new-director-name-input" placeholder="Nome dirigente" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <input type="text" id="new-director-surname-input" placeholder="Cognome dirigente" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <input type="text" id="new-director-matricola-input" placeholder="Matricola dirigente" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="add-director-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Aggiungi Dirigente
                    </button>
                </div>
                <div id="company-directors-list" class="space-y-2 mb-4">
                    <!-- Company directors will be loaded here -->
                </div>
                <button id="save-directors-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Salva Dirigenti
                </button>
                <div id="save-directors-message-area" class="mt-2 text-center text-sm font-medium text-gray-600 hidden"></div>
            </div>
            
            <button id="back-from-players-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- Name Entry Screen (deprecated, keeping for compatibility) -->
        <div id="name-entry-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Inserisci il tuo nome</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4">
                    <input type="text" id="name-input" placeholder="" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-me" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-me" class="text-gray-700">Ricordami</label>
                    </div>
                    <button id="enter-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra
                    </button>
                </div>
            </div>
            <div id="name-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Start Screen View -->
        <div id="start-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Seleziona una squadra</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200 text-center">
                <p class="text-gray-600 mb-2">ID App attuale (il tuo ID):</p>
                <div class="flex flex-col items-center">
                    <span id="app-id-display" class="font-bold text-lg text-blue-600 mb-4 cursor-pointer" onclick="copyAppId()"></span>
                    <button id="create-team-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra
                    </button>
                </div>
            </div>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Partecipa a una squadra esistente</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="join-app-id-input" placeholder="Incolla l'ID app qui" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="join-team-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Partecipa
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="remember-team-id" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-team-id" class="text-gray-700">Ricorda ID squadra</label>
                </div>
            </div>
            <button id="forget-data-button" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Dimentica i dati salvati
            </button>
            <div id="start-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Main Form View -->
        <div id="main-view" class="hidden">
            <!-- App Info Section -->
            <div class="bg-gray-50 p-4 rounded-xl mb-6 shadow-sm border border-gray-200">
                <p class="text-gray-600 mb-2">ID Squadra attuale:</p>
                <div class="flex flex-col items-center">
                    <span id="current-app-id-display" class="font-bold text-lg text-blue-600 mb-4 cursor-pointer" onclick="copyAppId()"></span>
                    <button id="change-team-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Esci
                    </button>
                    <button id="reset-selections-button" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                        RESET
                    </button>
                </div>
            </div>

            <div id="role-message" class="mt-4 p-3 bg-blue-100 border border-blue-200 rounded-lg text-blue-800 text-sm font-medium hidden"></div>

            <!-- Notes section (editable by dirigente/marco, viewable by mister) -->
            <!-- Reset timestamp display (above notes) -->
            <div id="reset-timestamp-display" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                <p class="text-sm text-blue-700">
                    <span class="font-semibold">üîÑ Ultimo reset indisponibilit√†:</span>
                    <span id="reset-timestamp-text" class="ml-1">-</span>
                </p>
            </div>

            <div id="notes-section" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Note (Segnate dal Dirigente)</h3>
                <div id="notes-editable" class="hidden">
                    <textarea id="notes-textarea" placeholder="Inserisci le tue note qui..." class="w-full p-3 border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" rows="3" style="min-height: 80px; overflow-y: hidden;"></textarea>
                    <button id="save-notes-button" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                        Salva Note
                    </button>
                </div>
                <div id="notes-readonly" class="hidden">
                    <div id="notes-display" class="p-3 bg-white border border-yellow-300 rounded-lg min-h-[80px] text-gray-700"></div>
                </div>
            </div>

            <!-- View of unavailable players (visible to both Mister and Marco) -->
            <div id="unavailable-players-view" class="bg-red-100 p-4 rounded-xl mb-6 shadow-sm border border-red-200 hidden">
                <h2 id="unavailable-players-title" class="text-lg font-semibold text-red-700 mb-2">Giocatori Non Disponibili (Segnalati dal Dirigente)</h2>
                <ul id="unavailable-players-list" class="space-y-1 text-red-600">
                    <!-- Non-available players will be listed here -->
                </ul>
            </div>
            
            <!-- Match Details Section -->
            <div id="match-details-section" class="bg-gray-50 p-4 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Dettagli Partita</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="campo" class="block text-sm font-medium text-gray-700">üèüÔ∏è Campo</label>
                        <input type="text" id="campo" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="avversario" class="block text-sm font-medium text-gray-700">üÜö Avversario</label>
                        <input type="text" id="avversario" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="data-partita" class="block text-sm font-medium text-gray-700">üìÖ Data Partita</label>
                        <input type="date" id="data-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="orario-convocazione" class="block text-sm font-medium text-gray-700">üïí Orario Convocazione</label>
                        <input type="time" id="orario-convocazione" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="orario-partita" class="block text-sm font-medium text-gray-700">üïí Orario Partita</label>
                        <input type="time" id="orario-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tipo-partita" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipo-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="">Seleziona tipo</option>
                            <option value="Amichevole">ü§ù Amichevole</option>
                            <option value="Torneo">üèÜ Torneo</option>
                            <option value="Campionato">‚öΩÔ∏è Campionato</option>
                        </select>
                    </div>
                    <div id="mister-selection-1" class="hidden">
                        <label for="mister-partita" class="block text-sm font-medium text-gray-700">üë§ Mister</label>
                        <select id="mister-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="">Seleziona mister</option>
                        </select>
                    </div>
                    <div id="mister-selection-2" class="hidden">
                        <label for="mister-tipo" class="block text-sm font-medium text-gray-700">üë§ Mister</label>
                        <select id="mister-tipo" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="">Seleziona mister</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Players List Section -->
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-gray-700">Lista Giocatori</h2>
                <button id="legend-button" class="hidden bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium px-3 py-1 rounded-lg transition-colors duration-200">
                    üé® Legenda Colori
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4" id="players-list-message">Clicca sui nomi per selezionare i convocati.</p>
            <div id="players-list-container" class="bg-gray-50 rounded-xl p-4 mb-6 shadow-sm border border-gray-200">
                <ul id="players-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    <!-- Player items will be inserted here by JavaScript -->
                </ul>
            </div>
            
            <!-- Live Selected Players List -->
            <div id="selected-players-container" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-200">
                <h2 id="selected-players-title" class="text-lg font-semibold text-gray-700 mb-2">Giocatori Convocati</h2>
                <ul id="selected-players-live-list" class="space-y-2 text-gray-600">
                    <!-- Selected players will appear here in real-time -->
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                    Salva
                </button>
                <button id="share-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                    Condividi le convocazioni
                </button>
            </div>
            <button id="modulo-button" class="w-full mt-4 bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                ‚öΩ Tattiche
            </button>
            <button id="history-button" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Storico Convocazioni
            </button>
            <button id="attendance-button" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                Riepilogo Convocazioni
            </button>
            <button id="esci-button" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                ESCI
            </button>
            <div id="message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Success Popup -->
        <div id="success-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 mx-4 max-w-sm w-full">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Successo!</h3>
                <p id="success-popup-message" class="text-gray-600 text-center">Salvataggio effettuato con successo</p>
            </div>
        </div>

        <!-- Convocations History View (using Firestore) -->
        <div id="history-view" class="hidden">
            <button id="top-back-from-history-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Storico Convocazioni</h2>
            
            <!-- Period Filter -->
            <div class="mb-4">
                <label for="history-period-select" class="block text-sm font-medium text-gray-700 mb-2">Filtra per periodo:</label>
                <select id="history-period-select" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg">
                    <!-- V9.14: Options will be dynamically populated based on available history -->
                    <option value="week">Settimana corrente</option>
                    <option value="all">Tutti i periodi</option>
                </select>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-800 mb-4">
                <strong>‚ÑπÔ∏è Filtro attivo:</strong> <span id="history-filter-display" class="font-semibold">Mese corrente</span>
            </div>
            
            <div id="history-list" class="space-y-4">
                <!-- History items will be populated here -->
            </div>
            <button id="back-from-history-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- Attendance Summary View -->
        <div id="attendance-view" class="hidden">
            <button id="top-back-from-attendance-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-2">Riepilogo Convocazioni</h2>
            <p id="total-matches-display" class="text-center text-gray-600 mb-6">Partite totali: <span id="total-matches-count" class="font-semibold">0</span></p>
            
            <!-- Loading Spinner for Total Attendance -->
            <div id="attendance-totale-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <p class="mt-2 text-gray-600">Caricamento riepilogo totale...</p>
            </div>
            
            <!-- Total Attendance Table -->
            <div id="attendance-totale-content" class="hidden">
            <div class="flex items-center gap-2 mb-3">
                <h3 class="text-lg font-semibold text-gray-700">üìä Riepilogo Totale</h3>
                <button id="stats-chart-button" class="hidden text-blue-600 hover:text-blue-800 transition-colors" title="Visualizza grafico statistiche">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </button>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pres.</th>
                            <th scope="col" id="attendance-percentage-header" class="px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">% Conv.</th>
                            <th scope="col" id="availability-percentage-header" class="px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl hidden">% Disp.</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list" class="bg-white divide-y divide-gray-200">
                        <!-- Attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Amichevoli Attendance Table -->
            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors mb-3" id="amichevoli-section-header">
                <div class="flex justify-between items-center">
                    <h3 id="amichevoli-header" class="text-lg font-semibold text-gray-700">ü§ù Riepilogo Presenze Amichevoli</h3>
                    <svg class="w-6 h-6 text-gray-600 transform transition-transform" id="amichevoli-expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <div id="amichevoli-content" class="hidden bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list-amichevoli" class="bg-white divide-y divide-gray-200">
                        <!-- Amichevoli attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Tornei Attendance Table -->
            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors mb-3" id="tornei-section-header">
                <div class="flex justify-between items-center gap-2">
                    <div class="flex items-center gap-2">
                        <h3 id="tornei-header" class="text-lg font-semibold text-gray-700">üèÜ Riepilogo Presenze Tornei</h3>
                        <button id="tornei-stats-chart-button" class="hidden text-blue-600 hover:text-blue-800 transition-colors" title="Visualizza grafico statistiche tornei">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </button>
                    </div>
                    <svg class="w-6 h-6 text-gray-600 transform transition-transform" id="tornei-expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <!-- V8.6: Mobile-friendly table with responsive padding and horizontal scroll -->
            <div id="tornei-content" class="hidden bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Pres.</th>
                            <th scope="col" id="tornei-availability-header" class="px-2 sm:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl hidden">% Disp.</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list-tornei" class="bg-white divide-y divide-gray-200">
                        <!-- Tornei attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Campionato Attendance Table -->
            <div class="cursor-pointer hover:bg-gray-50 p-2 rounded transition-colors mb-3" id="campionato-section-header">
                <div class="flex justify-between items-center">
                    <h3 id="campionato-header" class="text-lg font-semibold text-gray-700">‚öΩÔ∏è Riepilogo Presenze Campionato</h3>
                    <svg class="w-6 h-6 text-gray-600 transform transition-transform" id="campionato-expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            <div id="campionato-content" class="hidden bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list-campionato" class="bg-white divide-y divide-gray-200">
                        <!-- Campionato attendance data will be populated here -->
                    </tbody>
                </table>
            </div>
            </div>

            <button id="back-from-attendance-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- V9.10: Training Attendance View - COMMENTED OUT - No longer needed -->
        <!-- <div id="training-attendance-view" class="hidden">
            <button id="top-back-from-training-attendance-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Presenze Allenamenti</h2>
            
            <div id="allenamenti-totali-display" class="text-center mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-lg font-semibold text-blue-800">
                    Allenamenti Totali: <span id="allenamenti-totali-value" class="text-2xl font-bold text-blue-900">-</span>
                </p>
                <p class="text-lg font-semibold text-blue-800 mt-2">
                    Media Presenze: <span id="media-presenze-value" class="text-2xl font-bold text-blue-900">-</span>
                </p>
            </div>
            
            <div id="training-attendance-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Caricamento dati allenamenti...</p>
            </div>

            <div id="training-attendance-error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 hidden">
                <p class="text-red-800 text-center">Errore nel caricamento dei dati. Riprova pi√π tardi.</p>
            </div>
            
            <div id="training-attendance-content" class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pres.</th>
                            <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">% Pres.</th>
                        </tr>
                    </thead>
                    <tbody id="training-attendance-list" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div class="text-center text-sm text-gray-500 mb-4">
                <p>Ultimo aggiornamento: <span id="training-last-update">Mai</span></p>
                <button id="refresh-training-button" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                    Aggiorna Dati
                </button>
            </div>

            <button id="back-from-training-attendance-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div> -->

        <!-- Allenamenti Management View (V8.11) -->
        <div id="allenamenti-view" class="hidden">
            <button id="top-back-from-allenamenti-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">üèÉ Gestione Allenamenti</h2>
            
            <!-- V8.11: Average Attendance Display -->
            <div id="average-attendance-display" class="mb-4 text-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm font-semibold text-blue-800">
                    Media Presenze Totale: <span id="average-attendance-value" class="text-lg font-bold text-blue-900">--%</span>
                </p>
            </div>
            
            <!-- Report Section (Monthly/Annual) -->
            <div id="allenamenti-report-section" class="mb-6">
                <div class="bg-blue-50 rounded-xl p-4 shadow-sm border border-blue-200 mb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">üìä Report Presenze</h3>
                    
                    <!-- Period Selection -->
                    <div class="flex gap-2 mb-4">
                        <select id="report-period-select" class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="all">Tutti i periodi</option>
                            <option value="week">Settimana corrente</option>
                            <option value="month">Mese corrente</option>
                            <option value="year" selected>Anno corrente</option>
                        </select>
                        <button id="refresh-report-button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                            Aggiorna
                        </button>
                    </div>
                    
                    <!-- Report Table -->
                    <div class="bg-white rounded-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Giocatore</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">N¬∞ All.</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Pres.</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">% Pres.</th>
                                </tr>
                            </thead>
                            <tbody id="allenamenti-report-body" class="bg-white divide-y divide-gray-200">
                                <!-- Report data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Training Sessions List -->
            <div id="allenamenti-sessions-section">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Sessioni Allenamento</h3>
                    
                    <!-- Sessions Period Selection -->
                    <div class="flex gap-2 mb-4">
                        <select id="sessions-period-select" class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="all">Tutti i periodi</option>
                            <option value="week" selected>Settimana corrente</option>
                            <option value="month">Mese corrente</option>
                            <option value="year">Anno corrente</option>
                        </select>
                        <button id="add-training-session-button" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium whitespace-nowrap">
                            + Nuovo
                        </button>
                    </div>
                </div>
                
                <!-- Loading State -->
                <div id="allenamenti-loading" class="text-center py-8 hidden">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div>
                    <p class="mt-2 text-gray-600">Caricamento allenamenti...</p>
                </div>
                
                <!-- Error State -->
                <div id="allenamenti-error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 hidden">
                    <p class="text-red-800 text-center">Errore nel caricamento dei dati. Riprova pi√π tardi.</p>
                </div>
                
                <!-- Training Sessions Cards Container -->
                <div id="training-sessions-container" class="space-y-4">
                    <!-- Training session cards will be populated here -->
                </div>
            </div>
            
            <button id="back-from-allenamenti-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- Add Training Session Modal (V8.11) -->
        <div id="add-training-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Nuovo Allenamento</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="training-date" class="block text-sm font-medium text-gray-700 mb-1">üìÖ Data</label>
                        <input type="date" id="training-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="training-time" class="block text-sm font-medium text-gray-700 mb-1">üïí Orario</label>
                        <input type="time" id="training-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500">
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="save-training-session-button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">
                            Salva
                        </button>
                        <button id="cancel-training-session-button" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">
                            Annulla
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campionato View -->
        <div id="campionato-view" class="hidden">
            <button id="back-from-campionato-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">‚öΩ Campionato</h2>
            
            <!-- Risultati Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">üìä Risultati</h3>
                <div id="risultati-widget-container" class="text-center text-gray-600">
                    <iframe src='https://www.tuttocampo.it/WidgetV2/Risultati/4736d246-7989-4f4d-acb7-464de2591ce7'
                        width='90%' 
                        height='600' 
                        style="min-width: 400px;"
                        scrolling='no' 
                        frameborder='0' 
                        loading='lazy'>
                    </iframe>
                </div>
            </div>
            
            <!-- Classifica Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">üèÜ Classifica</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/Classifica/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="12%" 
                            height="800" 
                            style="min-width: 350px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
            
            <!-- Marcatori Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">‚öΩ Marcatori</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/Marcatori/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="9%" 
                            height="700" 
                            style="min-width: 350px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
            
            <!-- Ultima Partita Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">üéØ Ultima Partita</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/Partita/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="5%" 
                            height="400" 
                            style="min-width: 320px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
            
            <!-- Prossima Partita Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">üîú Prossima Partita</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/ProssimaPartita/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="5%" 
                            height="400" 
                            style="min-width: 320px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- Shareable View (Hidden for image generation) -->
        <div id="share-view" class="absolute w-[600px] h-auto top-[-9999px] left-[-9999px] bg-white rounded-xl shadow-2xl p-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Convocazioni Ufficiali</h2>
            
            <div id="share-details" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-gray-700 mb-2">üèüÔ∏è Campo: <span id="share-campo" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">üÜö Avversario: <span id="share-avversario" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">üìÖ Data Partita: <span id="share-data-partita" class="font-semibold"></span></p>
                <p class="text-700 mb-2">üïí Orario Convocazione: <span id="share-orario-convocazione" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">üïí Orario Partita: <span id="share-orario-partita" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">Tipo: <span id="share-tipo" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">üë§ Mister: <span id="share-mister-partita" class="font-semibold"></span></p>
                <p class="text-gray-700">üë§ Mister: <span id="share-mister-tipo" class="font-semibold"></span></p>
            </div>

            <div class="mb-4">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Giocatori Convocati:</h3>
                <ul id="share-players-list" class="space-y-2 text-gray-600">
                    <!-- Selected players will be inserted here -->
                </ul>
            </div>
            <p class="text-sm text-gray-500 text-center mt-6">Rosterkick By Marco</p>
        </div>

        <!-- V8.14: Modulo/Tactics View with enhanced player positioning -->
        <div id="modulo-view" class="hidden">
            <button id="top-back-from-modulo-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">‚öΩ Tattiche</h2>
            
            <!-- Match Type and Formation Selection -->
            <div class="bg-gray-50 p-4 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="match-type-select" class="block text-sm font-medium text-gray-700 mb-2">Tipo Partita</label>
                        <select id="match-type-select" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="">Seleziona tipo</option>
                            <option value="5">Calcio a 5</option>
                            <option value="7">Calcio a 7</option>
                            <option value="9">Calcio a 9</option>
                            <option value="11">Calcio a 11</option>
                        </select>
                    </div>
                    <div>
                        <label for="formation-input" class="block text-sm font-medium text-gray-700 mb-2">Modulo Tattico</label>
                        <input type="text" id="formation-input" placeholder="es. 2-2, 2-3-2, 4-4-2" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                </div>
                <button id="generate-field-button" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                    Genera Campo
                </button>
            </div>
            
            <!-- Soccer Field Visualization -->
            <div id="soccer-field-container" class="bg-green-700 p-4 rounded-xl mb-6 shadow-lg border-4 border-white relative hidden" style="min-height: 500px;">
                <div class="absolute inset-0 bg-green-600" style="opacity: 0.3;"></div>
                <div class="relative">
                    <!-- Field markings -->
                    <div class="border-2 border-white rounded-lg p-2" style="min-height: 480px; position: relative;">
                        <!-- V8.14: Midfield line -->
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: white; transform: translateY(-50%);"></div>
                        
                        <!-- V8.14: Center circle -->
                        <div style="position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                        <div style="position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; background: white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                        
                        <!-- V8.14: Penalty area (bottom) -->
                        <div style="position: absolute; bottom: 0; left: 50%; width: 35%; height: 18%; border: 2px solid white; border-bottom: none; transform: translateX(-50%);"></div>
                        <div style="position: absolute; bottom: 0; left: 50%; width: 20%; height: 10%; border: 2px solid white; border-bottom: none; transform: translateX(-50%);"></div>
                        <!-- Penalty spot (bottom) -->
                        <div style="position: absolute; bottom: 12%; left: 50%; width: 6px; height: 6px; background: white; border-radius: 50%; transform: translateX(-50%);"></div>
                        
                        <!-- V8.14: Penalty area (top) -->
                        <div style="position: absolute; top: 0; left: 50%; width: 35%; height: 18%; border: 2px solid white; border-top: none; transform: translateX(-50%);"></div>
                        <div style="position: absolute; top: 0; left: 50%; width: 20%; height: 10%; border: 2px solid white; border-top: none; transform: translateX(-50%);"></div>
                        <!-- Penalty spot (top) -->
                        <div style="position: absolute; top: 12%; left: 50%; width: 6px; height: 6px; background: white; border-radius: 50%; transform: translateX(-50%);"></div>
                        
                        <div id="field-players-container" class="relative h-full" style="min-height: 480px;">
                            <!-- Player icons will be positioned here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="back-from-modulo-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- V8.15: Player Selection Modal for Modulo -->
        <div id="modulo-player-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl max-h-[80vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Seleziona Giocatore</h3>
                <div id="modulo-player-list" class="space-y-2 mb-4">
                    <!-- Player list will be populated here -->
                </div>
                <button id="close-modulo-modal" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                    Annulla
                </button>
            </div>
        </div>

        <!-- Modal for Marco's Status - Multi-select with checkboxes -->
        <div id="status-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
                <h2 class="text-xl font-bold mb-4">Seleziona indisponibilit√†</h2>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <label class="flex items-center p-3 bg-gray-900 text-white rounded-lg hover:bg-gray-800 cursor-pointer transition-colors duration-200">
                        <input type="checkbox" data-status="Infortunato" class="status-checkbox w-5 h-5 mr-3 rounded">
                        <span class="flex-1 font-medium">Infortunato üöë</span>
                    </label>
                    <label class="flex items-center p-3 bg-yellow-400 text-gray-900 rounded-lg hover:bg-yellow-500 cursor-pointer transition-colors duration-200">
                        <input type="checkbox" data-status="Squalificato" class="status-checkbox w-5 h-5 mr-3 rounded">
                        <span class="flex-1 font-medium">Squalificato üü•</span>
                    </label>
                    <label class="flex items-center p-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 cursor-pointer transition-colors duration-200">
                        <input type="checkbox" data-status="Non disponibile Sabato" class="status-checkbox w-5 h-5 mr-3 rounded">
                        <span class="flex-1 font-medium">N.D. SABATO</span>
                    </label>
                    <label class="flex items-center p-3 bg-blue-900 text-white rounded-lg hover:bg-blue-950 cursor-pointer transition-colors duration-200">
                        <input type="checkbox" data-status="Non disponibile Domenica" class="status-checkbox w-5 h-5 mr-3 rounded">
                        <span class="flex-1 font-medium">N.D. DOMENICA</span>
                    </label>
                    <label class="flex items-center p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 cursor-pointer transition-colors duration-200">
                        <input type="checkbox" data-status="Non disponibile Weekend" class="status-checkbox w-5 h-5 mr-3 rounded">
                        <span class="flex-1 font-medium">N.D. W.E.</span>
                    </label>
                    <!-- V9.12: Training attendance statuses - DISABLED (auto-calculated) -->
                    <div class="relative">
                        <label class="flex items-center p-3 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed opacity-60 transition-colors duration-200" title="Calcolato automaticamente in base alle presenze agli allenamenti">
                            <input type="checkbox" data-status="Solo 2 allenamenti" class="status-checkbox w-5 h-5 mr-3 rounded" disabled>
                            <span class="flex-1 font-medium">2 ALLENAMENTI</span>
                        </label>
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-600">
                            <span title="Calcolato automaticamente in base alle presenze agli allenamenti">‚ÑπÔ∏è</span>
                        </div>
                    </div>
                    <div class="relative">
                        <label class="flex items-center p-3 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed opacity-60 transition-colors duration-200" title="Calcolato automaticamente in base alle presenze agli allenamenti">
                            <input type="checkbox" data-status="Solo 1 allenamento" class="status-checkbox w-5 h-5 mr-3 rounded" disabled>
                            <span class="flex-1 font-medium">1 ALLENAMENTO</span>
                        </label>
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-600">
                            <span title="Calcolato automaticamente in base alle presenze agli allenamenti">‚ÑπÔ∏è</span>
                        </div>
                    </div>
                    <div class="relative">
                        <label class="flex items-center p-3 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed opacity-60 transition-colors duration-200" title="Calcolato automaticamente in base alle presenze agli allenamenti">
                            <input type="checkbox" data-status="Zero allenamenti" class="status-checkbox w-5 h-5 mr-3 rounded" disabled>
                            <span class="flex-1 font-medium">0 ALLENAMENTI ‚ùå</span>
                        </label>
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-600">
                            <span title="Calcolato automaticamente in base alle presenze agli allenamenti">‚ÑπÔ∏è</span>
                        </div>
                    </div>
                    <!-- V9.12: Info message about automatic calculation -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        <p><strong>‚ÑπÔ∏è Nota:</strong> Gli stati degli allenamenti sono calcolati automaticamente in base alle presenze della settimana corrente e non possono essere modificati manualmente.</p>
                    </div>
                </div>
                <div class="mt-4 space-y-2">
                    <button id="confirm-status-button" class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                        Conferma Selezione
                    </button>
                    <button id="clear-status-button" class="w-full py-2.5 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg transition-colors duration-200">
                        Rendi Disponibile
                    </button>
                    <button id="close-status-modal" class="w-full py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                        Annulla
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal for Mister's Unavailable Player Info -->
        <div id="unavailable-player-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
                <h2 class="text-xl font-bold mb-4 text-center text-red-600">‚ö†Ô∏èGiocatore Non Disponibile‚ö†Ô∏è</h2>
                <div class="text-center mb-6">
                    <p class="text-lg font-semibold text-gray-800 mb-2" id="unavailable-player-name">Nome Giocatore</p>
                    <p class="text-gray-600">Motivo:</p>
                    <p class="text-lg font-medium text-red-600" id="unavailable-player-reason">Motivo indisponibilit√†</p>
                </div>
                <button id="convoca-comunque-button" class="w-full py-3 mb-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    Convoca ugualmente
                </button>
                <!-- V6.6: Pulsante per rimuovere convocazione forzata -->
                <button id="togli-convocazione-button" class="w-full py-3 mb-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200 hidden">
                    Togli dalla convocazione
                </button>
                <button id="close-unavailable-modal" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                    Ok
                </button>
            </div>
        </div>
    </div>

    <!-- Already Called Today Confirmation Modal -->
    <div id="already-called-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center text-orange-600">‚ö†Ô∏è Giocatore Gi√† Convocato ‚ö†Ô∏è</h2>
            <div class="text-center mb-6">
                <p class="text-lg font-semibold text-gray-800 mb-2" id="already-called-player-name">Nome Giocatore</p>
                <p class="text-gray-600 mb-2">Questo giocatore √® gi√† stato convocato oggi.</p>
                <p class="text-sm text-gray-500">Vuoi confermarlo ugualmente?</p>
            </div>
            <button id="confirm-already-called-button" class="w-full py-3 mb-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                Conferma Convocazione
            </button>
            <button id="cancel-already-called-button" class="w-full py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                Annulla
            </button>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center">Condividi le convocazioni</h2>
            <div class="space-y-3">
                <!-- Web Share API button (will be shown only if supported) -->
                <button id="web-share-button" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200 hidden">
                    üì± Condividi con app
                </button>
                
                <!-- Separator line when Web Share is available -->
                <div id="share-separator" class="border-t border-gray-200 pt-3 hidden">
                    <p class="text-sm text-gray-500 text-center mb-3">Oppure scegli un servizio specifico:</p>
                </div>
                
                <!-- Manual sharing options -->
                <button id="whatsapp-share-button" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    üí¨ Condividi su WhatsApp
                </button>
                
                <button id="telegram-share-button" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    ‚úàÔ∏è Condividi su Telegram
                </button>
                
                <button id="email-share-button" class="w-full py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    üìß Condividi via Email
                </button>
                
                <button id="copy-link-button" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    üìã Copia link immagine
                </button>
                
                <button id="download-image-button" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    üíæ Scarica immagine
                </button>
            </div>
            <button id="close-share-modal" class="mt-6 w-full py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                Annulla
            </button>
        </div>
    </div>

    <!-- V9.19: Modal for Player Color Legend -->
    <div id="legend-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-gray-800">üé® Legenda Colori Giocatori</h2>
            <p class="text-sm text-gray-600 mb-4">I colori dei badge indicano lo stato di disponibilit√† dei giocatori:</p>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                <!-- Single status colors -->
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-gray-900 rounded border-2 border-gray-700 flex items-center justify-center text-white text-xs font-bold">
                        üöë
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">Infortunato</div>
                        <div class="text-xs text-gray-500">Badge nero con icona ambulanza</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-yellow-400 rounded border-2 border-yellow-500 flex items-center justify-center text-gray-900 text-xs font-bold">
                        üü•
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">Squalificato</div>
                        <div class="text-xs text-gray-500">Badge giallo con cartellino rosso</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-purple-600 rounded border-2 border-purple-700 flex items-center justify-center text-white text-xs font-bold">
                        SAB
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">N.D. SABATO</div>
                        <div class="text-xs text-gray-500">Badge viola</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-blue-900 rounded border-2 border-blue-950 flex items-center justify-center text-white text-xs font-bold">
                        DOM
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">N.D. DOMENICA</div>
                        <div class="text-xs text-gray-500">Badge blu scuro</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-red-600 rounded border-2 border-red-700 flex items-center justify-center text-white text-xs font-bold">
                        WE
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">N.D. W.E.</div>
                        <div class="text-xs text-gray-500">Badge rosso</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-white rounded border-2 border-gray-300 flex items-center justify-center text-gray-900 text-xs font-bold">
                        2 ALL
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">2 ALLENAMENTI</div>
                        <div class="text-xs text-gray-500">Badge bianco (calcolato automaticamente)</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-red-600 rounded border-2 border-red-700 flex items-center justify-center text-white text-xs font-bold">
                        1 ALL
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">1 ALLENAMENTO</div>
                        <div class="text-xs text-gray-500">Badge rosso (calcolato automaticamente)</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="w-16 h-10 bg-red-600 rounded border-2 border-red-700 flex items-center justify-center text-white text-xs font-bold">
                        ‚ùå
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">0 ALLENAMENTI</div>
                        <div class="text-xs text-gray-500">Badge rosso (calcolato automaticamente)</div>
                    </div>
                </div>
                
                <!-- Multi-status gradient example -->
                <div class="border-t pt-3 mt-3">
                    <div class="font-medium text-gray-800 mb-2">Stati Multipli:</div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-16 h-10 rounded border-2 border-gray-400 flex items-center justify-center text-xs font-bold" style="background: linear-gradient(90deg, #1e3a8a 0%, #1e3a8a 50%, #ffffff 50%, #ffffff 100%); color: #1f2937;">
                            <span style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">DOM</span>/<span style="color: #1f2937;">2</span>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm text-gray-700">N.D. DOMENICA + 2 ALLENAMENTI</div>
                            <div class="text-xs text-gray-500">Badge met√† blu/met√† bianco</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded">
                        <strong>Nota:</strong> Quando un giocatore ha pi√π stati, il badge mostra un gradiente con i colori degli stati combinati.
                    </div>
                </div>
            </div>
            <button id="close-legend-modal" class="mt-6 w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                Chiudi
            </button>
        </div>
    </div>

    <!-- Modal for Home/Away Selection -->
    <div id="distinta-location-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center">Tipo di Partita</h2>
            <p class="text-gray-600 text-center mb-6">Seleziona se la partita √® in casa o in trasferta:</p>
            <div class="space-y-3">
                <button id="distinta-home-button" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    üè† In Casa
                </button>
                <button id="distinta-away-button" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    ‚úàÔ∏è In Trasferta
                </button>
            </div>
            <button id="close-distinta-location-modal" class="mt-4 w-full py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                Annulla
            </button>
        </div>
    </div>

    <!-- Modal for Dirigenti Selection -->
    <div id="distinta-dirigenti-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center">Selezione Dirigenti</h2>
            <p class="text-gray-600 text-center mb-6">Seleziona i dirigenti da includere nella distinta (minimo 1):</p>
            <div id="dirigenti-selection-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto">
                <!-- Dirigenti checkboxes will be added here -->
            </div>
            <div class="flex space-x-3">
                <button id="confirm-dirigenti-selection" class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    Conferma
                </button>
                <button id="close-distinta-dirigenti-modal" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Girone and Giornata Input -->
    <div id="distinta-match-info-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center">Informazioni Partita</h2>
            <p class="text-gray-600 text-center mb-6">Inserisci il girone e il numero della giornata:</p>
            <div class="space-y-4 mb-6">
                <div>
                    <label for="distinta-girone-select" class="block text-sm font-medium text-gray-700 mb-2">Girone:</label>
                    <select id="distinta-girone-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Seleziona girone...</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G">G</option>
                    </select>
                </div>
                <div>
                    <label for="distinta-giornata-input" class="block text-sm font-medium text-gray-700 mb-2">Numero della Giornata:</label>
                    <input type="number" id="distinta-giornata-input" min="1" max="99" placeholder="Es: 1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex space-x-3">
                <button id="confirm-match-info" class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    Conferma
                </button>
                <button id="close-distinta-match-info-modal" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Distinta Display -->
    <div id="distinta-display-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Distinta Ufficiale</h2>
                <button id="close-distinta-display-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Distinta Content -->
            <div id="distinta-content" style="background: white;">
                <!-- Content will be generated here -->
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
                <button id="copy-distinta-button" class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                    üìã Copia Distinta
                </button>
                <button id="print-distinta-button" class="flex-1 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
                    üñ®Ô∏è Stampa
                </button>
                <button id="share-distinta-button" class="flex-1 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors duration-200">
                    üì§ Condividi
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Statistics Chart (POLIS only) -->
    <div id="stats-chart-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">üìä Statistiche Partite Giocatori</h2>
                <button id="close-stats-chart-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Chart Container -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <canvas id="stats-chart-canvas" class="w-full"></canvas>
            </div>
            
            <!-- Legend/Table -->
            <div class="mt-6 overflow-x-auto">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Dettaglio Statistiche</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giocatore</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Partite Tot</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Conv.</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">% Conv.</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">% Disp.</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Stats data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- V8.1: Tornei Stats Chart Modal -->
    <div id="tornei-stats-chart-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">üèÜ Statistiche Tornei</h2>
                <button id="close-tornei-stats-chart-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Chart Container -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <canvas id="tornei-stats-chart-canvas" class="w-full"></canvas>
            </div>
            
            <!-- Legend/Table -->
            <div class="mt-6 overflow-x-auto">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Dettaglio Statistiche Tornei</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giocatore</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tornei Tot</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pres.</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">% Disp.</th>
                        </tr>
                    </thead>
                    <tbody id="tornei-stats-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Tornei stats data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Player Details Modal -->
    <div id="player-modal" class="player-modal">
        <div class="player-modal-content">
            <div class="p-6">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="modal-player-name">Player Name</h2>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Content Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Trend Section -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                        <h3 class="text-sm font-bold text-gray-800 mb-3">üìà Trend delle Convocazioni</h3>
                        <div id="modal-trend"></div>
                    </div>

                    <!-- Chart Section -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                        <h3 class="text-sm font-bold text-gray-800 mb-3">üìä Ultime 8 Partite</h3>
                        <div class="mini-chart" id="modal-chart"></div>
                    </div>

                    <!-- Recent Callups Section -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
                        <h3 class="text-sm font-bold text-gray-800 mb-3">üóìÔ∏è Ultime 5 Convocazioni</h3>
                        <div class="space-y-2" id="modal-callups"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for app logic -->
    <script>

        
        // Vibration Functions
        function vibrateOnClick(element) {
            // Check if the clicked element is a save button (contains "Salva" text)
            const isSaveButton = element && (
                element.textContent?.includes('Salva') || 
                element.id?.includes('save') ||
                element.classList?.contains('save-button')
            );
            
            if (navigator.vibrate) {
                if (isSaveButton) {
                    // Triple vibration for save buttons: [50ms on, 50ms off, 50ms on, 50ms off, 50ms on, 50ms off]
                    navigator.vibrate([50, 50, 50, 50, 50, 50]);
                } else {
                    // Single vibration for all other buttons/keys
                    navigator.vibrate(50);
                }
            }
        }
        
        // Global event listener for all clicks and key presses
        document.addEventListener('click', function(event) {
            // Only vibrate for interactive elements
            const interactiveElements = ['BUTTON', 'A', 'INPUT', 'TEXTAREA', 'SELECT'];
            if (interactiveElements.includes(event.target.tagName) || 
                event.target.hasAttribute('onclick') ||
                event.target.classList.contains('clickable')) {
                vibrateOnClick(event.target);
            }
        });
        
        // Global event listener for key presses
        document.addEventListener('keydown', function(event) {
            // Vibrate on any key press (single vibration since keys are never save actions)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
        
        // Fallback initialization when Firebase modules don't load
        document.addEventListener('DOMContentLoaded', () => {
            // If Firebase modules didn't load, initialize in demo mode
            if (typeof window.signInAnonymously === 'undefined') {
                console.log("Firebase modules not available, initializing in demo mode");
                initializeDemoMode();
            }
        });

        function initializeDemoMode() {
            // Demo mode initialization
            const companyEntryScreen = document.getElementById('company-entry-screen');
            const companyCodeInput = document.getElementById('company-code-input');
            const verifyCompanyButton = document.getElementById('verify-company-button');
            const companyEntryMessageArea = document.getElementById('company-entry-message-area');
            const rememberCompanyCheckbox = document.getElementById('remember-company');
            
            const companyWelcomeScreen = document.getElementById('company-welcome-screen');
            const companyNameDisplay = document.getElementById('company-name-display');
            const enterMisterButton = document.getElementById('enter-mister-button');
            const enterDirigenteButton = document.getElementById('enter-dirigente-button');
            // V9.10: Training attendance button - COMMENTED OUT - Feature removed
            // const trainingAttendanceButton = document.getElementById('training-attendance-button');
            const campionatoButton = document.getElementById('campionato-button');
            
            const passwordEntryScreen = document.getElementById('password-entry-screen');
            const rolePrompt = document.getElementById('role-prompt');
            const passwordInput = document.getElementById('password-input');
            const passwordForm = document.getElementById('password-form');
            const confirmPasswordButton = document.getElementById('confirm-password-button');
            const cancelPasswordButton = document.getElementById('cancel-password-button');
            const passwordEntryMessageArea = document.getElementById('password-entry-message-area');
            const biometricLoginContainer = document.getElementById('biometric-login-container');
            const biometricLoginButton = document.getElementById('biometric-login-button');

            let currentCompanyCode = null;
            window.currentCompanyCode = currentCompanyCode;
            let currentCompanyData = null;
            let currentCompanyDocumentId = null;
            let pendingRole = null;

            // Show company entry screen
            companyEntryScreen.classList.remove('hidden');
            
            // Trigger login animations sequence (if available)
            setTimeout(() => {
                if (typeof startLoginAnimations === 'function') {
                    startLoginAnimations();
                }
            }, 100);

            // Initialize checkbox state based on saved preference
            const savedRememberPreference = localStorage.getItem('rememberCompanyPreference');
            if (savedRememberPreference === 'true') {
                rememberCompanyCheckbox.checked = true;
                // If remember is true and there's saved data, fill in the company code
                const savedCompanyCode = localStorage.getItem('companyCode');
                if (savedCompanyCode) {
                    companyCodeInput.value = savedCompanyCode;
                }
            } else {
                rememberCompanyCheckbox.checked = false;
            }

            function hideAllScreens() {
                document.querySelectorAll('[id$="-screen"]').forEach(screen => {
                    screen.classList.add('hidden');
                });
            }

            function showMessage(element, message, isError = true) {
                element.textContent = message;
                element.classList.remove('hidden');
                element.classList.toggle('text-red-600', isError);
                element.classList.toggle('text-green-600', !isError);
                setTimeout(() => element.classList.add('hidden'), 5000);
            }

            // Demo company verification
            function verifyCompanyCode(code) {
                if (code === "DEMO" || code === "demo") {
                    return {
                        name: "Societ√† Demo",
                        passwords: {
                            mister: "mister123",
                            marco: "marco123"
                        }
                    };
                }
                // Test PIEVE2010 company for campionato functionality
                if (code === "PIEVE2010" || code === "pieve2010") {
                    return {
                        name: "PIEVE2010",
                        passwords: {
                            mister: "mister123",
                            marco: "marco123"
                        }
                    };
                }
                // Test Polis company for visibility functionality
                if (code && code.toUpperCase().includes("POLIS")) {
                    return {
                        name: "POLIS Societ√† Test",
                        passwords: {
                            mister: "mister123",
                            marco: "marco123"
                        }
                    };
                }
                return null;
            }

            /**
             * Checks if the company is POLIS PIEVE 2010 by checking config.nome, nome, or id
             * @param {Object} companyData - The company data object
             * @returns {boolean} - True if the company is POLIS PIEVE 2010
             */
            function isPolisPieve2010(companyData) {
                const societa = companyData?.data;
                if (!societa) return false;
                
                const configNome = societa?.config?.nome || '';
                const nome = societa?.nome || '';
                const id = societa?.id || '';
                
                const isMatch = configNome === 'POLIS PIEVE 2010' || 
                               nome === 'POLIS PIEVE 2010' || 
                               id === 'POLIS PIEVE 2010';
                
                console.log('üîç DEBUG - isPolisPieve2010 check:', {
                    'config.nome': configNome,
                    'nome': nome,
                    'id': id,
                    'isPolisPieve2010': isMatch
                });
                
                return isMatch;
            }

            function showCompanyWelcome() {
                hideAllScreens();
                companyNameDisplay.textContent = currentCompanyData.name;
                
                // Set currentAppId correctly to avoid inconsistencies
                // Use document ID if available, otherwise use company code
                const expectedAppId = currentCompanyDocumentId || currentCompanyCode;
                if (currentAppId !== expectedAppId) {
                    console.log(`üîß Setting App ID to: ${expectedAppId} (was: ${currentAppId})`);
                    currentAppId = expectedAppId;
                }
                
                // Show/hide training attendance button based on company name
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                // Check if company is POLIS PIEVE 2010 (checks config.nome, nome, or id)
                const isPolisPieveCompany = isPolisPieve2010(currentCompanyData);
                
                // V9.10: Training attendance button - COMMENTED OUT - Feature removed
                // if (isPolisCompany) {
                //     trainingAttendanceButton.classList.remove('hidden');
                // } else {
                //     trainingAttendanceButton.classList.add('hidden');
                // }
                
                // Show/hide campionato button for POLIS PIEVE 2010
                if (isPolisPieveCompany) {
                    campionatoButton.classList.remove('hidden');
                    // V8.11: Change Campionato button color to yellow (same as Risultati) for PIEVE2010
                    // V9.7: Add text-black for better visibility on yellow background
                    campionatoButton.classList.remove('bg-purple-600', 'hover:bg-red-700', 'text-white');
                    campionatoButton.classList.add('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
                    console.log('üé® Campionato button color changed to yellow with black text for PIEVE2010');
                } else {
                    campionatoButton.classList.add('hidden');
                    // Reset to purple if not PIEVE2010
                    campionatoButton.classList.remove('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
                    campionatoButton.classList.add('bg-purple-600', 'hover:bg-red-700', 'text-white');
                }
                
                // Risultati button is always visible to all users (no conditional logic needed)
                // Button always shows and opens https://marcoc82.github.io/polis2013/ without pre-filled code
                console.log('‚úì Risultati button is visible to all users');
                
                // Show company details with document ID and codici field
                const companyDetails = document.getElementById('company-details');
                const companyDocumentIdSpan = document.getElementById('company-document-id');
                const companyCodeSpan = document.getElementById('company-code-display');
                
                if (currentCompanyData.data) {
                    companyDocumentIdSpan.textContent = currentCompanyDocumentId || 'N/A';
                    companyCodeSpan.textContent = currentCompanyData.data.codici || currentCompanyCode;
                if (currentCompanyData.data) {
                    companyDocumentIdSpan.textContent = currentCompanyDocumentId || 'N/A';
                    companyCodeSpan.textContent = currentCompanyData.data.codici || currentCompanyCode;
                    companyDetails.classList.remove('hidden');
                } else {
                    companyDetails.classList.add('hidden');
                }
                
                companyWelcomeScreen.classList.remove('hidden');
            }

            function showPasswordEntry(role) {
                hideAllScreens();
                pendingRole = role;
                rolePrompt.textContent = `Inserisci la password per ${role === 'mister' ? 'Mister' : 'Dirigente'}:`;
                passwordInput.value = '';
                passwordEntryScreen.classList.remove('hidden');
                
                // Check if biometric authentication is available and enrolled for this user
                if (biometricLoginContainer) {
                    if (isBiometricSupported() && currentCompanyCode && hasBiometricEnrolled(currentCompanyCode, role)) {
                        biometricLoginContainer.classList.remove('hidden');
                    } else {
                        biometricLoginContainer.classList.add('hidden');
                    }
                }
                
                passwordInput.focus();
            }

            // Event listeners
            verifyCompanyButton.addEventListener('click', async () => {
                const companyCode = companyCodeInput.value.trim();
                if (!companyCode) {
                    showMessage(companyEntryMessageArea, "Inserisci un codice societ√†.");
                    return;
                }

                try {
                    const companyData = await verifyCompanyCode(companyCode);
                    if (companyData) {
                        currentCompanyCode = companyCode;
                        window.currentCompanyCode = currentCompanyCode;
                        currentCompanyData = companyData;
                        
                        // Store document ID if available (from Firebase/cercaSocietaDaCodice)
                        if (currentCompanyData.data && currentCompanyData.data.id) {
                            currentCompanyDocumentId = currentCompanyData.data.id;
                        } else {
                            // Fallback to company code for demo mode
                            currentCompanyDocumentId = companyCode;
                        }
                        
                        // Populate passwords from data.config if available
                        if (currentCompanyData.data && currentCompanyData.data.config) {
                            currentCompanyData.passwords = {
                                ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                dirigente: currentCompanyData.data.config.dirigentePassword,
                                mister: currentCompanyData.data.config.misterPassword
                            };
                        }
                        
                        window.currentCompanyData = currentCompanyData;
                        
                        if (rememberCompanyCheckbox.checked) {
                            localStorage.setItem('companyCode', companyCode);
                            localStorage.setItem('companyData', JSON.stringify(companyData));
                            localStorage.setItem('rememberCompanyPreference', 'true');
                            // Show confirmation message
                            setTimeout(() => {
                                showMessage(companyEntryMessageArea, "Codice societ√† salvato!", false);
                            }, 500);
                        } else {
                            localStorage.removeItem('companyCode');
                            localStorage.removeItem('companyData');
                            localStorage.setItem('rememberCompanyPreference', 'false');
                        }
                        
                        // Hide any error messages
                        companyEntryMessageArea.style.display = 'none';
                        companyEntryMessageArea.classList.add('hidden');
                        
                        showCompanyWelcome();
                    } else {
                        showMessage(companyEntryMessageArea, "Codice societ√† non valido.");
                    }
                } catch (error) {
                    console.error("Errore nella verifica:", error);
                    showMessage(companyEntryMessageArea, "Errore nella verifica. Riprova.");
                }
            });

            enterMisterButton.addEventListener('click', () => {
                showPasswordEntry('mister');
            });

            enterDirigenteButton.addEventListener('click', () => {
                showPasswordEntry('dirigente');
            });

            // Common password validation function for demo mode
            async function handlePasswordSubmissionDemo() {
                const password = passwordInput.value.trim();
                if (!password) {
                    showMessage(passwordEntryMessageArea, "Inserisci la password.");
                    return;
                }

                // Case-sensitive password validation
                let isValid = currentCompanyData.passwords[pendingRole] === password;
                
                // For backward compatibility: if role is 'dirigente' and not found, try 'marco'
                if (!isValid && pendingRole === 'dirigente' && currentCompanyData.passwords['marco'] === password) {
                    isValid = true;
                }
                
                if (isValid) {
                    showMessage(passwordEntryMessageArea, "Accesso effettuato! (Demo mode)", false);
                    
                    // Register biometric authentication if not already enrolled (demo mode)
                    if (isBiometricSupported() && !hasBiometricEnrolled(currentCompanyCode, pendingRole)) {
                        console.log('üì± [DEMO] Attempting to register biometric authentication...');
                        const registered = await registerBiometric(currentCompanyCode, pendingRole, password);
                        if (registered) {
                            showMessage(passwordEntryMessageArea, "‚úÖ Autenticazione biometrica attivata! (Demo mode)", false);
                        }
                    }
                    
                    setTimeout(() => {
                        alert(`Benvenuto ${pendingRole === 'mister' ? 'Mister' : 'Dirigente'}!\n\nIn modalit√† demo, le funzionalit√† complete sarebbero disponibili con Firebase attivo.\n\nCodici di prova:\n- Codice societ√†: DEMO\n- Password Mister: mister123\n- Password Dirigente: marco123`);
                    }, 1000);
                } else {
                    showMessage(passwordEntryMessageArea, "Password errata.");
                }
            }

            confirmPasswordButton.addEventListener('click', handlePasswordSubmissionDemo);

            // Handle form submission (Enter key)
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent default form submission
                handlePasswordSubmissionDemo();
            });

            cancelPasswordButton.addEventListener('click', () => {
                pendingRole = null;
                passwordInput.value = '';
                showCompanyWelcome();
            });

            // Check for saved data
            const savedCompanyCode = localStorage.getItem('companyCode');
            const savedCompanyData = localStorage.getItem('companyData');
            const rememberPreference = localStorage.getItem('rememberCompanyPreference');
            
            if (savedCompanyCode && savedCompanyData && rememberPreference === 'true') {
                currentCompanyCode = savedCompanyCode;
                window.currentCompanyCode = currentCompanyCode;
                currentCompanyData = JSON.parse(savedCompanyData);
                
                // Populate passwords from data.config if available
                if (currentCompanyData.data && currentCompanyData.data.config) {
                    currentCompanyData.passwords = {
                        ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                        dirigente: currentCompanyData.data.config.dirigentePassword,
                        mister: currentCompanyData.data.config.misterPassword
                    };
                }
                
                window.currentCompanyData = currentCompanyData;
                companyCodeInput.value = savedCompanyCode;
                rememberCompanyCheckbox.checked = true;
                showCompanyWelcome();
            }
        }
    } // End of initializeDemoMode function
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const players = [
                "99 ALPA FEDERICO", "78 BECCARIS SEBASTIANO", "32 BEN MABROUK KEVIN", "23 BERLUSCONI NOAH",
                "1 BERNUCCI ROMEO", "18 BOERO GUGLIELMO", "22 BRIANO COSTANTINO", "28 CABASSI ROBERTO",
                "7 CALLIKU ANDREA", "4 CAZZULO MICHELE", "46 CONGIU ALESSIO", "20 DHAOUI OMAR",
                "5 DI DATO SIMONE", "77 DONALD BRYAN", "6 ESPOSITO EMANUELE", "25 GARDELLA ANDREA",
                "13 GENNARO EDOARDO", "91 GIOIA LEONARDO", "17 KHAY ADAM", "2 LAMKHAYAR AMIN",
                "29 LANNA MARK", "19 MARCHESE MATTEO", "47 MELLO CHRISTIAN", "61 MELLUSO MATTIA",
                "14 MONTEFIORI EDOARDO", "3 ODAGLIA ANDREA", "11 PELLICCI FRANCESCO", "90 PIGA GIOVANNI",
                "45 PINASCO ALESSANDRO", "10 POLLIO CESARE", "9 SCALA FEDERICO", "16 STANCHI FEDERICO",
                "21 TONINI LORENZO"
            ];

            // UI Elements
            const companyEntryScreen = document.getElementById('company-entry-screen');
            const companyCodeInput = document.getElementById('company-code-input');
            const verifyCompanyButton = document.getElementById('verify-company-button');
            const companyEntryMessageArea = document.getElementById('company-entry-message-area');
            const rememberCompanyCheckbox = document.getElementById('remember-company');
            
            const companyWelcomeScreen = document.getElementById('company-welcome-screen');
            const companyNameDisplay = document.getElementById('company-name-display');
            const enterMisterButton = document.getElementById('enter-mister-button');
            const enterDirigenteButton = document.getElementById('enter-dirigente-button');
            const viewHistoryButton = document.getElementById('view-history-button');
            const welcomeAttendanceButton = document.getElementById('welcome-attendance-button');
            // V9.10: Training attendance button - COMMENTED OUT - Feature removed
            // const trainingAttendanceButton = document.getElementById('training-attendance-button');
            const allenamentiButton = document.getElementById('allenamenti-button');
            const campionatoButton = document.getElementById('campionato-button');
            const managePlayersButton = document.getElementById('manage-players-button');
            const areaPolis2013Button = document.getElementById('area-polis2013-button');
            const companyLogoutButton = document.getElementById('company-logout-button');
            
            const passwordEntryScreen = document.getElementById('password-entry-screen');
            const rolePrompt = document.getElementById('role-prompt');
            const passwordInput = document.getElementById('password-input');
            const passwordForm = document.getElementById('password-form');
            const confirmPasswordButton = document.getElementById('confirm-password-button');
            const cancelPasswordButton = document.getElementById('cancel-password-button');
            const passwordEntryMessageArea = document.getElementById('password-entry-message-area');
            const biometricLoginContainer = document.getElementById('biometric-login-container');
            const biometricLoginButton = document.getElementById('biometric-login-button');
            
            const playerManagementScreen = document.getElementById('player-management-screen');
            const playerNumeroInput = document.getElementById('player-numero');
            const playerNomeInput = document.getElementById('player-nome');
            const playerDataNascitaInput = document.getElementById('player-data-nascita');
            const playerMatricolaInput = document.getElementById('player-matricola');
            const addPlayerButton = document.getElementById('add-player-button');
            const companyPlayersList = document.getElementById('company-players-list');
            const savePlayersButton = document.getElementById('save-players-button');
            const savePlayersMessageArea = document.getElementById('save-players-message-area');
            const backFromPlayersButton = document.getElementById('back-from-players-button');
            const topBackFromPlayersButton = document.getElementById('top-back-from-players-button');
            
            // Coach management elements
            const newCoachInput = document.getElementById('new-coach-input');
            const newCoachMatricolaInput = document.getElementById('new-coach-matricola-input');
            const addCoachButton = document.getElementById('add-coach-button');
            const companyCoachesList = document.getElementById('company-coaches-list');
            const saveCoachesButton = document.getElementById('save-coaches-button');
            const saveCoachesMessageArea = document.getElementById('save-coaches-message-area');
            
            // Director management elements
            const newDirectorNameInput = document.getElementById('new-director-name-input');
            const newDirectorSurnameInput = document.getElementById('new-director-surname-input');
            const newDirectorMatricolaInput = document.getElementById('new-director-matricola-input');
            const addDirectorButton = document.getElementById('add-director-button');
            const companyDirectorsList = document.getElementById('company-directors-list');
            const saveDirectorsButton = document.getElementById('save-directors-button');
            const saveDirectorsMessageArea = document.getElementById('save-directors-message-area');
            
            const nameEntryScreen = document.getElementById('name-entry-screen');
            const nameInput = document.getElementById('name-input');
            const enterButton = document.getElementById('enter-button');
            const nameEntryMessageArea = document.getElementById('name-entry-message-area');
            const rememberMeCheckbox = document.getElementById('remember-me');

            const startScreen = document.getElementById('start-screen');
            const mainView = document.getElementById('main-view');
            const historyView = document.getElementById('history-view');
            const attendanceView = document.getElementById('attendance-view');
            // V9.10: Training attendance view - COMMENTED OUT - Feature removed
            // const trainingAttendanceView = document.getElementById('training-attendance-view');
            const allenamentiView = document.getElementById('allenamenti-view');
            const campionatoView = document.getElementById('campionato-view');
            const moduloView = document.getElementById('modulo-view'); // V8.13
            const playersList = document.getElementById('players-list');
            const playersListMessage = document.getElementById('players-list-message');
            const selectedPlayersLiveList = document.getElementById('selected-players-live-list');
            const selectedPlayersTitle = document.getElementById('selected-players-title');

            const saveButton = document.getElementById('save-button');
            const shareButton = document.getElementById('share-button');
            const moduloButton = document.getElementById('modulo-button'); // V8.13
            const historyButton = document.getElementById('history-button');
            const attendanceButton = document.getElementById('attendance-button');
            const esciButton = document.getElementById('esci-button');
            const backFromHistoryButton = document.getElementById('back-from-history-button');
            const topBackFromHistoryButton = document.getElementById('top-back-from-history-button');
            const backFromAttendanceButton = document.getElementById('back-from-attendance-button');
            const topBackFromAttendanceButton = document.getElementById('top-back-from-attendance-button');
            const historyList = document.getElementById('history-list');
            const attendanceList = document.getElementById('attendance-list');
            const attendanceListAmichevoli = document.getElementById('attendance-list-amichevoli');
            const attendanceListTornei = document.getElementById('attendance-list-tornei');
            const attendanceListCampionato = document.getElementById('attendance-list-campionato');
            const shareView = document.getElementById('share-view');
            const messageArea = document.getElementById('message-area');
            const startMessageArea = document.getElementById('start-message-area');
            const appIdDisplay = document.getElementById('app-id-display');
            const currentAppIdDisplay = document.getElementById('current-app-id-display');
            const createTeamButton = document.getElementById('create-team-button');
            const joinTeamButton = document.getElementById('join-team-button');
            const joinAppIdInput = document.getElementById('join-app-id-input');
            const rememberTeamIdCheckbox = document.getElementById('remember-team-id');
            const changeTeamButton = document.getElementById('change-team-button');
            const resetSelectionsButton = document.getElementById('reset-selections-button');
            const forgetDataButton = document.getElementById('forget-data-button');
            const roleMessage = document.getElementById('role-message');
            const unavailablePlayersView = document.getElementById('unavailable-players-view');
            const unavailablePlayersList = document.getElementById('unavailable-players-list');
            const unavailablePlayersTitle = document.getElementById('unavailable-players-title');
            const matchDetailsSection = document.getElementById('match-details-section');
            
            // Notes Elements
            const notesSection = document.getElementById('notes-section');
            const notesEditable = document.getElementById('notes-editable');
            const notesReadonly = document.getElementById('notes-readonly');
            const notesTextarea = document.getElementById('notes-textarea');
            const notesDisplay = document.getElementById('notes-display');
            const saveNotesButton = document.getElementById('save-notes-button');
            
            // Reset timestamp display elements
            const resetTimestampDisplay = document.getElementById('reset-timestamp-display');
            const resetTimestampText = document.getElementById('reset-timestamp-text');
            
            // Modal Elements
            const statusModal = document.getElementById('status-modal');
            const closeModalButton = document.getElementById('close-status-modal');
            const statusCheckboxes = statusModal.querySelectorAll('.status-checkbox');
            const confirmStatusButton = document.getElementById('confirm-status-button');
            const clearStatusButton = document.getElementById('clear-status-button');
            
            // Unavailable Player Modal Elements
            const unavailablePlayerModal = document.getElementById('unavailable-player-modal');
            const closeUnavailableModalButton = document.getElementById('close-unavailable-modal');
            const unavailablePlayerName = document.getElementById('unavailable-player-name');
            const unavailablePlayerReason = document.getElementById('unavailable-player-reason');
            const convocaComunqueButton = document.getElementById('convoca-comunque-button'); // nuovo bottone
            const togliConvocazioneButton = document.getElementById('togli-convocazione-button'); // V6.6: pulsante per rimuovere convocazione forzata

            // Already Called Today Modal Elements
            const alreadyCalledModal = document.getElementById('already-called-modal');
            const alreadyCalledPlayerName = document.getElementById('already-called-player-name');
            const confirmAlreadyCalledButton = document.getElementById('confirm-already-called-button');
            const cancelAlreadyCalledButton = document.getElementById('cancel-already-called-button');

            // Share Modal Elements
            const shareModal = document.getElementById('share-modal');
            const closeShareModalButton = document.getElementById('close-share-modal');
            const webShareButton = document.getElementById('web-share-button');
            const whatsappShareButton = document.getElementById('whatsapp-share-button');
            const telegramShareButton = document.getElementById('telegram-share-button');
            const emailShareButton = document.getElementById('email-share-button');
            const copyLinkButton = document.getElementById('copy-link-button');
            const downloadImageButton = document.getElementById('download-image-button');

            // Distinta Modal Elements
            const distintaLocationModal = document.getElementById('distinta-location-modal');
            const distintaHomeButton = document.getElementById('distinta-home-button');
            const distintaAwayButton = document.getElementById('distinta-away-button');
            const closeDistintaLocationModalButton = document.getElementById('close-distinta-location-modal');
            
            const distintaDirigentiModal = document.getElementById('distinta-dirigenti-modal');
            const dirigentiSelectionList = document.getElementById('dirigenti-selection-list');
            const confirmDirigentiSelectionButton = document.getElementById('confirm-dirigenti-selection');
            const closeDistintaDirigentiModalButton = document.getElementById('close-distinta-dirigenti-modal');
            
            const distintaMatchInfoModal = document.getElementById('distinta-match-info-modal');
            const distintaGironeSelect = document.getElementById('distinta-girone-select');
            const distintaGiornataInput = document.getElementById('distinta-giornata-input');
            const confirmMatchInfoButton = document.getElementById('confirm-match-info');
            const closeDistintaMatchInfoModalButton = document.getElementById('close-distinta-match-info-modal');
            
            const distintaDisplayModal = document.getElementById('distinta-display-modal');
            const distintaContent = document.getElementById('distinta-content');
            const closeDistintaDisplayModalButton = document.getElementById('close-distinta-display-modal');
            const copyDistintaButton = document.getElementById('copy-distinta-button');
            const printDistintaButton = document.getElementById('print-distinta-button');
            const shareDistintaButton = document.getElementById('share-distinta-button');

            // V8.0: Stats Chart Modal Elements
            const statsChartModal = document.getElementById('stats-chart-modal');
            const statsChartButton = document.getElementById('stats-chart-button');
            const closeStatsChartModalButton = document.getElementById('close-stats-chart-modal');

            // V8.1: Tornei Stats Chart Modal Elements
            const torneiStatsChartModal = document.getElementById('tornei-stats-chart-modal');
            const torneiStatsChartButton = document.getElementById('tornei-stats-chart-button');
            const closeTorneiStatsChartModalButton = document.getElementById('close-tornei-stats-chart-modal');

            // V9.19: Legend Modal Elements
            const legendModal = document.getElementById('legend-modal');
            const legendButton = document.getElementById('legend-button');
            const closeLegendModalButton = document.getElementById('close-legend-modal');

            // --- App State ---
            let userRole = null;
            let isGuestUser = false; // New: track if user is logged in as guest
            let currentAppId = window.appId;
            let currentCompanyCode = null;
            window.currentCompanyCode = currentCompanyCode;
            let currentCompanyData = null;
            let companyPlayers = [];
            let companyCoaches = [];
            let companyDirectors = [];
            let pendingRole = null; // for password verification
            let unavailablePlayers = new Map();
            let currentNotes = '';
            let tempPlayerName = null;
            let tempUnavailablePlayerName = null; // per "convoca comunque"
            let tempAlreadyCalledPlayerName = null; // per giocatori gi√† convocati oggi
            let unsubscribeListeners = [];
            let selectedDistintaLocation = null; // home/away selection for distinta
            let selectedDirigenti = []; // selected dirigenti for distinta
            let selectedGirone = ''; // selected girone for distinta
            let selectedGiornata = ''; // selected giornata for distinta
            let historyPreviousView = null; // track where history was accessed from
            let attendancePreviousView = null; // track where attendance was accessed from
            let convocationHistory = []; // store convocation history data for attendance filtering
            let allConvocationHistory = []; // store all unfiltered history items for period filtering
            
            // Navigation stack for back button handling
            let navigationStack = [];
            let isNavigatingBack = false;
            
            // Push navigation state to history
            function pushNavigationState(viewName) {
                if (!isNavigatingBack) {
                    navigationStack.push(viewName);
                    history.pushState({ view: viewName }, '', '');
                    console.log(`üì± [BACK BUTTON] Pushed state: ${viewName}, Stack:`, navigationStack);
                } else {
                    console.log(`üì± [BACK BUTTON] SKIPPED push (navigating back): ${viewName}, Stack:`, navigationStack);
                }
            }

            // Get current visible view
            function getCurrentView() {
                const views = [
                    { id: 'company-entry-screen', name: 'company-entry' },
                    { id: 'company-welcome-screen', name: 'company-welcome' },
                    { id: 'password-entry-screen', name: 'password-entry' },
                    { id: 'player-management-screen', name: 'player-management' },
                    { id: 'main-view', name: 'main' },
                    { id: 'history-view', name: 'history' },
                    { id: 'attendance-view', name: 'attendance' },
                    { id: 'allenamenti-view', name: 'allenamenti' },
                    { id: 'campionato-view', name: 'campionato' },
                    { id: 'modulo-view', name: 'modulo' }
                ];
                
                for (const view of views) {
                    const element = document.getElementById(view.id);
                    if (element && !element.classList.contains('hidden')) {
                        return view.name;
                    }
                }
                return null;
            }

            // Handle back button press
            function handleBackButton() {
                const currentView = getCurrentView();
                console.log(`üì± [BACK BUTTON] Back pressed, current view: ${currentView}`);
                
                // Pop current state from stack if it exists
                if (navigationStack.length > 0 && navigationStack[navigationStack.length - 1] === currentView) {
                    navigationStack.pop();
                }
                
                // Determine where to go back
                switch(currentView) {
                    case 'history':
                        // Simulate clicking back button
                        if (historyPreviousView === 'welcome') {
                            if (currentCompanyCode) {
                                showCompanyWelcome();
                            } else {
                                mainView.classList.remove('hidden');
                            }
                        } else {
                            mainView.classList.remove('hidden');
                        }
                        historyView.classList.add('hidden');
                        historyPreviousView = null;
                        break;
                        
                    case 'attendance':
                        // Simulate clicking back button
                        if (attendancePreviousView === 'welcome') {
                            if (currentCompanyCode) {
                                showCompanyWelcome();
                            } else {
                                mainView.classList.remove('hidden');
                            }
                        } else {
                            mainView.classList.remove('hidden');
                        }
                        attendanceView.classList.add('hidden');
                        attendancePreviousView = null;
                        break;
                        
                    case 'allenamenti':
                        // Go back to welcome screen
                        hideAllScreens();
                        showCompanyWelcome();
                        break;
                        
                    case 'campionato':
                        // Go back to welcome screen
                        hideAllScreens();
                        showCompanyWelcome();
                        break;
                        
                    case 'modulo':
                        // Go back to main view
                        moduloView.classList.add('hidden');
                        mainView.classList.remove('hidden');
                        break;
                        
                    case 'main':
                        // Go back to welcome screen
                        mainView.classList.add('hidden');
                        showCompanyWelcome();
                        break;
                        
                    case 'player-management':
                        // Go back to welcome screen
                        playerManagementScreen.classList.add('hidden');
                        showCompanyWelcome();
                        break;
                        
                    case 'password-entry':
                        // Go back to welcome screen
                        passwordEntryScreen.classList.add('hidden');
                        showCompanyWelcome();
                        break;
                        
                    case 'company-welcome':
                        // Go back to company entry
                        companyWelcomeScreen.classList.add('hidden');
                        companyEntryScreen.classList.remove('hidden');
                        break;
                        
                    case 'company-entry':
                    default:
                        // At the entry point - let the app close naturally
                        console.log(`üì± [BACK BUTTON] At entry point, allowing default behavior`);
                        // Don't prevent default - allow the app/page to close
                        return false;
                }
                
                return true; // We handled the back
            }
            
            // Distinta-related global variables
            window.currentDistintaData = null;
            
            // Weekly reset functionality - reset unavailable players every Sunday at midnight
            function checkAndResetWeeklyUnavailability() {
                const RESET_KEY = 'lastUnavailabilityReset';
                const now = new Date();
                const lastResetStr = localStorage.getItem(RESET_KEY);
                
                // Get the last Sunday at 00:00 (start of week) - domenica sera = Sunday at midnight
                const getLastSunday = (date) => {
                    const d = new Date(date);
                    const day = d.getDay();
                    // Calculate days to subtract to get to last Sunday
                    // If day is 0 (Sunday), we're already at the start of the week
                    const diff = day === 0 ? 0 : day;
                    d.setDate(d.getDate() - diff);
                    d.setHours(0, 0, 0, 0);
                    return d;
                };
                
                const currentWeekStart = getLastSunday(now);
                
                // Check if we need to reset
                let needsReset = false;
                if (!lastResetStr) {
                    // First time running, store current week
                    needsReset = false; // Don't reset on first load
                    localStorage.setItem(RESET_KEY, currentWeekStart.toISOString());
                } else {
                    const lastReset = new Date(lastResetStr);
                    const lastResetWeekStart = getLastSunday(lastReset);
                    
                    // If current week is different from last reset week, we need to reset
                    if (currentWeekStart.getTime() !== lastResetWeekStart.getTime()) {
                        needsReset = true;
                        localStorage.setItem(RESET_KEY, currentWeekStart.toISOString());
                    }
                }
                
                return needsReset;
            }
            
            // Reset unavailable players in Firebase
            async function resetUnavailablePlayersInFirebase() {
                if (!window.db || !currentCompanyDocumentId) {
                    console.log('‚ö†Ô∏è Cannot reset: Firebase not available or company not set');
                    return;
                }
                
                try {
                    const availabilityBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;
                    const unavailableDocRef = window.doc(window.db, `${availabilityBasePath}/availability`, "marco_unavailable");
                    
                    // Clear the unavailable players data
                    await window.setDoc(unavailableDocRef, { players: {} }, { merge: true });
                    console.log('‚úÖ Weekly reset: Unavailable players cleared from Firebase');
                    
                    // Clear local Map
                    unavailablePlayers = new Map();
                    renderPlayers(); // Re-render players
                    updateUnavailablePlayersView(); // Update view
                    updateResetTimestampDisplay(); // Update reset timestamp display
                } catch (error) {
                    console.error('‚ùå Error resetting unavailable players:', error);
                }
            }
            
            // V9.12: Calculate current week training attendance for each player
            function calculateCurrentWeekTrainingAttendance() {
                const playerAttendance = new Map();
                
                if (!trainingSessions || trainingSessions.length === 0) {
                    return playerAttendance; // No sessions, return empty map
                }
                
                // Get start of current week (Monday 00:00)
                const now = new Date();
                const getMonday = (date) => {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                    d.setDate(diff);
                    d.setHours(0, 0, 0, 0);
                    return d;
                };
                
                const currentWeekStart = getMonday(now);
                const currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekStart.getDate() + 7); // Next Monday
                
                // Filter sessions for current week
                const weekSessions = trainingSessions.filter(session => {
                    const sessionDate = new Date(session.date);
                    return sessionDate >= currentWeekStart && sessionDate < currentWeekEnd;
                });
                
                // Calculate attendance for each player
                const allPlayers = companyPlayers.length > 0 ? companyPlayers : players;
                allPlayers.forEach(player => {
                    let playerKey;
                    if (typeof player === 'string') {
                        playerKey = player;
                    } else {
                        playerKey = `${player.numero} ${player.nome}`;
                    }
                    
                    let attended = 0;
                    let totalSessions = weekSessions.length;
                    
                    weekSessions.forEach(session => {
                        if (session.attendance && session.attendance[playerKey] === true) {
                            attended++;
                        }
                    });
                    
                    playerAttendance.set(playerKey, {
                        attended: attended,
                        total: totalSessions
                    });
                });
                
                return playerAttendance;
            }
            
            // V9.13: Check if there are training sessions in the current week
            function hasCurrentWeekTrainingSessions() {
                if (!trainingSessions || trainingSessions.length === 0) {
                    return false;
                }
                
                // Get start of current week (Monday 00:00)
                const now = new Date();
                const getMonday = (date) => {
                    const d = new Date(date);
                    const day = d.getDay();
                    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                    d.setDate(diff);
                    d.setHours(0, 0, 0, 0);
                    return d;
                };
                
                const currentWeekStart = getMonday(now);
                const currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekStart.getDate() + 7); // Next Monday
                
                // Check if there's at least one session in current week
                const weekSessions = trainingSessions.filter(session => {
                    const sessionDate = new Date(session.date);
                    return sessionDate >= currentWeekStart && sessionDate < currentWeekEnd;
                });
                
                return weekSessions.length > 0;
            }
            
            // V9.12: Get automatic training status for a player based on current week attendance
            function getAutomaticTrainingStatus(playerKey) {
                const weekAttendance = calculateCurrentWeekTrainingAttendance();
                const attendance = weekAttendance.get(playerKey);
                
                if (!attendance || attendance.total === 0) {
                    return null; // No sessions this week, no automatic status
                }
                
                const attended = attendance.attended;
                
                if (attended === 0) {
                    return 'Zero allenamenti';
                } else if (attended === 1) {
                    return 'Solo 1 allenamento';
                } else if (attended === 2) {
                    return 'Solo 2 allenamenti';
                }
                
                return null; // 3+ trainings, no automatic status
            }
            
            // V8.17: Demo mode and demo players for tactical module (with jersey numbers)
            let demoMode = !window.db; // Use demo mode if Firebase is not available
            const DEMO_PLAYERS = ['10 Mario Rossi', '7 Luca Bianchi', '5 Paolo Verdi', '3 Andrea Neri', 
                                  '9 Giuseppe Gialli', '11 Marco Blu', '8 Stefano Viola', '4 Antonio Arancioni',
                                  '6 Francesco Rosa', '2 Giovanni Grigi', '1 Alessandro Marroni'];

            // Helper function to check if user is a guest
            function isGuest() {
                return isGuestUser;
            }

            // Helper function to check if user has dirigente/marco privileges
            function isDirigente() {
                return !isGuestUser && (userRole === 'marco' || userRole === 'dirigente');
            }

            // Helper function to check if user can access distinta functionality (both mister and dirigente, not guests)
            function canAccessDistinta() {
                return !isGuestUser && (userRole === 'marco' || userRole === 'dirigente' || userRole === 'mister');
            }

            // Helper function to check if user can share content (not guests)
            function canShare() {
                return !isGuestUser && userRole === 'mister';
            }

            // Helper function to check if user can share historical convocations (mister and dirigente)
            function canShareHistory() {
                return !isGuestUser && (userRole === 'mister' || userRole === 'dirigente');
            }

            // Helper function to check if a player was already called up today
            function isPlayerCalledToday(playerName) {
                if (!convocationHistory || convocationHistory.length === 0) {
                    return false;
                }
                
                const today = new Date();
                const todayDateString = today.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Check each convocation in history
                for (const convocation of convocationHistory) {
                    if (!convocation.createdAt || !convocation.players) {
                        continue;
                    }
                    
                    // Compare convocation creation date with today's date (not match date)
                    const convocationDate = new Date(convocation.createdAt);
                    const convocationDateString = convocationDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                    if (convocationDateString === todayDateString) {
                        // Check if player is in the players list
                        const isInList = convocation.players.some(player => {
                            if (typeof player === 'string') {
                                return player === playerName;
                            } else {
                                return `${player.numero} ${player.nome}` === playerName;
                            }
                        });
                        
                        if (isInList) {
                            return true;
                        }
                    }
                }
                
                return false;
            }

            // V7.9: Helper function to normalize player names for matching
            // Strips leading numbers/characters, then normalizes (lowercase, trim, remove accents/special chars)
            // Used in all attendance summary tables (Amichevoli, Tornei, Campionato) and Firebase % Disp. matching
            function normalizePlayerName(name) {
                if (!name) return '';
                return name
                    .replace(/^[^a-zA-Z]+/, '') // V7.2: Strip leading numbers and non-letter characters
                    .toLowerCase()
                    .trim()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
                    .replace(/[^a-z0-9\s]/gi, '') // Remove special characters except spaces and alphanumeric
                    .replace(/\s+/g, ' '); // Collapse multiple spaces to single space
            }

            // Initial Firebase setup
             async function initApp() {
                if (window.auth) {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await window.signInWithCustomToken(window.auth, token);
                        } else {
                            await window.signInAnonymously(window.auth);
                        }
                        
                        console.log("Firebase initialized and user authenticated.");
                        
                        // Check for companyDocId from edit_convocation.html (priority: URL param ‚Üí sessionStorage ‚Üí localStorage)
                        const urlParams = new URLSearchParams(window.location.search);
                        let companyDocIdFromReturn = urlParams.get('companyDocId') || 
                                                      sessionStorage.getItem('companyDocId') || 
                                                      localStorage.getItem('companyDocId');
                        
                        // üîç IMPORTANT: If companyDocId is present AND we have hash=#history or returnToHistory flag,
                        // hide ALL login/welcome screens and show ONLY history view immediately
                        const hash = window.location.hash;
                        const returnToHistory = sessionStorage.getItem('returnToHistory');
                        
                        if (companyDocIdFromReturn && (hash === '#history' || returnToHistory === 'true')) {
                            console.log('üè¢ companyDocId found with hash=#history or returnToHistory flag');
                            console.log('   üìç companyDocId:', companyDocIdFromReturn);
                            console.log('   üìç hash:', hash);
                            console.log('   üìç returnToHistory:', returnToHistory);
                            console.log('   ‚úÖ Hiding ALL login/welcome screens and showing ONLY history view immediately');
                            
                            // Hide ALL screens explicitly (company-entry, welcome, password, player-management, name-entry, start)
                            companyEntryScreen.classList.add('hidden');
                            companyWelcomeScreen.classList.add('hidden');
                            passwordEntryScreen.classList.add('hidden');
                            playerManagementScreen.classList.add('hidden');
                            nameEntryScreen.classList.add('hidden');
                            startScreen.classList.add('hidden');
                            
                            // Hide ALL views except history (main, attendance, training-attendance, campionato)
                            mainView.classList.add('hidden');
                            attendanceView.classList.add('hidden');
                            trainingAttendanceView.classList.add('hidden');
                            campionatoView.classList.add('hidden');
                            
                            // Show ONLY history view explicitly
                            historyView.classList.remove('hidden');
                            
                            console.log('   üîÑ checkHashNavigation() will restore state and load history data...');
                            return; // Exit early - checkHashNavigation() will restore state and load data
                        }
                        
                        // Check for saved company data
                        const savedCompanyCode = localStorage.getItem('companyCode');
                        const savedCompanyData = localStorage.getItem('companyData');
                        const savedRole = localStorage.getItem('userRole');
                        const savedAppId = localStorage.getItem('convocazioniAppId');
                        
                        if (savedCompanyCode && savedCompanyData && savedRole && savedAppId) {
                            // Restore full session
                            currentCompanyCode = savedCompanyCode;
                            window.currentCompanyCode = currentCompanyCode;
                            currentCompanyData = JSON.parse(savedCompanyData);
                            
                            // Populate passwords from data.config if available
                            if (currentCompanyData.data && currentCompanyData.data.config) {
                                currentCompanyData.passwords = {
                                    ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                    dirigente: currentCompanyData.data.config.dirigentePassword,
                                    mister: currentCompanyData.data.config.misterPassword
                                };
                            }
                            
                            window.currentCompanyData = currentCompanyData;
                            userRole = savedRole;
                            companyPlayers = await loadCompanyPlayers();
                            companyCoaches = await loadCompanyCoaches();
                            companyDirectors = await loadCompanyDirectors();
                            startApp(savedAppId);
                        } else if (savedCompanyCode && savedCompanyData) {
                            // Show welcome screen with company data
                            currentCompanyCode = savedCompanyCode;
                            window.currentCompanyCode = currentCompanyCode;
                            currentCompanyData = JSON.parse(savedCompanyData);
                            
                            // Populate passwords from data.config if available
                            if (currentCompanyData.data && currentCompanyData.data.config) {
                                currentCompanyData.passwords = {
                                    ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                    dirigente: currentCompanyData.data.config.dirigentePassword,
                                    mister: currentCompanyData.data.config.misterPassword
                                };
                            }
                            
                            window.currentCompanyData = currentCompanyData;
                            companyPlayers = await loadCompanyPlayers();
                            companyCoaches = await loadCompanyCoaches();
                            companyDirectors = await loadCompanyDirectors();
                            showCompanyWelcome();
                        } else {
                            // Show company entry screen
                            const savedCompanyCode = localStorage.getItem('companyCode');
                            const rememberPreference = localStorage.getItem('rememberCompanyPreference');
                            if (savedCompanyCode && rememberPreference === 'true') {
                                companyCodeInput.value = savedCompanyCode;
                                rememberCompanyCheckbox.checked = true;
                            }
                            companyEntryScreen.classList.remove('hidden');
                            // Trigger login animations sequence
                            setTimeout(() => startLoginAnimations(), 100);
                        }
                    } catch (err) {
                        console.error("Firebase authentication failed:", err);
                        companyEntryScreen.classList.remove('hidden');
                        // Trigger login animations sequence
                        setTimeout(() => startLoginAnimations(), 100);
                    }
                } else {
                    console.error("Firebase configuration not available. Some features will not work.");
                    companyEntryScreen.classList.remove('hidden');
                    // Trigger login animations sequence
                    setTimeout(() => startLoginAnimations(), 100);
                }
            }

            // Global function for login animations - moved here to be available before initApp() call
            function startLoginAnimations() {
                const logo = document.getElementById('animated-logo');
                const title = document.getElementById('animated-title');
                const subtitle = document.getElementById('animated-subtitle');
                const form = document.getElementById('animated-form');
                
                // Only proceed if elements exist
                if (!logo || !title || !subtitle || !form) return;
                
                // Reset all elements to initial state
                logo.classList.remove('animate-drop-bounce');
                title.classList.remove('animate-slide-in-right');
                subtitle.classList.remove('animate-slide-in-right');
                form.classList.remove('animate-slide-in-left');
                
                // Step 1: Logo drops and bounces (starts immediately)
                logo.classList.add('animate-drop-bounce');
                
                // Step 2: Title slides in from right (after 0.8s)
                setTimeout(() => {
                    title.classList.add('animate-slide-in-right');
                }, 800);
                
                // Step 3: Subtitle slides in from right (after 1.2s)
                setTimeout(() => {
                    subtitle.classList.add('animate-slide-in-right');
                }, 1200);
                
                // Step 4: Form slides in from left (after 1.8s)
                setTimeout(() => {
                    form.classList.add('animate-slide-in-left');
                }, 1800);
            }

            initApp();
            
            
            // Company verification functions
            async function verifyCompanyCode(companyCode) {
                // Try to use cercaSocietaDaCodice function if available
                if (window.cercaSocietaDaCodice) {
                    try {
                        const societa = await window.cercaSocietaDaCodice(companyCode);
                        
                        // Check if company exists and is active
                        if (!societa) {
                            return null;
                        }
                        
                        if (societa.attiva === false) {
                            return null;
                        }
                        
                        // Convert to expected format for compatibility
                        const companyData = {
                            name: societa.nome || "Societ√† Sconosciuta",
                            passwords: societa.passwords || {},
                            data: societa, // Keep original data
                            isGuestLogin: societa.isGuestLogin || false // Include guest login flag
                        };
                        
                        // Populate passwords from data.config if available
                        if (societa.config) {
                            companyData.passwords = {
                                ...companyData.passwords, // Keep existing passwords for backward compatibility
                                dirigente: societa.config.dirigentePassword,
                                mister: societa.config.misterPassword
                            };
                        }
                        
                        return companyData;
                    } catch (error) {
                        console.error("Errore nella ricerca societ√†:", error);
                        // Fall back to old method
                    }
                }

                // Fallback: Demo mode when Firebase is not available or cercaSocietaDaCodice fails
                if (!window.db) {
                    console.log("Firebase not available, using demo mode");
                    if (companyCode === "DEMO" || companyCode === "demo") {
                        return {
                            name: "Societ√† Demo",
                            passwords: {
                                mister: "mister123",
                                marco: "marco123",
                                dirigente: "marco123"
                            },
                            isGuestLogin: false,
                            data: {
                                id: "demo-demo",
                                nome: "Societ√† Demo",
                                codici: "DEMO",
                                config: { 
                                    tema: "light", 
                                    notifiche: true, 
                                    demo: true,
                                    misterPassword: "mister123",
                                    dirigentePassword: "marco123"
                                },
                                giocatori: ["1 DEMO MARIO", "2 TEST LUIGI", "3 EXAMPLE GIUSEPPE", "4 SAMPLE ANTONIO"],
                                attiva: true,
                                dataCreazione: "2024-01-01"
                            }
                        };
                    } else if (companyCode === "GUEST" || companyCode === "guest") {
                        // Demo guest code for testing
                        return {
                            name: "Societ√† Demo",
                            passwords: {},
                            isGuestLogin: true,
                            data: {
                                id: "demo-demo",
                                nome: "Societ√† Demo",
                                codici: "DEMO",
                                ospitecode: "GUEST",
                                config: { 
                                    tema: "light", 
                                    notifiche: true, 
                                    demo: true,
                                    misterPassword: "mister123",
                                    dirigentePassword: "marco123"
                                },
                                giocatori: ["1 DEMO MARIO", "2 TEST LUIGI", "3 EXAMPLE GIUSEPPE", "4 SAMPLE ANTONIO"],
                                attiva: true,
                                dataCreazione: "2024-01-01"
                            }
                        };
                    } else {
                        return null;
                    }
                }
                
                try {
                    const companyDocRef = window.doc(window.db, "societa", companyCode);
                    const companyDoc = await window.getDoc(companyDocRef);
                    
                    if (companyDoc.exists()) {
                        const data = companyDoc.data();
                        // Check if company is active
                        if (data.attiva === false) {
                            return null;
                        }
                        return {
                            ...data,
                            isGuestLogin: false // Default to false for Firebase fallback
                        };
                    } else {
                        return null;
                    }
                } catch (error) {
                    console.error("Errore nella verifica del codice societ√†:", error);
                    throw error;
                }
            }
            
            async function verifyPassword(role, password) {
                if (!currentCompanyData) {
                    return false;
                }
                
                const passwords = currentCompanyData.passwords || {};
                
                // Case-sensitive password validation
                // First, try the requested role
                if (passwords[role] === password) {
                    return true;
                }
                
                // For backward compatibility: if role is 'dirigente' and not found, try 'marco'
                if (role === 'dirigente' && passwords['marco'] === password) {
                    return true;
                }
                
                return false;
            }
            
            // ========================================
            // BIOMETRIC AUTHENTICATION FUNCTIONS
            // ========================================
            
            /**
             * Check if the browser supports biometric authentication via WebAuthn API
             */
            function isBiometricSupported() {
                return window.PublicKeyCredential !== undefined && 
                       navigator.credentials !== undefined &&
                       typeof navigator.credentials.create === 'function' &&
                       typeof navigator.credentials.get === 'function';
            }
            
            /**
             * Get the storage key for biometric credentials
             */
            function getBiometricStorageKey(companyCode, role) {
                return `biometric_cred_${companyCode}_${role}`;
            }
            
            /**
             * Check if user has enrolled biometric authentication for this company/role
             */
            function hasBiometricEnrolled(companyCode, role) {
                const storageKey = getBiometricStorageKey(companyCode, role);
                const storedData = localStorage.getItem(storageKey);
                return storedData !== null;
            }
            
            /**
             * Generate a random challenge for WebAuthn
             */
            function generateChallenge() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return array;
            }
            
            /**
             * Convert base64url string to ArrayBuffer
             */
            function base64urlToBuffer(base64url) {
                const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes.buffer;
            }
            
            /**
             * Convert ArrayBuffer to base64url string
             */
            function bufferToBase64url(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                const base64 = btoa(binary);
                return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
            }
            
            /**
             * Register biometric authentication for the user after successful password login
             */
            async function registerBiometric(companyCode, role, password) {
                if (!isBiometricSupported()) {
                    console.log('üì± Biometric authentication not supported on this device');
                    return false;
                }
                
                try {
                    const challenge = generateChallenge();
                    const userId = new TextEncoder().encode(`${companyCode}_${role}`);
                    
                    const publicKeyCredentialCreationOptions = {
                        challenge: challenge,
                        rp: {
                            name: "Rosterkick",
                            id: window.location.hostname
                        },
                        user: {
                            id: userId,
                            name: `${companyCode}_${role}`,
                            displayName: `${role === 'mister' ? 'Mister' : 'Dirigente'} - ${companyCode}`
                        },
                        pubKeyCredParams: [
                            { alg: -7, type: "public-key" },  // ES256
                            { alg: -257, type: "public-key" } // RS256
                        ],
                        authenticatorSelection: {
                            authenticatorAttachment: "platform", // Use platform authenticator (Touch ID, Face ID, Windows Hello)
                            requireResidentKey: false,
                            userVerification: "preferred"
                        },
                        timeout: 60000,
                        attestation: "none"
                    };
                    
                    const credential = await navigator.credentials.create({
                        publicKey: publicKeyCredentialCreationOptions
                    });
                    
                    if (credential) {
                        // Store credential ID and encrypted password
                        const storageKey = getBiometricStorageKey(companyCode, role);
                        const credentialData = {
                            credentialId: bufferToBase64url(credential.rawId),
                            password: btoa(password), // Simple base64 encoding (not fully secure, but better than plaintext)
                            timestamp: Date.now()
                        };
                        
                        localStorage.setItem(storageKey, JSON.stringify(credentialData));
                        console.log('‚úÖ Biometric authentication registered successfully');
                        return true;
                    }
                } catch (error) {
                    console.error('‚ùå Error registering biometric:', error);
                    // User may have cancelled or device doesn't support it
                    return false;
                }
                
                return false;
            }
            
            /**
             * Authenticate using biometric and retrieve stored password
             */
            async function authenticateWithBiometric(companyCode, role) {
                if (!isBiometricSupported()) {
                    return null;
                }
                
                const storageKey = getBiometricStorageKey(companyCode, role);
                const storedDataStr = localStorage.getItem(storageKey);
                
                if (!storedDataStr) {
                    return null;
                }
                
                try {
                    const storedData = JSON.parse(storedDataStr);
                    const challenge = generateChallenge();
                    const credentialId = base64urlToBuffer(storedData.credentialId);
                    
                    const publicKeyCredentialRequestOptions = {
                        challenge: challenge,
                        allowCredentials: [{
                            id: credentialId,
                            type: 'public-key',
                            transports: ['internal']
                        }],
                        timeout: 60000,
                        userVerification: "preferred"
                    };
                    
                    const assertion = await navigator.credentials.get({
                        publicKey: publicKeyCredentialRequestOptions
                    });
                    
                    if (assertion) {
                        // Biometric authentication successful, return stored password
                        const password = atob(storedData.password);
                        console.log('‚úÖ Biometric authentication successful');
                        return password;
                    }
                } catch (error) {
                    console.error('‚ùå Biometric authentication failed:', error);
                    // User may have cancelled, or biometric didn't match
                    return null;
                }
                
                return null;
            }
            
            /**
             * Clear biometric credentials for a company/role
             */
            function clearBiometricCredentials(companyCode, role) {
                const storageKey = getBiometricStorageKey(companyCode, role);
                localStorage.removeItem(storageKey);
                console.log('üóëÔ∏è Biometric credentials cleared');
            }
            
            // ========================================
            // END BIOMETRIC AUTHENTICATION FUNCTIONS
            // ========================================
            
            // Functions to handle player loading error messages in UI
            function showPlayerLoadingError(message) {
                // Show error in the player management screen if it exists
                const playerManagementScreen = document.getElementById('player-management-screen');
                let errorDiv = document.getElementById('player-loading-error');
                
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = 'player-loading-error';
                    errorDiv.className = 'mt-4 p-3 bg-red-100 border border-red-200 rounded-lg text-red-800 text-sm font-medium';
                    
                    // Insert at the top of player management screen if it exists
                    if (playerManagementScreen) {
                        playerManagementScreen.insertBefore(errorDiv, playerManagementScreen.firstChild);
                    }
                }
                
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">‚ùå</span>
                        <span><strong>Errore caricamento giocatori:</strong> ${message}</span>
                    </div>
                `;
                errorDiv.classList.remove('hidden');
                
                console.error(`üö® UI Error: ${message}`);
            }
            
            function hidePlayerLoadingError() {
                const errorDiv = document.getElementById('player-loading-error');
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            }

            /**
             * Custom sorting function for players that sorts alphabetically by name,
             * handling both old string format ("1 ROSSI MARIO") and new object format
             * @param {(string|object)[]} players - Array of player strings or objects
             * @returns {(string|object)[]} - Sorted array of players
             */
            function sortPlayersByName(players) {
                return players.sort((a, b) => {
                    let nameA, nameB;
                    
                    // Handle old string format: "NUMBER SURNAME NAME"
                    if (typeof a === 'string') {
                        nameA = a.replace(/^\d+\s+/, '').trim();
                    } else {
                        // Handle new object format
                        nameA = a.nome;
                    }
                    
                    if (typeof b === 'string') {
                        nameB = b.replace(/^\d+\s+/, '').trim();
                    } else {
                        // Handle new object format
                        nameB = b.nome;
                    }
                    
                    // Compare the names alphabetically (case-insensitive)
                    return nameA.localeCompare(nameB, 'it', { sensitivity: 'base' });
                });
            }

            async function loadCompanyPlayers() {
                console.log("üîÑ loadCompanyPlayers() chiamata");
                
                if (!currentCompanyCode) {
                    console.log("‚ùå Nessun codice societ√† disponibile (currentCompanyCode √® null/undefined)");
                    showPlayerLoadingError("Codice societ√† non disponibile");
                    return [];
                }
                
                console.log(`üè¢ Caricamento giocatori per societ√†: ${currentCompanyCode}`);
                
                // Demo mode - load from localStorage or return defaults
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("üé≠ Modalit√† DEMO attivata");
                    // Try to load from localStorage first
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            console.log("üìÅ Caricamento giocatori da localStorage (modalit√† demo)");
                            return sortPlayersByName(JSON.parse(savedPlayers)); // Sort players by name only
                        } catch (error) {
                            console.error("‚ùå Errore nel parsing localStorage (modalit√† demo):", error);
                        }
                    }
                    // Return default demo players if nothing saved
                    console.log("üé≤ Utilizzo giocatori predefiniti per modalit√† demo");
                    return sortPlayersByName([
                        "1 ROSSI MARIO", "2 BIANCHI LUIGI", "3 VERDI GIUSEPPE", 
                        "4 NERI ANTONIO", "5 GIALLI FRANCESCO", "6 BLU MARCO",
                        "7 VIOLA STEFANO", "8 ROSA ANDREA", "9 GRIGIO PAOLO", "10 AZZURRI LUCA"
                    ]); // Sort demo players by name only
                }
                
                // Firebase mode - load from players subcollection
                if (!window.db) {
                    console.log("‚ùå Firebase non disponibile, tentativo fallback localStorage");
                    // Firebase not available, fallback to localStorage
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            console.log("üìÅ Fallback: caricamento da localStorage");
                            return sortPlayersByName(JSON.parse(savedPlayers)); // Sort players by name only
                        } catch (error) {
                            console.error("‚ùå Errore nel parsing localStorage fallback:", error);
                            showPlayerLoadingError("Errore nel caricamento dei dati salvati localmente");
                        }
                    } else {
                        console.log("‚ùå Nessun dato disponibile in localStorage");
                        showPlayerLoadingError("Firebase non disponibile e nessun dato locale trovato");
                    }
                    return [];
                }
                
                // Log the complete subcollection path using document ID
                const subcollectionPath = `societa/${currentCompanyDocumentId}/giocatori`;
                console.log(`üìÑ Lettura subcollection Firebase da percorso completo: ${subcollectionPath}`);
                console.log(`üîó Percorso completo della subcollection: societa/${currentCompanyDocumentId}/giocatori`);
                console.log(`üìã Caricando giocatori dalla subcollection con document ID societ√†: ${currentCompanyDocumentId}`);
                console.log(`üè∑Ô∏è Codice inserito dall'utente (campo 'codici'): ${currentCompanyCode}`);
                
                try {
                    // Load giocatori from the giocatori subcollection using document ID
                    const playersCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "giocatori");
                    const playersSnapshot = await window.getDocs(playersCollectionRef);
                    
                    if (!playersSnapshot.empty) {
                        const players = [];
                        playersSnapshot.forEach((doc) => {
                            const playerData = doc.data();
                            // Use the player name from the document data, or fallback to document ID
                            const playerName = playerData.name || playerData.nome || doc.id;
                            players.push(playerName);
                        });
                        
                        console.log(`‚úÖ Subcollection trovata: societa/${currentCompanyDocumentId}/giocatori`);
                        console.log(`üë• Giocatori trovati nella subcollection (${players.length}):`, players);
                        hidePlayerLoadingError();
                        return sortPlayersByName(players); // Sort players by name only
                    } else {
                        console.log(`üìù Subcollection 'giocatori' vuota per societ√† document ID ${currentCompanyDocumentId}, ritorno array vuoto`);
                        hidePlayerLoadingError();
                        return [];
                    }
                } catch (error) {
                    console.error(`üí• Errore nel caricamento giocatori dalla subcollection Firebase (percorso: societa/${currentCompanyDocumentId}/giocatori):`, error);
                    showPlayerLoadingError(`Errore di connessione a Firebase subcollection: ${error.message}`);
                    
                    // Fallback to localStorage if Firebase fails
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            console.log("üîÑ Fallback: caricamento da localStorage dopo errore Firebase");
                            return sortPlayersByName(JSON.parse(savedPlayers)); // Sort players by name only
                        } catch (parseError) {
                            console.error("‚ùå Errore nel parsing localStorage fallback:", parseError);
                        }
                    }
                    return [];
                }
            }
            
            async function saveCompanyPlayers(playersList) {
                if (!currentCompanyCode) {
                    throw new Error("Codice societ√† non disponibile");
                }
                
                // Demo mode - save to localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("Demo mode: players saved locally", playersList);
                    localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                    return;
                }
                
                // Firebase mode - save to players subcollection
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving to localStorage as fallback");
                    localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                    return;
                }
                
                try {
                    // First, get existing players from subcollection to identify what to remove
                    const playersCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "giocatori");
                    const existingPlayersSnapshot = await window.getDocs(playersCollectionRef);
                    
                    // Create a set of existing player names for comparison
                    const existingPlayerNames = new Set();
                    const existingPlayerDocs = new Map();
                    existingPlayersSnapshot.forEach((doc) => {
                        const playerData = doc.data();
                        const playerName = playerData.name || playerData.nome || doc.id;
                        existingPlayerNames.add(playerName);
                        existingPlayerDocs.set(playerName, doc.id);
                    });
                    
                    // Add new players to subcollection
                    for (const playerName of playersList) {
                        if (!existingPlayerNames.has(playerName)) {
                            // Create a new document for this player
                            const playerDocRef = window.doc(playersCollectionRef);
                            await window.setDoc(playerDocRef, {
                                name: playerName,
                                nome: playerName, // Keep both for compatibility
                                createdAt: new Date().toISOString(),
                                active: true
                            });
                            console.log(`‚úÖ Nuovo giocatore aggiunto alla subcollection: ${playerName}`);
                        }
                    }
                    
                    // Remove players that are no longer in the list
                    for (const existingPlayerName of existingPlayerNames) {
                        if (!playersList.includes(existingPlayerName)) {
                            const docId = existingPlayerDocs.get(existingPlayerName);
                            const playerDocRef = window.doc(window.db, "societa", currentCompanyDocumentId, "giocatori", docId);
                            await window.deleteDoc(playerDocRef);
                            console.log(`üóëÔ∏è Giocatore rimosso dalla subcollection: ${existingPlayerName}`);
                        }
                    }
                    
                    console.log(`‚úÖ Giocatori salvati nella subcollection societa/${currentCompanyDocumentId}/giocatori`);
                } catch (error) {
                    console.error("Errore nel salvataggio giocatori nella subcollection Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    console.log("Falling back to localStorage due to Firebase error");
                    try {
                        localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                        console.log("Players saved to localStorage as fallback");
                        // Don't throw error since localStorage save succeeded
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        throw new Error("Salvataggio fallito sia su Firebase che su localStorage");
                    }
                }
            }

            async function saveCompanyCoaches(coachesList) {
                if (!currentCompanyCode) {
                    throw new Error("Codice societ√† non disponibile");
                }
                
                // Demo mode - save to localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("Demo mode: coaches saved locally", coachesList);
                    localStorage.setItem(`coaches_${currentCompanyCode}`, JSON.stringify(coachesList));
                    return;
                }
                
                // Firebase mode - save to coaches subcollection
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving coaches to localStorage as fallback");
                    localStorage.setItem(`coaches_${currentCompanyCode}`, JSON.stringify(coachesList));
                    return;
                }
                
                try {
                    // First, get existing coaches from subcollection to identify what to remove
                    const coachesCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "mister");
                    const existingCoachesSnapshot = await window.getDocs(coachesCollectionRef);
                    
                    // Create a set of existing coach names for comparison
                    const existingCoachNames = new Set();
                    const existingCoachDocs = new Map();
                    existingCoachesSnapshot.forEach((doc) => {
                        const coachData = doc.data();
                        const coachName = coachData.name || coachData.nome || doc.id;
                        existingCoachNames.add(coachName);
                        existingCoachDocs.set(coachName, doc.id);
                    });
                    
                    // Add new coaches to subcollection
                    for (const coach of coachesList) {
                        const coachName = typeof coach === 'string' ? coach : coach.name;
                        const coachMatricola = typeof coach === 'object' && coach.matricola ? coach.matricola : '';
                        
                        if (!existingCoachNames.has(coachName)) {
                            // Create a new document for this coach
                            const coachDocRef = window.doc(coachesCollectionRef);
                            const coachData = {
                                name: coachName,
                                nome: coachName, // Keep both for compatibility
                                createdAt: new Date().toISOString(),
                                active: true
                            };
                            
                            // Add matricola if available
                            if (coachMatricola) {
                                coachData.matricola = coachMatricola;
                            }
                            
                            await window.setDoc(coachDocRef, coachData);
                            console.log(`Mister aggiunto: ${coachName}${coachMatricola ? ` (Matricola: ${coachMatricola})` : ''}`);
                        }
                    }
                    
                    // Remove coaches that are no longer in the list
                    for (const [coachName, docId] of existingCoachDocs) {
                        const stillExists = coachesList.some(coach => {
                            const currentCoachName = typeof coach === 'string' ? coach : coach.name;
                            return currentCoachName === coachName;
                        });
                        
                        if (!stillExists) {
                            const coachDocRef = window.doc(window.db, "societa", currentCompanyDocumentId, "mister", docId);
                            await window.deleteDoc(coachDocRef);
                            console.log(`Mister rimosso: ${coachName}`);
                        }
                    }
                    
                    console.log("Mister salvati con successo nella subcollection Firebase");
                } catch (error) {
                    console.error("Errore nel salvataggio mister nella subcollection Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    console.log("Falling back to localStorage due to Firebase error");
                    try {
                        localStorage.setItem(`coaches_${currentCompanyCode}`, JSON.stringify(coachesList));
                        console.log("Coaches saved to localStorage as fallback");
                        // Don't throw error since localStorage save succeeded
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        throw new Error("Salvataggio mister fallito sia su Firebase che su localStorage");
                    }
                }
            }

            async function saveCompanyDirectors(directorsList) {
                if (!currentCompanyCode) {
                    throw new Error("Codice societ√† non disponibile");
                }
                
                // Demo mode - save to localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("Demo mode: directors saved locally", directorsList);
                    localStorage.setItem(`directors_${currentCompanyCode}`, JSON.stringify(directorsList));
                    return;
                }
                
                // Firebase mode - save to directors subcollection
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving directors to localStorage as fallback");
                    localStorage.setItem(`directors_${currentCompanyCode}`, JSON.stringify(directorsList));
                    return;
                }
                
                try {
                    // First, get existing directors from subcollection to identify what to remove
                    const directorsCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "dirigenti");
                    const existingDirectorsSnapshot = await window.getDocs(directorsCollectionRef);
                    
                    // Create a set of existing director full names for comparison
                    const existingDirectorNames = new Set();
                    const existingDirectorDocs = new Map();
                    existingDirectorsSnapshot.forEach((doc) => {
                        const directorData = doc.data();
                        const fullName = `${directorData.name || ''} ${directorData.surname || ''}`.trim();
                        existingDirectorNames.add(fullName);
                        existingDirectorDocs.set(fullName, doc.id);
                    });
                    
                    // Add new directors to subcollection
                    for (const director of directorsList) {
                        const fullName = `${director.name || ''} ${director.surname || ''}`.trim();
                        
                        if (!existingDirectorNames.has(fullName)) {
                            // Create a new document for this director
                            const directorDocRef = window.doc(directorsCollectionRef);
                            const directorData = {
                                name: director.name || '',
                                surname: director.surname || '',
                                matricola: director.matricola || '',
                                createdAt: new Date().toISOString(),
                                active: true
                            };
                            
                            await window.setDoc(directorDocRef, directorData);
                            console.log(`Dirigente aggiunto: ${fullName} (Matricola: ${director.matricola})`);
                        }
                    }
                    
                    // Remove directors that are no longer in the list
                    for (const [fullName, docId] of existingDirectorDocs) {
                        const stillExists = directorsList.some(director => {
                            const currentFullName = `${director.name || ''} ${director.surname || ''}`.trim();
                            return currentFullName === fullName;
                        });
                        
                        if (!stillExists) {
                            const directorDocRef = window.doc(window.db, "societa", currentCompanyDocumentId, "dirigenti", docId);
                            await window.deleteDoc(directorDocRef);
                            console.log(`Dirigente rimosso: ${fullName}`);
                        }
                    }
                    
                    console.log("Dirigenti salvati con successo nella subcollection Firebase");
                } catch (error) {
                    console.error("Errore nel salvataggio dirigenti nella subcollection Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    console.log("Falling back to localStorage due to Firebase error");
                    try {
                        localStorage.setItem(`directors_${currentCompanyCode}`, JSON.stringify(directorsList));
                        console.log("Directors saved to localStorage as fallback");
                        // Don't throw error since localStorage save succeeded
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        throw new Error("Salvataggio dirigenti fallito sia su Firebase che su localStorage");
                    }
                }
            }

            async function loadCompanyCoaches() {
                if (!currentCompanyCode) {
                    console.log("Nessun codice societ√† disponibile per caricare i mister");
                    return [];
                }

                // Demo mode - load from localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    const storedCoaches = localStorage.getItem(`coaches_${currentCompanyCode}`);
                    return storedCoaches ? JSON.parse(storedCoaches) : [];
                }

                // Firebase mode - load from coaches subcollection
                if (!window.db) {
                    // Firebase not available, try localStorage fallback
                    const storedCoaches = localStorage.getItem(`coaches_${currentCompanyCode}`);
                    return storedCoaches ? JSON.parse(storedCoaches) : [];
                }

                try {
                    const coachesCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "mister");
                    const coachesSnapshot = await window.getDocs(coachesCollectionRef);
                    
                    const coaches = [];
                    coachesSnapshot.forEach((doc) => {
                        const coachData = doc.data();
                        const coachName = coachData.name || coachData.nome || doc.id;
                        if (coachData.active !== false) { // Include active coaches or those without active field
                            if (coachData.matricola) {
                                // New format: object with name and matricola
                                coaches.push({
                                    name: coachName,
                                    matricola: coachData.matricola
                                });
                            } else {
                                // Old format: just the name (for backward compatibility)
                                coaches.push(coachName);
                            }
                        }
                    });
                    
                    // Sort coaches by name
                    return coaches.sort((a, b) => {
                        const nameA = typeof a === 'string' ? a : a.name;
                        const nameB = typeof b === 'string' ? b : b.name;
                        return nameA.localeCompare(nameB);
                    });
                } catch (error) {
                    console.error("Errore nel caricamento mister da Firebase:", error);
                    // Try localStorage fallback
                    const storedCoaches = localStorage.getItem(`coaches_${currentCompanyCode}`);
                    return storedCoaches ? JSON.parse(storedCoaches) : [];
                }
            }

            async function loadCompanyDirectors() {
                if (!currentCompanyCode) {
                    console.log("Nessun codice societ√† disponibile per caricare i dirigenti");
                    return [];
                }

                // Demo mode - load from localStorage or provide defaults
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    const storedDirectors = localStorage.getItem(`directors_${currentCompanyCode}`);
                    if (storedDirectors) {
                        return JSON.parse(storedDirectors);
                    } else {
                        // Provide default directors for demo mode
                        const defaultDirectors = [
                            { name: "Marco", surname: "Dirigente", matricola: "DIR001" },
                            { name: "Giuseppe", surname: "Presidente", matricola: "DIR002" },
                            { name: "Antonio", surname: "Segretario", matricola: "DIR003" }
                        ];
                        return defaultDirectors;
                    }
                }

                // Firebase mode - load from directors subcollection
                if (!window.db) {
                    // Firebase not available, try localStorage fallback
                    const storedDirectors = localStorage.getItem(`directors_${currentCompanyCode}`);
                    return storedDirectors ? JSON.parse(storedDirectors) : [];
                }

                try {
                    const directorsCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "dirigenti");
                    const directorsSnapshot = await window.getDocs(directorsCollectionRef);
                    
                    const directors = [];
                    directorsSnapshot.forEach((doc) => {
                        const directorData = doc.data();
                        if (directorData.active !== false) { // Include active directors or those without active field
                            directors.push({
                                name: directorData.name || directorData.nome,
                                surname: directorData.surname || directorData.cognome,
                                matricola: directorData.matricola
                            });
                        }
                    });

                    // Sort directors by surname, then name
                    return directors.sort((a, b) => {
                        const surnameCompare = (a.surname || '').localeCompare(b.surname || '');
                        if (surnameCompare !== 0) return surnameCompare;
                        return (a.name || '').localeCompare(b.name || '');
                    });
                } catch (error) {
                    console.error("Errore nel caricamento dirigenti da Firebase:", error);
                    // Try localStorage fallback
                    const storedDirectors = localStorage.getItem(`directors_${currentCompanyCode}`);
                    return storedDirectors ? JSON.parse(storedDirectors) : [];
                }
            }

            // Set up real-time listeners for all necessary data
            function setupFirestoreListeners(appId) {
                console.log(`üîÑ [DIAGNOSTIC] setupFirestoreListeners chiamata con appId: ${appId}`);
                console.log(`   üè¢ Company variables - Codice: ${currentCompanyCode}, Document ID: ${currentCompanyDocumentId}`);
                
                // Clear old listeners
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                // Check if Firebase is available
                if (!window.db || !window.collection || !window.onSnapshot || !window.doc) {
                    console.log('Firebase not available, using demo mode for history/attendance');
                    // In demo mode, initialize with empty data
                    loadHistoryDemo();
                    loadAttendanceDemo();
                    // Initialize unavailable players view with empty state message
                    unavailablePlayers = new Map();
                    updateUnavailablePlayersView();
                    console.log('üìù Demo mode: Initialized availability with empty state message');
                    return;
                }

                // Use company-specific paths
                const basePath = currentCompanyCode ? `societa/${currentCompanyCode}` : `artifacts/${appId}/public/data`;
                
                // For availability subcollection, use document ID instead of company code
                const availabilityBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;

                // Log the paths being used for debugging
                console.log(`üè¢ Societ√† corrente - Codice: ${currentCompanyCode}, Document ID: ${currentCompanyDocumentId}`);
                console.log(`üìÇ Percorso base convocazioni/presenze: ${basePath}`);
                console.log(`üìÇ Percorso base availability (con Document ID): ${availabilityBasePath}`);

                // Listener for Mister's convocations history - using document ID path like giocatori and availability
                const historyBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;
                const historyCollectionRef = window.collection(window.db, `${historyBasePath}/convocations_history`);
                console.log(`üìç Percorso completo subcollection convocations_history: ${historyBasePath}/convocations_history`);
                const historyUnsub = window.onSnapshot(historyCollectionRef, (querySnapshot) => {
                    loadHistory(querySnapshot);
                });
                unsubscribeListeners.push(historyUnsub);

                // Listener for player attendance - using document ID path like other subcollections
                const attendanceBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;
                const attendanceCollectionRef = window.collection(window.db, `${attendanceBasePath}/player_attendance`);
                console.log(`üìç Percorso completo subcollection player_attendance: ${attendanceBasePath}/player_attendance`);
                const attendanceUnsub = window.onSnapshot(attendanceCollectionRef, (querySnapshot) => {
                    loadAttendance(querySnapshot);
                });
                unsubscribeListeners.push(attendanceUnsub);
                
                // Listener for Marco's unavailable players list - using document ID path
                const unavailableDocRef = window.doc(window.db, `${availabilityBasePath}/availability`, "marco_unavailable");
                console.log(`üìç Percorso completo subcollection availability: ${availabilityBasePath}/availability/marco_unavailable`);
                const unavailableUnsub = window.onSnapshot(unavailableDocRef, async (docSnap) => {
                    // Check if weekly reset is needed
                    const needsReset = checkAndResetWeeklyUnavailability();
                    
                    if (needsReset) {
                        console.log('üîÑ Weekly reset triggered - clearing unavailable players');
                        await resetUnavailablePlayersInFirebase();
                        return; // The reset will trigger this listener again with empty data
                    }
                    
                    if (docSnap.exists() && docSnap.data().players) {
                        unavailablePlayers = new Map(Object.entries(docSnap.data().players));
                        console.log(`‚úÖ Caricata availability subcollection da: ${availabilityBasePath}/availability/marco_unavailable (${unavailablePlayers.size} giocatori non disponibili)`);
                    } else {
                        unavailablePlayers = new Map();
                        console.log(`üìù Subcollection 'availability' vuota o non trovata per societ√† document ID ${currentCompanyDocumentId}`);
                    }
                    renderPlayers(); // Re-render players with new unavailable status
                    updateUnavailablePlayersView(); // Update Mister's view
                });
                unsubscribeListeners.push(unavailableUnsub);
                
                // Listener for notes - using document ID path like giocatori and availability
                const notesBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;
                const notesDocRef = window.doc(window.db, `${notesBasePath}/notes`, "marco_notes");
                console.log(`üìç Percorso completo subcollection notes: ${notesBasePath}/notes/marco_notes`);
                const notesUnsub = window.onSnapshot(notesDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().content) {
                        currentNotes = docSnap.data().content;
                        console.log(`‚úÖ Caricata notes subcollection da: ${notesBasePath}/notes/marco_notes`);
                    } else {
                        currentNotes = '';
                        console.log(`üìù Subcollection 'notes' vuota o non trovata per societ√† document ID ${currentCompanyDocumentId}`);
                    }
                    updateNotesDisplay();
                    updateResetTimestampDisplay();
                });
                unsubscribeListeners.push(notesUnsub);
            }

            // Function to save data based on role
            async function saveData() {
                if (!window.db || !window.auth.currentUser) {
                    showMessage("Errore: Firebase non √® ancora pronto. Riprova tra un attimo.", "text-red-600");
                    return;
                }

                // Use company-specific paths
                const basePath = currentCompanyCode ? `societa/${currentCompanyCode}` : `artifacts/${currentAppId}/public/data`;
                
                // For availability subcollection, use document ID instead of company code
                const availabilityBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;

                if (userRole === 'mister') {
                    const matchDetails = getMatchDetails();
                    const selectedPlayers = getSelectedPlayers();
                    
                    // For Torneo type, avversario field should contain trophy emoji or be considered valid
                    const isValidAvversario = matchDetails.tipo === 'Torneo' ? 
                        (matchDetails.avversario === 'üèÜ' || matchDetails.avversario) :
                        matchDetails.avversario;
                    
                    if (!isValidAvversario || selectedPlayers.length === 0) {
                        const missingFields = [];
                        if (!isValidAvversario) {
                            missingFields.push(matchDetails.tipo === 'Torneo' ? 'tipo torneo' : 'avversario');
                        }
                        if (selectedPlayers.length === 0) {
                            missingFields.push('almeno un giocatore');
                        }
                        showMessage(`Inserisci ${missingFields.join(' e ')} per salvare.`, "text-red-600");
                        return;
                    }

                    // Sort players alphabetically ignoring numbers before names
                    const sortedPlayers = selectedPlayers.sort((a, b) => a.replace(/^\d+\s*/, '').localeCompare(b.replace(/^\d+\s*/, '')));

                    try {
                        // Use document ID path for convocations_history like giocatori and availability
                        const historyBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;
                        console.log(`üíæ Salvando convocazione per societ√† document ID: ${currentCompanyDocumentId}`);
                        console.log(`üìÇ Percorso salvataggio convocations_history: ${historyBasePath}/convocations_history`);
                        
                        await window.addDoc(window.collection(window.db, `${historyBasePath}/convocations_history`), {
                            details: matchDetails,
                            players: sortedPlayers,
                            createdAt: new Date().toISOString()
                        });

                        for (const player of sortedPlayers) {
                            const playerDocRef = window.doc(window.db, `${historyBasePath}/player_attendance`, player);
                            await window.setDoc(playerDocRef, { count: window.increment(1) }, { merge: true });
                        }

                        showSuccessPopup("Convocazione salvata e presenze aggiornate!");
                        
                        // Auto-reset fields after successful save for Mister role only
                        resetMisterSelectionsWithoutConfirm();
                    } catch (e) {
                        console.error("Errore salvataggio su Firestore: ", e);
                        showMessage("Errore durante il salvataggio. Controlla la console.", "text-red-600");
                    }
                } else if (isDirigente()) {
                    const unavailablePlayersObject = Object.fromEntries(unavailablePlayers);
                    const unavailableDocRef = window.doc(window.db, `${availabilityBasePath}/availability`, "marco_unavailable");
                    
                    // V9.11: Track injured players separately with history (cumulative for entire season)
                    const currentlyInjuredPlayers = [];
                    unavailablePlayers.forEach((status, player) => {
                        const statuses = Array.isArray(status) ? status : [status];
                        if (statuses.includes('Infortunato')) {
                            currentlyInjuredPlayers.push(player);
                        }
                    });
                    const injuredDocRef = window.doc(window.db, `${availabilityBasePath}/availability`, "injured_players");
                    
                    console.log(`üíæ Salvando lista giocatori non disponibili per societ√† document ID: ${currentCompanyDocumentId}`);
                    console.log(`üìÇ Percorso salvataggio availability: ${availabilityBasePath}/availability/marco_unavailable`);
                    console.log(`üöë Giocatori infortunati: ${currentlyInjuredPlayers.length > 0 ? currentlyInjuredPlayers.join(', ') : 'Nessuno'}`);
                    
                    try {
                        await window.setDoc(unavailableDocRef, { players: unavailablePlayersObject });
                        
                        // V9.11: Use arrayUnion to maintain cumulative history of all injured players for the season
                        // This ensures players remain in the list even after they recover
                        if (currentlyInjuredPlayers.length > 0) {
                            // Check if document exists first
                            const injuredDocSnapshot = await window.getDoc(injuredDocRef);
                            if (injuredDocSnapshot.exists()) {
                                // Document exists, use updateDoc with arrayUnion to add new players
                                await window.updateDoc(injuredDocRef, { 
                                    players: window.arrayUnion(...currentlyInjuredPlayers) 
                                });
                            } else {
                                // Document doesn't exist, create it with initial players
                                await window.setDoc(injuredDocRef, { players: currentlyInjuredPlayers });
                            }
                        }
                        
                        showSuccessPopup("Lista di giocatori non disponibili salvata!");
                        console.log(`‚úÖ Lista giocatori non disponibili salvata con successo (${Object.keys(unavailablePlayersObject).length} giocatori)`);
                        console.log(`‚úÖ Lista giocatori infortunati aggiornata con successo (${currentlyInjuredPlayers.length} nuovi infortunati, storico mantenuto)`);
                    } catch (e) {
                        console.error("Errore salvataggio su Firestore: ", e);
                        showMessage("Errore durante il salvataggio. Controlla la console.", "text-red-600");
                    }
                }
            }

            // Function to ensure convocation history is loaded
            // This is called when opening Riepilogo to guarantee data is available
            async function ensureConvocationHistoryLoaded() {
                // If data is already loaded, return immediately
                if (convocationHistory.length > 0) {
                    console.log(`‚úÖ convocationHistory gi√† caricato (${convocationHistory.length} convocazioni)`);
                    return;
                }
                
                console.log(`üîÑ convocationHistory vuoto, caricamento esplicito dei dati...`);
                
                // Check if Firebase is available
                if (!window.db || !window.collection || !window.getDocs) {
                    console.log('‚ö†Ô∏è Firebase non disponibile, usando modalit√† demo');
                    loadHistoryDemo();
                    return;
                }
                
                // Load data from Firestore
                try {
                    const historyBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;
                    const historyCollectionRef = window.collection(window.db, `${historyBasePath}/convocations_history`);
                    console.log(`üìç Caricamento esplicito da: ${historyBasePath}/convocations_history`);
                    
                    const querySnapshot = await window.getDocs(historyCollectionRef);
                    
                    if (querySnapshot.empty) {
                        console.log(`üìù Nessuna convocazione trovata per societ√† ${currentCompanyDocumentId}`);
                        convocationHistory = [];
                        allConvocationHistory = [];
                        return;
                    }
                    
                    const history = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const historyItem = { ...data, id: doc.id };
                        history.push(historyItem);
                        convocationHistory.push(historyItem);
                    });
                    
                    // Sort by createdAt descending
                    history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    convocationHistory.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // Store all unfiltered history
                    allConvocationHistory = history;
                    
                    console.log(`‚úÖ Caricato ${convocationHistory.length} convocazioni storiche`);
                } catch (error) {
                    console.error('‚ùå Errore durante il caricamento delle convocazioni:', error);
                    convocationHistory = [];
                    allConvocationHistory = [];
                }
            }

            // Function to load and display history from Firestore
            function loadHistory(querySnapshot) {
                convocationHistory = []; // reset convocation history data
                allConvocationHistory = []; // reset all history data
                
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Nessuna convocazione registrata.</p>';
                    console.log(`üìù Subcollection 'convocations_history' vuota o non trovata per societ√† document ID ${currentCompanyDocumentId}`);
                    // Update attendance tables even if no history (to show empty state)
                    updateAttendanceTables();
                    // V7.10: Update total attendance table as well
                    loadAttendance(querySnapshot);
                    return;
                }
                
                const history = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const historyItem = { ...data, id: doc.id };
                    history.push(historyItem);
                    convocationHistory.push(historyItem); // store for attendance filtering
                });
                
                // Sort by createdAt descending
                history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                convocationHistory.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Store all unfiltered history
                allConvocationHistory = history;
                
                // V9.14: Populate month dropdown with available months
                populateMonthDropdown();
                
                // Render with default filter (month)
                renderFilteredHistory();
                
                // Update filtered attendance tables after loading history data
                updateAttendanceTables();
                
                // V7.10: Update total attendance table (Riepilogo Totale) after loading history
                loadAttendance(querySnapshot);
                
                // Re-render players to apply already-called-today styling
                if (userRole === 'mister') {
                    renderPlayers();
                }
            }
            
            // V9.14: Function to populate month dropdown with all available months
            function populateMonthDropdown() {
                const periodSelect = document.getElementById('history-period-select');
                if (!periodSelect || allConvocationHistory.length === 0) {
                    return;
                }
                
                // Extract all unique months from history
                const monthsSet = new Set();
                allConvocationHistory.forEach(item => {
                    const matchDateStr = item.details.data;
                    let dateToUse;
                    
                    if (matchDateStr && matchDateStr !== 'N/D') {
                        dateToUse = new Date(matchDateStr + 'T00:00:00');
                    } else {
                        dateToUse = new Date(item.createdAt);
                    }
                    
                    if (!isNaN(dateToUse.getTime())) {
                        const monthKey = `${dateToUse.getFullYear()}-${String(dateToUse.getMonth() + 1).padStart(2, '0')}`;
                        monthsSet.add(monthKey);
                    }
                });
                
                // Convert to array and sort (most recent first)
                const monthsArray = Array.from(monthsSet).sort().reverse();
                
                // Get current month for default selection
                const now = new Date();
                const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                // Store current selection before clearing
                const currentValue = periodSelect.value;
                
                // Check if this is first load (currentValue is 'week' or 'all' from HTML default)
                const isFirstLoad = currentValue === 'week' || currentValue === 'all';
                
                // Clear existing options
                periodSelect.innerHTML = '';
                
                // Add "Settimana corrente" option
                const weekOption = document.createElement('option');
                weekOption.value = 'week';
                weekOption.textContent = 'Settimana corrente';
                periodSelect.appendChild(weekOption);
                
                // Add "Tutti i periodi" option
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'Tutti i periodi';
                periodSelect.appendChild(allOption);
                
                // Add individual month options
                monthsArray.forEach(monthKey => {
                    const option = document.createElement('option');
                    option.value = monthKey;
                    
                    // Format month name in Italian
                    const [year, month] = monthKey.split('-');
                    const date = new Date(year, parseInt(month) - 1, 1);
                    const monthName = date.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                    const capitalizedMonthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                    option.textContent = capitalizedMonthName;
                    
                    periodSelect.appendChild(option);
                });
                
                // Select current month by default on first load or if previous selection was 'month'
                if (monthsArray.includes(currentMonthKey) && (isFirstLoad || currentValue === 'month')) {
                    periodSelect.value = currentMonthKey;
                } else if (currentValue && !isFirstLoad) {
                    // Restore previous selection if it's not first load and not 'month'
                    periodSelect.value = currentValue;
                }
            }
            
            // Function to filter history by period
            function filterHistoryByPeriod(history, period) {
                if (period === 'all') {
                    return history;
                }
                
                const now = new Date();
                
                // V9.14: Check if period is a specific month (format: YYYY-MM)
                const isSpecificMonth = /^\d{4}-\d{2}$/.test(period);
                
                return history.filter(item => {
                    // Use match date for filtering
                    const matchDateStr = item.details.data;
                    if (!matchDateStr || matchDateStr === 'N/D') {
                        // If no match date, use createdAt
                        const createdDate = new Date(item.createdAt);
                        if (period === 'week') {
                            const startOfWeek = new Date(now);
                            const day = startOfWeek.getDay();
                            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
                            startOfWeek.setDate(diff);
                            startOfWeek.setHours(0, 0, 0, 0);
                            
                            const endOfWeek = new Date(startOfWeek);
                            endOfWeek.setDate(startOfWeek.getDate() + 6);
                            endOfWeek.setHours(23, 59, 59, 999);
                            
                            return createdDate >= startOfWeek && createdDate <= endOfWeek;
                        } else if (period === 'month') {
                            return createdDate.getMonth() === now.getMonth() && 
                                   createdDate.getFullYear() === now.getFullYear();
                        } else if (isSpecificMonth) {
                            // V9.14: Filter by specific month
                            const [year, month] = period.split('-');
                            return createdDate.getMonth() === parseInt(month) - 1 && 
                                   createdDate.getFullYear() === parseInt(year);
                        }
                        return true;
                    }
                    
                    const matchDate = new Date(matchDateStr + 'T00:00:00');
                    
                    if (period === 'week') {
                        const startOfWeek = new Date(now);
                        const day = startOfWeek.getDay();
                        const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
                        startOfWeek.setDate(diff);
                        startOfWeek.setHours(0, 0, 0, 0);
                        
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23, 59, 59, 999);
                        
                        return matchDate >= startOfWeek && matchDate <= endOfWeek;
                    } else if (period === 'month') {
                        return matchDate.getMonth() === now.getMonth() && 
                               matchDate.getFullYear() === now.getFullYear();
                    } else if (isSpecificMonth) {
                        // V9.14: Filter by specific month
                        const [year, month] = period.split('-');
                        return matchDate.getMonth() === parseInt(month) - 1 && 
                               matchDate.getFullYear() === parseInt(year);
                    }
                    
                    return true;
                });
            }
            
            // Function to render filtered history
            function renderFilteredHistory() {
                const periodSelect = document.getElementById('history-period-select');
                const selectedPeriod = periodSelect ? periodSelect.value : 'month';
                const filterDisplay = document.getElementById('history-filter-display');
                
                // Update filter display text
                if (filterDisplay) {
                    const filterTexts = {
                        'all': 'Tutti i periodi',
                        'week': 'Settimana corrente',
                        'month': 'Mese corrente'
                    };
                    
                    // V9.14: Handle specific month display
                    if (/^\d{4}-\d{2}$/.test(selectedPeriod)) {
                        const [year, month] = selectedPeriod.split('-');
                        const date = new Date(year, parseInt(month) - 1, 1);
                        const monthName = date.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
                        const capitalizedMonthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                        filterDisplay.textContent = capitalizedMonthName;
                    } else {
                        filterDisplay.textContent = filterTexts[selectedPeriod] || 'Mese corrente';
                    }
                }
                
                // Filter history
                const filteredHistory = filterHistoryByPeriod(allConvocationHistory, selectedPeriod);
                
                // Clear history list
                historyList.innerHTML = '';
                
                // Check if filtered result is empty
                if (filteredHistory.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Nessuna convocazione trovata per il periodo selezionato.</p>';
                    return;
                }
                
                // Render each history item
                filteredHistory.forEach(data => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                    const createdAt = new Date(data.createdAt);
                    const formattedDate = createdAt.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
                    const formattedTime = createdAt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                    // Format match date with uppercase day of week
                    let formattedMatchDate = data.details.data;
                    if (data.details.data !== 'N/D') {
                        const matchDate = new Date(data.details.data + 'T00:00:00');
                        const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                        const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                        const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                        formattedMatchDate = `${dayOfWeek} ${dateString}`;
                    }

                    item.innerHTML = `
                        <div class="font-bold text-lg mb-2 text-gray-800">${data.details.avversario}</div>
                        <div class="text-sm text-gray-600 mb-2">
                            <p>Salvataggio: ${formattedDate} alle ${formattedTime}</p>
                            <p>üèüÔ∏è Campo: ${data.details.campo}</p>
                            <p>üìÖ Data Partita: ${formattedMatchDate}</p>
                            <p>üïí Orario Convocazione: ${data.details.orarioConvocazione}</p>
                            <p>üïí Orario Partita: ${data.details.orarioPartita}</p>
                            <p>Tipo: ${data.details.tipo || 'N/D'}</p>
                            <p>üë§ Mister: ${data.details.misterPartita || 'N/D'}</p>
                            <p>üë§ Mister: ${data.details.misterTipo || 'N/D'}</p>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p class="font-semibold mb-1">Giocatori: (${data.players.length})</p>
                            <ul class="list-disc list-inside space-y-0.5">
                                ${data.players.map(p => {
                                    if (typeof p === 'string') {
                                        return `<li>${p}</li>`;
                                    } else {
                                        return `<li>${p.numero} ${p.nome}</li>`;
                                    }
                                }).join('')}
                            </ul>
                        </div>
                        <div class="mt-3 flex gap-2 flex-wrap">
                            ${(userRole === 'mister' || isDirigente()) && !isGuestUser ? `<button class="edit-history-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1 rounded" data-docid="${data.id}">Modifica</button>` : ''}
                            ${canShareHistory() ? `<button class="share-history-btn bg-blue-500 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded" data-convocation='${safeJSONStringify(data)}'>Condividi</button>` : ''}
                            ${canAccessDistinta() ? `<button class="distinta-history-btn bg-green-500 hover:bg-green-700 text-white text-xs px-3 py-1 rounded" data-convocation='${safeJSONStringify(data)}'>Distinta</button>` : ''}
                            ${isDirigente() ? `<button class="delete-history-btn bg-red-500 hover:bg-red-700 text-white text-xs px-3 py-1 rounded" data-docid="${data.id}">Elimina</button>` : ''}
                        </div>
                    `;
                    historyList.appendChild(item);
                });

                // Listener sui pulsanti "Modifica"
                if ((userRole === 'mister' || isDirigente()) && !isGuestUser) {
                    const editButtons = historyList.querySelectorAll('.edit-history-btn');
                    editButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const docId = btn.getAttribute('data-docid');
                            console.log(`‚úèÔ∏è Modificando convocazione con ID: ${docId}`);
                            
                            // Store state in sessionStorage to restore history view after editing
                            sessionStorage.setItem('editOrigin', 'history');
                            sessionStorage.setItem('editCompanyDocId', currentCompanyDocumentId);
                            sessionStorage.setItem('editUserRole', userRole);
                            sessionStorage.setItem('editAppId', currentAppId);
                            
                            // Navigate to edit page with parameters
                            window.location.href = `edit_convocation.html?id=${docId}&companyDocId=${currentCompanyDocumentId}&role=${userRole}`;
                        });
                    });
                }

                // Listener sui pulsanti "Elimina"
                if (isDirigente()) {
                    const deleteButtons = historyList.querySelectorAll('.delete-history-btn');
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const docId = btn.getAttribute('data-docid');
                            if (confirm('Vuoi davvero eliminare questa partita dallo storico?')) {
                                try {
                                    // Use document ID path for convocations_history like other subcollections
                                    const historyBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;
                                    console.log(`üóëÔ∏è Eliminando convocazione per societ√† document ID: ${currentCompanyDocumentId}`);
                                    console.log(`üìÇ Percorso eliminazione: ${historyBasePath}/convocations_history/${docId}`);
                                    
                                    // Recupera i giocatori coinvolti e aggiorna le presenze
                                    const docRef = window.doc(window.db, `${historyBasePath}/convocations_history`, docId);
                                    const docSnap = await window.getDoc(docRef);
                                    if (docSnap.exists()) {
                                        const convocazione = docSnap.data();
                                        for (const player of convocazione.players) {
                                            const playerDocRef = window.doc(window.db, `${historyBasePath}/player_attendance`, player);
                                            await window.setDoc(playerDocRef, { count: window.increment(-1) }, { merge: true });
                                        }
                                    }
                                    await window.deleteDoc(docRef);
                                    showMessage('Partita eliminata e presenze aggiornate!', 'text-green-600');
                                } catch (err) {
                                    showMessage('Errore eliminazione: ' + err, 'text-red-600');
                                }
                            }
                        });
                    });
                }

                // Listener sui pulsanti "Condividi" per singole convocazioni
                const shareButtons = historyList.querySelectorAll('.share-history-btn');
                shareButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const convocationData = safeJSONParse(btn.getAttribute('data-convocation'));
                        if (convocationData) {
                            generateHistoryShareImage(convocationData);
                        } else {
                            showMessage("Errore nel recupero dei dati per la condivisione.", "text-red-600");
                        }
                    });
                });

                // Listener sui pulsanti "Distinta" per singole convocazioni
                if (canAccessDistinta()) {
                    const distintaButtons = historyList.querySelectorAll('.distinta-history-btn');
                    distintaButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            console.log('üéØ DISTINTA FLOW START: Distinta button clicked from storico convocazioni');
                            console.log('üë§ User role:', userRole);
                            console.log('üè¢ Company code:', currentCompanyCode);
                            
                            const convocationData = safeJSONParse(btn.getAttribute('data-convocation'));
                            console.log('üìä Raw convocation data from button attribute:', btn.getAttribute('data-convocation'));
                            console.log('üìã Parsed convocation data:', convocationData);
                            
                            if (convocationData) {
                                // Store the convocation data globally for the distinta generation
                                window.currentDistintaData = convocationData;
                                console.log('‚úÖ DISTINTA FLOW: currentDistintaData stored globally:', window.currentDistintaData);
                                console.log('üìç DISTINTA FLOW: Showing location modal...');
                                showDistintaLocationModal();
                            } else {
                                console.error('‚ùå DISTINTA FLOW ERROR: Failed to parse convocation data');
                                showMessage("Errore nel recupero dei dati per la distinta.", "text-red-600");
                            }
                        });
                    });
                }
                
                // Update filtered attendance tables after loading history data
                updateAttendanceTables();
                
                // Re-render players to apply already-called-today styling
                if (userRole === 'mister') {
                    renderPlayers();
                }
            }

            // V9.28: Count-up animation function for total matches
            function animateCountUp(element, targetValue, duration = 1500) {
                if (!element) return;
                
                const startValue = 0;
                const startTime = performance.now();
                
                function updateCount(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function for smooth animation
                    const easeOutQuad = progress * (2 - progress);
                    const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuad);
                    
                    element.textContent = currentValue;
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateCount);
                    } else {
                        element.textContent = targetValue;
                    }
                }
                
                requestAnimationFrame(updateCount);
            }
            
            // V9.30: Helper functions for modal player details
            function getPlayerTrend(playerName) {
                // Analyze last 8 convocations to determine trend
                // convocationHistory is sorted descending (most recent first)
                // Reverse to get oldest to newest for trend analysis
                const recentConvocations = convocationHistory.slice(0, 8).reverse();
                const playerAppearances = [];
                
                recentConvocations.forEach(conv => {
                    const players = conv.players || [];
                    const isPresent = players.some(p => {
                        const pName = typeof p === 'string' ? p : `${p.numero} ${p.nome}`;
                        return pName.includes(playerName);
                    });
                    playerAppearances.push(isPresent ? 1 : 0);
                });
                
                if (playerAppearances.length < 4) return 'neutral';
                
                const firstHalf = playerAppearances.slice(0, Math.floor(playerAppearances.length / 2));
                const secondHalf = playerAppearances.slice(Math.floor(playerAppearances.length / 2));
                
                const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
                const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;
                
                if (secondAvg > firstAvg + 0.15) return 'positive';
                if (secondAvg < firstAvg - 0.15) return 'negative';
                return 'neutral';
            }
            
            function getPlayerChartData(playerName) {
                // Get last 8 convocations for chart
                // convocationHistory is sorted descending (most recent first)
                // Reverse to get oldest to newest for chart display
                const recentConvocations = convocationHistory.slice(0, 8).reverse();
                const chartData = [];
                
                recentConvocations.forEach(conv => {
                    const players = conv.players || [];
                    const isPresent = players.some(p => {
                        const pName = typeof p === 'string' ? p : `${p.numero} ${p.nome}`;
                        return pName.includes(playerName);
                    });
                    chartData.push(isPresent ? 100 : 0);
                });
                
                // Pad with zeros if less than 8
                while (chartData.length < 8) {
                    chartData.unshift(0);
                }
                
                return chartData.slice(-8);
            }
            
            function getRecentCallups(playerName) {
                // Get last 5 convocations with details
                // convocationHistory is sorted descending (most recent first)
                const recentConvocations = convocationHistory.slice(0, 5);
                const callups = [];
                
                recentConvocations.forEach(conv => {
                    const players = conv.players || [];
                    const isPresent = players.some(p => {
                        const pName = typeof p === 'string' ? p : `${p.numero} ${p.nome}`;
                        return pName.includes(playerName);
                    });
                    
                    const details = conv.details || {};
                    const date = details.data || 'N/D';
                    const opponent = details.avversario || 'N/D';
                    const tipo = details.tipo || 'N/D';
                    
                    callups.push({
                        date: date.split(' ')[0] || date, // Get just the date part
                        opponent: opponent,
                        tipo: tipo,
                        status: isPresent ? 'presente' : 'non-convocato'
                    });
                });
                
                return callups;
            }
            
            function generateMiniChart(chartData) {
                const maxHeight = Math.max(...chartData, 1);
                return chartData.map(value => {
                    const height = value === 0 ? 10 : (value / maxHeight * 100);
                    return `<div class="mini-chart-bar" style="height: ${height}%;"></div>`;
                }).join('');
            }
            
            function generateCallupsList(callups) {
                if (callups.length === 0) {
                    return '<div class="text-xs text-gray-500">Nessun dato disponibile</div>';
                }
                return callups.map(callup => {
                    const icon = callup.status === 'presente' ? '‚úÖ' : '‚ö™';
                    
                    // Format date for better visibility
                    let formattedDate = callup.date;
                    try {
                        // Try to parse and format the date in Italian format
                        const dateParts = callup.date.split('-');
                        if (dateParts.length === 3) {
                            const dateObj = new Date(dateParts[0], parseInt(dateParts[1]) - 1, dateParts[2]);
                            formattedDate = dateObj.toLocaleDateString('it-IT', { 
                                day: '2-digit', 
                                month: '2-digit',
                                year: 'numeric'
                            });
                        }
                    } catch (e) {
                        // If parsing fails, use the original date
                        formattedDate = callup.date;
                    }
                    
                    // Format match type with emoji
                    let tipoDisplay = '';
                    if (callup.tipo === 'Campionato') {
                        tipoDisplay = '‚öΩÔ∏è Campionato';
                    } else if (callup.tipo === 'Amichevole') {
                        tipoDisplay = 'ü§ù Amichevole';
                    } else if (callup.tipo === 'Torneo') {
                        tipoDisplay = 'üèÜ Torneo';
                    } else {
                        tipoDisplay = callup.tipo;
                    }
                    
                    return `
                        <div class="recent-callup ${callup.status}">
                            <span>${icon}</span>
                            <div class="flex flex-col">
                                <span><strong>${formattedDate}</strong> vs ${callup.opponent}</span>
                                <span class="text-xs text-gray-600 mt-1">${tipoDisplay}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function getTrendBadge(trend) {
                if (trend === 'positive') return '<div class="trend-badge positive">üìà In Crescita</div>';
                if (trend === 'negative') return '<div class="trend-badge negative">üìâ In Calo</div>';
                return '<div class="trend-badge neutral">‚û°Ô∏è Stabile</div>';
            }
            
            // V9.30: Modal control functions
            const playerModal = document.getElementById('player-modal');
            const closeModalBtn = document.getElementById('close-modal');
            const modalPlayerName = document.getElementById('modal-player-name');
            const modalTrend = document.getElementById('modal-trend');
            const modalChart = document.getElementById('modal-chart');
            const modalCallups = document.getElementById('modal-callups');
            
            function openPlayerModal(playerName, trend, chartData, recentCallups) {
                modalPlayerName.textContent = playerName;
                modalTrend.innerHTML = getTrendBadge(trend);
                modalChart.innerHTML = generateMiniChart(chartData);
                modalCallups.innerHTML = generateCallupsList(recentCallups);
                
                playerModal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
            
            function closePlayerModal() {
                playerModal.classList.remove('show');
                document.body.style.overflow = '';
            }
            
            // Event listeners for modal
            // V9.32: Modal closes ONLY with X button, not by clicking outside
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closePlayerModal);
            }

            // Function to load and display attendance summary from Firestore
            async function loadAttendance(querySnapshot) {
                console.log(`üìä [DIAGNOSTIC] loadAttendance chiamata, caricamento dati presenze...`);
                attendanceList.innerHTML = '';
                
                // Calculate total attendance from convocationHistory (sum of all categories)
                const attendanceData = {};
                convocationHistory.forEach(convocation => {
                    const players = convocation.players || [];
                    players.forEach(player => {
                        // Handle both old string format and new object format
                        let playerKey;
                        if (typeof player === 'string') {
                            playerKey = player;
                        } else {
                            playerKey = `${player.numero} ${player.nome}`;
                        }
                        attendanceData[playerKey] = (attendanceData[playerKey] || 0) + 1;
                    });
                });
                
                // Use companyPlayers instead of global players array to show correct company data
                const playersToShow = companyPlayers.length > 0 ? companyPlayers : players;
                console.log(`üìä [DIAGNOSTIC] Visualizzazione presenze per ${playersToShow.length} giocatori della societ√†`);
                
                // V7.2: Calculate total matches from convocationHistory
                const totalMatches = convocationHistory.length;
                const totalMatchesCountElement = document.getElementById('total-matches-count');
                if (totalMatchesCountElement) {
                    // V9.28: Use count-up animation instead of direct text update
                    animateCountUp(totalMatchesCountElement, totalMatches);
                }
                console.log(`üìä [V7.2] Partite totali: ${totalMatches}`);
                
                // V7.2: Check if company is POLIS to show availability column
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                const availabilityHeader = document.getElementById('availability-percentage-header');
                if (availabilityHeader) {
                    if (isPolisCompany) {
                        availabilityHeader.classList.remove('hidden');
                    } else {
                        availabilityHeader.classList.add('hidden');
                    }
                }
                
                // V8.0: Show stats chart button only for POLIS company
                const statsButton = document.getElementById('stats-chart-button');
                if (statsButton) {
                    if (isPolisCompany) {
                        statsButton.classList.remove('hidden');
                    } else {
                        statsButton.classList.add('hidden');
                    }
                }
                
                // V8.1: Show Tornei stats chart button only for POLIS company
                const torneiStatsButton = document.getElementById('tornei-stats-chart-button');
                if (torneiStatsButton) {
                    if (isPolisCompany) {
                        torneiStatsButton.classList.remove('hidden');
                    } else {
                        torneiStatsButton.classList.add('hidden');
                    }
                }
                
                // V7.9: Fetch availability data from Firebase Realtime Database for POLIS (using global normalizePlayerName)
                let availabilityData = {};
                let availabilityDataNormalized = {}; // Normalized keys for matching
                if (isPolisCompany) {
                    try {
                        const FIREBASE_CONVOCAZIONI_URL = 'https://polis-2013-default-rtdb.europe-west1.firebasedatabase.app/convocazioni.json';
                        const response = await fetch(FIREBASE_CONVOCAZIONI_URL);
                        if (response.ok) {
                            availabilityData = await response.json() || {};
                            // V7.9: Create normalized version for case-insensitive matching (using global normalizePlayerName)
                            Object.keys(availabilityData).forEach(key => {
                                const normalizedKey = normalizePlayerName(key);
                                availabilityDataNormalized[normalizedKey] = availabilityData[key];
                            });
                            console.log(`üìä [V7.9] Dati disponibilit√† caricati da Firebase Realtime Database (${Object.keys(availabilityData).length} giocatori):`, availabilityData);
                        }
                    } catch (error) {
                        console.error('üìä [V7.9] Errore nel caricamento dei dati disponibilit√†:', error);
                    }
                }
                
                // V9.16: Build player data with availability percentages before sorting
                const playersWithData = playersToShow.map(p => {
                    // Handle both old string format and new object format
                    let playerName, playerKey;
                    if (typeof p === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerName = p;
                        playerKey = p;
                    } else {
                        // New format: object with numero, nome, etc.
                        playerName = `${p.numero} ${p.nome}`;
                        playerKey = playerName; // Use the display name as key for compatibility
                    }
                    
                    const count = attendanceData[playerKey] || 0;
                    const percentage = totalMatches > 0 ? Math.ceil((count / totalMatches) * 100) : 0;
                    
                    // V7.9: Get availability percentage for POLIS with improved matching (using global normalizePlayerName)
                    let availabilityPercentage = 'N/D';
                    let availabilityNumeric = -1; // For sorting purposes
                    if (isPolisCompany) {
                        // Try exact match first
                        let rawValue = availabilityData[playerName];
                        
                        // If no exact match, try normalized match (strips leading numbers)
                        if (rawValue === undefined) {
                            const normalizedPlayerName = normalizePlayerName(playerName);
                            rawValue = availabilityDataNormalized[normalizedPlayerName];
                        }
                        
                        // V7.4: Process the value if found (shows "0%" for zero, "N/D" only if missing) - rounded up to integer
                        if (rawValue !== undefined && rawValue !== null) {
                            if (typeof rawValue === 'number') {
                                // If value is between 0 and 1, multiply by 100, otherwise use as is, then round up
                                availabilityPercentage = Math.ceil(rawValue <= 1 ? rawValue * 100 : rawValue);
                                availabilityNumeric = availabilityPercentage;
                            } else if (typeof rawValue === 'string') {
                                // Handle string numbers
                                const numValue = parseFloat(rawValue);
                                if (!isNaN(numValue)) {
                                    availabilityPercentage = Math.ceil(numValue <= 1 ? numValue * 100 : numValue);
                                    availabilityNumeric = availabilityPercentage;
                                }
                            }
                        }
                    }
                    
                    return {
                        name: playerName,
                        count: count,
                        percentage: percentage,
                        availabilityPercentage: availabilityPercentage,
                        availabilityNumeric: availabilityNumeric
                    };
                });
                
                // V9.26: Sort by presences descending, then by availability percentage descending, then by attendance percentage descending, then alphabetically by name
                const sortedPlayers = playersWithData.sort((a, b) => {
                    if (b.count !== a.count) {
                        return b.count - a.count; // Primary sort: presences descending
                    }
                    if (b.availabilityNumeric !== a.availabilityNumeric) {
                        return b.availabilityNumeric - a.availabilityNumeric; // Secondary sort: availability percentage descending
                    }
                    if (b.percentage !== a.percentage) {
                        return b.percentage - a.percentage; // Tertiary sort: attendance percentage descending
                    }
                    // Quaternary sort: alphabetically by name (ignoring jersey number)
                    const nameA = a.name.replace(/^\d+\s*/, '').trim();
                    const nameB = b.name.replace(/^\d+\s*/, '').trim();
                    return nameA.localeCompare(nameB, 'it');
                });

                // V9.16: Ranking arrows - Compare with last week's ranking
                // V9.26: Calculate ranks considering ties (same presences + same availability + same attendance percentage = same rank)
                const currentRanking = [];
                let currentRank = 1;
                for (let i = 0; i < sortedPlayers.length; i++) {
                    if (i > 0) {
                        const prevPlayer = sortedPlayers[i - 1];
                        const currPlayer = sortedPlayers[i];
                        // Check if tied (same presences AND same availability AND same attendance percentage)
                        if (prevPlayer.count !== currPlayer.count || 
                            prevPlayer.availabilityNumeric !== currPlayer.availabilityNumeric ||
                            prevPlayer.percentage !== currPlayer.percentage) {
                            currentRank = i + 1; // Move to next rank if not tied
                        }
                        // Otherwise keep same rank (tied)
                    }
                    currentRanking.push({
                        name: sortedPlayers[i].name,
                        rank: currentRank
                    });
                }
                
                // Get last week's ranking from localStorage (company-specific)
                const companyKey = currentCompanyCode || 'default';
                const lastWeekRankingStr = localStorage.getItem(`lastWeekRanking_${companyKey}`);
                let lastWeekRanking = {};
                if (lastWeekRankingStr) {
                    try {
                        const rankingData = JSON.parse(lastWeekRankingStr);
                        lastWeekRanking = rankingData.ranking || {};
                    } catch (e) {
                        console.error('Error parsing last week ranking:', e);
                    }
                }
                
                // Check if we need to update the weekly snapshot (every Monday)
                const now = new Date();
                const lastUpdateStr = localStorage.getItem(`lastRankingUpdate_${companyKey}`);
                let shouldUpdate = false;
                
                if (!lastUpdateStr) {
                    shouldUpdate = true;
                } else {
                    // Helper function to get Monday of a given week
                    const getMondayOfWeek = (date) => {
                        const d = new Date(date);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
                        d.setDate(diff);
                        d.setHours(0, 0, 0, 0);
                        return d;
                    };
                    
                    const lastUpdate = new Date(lastUpdateStr);
                    const currentWeekMonday = getMondayOfWeek(now);
                    const lastUpdateWeekMonday = getMondayOfWeek(lastUpdate);
                    
                    // Update only if we're in a different week (comparing Mondays)
                    if (currentWeekMonday.getTime() !== lastUpdateWeekMonday.getTime()) {
                        shouldUpdate = true;
                    }
                }
                
                if (shouldUpdate) {
                    // Store current ranking as new baseline (company-specific)
                    const rankingMap = {};
                    currentRanking.forEach(item => {
                        rankingMap[item.name] = item.rank;
                    });
                    localStorage.setItem(`lastWeekRanking_${companyKey}`, JSON.stringify({
                        ranking: rankingMap,
                        date: now.toISOString()
                    }));
                    localStorage.setItem(`lastRankingUpdate_${companyKey}`, now.toISOString());
                    console.log(`üìä [V9.16] Updated weekly ranking snapshot for ${companyKey}`);
                }
                
                // Calculate rank changes
                const rankChanges = {};
                currentRanking.forEach(item => {
                    const lastRank = lastWeekRanking[item.name];
                    if (lastRank !== undefined) {
                        const change = lastRank - item.rank; // Positive means moved up
                        rankChanges[item.name] = change;
                    }
                });

                sortedPlayers.forEach((player, index) => {
                    const rankChange = rankChanges[player.name];
                    let arrowIcon = '';
                    // V9.18: Show "=" for unchanged position
                    if (rankChange !== undefined) {
                        if (rankChange > 0) {
                            arrowIcon = '<span style="color: green; margin-left: 4px;">‚ñ≤</span>';
                        } else if (rankChange < 0) {
                            arrowIcon = '<span style="color: red; margin-left: 4px;">‚ñº</span>';
                        } else {
                            // rankChange === 0: same position
                            arrowIcon = '<span style="color: gray; margin-left: 4px;">=</span>';
                        }
                    }
                    
                    // V9.27: Display only player name without jersey number
                    const playerNameOnly = player.name.replace(/^\d+\s*/, '').trim();
                    
                    // V9.28: Determine if this is the top player (highest count)
                    const isTopPlayer = index === 0 && player.count > 0;
                    const topPlayerBadge = isTopPlayer ? '<span class="top-player-badge">üèÜ Top Player</span>' : '';
                    
                    // V9.28: Create progress bar for percentage
                    let progressBarColor = 'low';
                    if (player.percentage >= 70) {
                        progressBarColor = 'high';
                    } else if (player.percentage >= 40) {
                        progressBarColor = 'medium';
                    }
                    
                    const progressBarHTML = `
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressBarColor}" style="width: ${player.percentage}%">
                                ${player.percentage}%
                            </div>
                        </div>
                    `;
                    
                    // V9.30: Get player data for modal
                    const trend = getPlayerTrend(playerNameOnly);
                    const chartData = getPlayerChartData(playerNameOnly);
                    const recentCallups = getRecentCallups(playerNameOnly);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <span class="player-name-clickable">${playerNameOnly}</span>${topPlayerBadge}
                        </td>
                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${player.count}${arrowIcon}</td>
                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${progressBarHTML}</td>
                        ${isPolisCompany ? `<td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${player.availabilityPercentage}${player.availabilityPercentage !== 'N/D' ? '%' : ''}</td>` : ''}
                    `;
                    
                    attendanceList.appendChild(row);
                    
                    // V9.30: Add click handler to open modal
                    const nameElement = row.querySelector('.player-name-clickable');
                    if (nameElement) {
                        nameElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                            openPlayerModal(playerNameOnly, trend, chartData, recentCallups);
                        });
                    }
                });
                
                console.log(`üìä [DIAGNOSTIC] Tabella presenze aggiornata con ${sortedPlayers.length} giocatori`);
                
                // Hide loading spinner and show content
                const loadingElement = document.getElementById('attendance-totale-loading');
                const contentElement = document.getElementById('attendance-totale-content');
                if (loadingElement) loadingElement.classList.add('hidden');
                if (contentElement) contentElement.classList.remove('hidden');
            }

            // Function to update filtered attendance tables based on convocation history
            async function updateAttendanceTables() {
                console.log(`üìä [DIAGNOSTIC] updateAttendanceTables chiamata con ${convocationHistory.length} convocazioni storiche`);
                
                // Clear all tables
                attendanceListAmichevoli.innerHTML = '';
                attendanceListTornei.innerHTML = '';
                attendanceListCampionato.innerHTML = '';
                
                // Calculate filtered attendance data and match counts
                const amichevoliData = {};
                const torneiData = {};
                const campionatoData = {};
                let amichevoliCount = 0;
                let torneiCount = 0;
                let campionatoCount = 0;
                
                // Process each convocation and count players by type
                convocationHistory.forEach(convocation => {
                    const tipo = convocation.details?.tipo || 'N/D';
                    const players = convocation.players || [];
                    
                    // Count matches by type
                    if (tipo === 'Amichevole') {
                        amichevoliCount++;
                    } else if (tipo === 'Torneo') {
                        torneiCount++;
                    } else if (tipo === 'Campionato') {
                        campionatoCount++;
                    }
                    
                    players.forEach(player => {
                        // Handle both old string format and new object format
                        let playerKey;
                        if (typeof player === 'string') {
                            // Old format: "10 ROSSI MARIO"
                            playerKey = player;
                        } else {
                            // New format: object with numero, nome, etc.
                            playerKey = `${player.numero} ${player.nome}`;
                        }
                        
                        if (tipo === 'Amichevole') {
                            amichevoliData[playerKey] = (amichevoliData[playerKey] || 0) + 1;
                        } else if (tipo === 'Torneo') {
                            torneiData[playerKey] = (torneiData[playerKey] || 0) + 1;
                        } else if (tipo === 'Campionato') {
                            campionatoData[playerKey] = (campionatoData[playerKey] || 0) + 1;
                        }
                    });
                });
                
                // V7.8: Update section headers with match counts - Fixed querySelector to use IDs instead of :has()
                const amichevoliHeader = document.getElementById('amichevoli-header');
                const torneiHeader = document.getElementById('tornei-header');
                const campionatoHeader = document.getElementById('campionato-header');
                
                if (amichevoliHeader) {
                    amichevoliHeader.innerHTML = `ü§ù Riepilogo Presenze Amichevoli<br><span class="text-gray-600 text-base font-normal">${amichevoliCount} ${amichevoliCount === 1 ? 'partita' : 'partite'}</span>`;
                }
                if (torneiHeader) {
                    torneiHeader.innerHTML = `üèÜ Riepilogo Presenze Tornei<br><span class="text-gray-600 text-base font-normal">${torneiCount} ${torneiCount === 1 ? 'torneo' : 'tornei'}</span>`;
                }
                if (campionatoHeader) {
                    campionatoHeader.innerHTML = `‚öΩÔ∏è Riepilogo Presenze Campionato<br><span class="text-gray-600 text-base font-normal">${campionatoCount} ${campionatoCount === 1 ? 'partita' : 'partite'}</span>`;
                }
                
                // Use companyPlayers instead of global players array to show correct company data
                const playersToShow = companyPlayers.length > 0 ? companyPlayers : players;
                
                // V7.7: Fetch disptornei data from Firebase Realtime Database for POLIS
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                let dispTorneiData = {};
                let dispTorneiDataNormalized = {};
                
                // V7.7: Show/hide Tornei availability header based on company
                const torneiAvailabilityHeader = document.getElementById('tornei-availability-header');
                if (torneiAvailabilityHeader) {
                    if (isPolisCompany) {
                        torneiAvailabilityHeader.classList.remove('hidden');
                    } else {
                        torneiAvailabilityHeader.classList.add('hidden');
                    }
                }
                
                if (isPolisCompany) {
                    try {
                        const FIREBASE_DISPTORNEI_URL = 'https://polis-2013-default-rtdb.europe-west1.firebasedatabase.app/disptornei.json';
                        const response = await fetch(FIREBASE_DISPTORNEI_URL);
                        if (response.ok) {
                            dispTorneiData = await response.json() || {};
                            // V7.9: Create normalized version for case-insensitive matching (using global normalizePlayerName)
                            Object.keys(dispTorneiData).forEach(key => {
                                const normalizedKey = normalizePlayerName(key);
                                dispTorneiDataNormalized[normalizedKey] = dispTorneiData[key];
                            });
                            console.log(`üìä [V7.9] Dati disptornei caricati da Firebase Realtime Database (${Object.keys(dispTorneiData).length} giocatori):`, dispTorneiData);
                        }
                    } catch (error) {
                        console.error('üìä [V7.9] Errore nel caricamento dei dati disptornei:', error);
                    }
                }
                
                // Populate Amichevoli table
                populateAttendanceTable(attendanceListAmichevoli, playersToShow, amichevoliData, 'Amichevoli', null, null);
                
                // Populate Tornei table with availability data for POLIS
                populateAttendanceTable(attendanceListTornei, playersToShow, torneiData, 'Tornei', isPolisCompany ? dispTorneiData : null, isPolisCompany ? dispTorneiDataNormalized : null);
                
                // Populate Campionato table
                populateAttendanceTable(attendanceListCampionato, playersToShow, campionatoData, 'Campionato', null, null);
                
                console.log(`üìä [DIAGNOSTIC] Tabelle presenze filtrate aggiornate`);
                
                // Hide loading spinner and show content - Always hide spinner when tables are ready
                const loadingElement = document.getElementById('attendance-totale-loading');
                const contentElement = document.getElementById('attendance-totale-content');
                if (loadingElement) loadingElement.classList.add('hidden');
                if (contentElement) contentElement.classList.remove('hidden');
            }

            // Helper function to populate a specific attendance table
            // V7.9: Added availabilityData and availabilityDataNormalized parameters for Tornei table (uses global normalizePlayerName)
            function populateAttendanceTable(tableElement, players, attendanceData, tableType, availabilityData, availabilityDataNormalized) {
                const sortedPlayers = players.map(p => {
                    // Handle both old string format and new object format
                    let playerName, playerKey;
                    if (typeof p === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerName = p;
                        playerKey = p;
                    } else {
                        // New format: object with numero, nome, etc.
                        playerName = `${p.numero} ${p.nome}`;
                        playerKey = playerName; // Use the display name as key for compatibility
                    }
                    
                    return {
                        name: playerName,
                        count: attendanceData[playerKey] || 0
                    };
                }).sort((a, b) => b.count - a.count);

                const hasAvailabilityData = availabilityData !== null && availabilityData !== undefined;
                const colSpan = hasAvailabilityData ? 3 : 2;
                
                // V8.6: Use responsive padding for tornei table
                const isTorneiTable = tableType === 'Tornei';
                const cellPadding = isTorneiTable ? 'px-2 sm:px-6 py-4' : 'px-6 py-4';

                if (sortedPlayers.length === 0) {
                    // Show empty state message only if no players at all
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="${colSpan}" class="${cellPadding} text-center text-gray-500 italic">
                            Nessun giocatore disponibile per ${tableType}
                        </td>
                    `;
                    tableElement.appendChild(row);
                } else {
                    // Show ALL players including those with 0 attendance
                    sortedPlayers.forEach(player => {
                        let availabilityCell = '';
                        
                        // V7.9: Add availability percentage for Tornei table if data is available (uses global normalizePlayerName)
                        if (hasAvailabilityData) {
                            let availabilityPercentage = 'N/D';
                            
                            // Try exact match first
                            let rawValue = availabilityData[player.name];
                            
                            // If no exact match, try normalized match (strips leading numbers)
                            if (rawValue === undefined && availabilityDataNormalized) {
                                const normalizedPlayerName = normalizePlayerName(player.name);
                                rawValue = availabilityDataNormalized[normalizedPlayerName];
                            }
                            
                            // Process the value if found - rounded up to integer (no decimals)
                            if (rawValue !== undefined && rawValue !== null) {
                                if (typeof rawValue === 'number') {
                                    // If value is between 0 and 1, multiply by 100, otherwise use as is, then round up
                                    availabilityPercentage = Math.ceil(rawValue <= 1 ? rawValue * 100 : rawValue);
                                } else if (typeof rawValue === 'string') {
                                    // Handle string numbers
                                    const numValue = parseFloat(rawValue);
                                    if (!isNaN(numValue)) {
                                        availabilityPercentage = Math.ceil(numValue <= 1 ? numValue * 100 : numValue);
                                    }
                                }
                            }
                            
                            availabilityCell = `<td class="${cellPadding} whitespace-nowrap text-sm text-gray-500 text-center">${availabilityPercentage}${availabilityPercentage !== 'N/D' ? '%' : ''}</td>`;
                        }
                        
                        // V9.27: Display only player name without jersey number
                        const playerNameOnly = player.name.replace(/^\d+\s*/, '').trim();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="${cellPadding} whitespace-nowrap text-sm font-medium text-gray-900">${playerNameOnly}</td>
                            <td class="${cellPadding} whitespace-nowrap text-sm text-gray-500 text-center">${player.count}</td>
                            ${availabilityCell}
                        `;
                        tableElement.appendChild(row);
                    });
                }
            }

            // Demo version for loadHistory when Firebase is not available
            function loadHistoryDemo() {
                historyList.innerHTML = '';
                // Get today's date in YYYY-MM-DD format
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                
                // Create sample demo data for history using consistent player names from attendance data
                const demoHistory = [
                    {
                        id: 'demo-today',
                        createdAt: new Date().toISOString(),
                        details: {
                            avversario: 'Test Oggi',
                            campo: 'Campo Oggi',
                            data: todayString, // TODAY'S DATE
                            orarioConvocazione: '14:30',
                            orarioPartita: '15:00',
                            tipo: 'Amichevole'
                        },
                        players: ['10 AZZURRI LUCA', '1 ROSSI MARIO'] // Players called up today
                    },
                    {
                        id: 'demo-1',
                        createdAt: new Date(2024, 1, 15, 14, 30).toISOString(),
                        details: {
                            avversario: 'FC Demo Avversario',
                            campo: 'Campo Comunale Demo',
                            data: '2024-02-20',
                            orarioConvocazione: '14:30',
                            orarioPartita: '15:00',
                            tipo: 'Campionato'
                        },
                        players: ['1 ROSSI MARIO', '2 BIANCHI LUIGI', '3 VERDI GIUSEPPE']
                    },
                    {
                        id: 'demo-2',
                        createdAt: new Date(2024, 1, 8, 10, 15).toISOString(),
                        details: {
                            avversario: 'Squadra Test',
                            campo: 'Centro Sportivo',
                            data: '2024-02-10',
                            orarioConvocazione: '09:30',
                            orarioPartita: '10:00',
                            tipo: 'Amichevole'
                        },
                        players: ['10 AZZURRI LUCA', '4 NERI ANTONIO']
                    },
                    {
                        id: 'demo-3',
                        createdAt: new Date(2024, 1, 1, 16, 0).toISOString(),
                        details: {
                            avversario: 'üèÜ Torneo Cittadino',
                            campo: 'Stadio Principale',
                            data: '2024-02-05',
                            orarioConvocazione: '15:30',
                            orarioPartita: '16:00',
                            tipo: 'Torneo'
                        },
                        players: ['6 BLU MARCO', '5 GIALLI FRANCESCO', '8 ROSA ANDREA']
                    }
                ];

                // Set demo convocation history for attendance filtering
                convocationHistory = [...demoHistory];
                allConvocationHistory = [...demoHistory]; // V9.14: Store all history for filtering
                
                // V9.14: Populate month dropdown with available months
                populateMonthDropdown();

                if (demoHistory.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Nessuna convocazione registrata. (Modalit√† Demo)</p>';
                    return;
                }
                
                // V9.14: Use renderFilteredHistory instead of manual rendering
                renderFilteredHistory();
                
                // Update filtered attendance tables after loading demo history data
                updateAttendanceTables();
                
                // V7.10: Update total attendance table (Riepilogo Totale) for demo mode
                loadAttendanceDemo();
            }

            // Demo version for loadAttendance when Firebase is not available
            function loadAttendanceDemo() {
                attendanceList.innerHTML = '';
                
                // Calculate total attendance from convocationHistory (sum of all categories)
                const demoAttendanceData = {};
                convocationHistory.forEach(convocation => {
                    const players = convocation.players || [];
                    players.forEach(player => {
                        // Handle both old string format and new object format
                        let playerKey;
                        if (typeof player === 'string') {
                            playerKey = player;
                        } else {
                            playerKey = `${player.numero} ${player.nome}`;
                        }
                        demoAttendanceData[playerKey] = (demoAttendanceData[playerKey] || 0) + 1;
                    });
                });
                
                // V7.2: Calculate total matches from convocationHistory
                const totalMatches = convocationHistory.length;
                const totalMatchesCountElement = document.getElementById('total-matches-count');
                if (totalMatchesCountElement) {
                    // V9.28: Use count-up animation instead of direct text update
                    animateCountUp(totalMatchesCountElement, totalMatches);
                }
                console.log(`üìä [V7.2 Demo] Partite totali: ${totalMatches}`);
                
                // V7.2: Check if company is POLIS to show availability column
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                const availabilityHeader = document.getElementById('availability-percentage-header');
                if (availabilityHeader) {
                    if (isPolisCompany) {
                        availabilityHeader.classList.remove('hidden');
                    } else {
                        availabilityHeader.classList.add('hidden');
                    }
                }
                
                const playersToShow = companyPlayers.length > 0 ? companyPlayers : players;
                const sortedPlayers = playersToShow.map(p => {
                    // Handle both old string format and new object format
                    let playerName, playerKey;
                    if (typeof p === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerName = p;
                        playerKey = p;
                    } else {
                        // New format: object with numero, nome, etc.
                        playerName = `${p.numero} ${p.nome}`;
                        playerKey = playerName; // Use the display name as key for compatibility
                    }
                    
                    return {
                        name: playerName,
                        count: demoAttendanceData[playerKey] || 0
                    };
                }).sort((a, b) => b.count - a.count);

                sortedPlayers.forEach((player, index) => {
                    // V7.4: Calculate percentage of convocation (rounded up to integer)
                    const percentage = totalMatches > 0 ? Math.ceil((player.count / totalMatches) * 100) : 0;
                    
                    // V9.27: Display only player name without jersey number
                    const playerNameOnly = player.name.replace(/^\d+\s*/, '').trim();
                    
                    // V9.28: Determine if this is the top player (highest count)
                    const isTopPlayer = index === 0 && player.count > 0;
                    const topPlayerBadge = isTopPlayer ? '<span class="top-player-badge">üèÜ Top Player</span>' : '';
                    
                    // V9.28: Create progress bar for percentage
                    let progressBarColor = 'low';
                    if (percentage >= 70) {
                        progressBarColor = 'high';
                    } else if (percentage >= 40) {
                        progressBarColor = 'medium';
                    }
                    
                    const progressBarHTML = `
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressBarColor}" style="width: ${percentage}%">
                                ${percentage}%
                            </div>
                        </div>
                    `;
                    
                    // V9.30: Get player data for modal
                    const trend = getPlayerTrend(playerNameOnly);
                    const chartData = getPlayerChartData(playerNameOnly);
                    const recentCallups = getRecentCallups(playerNameOnly);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <span class="player-name-clickable">${playerNameOnly}</span>${topPlayerBadge}
                        </td>
                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${player.count} <span class="text-xs text-blue-600">(Demo)</span></td>
                        <td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${progressBarHTML}</td>
                        ${isPolisCompany ? `<td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">N/D</td>` : ''}
                    `;
                    
                    attendanceList.appendChild(row);
                    
                    // V9.30: Add click handler to open modal
                    const nameElement = row.querySelector('.player-name-clickable');
                    if (nameElement) {
                        nameElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                            openPlayerModal(playerNameOnly, trend, chartData, recentCallups);
                        });
                    }
                });
                
                // Hide loading spinner and show content
                const loadingElement = document.getElementById('attendance-totale-loading');
                const contentElement = document.getElementById('attendance-totale-content');
                if (loadingElement) loadingElement.classList.add('hidden');
                if (contentElement) contentElement.classList.remove('hidden');
                
                // Re-render players to apply already-called-today styling
                if (userRole === 'mister') {
                    renderPlayers();
                }
            }

            function renderPlayers() {
                playersList.innerHTML = '';
                const playersToRender = companyPlayers.length > 0 ? companyPlayers : players;
                playersToRender.forEach(player => {
                    const li = document.createElement('li');
                    
                    // Handle both old string format and new object format
                    let displayName, playerKey;
                    if (typeof player === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        displayName = player;
                        playerKey = player;
                    } else {
                        // New format: object with numero, nome, etc.
                        displayName = `${player.numero} ${player.nome}`;
                        playerKey = displayName; // Use the display name as key for compatibility
                    }
                    
                    li.textContent = displayName;
                    li.className = 'player-item p-3 bg-white text-gray-800 rounded-lg shadow-sm border border-gray-200';
                    li.dataset.player = playerKey;
                    
                    // Check if player was already called up today FIRST (highest priority for Mister view)
                    if (userRole === 'mister' && isPlayerCalledToday(playerKey)) {
                        li.classList.add('already-called-today');
                    }
                    // Check for unavailable players (only if not already called today)
                    else {
                        // V9.13: Check if there are sessions in current week
                        const hasCurrentWeekSessions = hasCurrentWeekTrainingSessions();
                        
                        // V9.12: Calculate automatic training status (only if sessions exist)
                        const autoTrainingStatus = hasCurrentWeekSessions ? getAutomaticTrainingStatus(playerKey) : null;
                        let finalStatuses = [];
                        
                        // Get manual statuses from unavailablePlayers
                        if (unavailablePlayers.has(playerKey)) {
                            const status = unavailablePlayers.get(playerKey);
                            const manualStatuses = Array.isArray(status) ? status : [status];
                            
                            if (hasCurrentWeekSessions) {
                                // V9.12: If sessions exist, filter out training statuses (they're auto-calculated)
                                const filteredManualStatuses = manualStatuses.filter(s => 
                                    s !== 'Zero allenamenti' && 
                                    s !== 'Solo 1 allenamento' && 
                                    s !== 'Solo 2 allenamenti'
                                );
                                finalStatuses = filteredManualStatuses;
                            } else {
                                // V9.13: If NO sessions exist, keep all manual statuses including training ones
                                finalStatuses = manualStatuses;
                            }
                        }
                        
                        // V9.12: Add automatic training status if exists
                        if (autoTrainingStatus) {
                            finalStatuses.push(autoTrainingStatus);
                        }
                        
                        // Apply styling if there are any statuses
                        if (finalStatuses.length > 0) {
                            applyPlayerStatusStyle(li, finalStatuses);
                            
                            // V9.10: Add icons for Infortunato and Squalificato in player badge
                            if (finalStatuses.includes('Infortunato')) {
                                li.textContent = `üöë ${displayName}`;
                            } else if (finalStatuses.includes('Squalificato')) {
                                li.textContent = `üü• ${displayName}`;
                            }
                        }
                    }

                    li.addEventListener('click', () => {
                        if (userRole === 'mister') {
                            // V9.13: Check if there are sessions in current week
                            const hasCurrentWeekSessions = hasCurrentWeekTrainingSessions();
                            
                            // V9.12: Check for both manual unavailability and automatic training status
                            const autoTrainingStatus = hasCurrentWeekSessions ? getAutomaticTrainingStatus(playerKey) : null;
                            const hasManualStatus = unavailablePlayers.has(playerKey);
                            
                            if (hasManualStatus || autoTrainingStatus) {
                                // Build combined status for display
                                let combinedStatus = [];
                                if (hasManualStatus) {
                                    const status = unavailablePlayers.get(playerKey);
                                    const manualStatuses = Array.isArray(status) ? status : [status];
                                    
                                    if (hasCurrentWeekSessions) {
                                        // V9.12: If sessions exist, filter out training statuses (auto-calculated)
                                        combinedStatus = manualStatuses.filter(s => 
                                            s !== 'Zero allenamenti' && 
                                            s !== 'Solo 1 allenamento' && 
                                            s !== 'Solo 2 allenamenti'
                                        );
                                    } else {
                                        // V9.13: If NO sessions exist, keep all manual statuses including training ones
                                        combinedStatus = manualStatuses;
                                    }
                                }
                                if (autoTrainingStatus) {
                                    combinedStatus.push(autoTrainingStatus);
                                }
                                
                                showUnavailablePlayerModal(playerKey, combinedStatus.length === 1 ? combinedStatus[0] : combinedStatus);
                                return; // Don't allow selection of unavailable players (unless forzato)
                            }
                            
                            // Check if player was already called up today
                            if (isPlayerCalledToday(playerKey)) {
                                showAlreadyCalledModal(playerKey);
                                return; // Show confirmation modal instead of direct selection
                            }
                            
                            li.classList.toggle('selected-mister');
                            updateSelectedPlayersLiveList(playerKey, li.classList.contains('selected-mister'));
                        } else if (isDirigente()) {
                            tempPlayerName = playerKey;
                            showModal();
                        }
                    });
                    playersList.appendChild(li);
                });
            }

            function updateSelectedPlayersLiveList(playerName, isSelected) {
                const liveId = `live-${playerName.replace(/\s+/g, '-')}`;
                if (isSelected) {
                    const newLi = document.createElement('li');
                    newLi.textContent = playerName;
                    newLi.id = liveId;
                    newLi.className = "font-medium p-1";
                    selectedPlayersLiveList.appendChild(newLi);
                } else {
                    const playerToRemove = document.getElementById(liveId);
                    if (playerToRemove) {
                        playerToRemove.remove();
                    }
                }
                
                // Update title with player count
                updateSelectedPlayersTitle();
            }
            
            function updateSelectedPlayersTitle() {
                const count = selectedPlayersLiveList.children.length;
                if (selectedPlayersTitle) {
                    selectedPlayersTitle.textContent = `Giocatori Convocati (${count})`;
                }
            }

            function getSelectedPlayers() {
                if (userRole === 'mister') {
                    return Array.from(document.querySelectorAll('.player-item.selected-mister')).map(item => item.textContent);
                }
                return Array.from(unavailablePlayers.keys());
            }

            function getMatchDetails() {
                return {
                    campo: document.getElementById('campo').value || 'N/D',
                    avversario: document.getElementById('avversario').value || 'N/D',
                    data: document.getElementById('data-partita').value || 'N/D',
                    orarioConvocazione: document.getElementById('orario-convocazione').value || 'N/D',
                    orarioPartita: document.getElementById('orario-partita').value || 'N/D',
                    tipo: document.getElementById('tipo-partita').value || 'N/D',
                    misterPartita: document.getElementById('mister-partita').value || 'N/D',
                    misterTipo: document.getElementById('mister-tipo').value || 'N/D',
                };
            }

            // Helper function to reset Mister's selections without confirmation dialog
            function resetMisterSelectionsWithoutConfirm() {
                if (userRole === 'mister') {
                    // Clear only Mister's selected players from UI
                    // V7.5: Also remove unavailable-forced class
                    const selectedPlayers = document.querySelectorAll('.player-item.selected-mister');
                    selectedPlayers.forEach(player => {
                        player.classList.remove('selected-mister', 'unavailable-forced');
                    });

                    // Clear the live selected players list
                    if (selectedPlayersLiveList) {
                        selectedPlayersLiveList.innerHTML = '';
                        updateSelectedPlayersTitle();
                    }

                    // Clear match details form
                    const campos = ['campo', 'avversario', 'data-partita', 'orario-convocazione', 'orario-partita'];
                    campos.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = '';
                            // Reset avversario field styling if it was modified for Torneo
                            if (fieldId === 'avversario') {
                                field.readOnly = false;
                                field.style.backgroundColor = 'white';
                                field.style.textAlign = 'left';
                                field.style.fontSize = '';
                            }
                        }
                    });
                    
                    // Reset tipo partita dropdown
                    const tipoPartita = document.getElementById('tipo-partita');
                    if (tipoPartita) {
                        tipoPartita.selectedIndex = 0;
                    }
                    
                    // Reset mister dropdowns
                    const misterPartita = document.getElementById('mister-partita');
                    const misterTipo = document.getElementById('mister-tipo');
                    if (misterPartita) {
                        misterPartita.selectedIndex = 0;
                    }
                    if (misterTipo) {
                        misterTipo.selectedIndex = 0;
                    }

                    // Clear localStorage data related to match details (keep unavailable players)
                    localStorage.removeItem('selectedPlayers');
                    localStorage.removeItem('matchDetails');

                    // Re-render players to ensure UI is clean (this preserves unavailable players styling)
                    renderPlayers();
                }
            }

            function resetPlayerSelections() {
                if (userRole === 'mister') {
                    // Mister role: only reset his selections, keep Dirigente's unavailable players
                    if (confirm('Sei sicuro di voler azzerare le tue convocazioni? Questa azione non pu√≤ essere annullata.')) {
                        resetMisterSelectionsWithoutConfirm();
                        // Show success message
                        showMessage("Le tue convocazioni sono state azzerate. I giocatori non disponibili segnalati dal Dirigente sono rimasti invariati.", "text-green-600");
                    }
                } else if (isDirigente()) {
                    // Dirigente role: reset everything including unavailable players
                    if (confirm('Sei sicuro di voler azzerare tutte le selezioni e le indisponibilit√†? Questa azione non pu√≤ essere annullata.')) {
                        // Clear all selected players from UI
                        const selectedPlayers = document.querySelectorAll('.player-item.selected-mister');
                        selectedPlayers.forEach(player => {
                            player.classList.remove('selected-mister');
                        });

                        // Clear unavailable players (for dirigente role)
                        unavailablePlayers.clear();

                        // Clear the live selected players list
                        if (selectedPlayersLiveList) {
                            selectedPlayersLiveList.innerHTML = '';
                            updateSelectedPlayersTitle();
                        }

                        // Clear match details form
                        const campos = ['campo', 'avversario', 'data-partita', 'orario-convocazione', 'orario-partita'];
                        campos.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (field) {
                                field.value = '';
                                // Reset avversario field styling if it was modified for Torneo
                                if (fieldId === 'avversario') {
                                    field.readOnly = false;
                                    field.style.backgroundColor = 'white';
                                    field.style.textAlign = 'left';
                                    field.style.fontSize = '';
                                }
                            }
                        });
                        
                        // Reset tipo partita dropdown
                        const tipoPartita = document.getElementById('tipo-partita');
                        if (tipoPartita) {
                            tipoPartita.selectedIndex = 0;
                        }

                        // Clear any localStorage data related to selections
                        localStorage.removeItem('selectedPlayers');
                        localStorage.removeItem('matchDetails');

                        // Re-render players to ensure UI is clean
                        renderPlayers();

                        // Show success message
                        showMessage("Tutte le selezioni e le indisponibilit√† sono state azzerate.", "text-green-600");
                    }
                }
            }

            // Share handler functions
            let shareImageDataUrl = null; // Store generated image for sharing

            // Safe JSON functions for HTML attributes to prevent parsing errors
            function safeJSONStringify(obj) {
                try {
                    const jsonString = JSON.stringify(obj);
                    // Escape quotes and other special characters for HTML attributes
                    return jsonString
                        .replace(/'/g, '&#39;')  // Replace single quotes
                        .replace(/"/g, '&quot;') // Replace double quotes
                        .replace(/</g, '&lt;')   // Replace less than
                        .replace(/>/g, '&gt;')   // Replace greater than
                        .replace(/&/g, '&amp;'); // Replace ampersand (do this last)
                } catch (error) {
                    console.error('Error stringifying JSON:', error);
                    return '{}';
                }
            }

            function safeJSONParse(str) {
                try {
                    if (!str) return null;
                    // Unescape HTML entities back to original characters
                    const unescaped = str
                        .replace(/&amp;/g, '&')    // Restore ampersand (do this first)
                        .replace(/&lt;/g, '<')     // Restore less than
                        .replace(/&gt;/g, '>')     // Restore greater than
                        .replace(/&quot;/g, '"')   // Restore double quotes
                        .replace(/&#39;/g, "'");   // Restore single quotes
                    return JSON.parse(unescaped);
                } catch (error) {
                    console.error('Error parsing JSON:', error, 'Original string:', str);
                    return null;
                }
            }

            async function handleWebShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    // Prepare share data
                    const shareText = `üèüÔ∏è Convocazioni Ufficiali üèüÔ∏è\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario: ${matchDetails.orarioPartita}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\n‚öΩ Rosterkick`;
                    
                    // Try Web Share API with files first (for browsers that support it)
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert data URL to blob
                            const response = await fetch(shareImageDataUrl);
                            const blob = await response.blob();
                            const file = new File([blob], `convocazioni-${matchDetails.avversario}.png`, { type: 'image/png' });

                            const shareDataWithFile = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                files: [file]
                            };

                            // Check if sharing with files is supported
                            if (navigator.canShare(shareDataWithFile)) {
                                await navigator.share(shareDataWithFile);
                                hideShareModal();
                                showMessage("Convocazioni condivise con successo!", "text-green-600");
                                return;
                            }
                        } catch (fileShareError) {
                            console.log('File sharing not supported, trying text-only share');
                        }
                    }
                    
                    // Fallback to text-only Web Share API
                    if (navigator.share) {
                        try {
                            const shareDataTextOnly = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                url: window.location.href
                            };

                            await navigator.share(shareDataTextOnly);
                            hideShareModal();
                            showMessage("Testo condiviso! Condividi l'immagine manualmente se necessario.", "text-blue-600");
                            
                            // Also trigger download for user convenience
                            setTimeout(() => handleDownloadImage(), 1000);
                            return;
                        } catch (textShareError) {
                            console.log('Text sharing failed, falling back to download');
                        }
                    }
                    
                    // Final fallback: download the image
                    handleDownloadImage();
                    showMessage("Web Share non disponibile. Immagine scaricata!", "text-orange-600");
                    
                } catch (error) {
                    console.error('Errore nella condivisione:', error);
                    // If everything fails, offer download instead
                    if (shareImageDataUrl) {
                        handleDownloadImage();
                        showMessage("Errore nella condivisione. Immagine scaricata!", "text-red-600");
                    } else {
                        showMessage("Errore nella condivisione. Prova con un'altra opzione.", "text-red-600");
                    }
                }
            }

            async function handleWhatsAppShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    const text = encodeURIComponent(`üèüÔ∏è Convocazioni Ufficiali üèüÔ∏è\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario: ${matchDetails.orarioPartita}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\n‚öΩ Rosterkick`);
                    
                    const whatsappUrl = `https://wa.me/?text=${text}`;
                    window.open(whatsappUrl, '_blank');
                    
                    hideShareModal();
                    showMessage("Link WhatsApp aperto! Condividi l'immagine manualmente.", "text-blue-600");
                    
                    // Also trigger download for user convenience
                    setTimeout(() => handleDownloadImage(), 1000);
                } catch (error) {
                    console.error('Errore WhatsApp:', error);
                    showMessage("Errore nell'apertura di WhatsApp.", "text-red-600");
                }
            }

            async function handleTelegramShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    const text = encodeURIComponent(`üèüÔ∏è Convocazioni Ufficiali üèüÔ∏è\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario: ${matchDetails.orarioPartita}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\n‚öΩ Rosterkick`);
                    
                    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${text}`;
                    window.open(telegramUrl, '_blank');
                    
                    hideShareModal();
                    showMessage("Link Telegram aperto! Condividi l'immagine manualmente.", "text-blue-600");
                    
                    // Also trigger download for user convenience
                    setTimeout(() => handleDownloadImage(), 1000);
                } catch (error) {
                    console.error('Errore Telegram:', error);
                    showMessage("Errore nell'apertura di Telegram.", "text-red-600");
                }
            }

            async function handleEmailShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    const subject = encodeURIComponent(`Convocazioni per ${matchDetails.avversario}`);
                    const body = encodeURIComponent(`Convocazioni Ufficiali\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario Partita: ${matchDetails.orarioPartita}\nOrario Convocazione: ${matchDetails.orarioConvocazione}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\nGenerato con Rosterkick`);
                    
                    const emailUrl = `mailto:?subject=${subject}&body=${body}`;
                    window.location.href = emailUrl;
                    
                    hideShareModal();
                    showMessage("Client email aperto! Aggiungi l'immagine come allegato.", "text-blue-600");
                    
                    // Also trigger download for user convenience
                    setTimeout(() => handleDownloadImage(), 1000);
                } catch (error) {
                    console.error('Errore Email:', error);
                    showMessage("Errore nell'apertura del client email.", "text-red-600");
                }
            }

            async function handleCopyLink() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    // Copy the data URL to clipboard
                    await navigator.clipboard.writeText(shareImageDataUrl);
                    
                    hideShareModal();
                    showMessage("Link immagine copiato negli appunti!", "text-green-600");
                } catch (error) {
                    console.error('Errore copia link:', error);
                    // Fallback: offer download instead
                    showMessage("Impossibile copiare il link. Scarico l'immagine...", "text-yellow-600");
                    handleDownloadImage();
                }
            }

            async function handleDownloadImage() {
                try {
                    if (!shareImageDataUrl) {
                        shareImageDataUrl = await generateShareImageData();
                    }
                    if (!shareImageDataUrl) return;

                    const matchDetails = getMatchDetails();
                    const link = document.createElement('a');
                    link.href = shareImageDataUrl;
                    link.download = `convocazioni-${matchDetails.avversario}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    hideShareModal();
                    showMessage("Immagine scaricata con successo!", "text-green-600");
                } catch (error) {
                    console.error('Errore download:', error);
                    showMessage("Errore nel download dell'immagine.", "text-red-600");
                }
            }

            // Helper function to generate image data without downloading
            async function generateShareImageData() {
                try {
                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    const sharePlayersList = document.getElementById('share-players-list');
                    sharePlayersList.innerHTML = '';
                    document.getElementById('share-campo').textContent = matchDetails.campo;
                    document.getElementById('share-avversario').textContent = matchDetails.avversario;
                    
                    let formattedDate = 'N/D';
                    if (matchDetails.data !== 'N/D') {
                        const dateObj = new Date(matchDetails.data + 'T00:00:00'); 
                        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                        formattedDate = dateObj.toLocaleDateString('it-IT', options);
                    }
                    
                    document.getElementById('share-data-partita').textContent = formattedDate;
                    document.getElementById('share-orario-convocazione').textContent = matchDetails.orarioConvocazione;
                    document.getElementById('share-orario-partita').textContent = matchDetails.orarioPartita;
                    document.getElementById('share-tipo').textContent = matchDetails.tipo;
                    document.getElementById('share-mister-partita').textContent = matchDetails.misterPartita || 'N/D';
                    document.getElementById('share-mister-tipo').textContent = matchDetails.misterTipo || 'N/D';

                    if (selectedPlayers.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = "Nessun giocatore convocato.";
                        li.className = "text-gray-500 italic text-center";
                        sharePlayersList.appendChild(li);
                    } else {
                        selectedPlayers.forEach(player => {
                            const li = document.createElement('li');
                            if (typeof player === 'string') {
                                li.textContent = player;
                            } else {
                                li.textContent = `${player.numero} ${player.nome}`;
                            }
                            li.className = 'font-medium';
                            sharePlayersList.appendChild(li);
                        });
                    }
                    
                    const shareView = document.getElementById('share-view');
                    shareView.style.position = 'relative';
                    shareView.style.top = '0';
                    shareView.style.left = '0';
                    
                    const canvas = await html2canvas(shareView, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imageDataUrl = canvas.toDataURL("image/png");
                    
                    // Reset share view position
                    shareView.style.position = 'absolute';
                    shareView.style.top = '-9999px';
                    shareView.style.left = '-9999px';
                    
                    return imageDataUrl;
                } catch (error) {
                    console.error('Errore generazione immagine:', error);
                    showMessage("Errore nella generazione dell'immagine.", "text-red-600");
                    return null;
                }
            }

            async function generateShareImage() {
                // This function is kept for backward compatibility
                // but now it just downloads the image directly
                await handleDownloadImage();
            }

            async function generateHistoryShareImage(convocationData) {
                try {
                    // Populate share view with historical convocation data
                    const sharePlayersList = document.getElementById('share-players-list');
                    sharePlayersList.innerHTML = '';
                    document.getElementById('share-campo').textContent = convocationData.details.campo;
                    document.getElementById('share-avversario').textContent = convocationData.details.avversario;
                    
                    // Format match date with uppercase day of week for share image
                    let formattedDate = convocationData.details.data;
                    if (convocationData.details.data !== 'N/D') {
                        const matchDate = new Date(convocationData.details.data + 'T00:00:00');
                        const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                        const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                        const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                        formattedDate = `${dayOfWeek} ${dateString}`;
                    }
                    
                    document.getElementById('share-data-partita').textContent = formattedDate;
                    document.getElementById('share-orario-convocazione').textContent = convocationData.details.orarioConvocazione;
                    document.getElementById('share-orario-partita').textContent = convocationData.details.orarioPartita;
                    document.getElementById('share-tipo').textContent = convocationData.details.tipo || 'N/D';
                    document.getElementById('share-mister-partita').textContent = convocationData.details.misterPartita || 'N/D';
                    document.getElementById('share-mister-tipo').textContent = convocationData.details.misterTipo || 'N/D';

                    if (convocationData.players.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = "Nessun giocatore convocato.";
                        li.className = "text-gray-500 italic text-center";
                        sharePlayersList.appendChild(li);
                    } else {
                        convocationData.players.forEach(player => {
                            const li = document.createElement('li');
                            if (typeof player === 'string') {
                                li.textContent = player;
                            } else {
                                li.textContent = `${player.numero} ${player.nome}`;
                            }
                            li.className = 'font-medium';
                            sharePlayersList.appendChild(li);
                        });
                    }

                    // Generate image from share view
                    shareView.style.position = 'relative';
                    shareView.style.top = '0';
                    shareView.style.left = '0';
                    
                    const canvas = await html2canvas(shareView, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imageDataUrl = canvas.toDataURL("image/png");
                    
                    // Reset share view position
                    shareView.style.position = 'absolute';
                    shareView.style.top = '-9999px';
                    shareView.style.left = '-9999px';

                    // Prepare share text for historical convocation
                    const shareText = `üèüÔ∏è Convocazioni Ufficiali üèüÔ∏è\n\nPartita: ${convocationData.details.avversario}\nCampo: ${convocationData.details.campo}\nData: ${formattedDate}\nOrario: ${convocationData.details.orarioPartita}\n\nGiocatori convocati (${convocationData.players.length}):\n${convocationData.players.join('\n')}\n\n‚öΩ Rosterkick`;

                    // Detect if user is on mobile device
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                     (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));

                    // Try Web Share API first (prioritize on mobile)
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert data URL to blob
                            const response = await fetch(imageDataUrl);
                            const blob = await response.blob();
                            const file = new File([blob], `convocazioni-${convocationData.details.avversario}-${new Date(convocationData.createdAt).toLocaleDateString('it-IT')}.png`, { type: 'image/png' });

                            const shareDataWithFile = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                files: [file]
                            };

                            // Check if sharing with files is supported
                            if (navigator.canShare(shareDataWithFile)) {
                                await navigator.share(shareDataWithFile);
                                showMessage("Convocazione condivisa con successo!", "text-green-600");
                                return;
                            }
                        } catch (fileShareError) {
                            console.log('File sharing not supported for history, trying text-only share');
                        }
                    }
                    
                    // Fallback to text-only Web Share API
                    if (navigator.share) {
                        try {
                            const shareDataTextOnly = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                url: window.location.href
                            };

                            await navigator.share(shareDataTextOnly);
                            showMessage("Testo condiviso! Condividi l'immagine manualmente se necessario.", "text-blue-600");
                            
                            // Also trigger download for user convenience
                            setTimeout(() => downloadHistoryImage(imageDataUrl, convocationData), 1000);
                            return;
                        } catch (textShareError) {
                            console.log('Text sharing failed for history, falling back to download');
                        }
                    }
                    
                    // Final fallback: download the image
                    downloadHistoryImage(imageDataUrl, convocationData);
                    showMessage("Web Share non disponibile. Immagine scaricata!", "text-orange-600");
                    
                } catch (error) {
                    console.error('Errore nella condivisione dello storico:', error);
                    showMessage("Errore nella condivisione. Riprova pi√π tardi.", "text-red-600");
                }
            }

            // Helper function to download history image
            function downloadHistoryImage(imageDataUrl, convocationData) {
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = `convocazioni-${convocationData.details.avversario}-${new Date(convocationData.createdAt).toLocaleDateString('it-IT')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function updateUIForRole() {
                if (userRole === 'mister') {
                    selectedPlayersTitle.textContent = "Giocatori Convocati";
                    playersListMessage.textContent = "Clicca sui nomi per selezionare i convocati.";
                    roleMessage.textContent = "Ciao Mister!! Qui puoi creare e salvare le convocazioni.";
                    roleMessage.classList.remove('hidden');
                    saveButton.textContent = "Salva Convocazione";
                    shareButton.disabled = false;
                    shareButton.style.display = ''; // Show share button for mister
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    shareButton.classList.replace('bg-gray-400', 'bg-blue-600');
                    historyButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    unavailablePlayersView.classList.remove('hidden');
                    unavailablePlayersView.style.display = ''; // Show for Mister
                    unavailablePlayersTitle.textContent = "Giocatori Non Disponibili (Segnalati dal Dirigente)";
                    matchDetailsSection.classList.remove('hidden');
                    matchDetailsSection.style.display = ''; // Show match details for Mister

                    // V9.19: Show legend button for Mister
                    legendButton.classList.remove('hidden');

                    // Show notes section for Mister (readonly)
                    notesSection.classList.remove('hidden');
                    notesEditable.classList.add('hidden');
                    notesReadonly.classList.remove('hidden');

                    // Show reset button for Mister
                    resetSelectionsButton.classList.remove('hidden');
                    
                    // Show mister selection dropdowns for Mister role
                    document.getElementById('mister-selection-1').classList.remove('hidden');
                    document.getElementById('mister-selection-2').classList.remove('hidden');
                    
                    // Populate mister dropdowns
                    populateMisterDropdowns();
                    
                    // Initialize avversario field based on current tipo-partita selection
                    const tipoPartitaSelect = document.getElementById('tipo-partita');
                    const avversarioInput = document.getElementById('avversario');
                    if (tipoPartitaSelect && avversarioInput && tipoPartitaSelect.value === 'Torneo') {
                        avversarioInput.value = 'üèÜ';
                        avversarioInput.readOnly = true;
                        avversarioInput.style.backgroundColor = '#f9fafb';
                        avversarioInput.style.textAlign = 'center';
                        avversarioInput.style.fontSize = '1.5rem';
                    }

                    // Show ESCI button for Mister
                    esciButton.classList.remove('hidden');
                    
                    // Restore normal grid layout for mister (in case it was changed for dirigente)
                    const actionButtonsContainer = saveButton.parentElement;
                    if (!actionButtonsContainer.classList.contains('grid')) {
                        actionButtonsContainer.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'gap-4');
                        actionButtonsContainer.classList.remove('space-y-4');
                    }

                } else if (isDirigente()) {
                    selectedPlayersTitle.textContent = "";
                    playersListMessage.textContent = "Clicca sui nomi per segnalare l'indisponibilit√†.";
                    roleMessage.textContent = "Sei entrato come Dirigente. Puoi segnare e salvare i giocatori non disponibili.";
                    roleMessage.classList.remove('hidden');
                    saveButton.textContent = "Salva Indisponibilit√†";
                    shareButton.style.display = 'none'; // Hide share button completely for dirigente
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    historyButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    unavailablePlayersView.classList.remove('hidden');
                    unavailablePlayersView.style.display = ''; // Show unavailable players view for Marco
                    matchDetailsSection.classList.add('hidden');
                    matchDetailsSection.style.display = 'none'; // Hide match details for Marco
                    unavailablePlayersTitle.textContent = "Giocatori che hai segnato come non disponibili";
                    
                    // V9.19: Hide legend button for Dirigente
                    legendButton.classList.add('hidden');
                    
                    // Hide mister selection dropdowns for Dirigente role
                    document.getElementById('mister-selection-1').classList.add('hidden');
                    document.getElementById('mister-selection-2').classList.add('hidden');

                    // Show notes section for Marco (editable)
                    notesSection.classList.remove('hidden');
                    notesEditable.classList.remove('hidden');
                    notesReadonly.classList.add('hidden');

                    // Show reset button for Dirigente
                    resetSelectionsButton.classList.remove('hidden');
                    
                    // Show ESCI button for Dirigente
                    esciButton.classList.remove('hidden');
                    
                    // Make SALVA INDISPONIBILITA button same width as STORICO CONVOCAZIONI for dirigente
                    // Change from grid layout to full width for save button
                    const actionButtonsContainer = saveButton.parentElement;
                    if (actionButtonsContainer.classList.contains('grid')) {
                        actionButtonsContainer.classList.remove('grid', 'grid-cols-1', 'sm:grid-cols-2', 'gap-4');
                        actionButtonsContainer.classList.add('space-y-4');
                        saveButton.classList.remove('w-full');
                        saveButton.classList.add('w-full');
                    }
                } else if (isGuestUser) {
                    // Guest user: limited functionality
                    selectedPlayersTitle.textContent = "";
                    playersListMessage.textContent = "Accesso Ospite - Solo visualizzazione.";
                    roleMessage.textContent = "Accesso ospite: puoi solo visualizzare lo storico e le presenze.";
                    roleMessage.classList.remove('hidden');
                    
                    // V9.19: Hide legend button for Guests
                    legendButton.classList.add('hidden');
                    
                    // Hide main action buttons for guests
                    saveButton.style.display = 'none';
                    shareButton.style.display = 'none'; // Hide share button for guests
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    historyButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    
                    // Hide sections that are not relevant for guests
                    unavailablePlayersView.classList.add('hidden');
                    matchDetailsSection.classList.add('hidden');
                    notesSection.classList.add('hidden');
                    resetSelectionsButton.classList.add('hidden');
                    esciButton.classList.add('hidden');
                    
                    // Hide mister selection dropdowns for guest
                    document.getElementById('mister-selection-1').classList.add('hidden');
                    document.getElementById('mister-selection-2').classList.add('hidden');
                    
                    console.log('üë§ Guest UI updated - limited functionality enabled');
                }
                
                updateNotesDisplay();
            }

            // V9.24: Transform status text for display (added N.D. W.E. for weekend)
            function formatStatusForDisplay(status) {
                const statusMap = {
                    'Non disponibile Sabato': 'N.D. SABATO',
                    'Non disponibile Domenica': 'N.D. DOMENICA',
                    'Non disponibile Weekend': 'N.D. W.E.',
                    'Solo 2 allenamenti': '2 ALLENAMENTI',
                    'Solo 1 allenamento': '1 ALLENAMENTO',
                    'Zero allenamenti': '0 ALLENAMENTI'
                };
                return statusMap[status] || status;
            }

            function updateUnavailablePlayersView() {
                unavailablePlayersList.innerHTML = '';
                
                // V9.13: Check if there are sessions in current week
                const hasCurrentWeekSessions = hasCurrentWeekTrainingSessions();
                
                // V9.12: Build a complete list of players with unavailability (manual or auto)
                const allUnavailablePlayers = new Map();
                
                // Add all manual statuses
                unavailablePlayers.forEach((status, player) => {
                    const statusArray = Array.isArray(status) ? status : [status];
                    
                    if (hasCurrentWeekSessions) {
                        // V9.12: If sessions exist, filter out training statuses (they'll be added automatically)
                        const filteredStatuses = statusArray.filter(s => 
                            s !== 'Zero allenamenti' && 
                            s !== 'Solo 1 allenamento' && 
                            s !== 'Solo 2 allenamenti'
                        );
                        if (filteredStatuses.length > 0) {
                            allUnavailablePlayers.set(player, filteredStatuses);
                        }
                    } else {
                        // V9.13: If NO sessions exist, keep all manual statuses including training ones
                        allUnavailablePlayers.set(player, statusArray);
                    }
                });
                
                // V9.12: Add auto training statuses for all players (only if sessions exist)
                if (hasCurrentWeekSessions) {
                    const playersToCheck = companyPlayers.length > 0 ? companyPlayers : players;
                    playersToCheck.forEach(player => {
                        let playerKey;
                        if (typeof player === 'string') {
                            playerKey = player;
                        } else {
                            playerKey = `${player.numero} ${player.nome}`;
                        }
                        
                        const autoTrainingStatus = getAutomaticTrainingStatus(playerKey);
                        if (autoTrainingStatus) {
                            const existingStatuses = allUnavailablePlayers.get(playerKey) || [];
                            allUnavailablePlayers.set(playerKey, [...existingStatuses, autoTrainingStatus]);
                        }
                    });
                }
                
                if (allUnavailablePlayers.size === 0) {
                    unavailablePlayersList.innerHTML = '<li class="text-sm italic text-red-500">Nessuna disponibilit√† registrata.</li>';
                    return;
                }
                
                allUnavailablePlayers.forEach((statusArray, player) => {
                    const li = document.createElement('li');
                    // V9.24: Format each status for display
                    const formattedStatuses = statusArray.map(s => formatStatusForDisplay(s));
                    const statusText = formattedStatuses.join(', ');
                    
                    // V9.10: Add icons for Infortunato and Squalificato
                    let playerDisplayName = player;
                    if (statusArray.includes('Infortunato')) {
                        playerDisplayName = `üöë ${player}`;
                    } else if (statusArray.includes('Squalificato')) {
                        playerDisplayName = `üü• ${player}`;
                    }
                    
                    // V6.7: When Mister views the list, make player names bold
                    // V7.5: Also make player names bold for Dirigente view
                    if (userRole === 'mister' || isDirigente()) {
                        li.innerHTML = `<strong class="font-bold">${playerDisplayName}</strong>: ${statusText}`;
                    } else {
                        li.textContent = `${playerDisplayName}: ${statusText}`;
                    }
                    li.className = 'font-medium';
                    unavailablePlayersList.appendChild(li);
                });
            }

            function updateResetTimestampDisplay() {
                const RESET_KEY = 'lastUnavailabilityReset';
                const lastResetStr = localStorage.getItem(RESET_KEY);
                
                if (lastResetStr && resetTimestampDisplay && resetTimestampText) {
                    const lastResetDate = new Date(lastResetStr);
                    const formattedDate = lastResetDate.toLocaleDateString('it-IT', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    resetTimestampText.textContent = formattedDate;
                    resetTimestampDisplay.classList.remove('hidden');
                } else if (resetTimestampDisplay) {
                    resetTimestampDisplay.classList.add('hidden');
                }
            }

            function updateNotesDisplay() {
                if (isDirigente()) {
                    // V9.21: Format notes with bullet points for dirigente
                    if (currentNotes.trim() === '') {
                        notesTextarea.value = '';
                    } else {
                        const lines = currentNotes
                            .split('\n') // Split by newline only (commas already converted to newlines on input)
                            .map(line => line.trim()) // Trim whitespace
                            .filter(line => line.length > 0); // Remove empty lines
                        
                        if (lines.length > 0) {
                            notesTextarea.value = lines.map(line => `‚Ä¢ ${line}`).join('\n');
                        } else {
                            notesTextarea.value = '';
                        }
                    }
                    // Auto-resize the textarea after setting the value
                    if (notesTextarea) {
                        notesTextarea.style.height = 'auto';
                        notesTextarea.style.height = Math.max(notesTextarea.scrollHeight, 80) + 'px';
                    }
                } else if (userRole === 'mister') {
                    if (currentNotes.trim() === '') {
                        notesDisplay.innerHTML = '<span class="text-gray-500 italic">Nessuna nota registrata</span>';
                    } else {
                        // V9.20: Format notes with bullet points and split by commas/newlines
                        const lines = currentNotes
                            .split(/[,\n]/) // Split by comma or newline
                            .map(line => line.trim()) // Trim whitespace
                            .filter(line => line.length > 0); // Remove empty lines
                        
                        if (lines.length > 0) {
                            notesDisplay.innerHTML = lines.map(line => `‚Ä¢ ${line}`).join('<br>');
                        } else {
                            notesDisplay.innerHTML = '<span class="text-gray-500 italic">Nessuna nota registrata</span>';
                        }
                    }
                }
            }

            async function populateMisterDropdowns() {
                try {
                    const coaches = await loadCompanyCoaches();
                    const misterPartitaSelect = document.getElementById('mister-partita');
                    const misterTipoSelect = document.getElementById('mister-tipo');
                    
                    // Clear existing options (except the first default option)
                    misterPartitaSelect.innerHTML = '<option value="">Seleziona mister</option>';
                    misterTipoSelect.innerHTML = '<option value="">Seleziona mister</option>';
                    
                    // Populate both dropdowns with coaches
                    coaches.forEach(coach => {
                        const coachName = typeof coach === 'string' ? coach : coach.name;
                        const coachMatricola = typeof coach === 'object' && coach.matricola ? coach.matricola : '';
                        const displayText = coachMatricola ? `${coachName} (${coachMatricola})` : coachName;
                        
                        const option1 = document.createElement('option');
                        option1.value = coachName; // Use name as value for compatibility
                        option1.textContent = displayText;
                        misterPartitaSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = coachName; // Use name as value for compatibility
                        option2.textContent = displayText;
                        misterTipoSelect.appendChild(option2);
                    });
                } catch (error) {
                    console.error('Errore nel caricamento mister per i dropdown:', error);
                }
            }

            async function saveNotes() {
                if (!window.db || !window.auth.currentUser) {
                    showMessage("Errore: Firebase non √® ancora pronto. Riprova tra un attimo.", "text-red-600");
                    return;
                }

                if (!isDirigente()) {
                    showMessage("Solo il Dirigente pu√≤ modificare le note.", "text-red-600");
                    return;
                }

                // V9.21: Remove bullet points before saving
                const notesContent = notesTextarea.value
                    .split('\n')
                    .map(line => line.replace(/^‚Ä¢\s*/, '').trim()) // Remove bullet point and trim
                    .filter(line => line.length > 0) // Remove empty lines
                    .join('\n');
                    
                // Use document ID path for notes like giocatori and availability
                const notesBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;
                const notesDocRef = window.doc(window.db, `${notesBasePath}/notes`, "marco_notes");
                
                console.log(`üíæ Salvando note per societ√† document ID: ${currentCompanyDocumentId}`);
                console.log(`üìÇ Percorso salvataggio notes: ${notesBasePath}/notes/marco_notes`);
                
                try {
                    await window.setDoc(notesDocRef, { content: notesContent });
                    // Update currentNotes to match what was saved (without bullet points)
                    currentNotes = notesContent;
                    showSuccessPopup("Note salvate con successo!");
                } catch (e) {
                    console.error("Errore salvataggio note su Firestore: ", e);
                    showMessage("Errore durante il salvataggio delle note. Controlla la console.", "text-red-600");
                }
            }

            function showMessage(msg, colorClass) {
                messageArea.textContent = msg;
                messageArea.className = `mt-4 text-center text-sm font-medium ${colorClass}`;
                messageArea.style.display = 'block';
                setTimeout(() => {
                    messageArea.style.display = 'none';
                }, 5000);
            }

            function showSuccessPopup(message = "Salvataggio effettuato con successo") {
                const popup = document.getElementById('success-popup');
                const messageElement = document.getElementById('success-popup-message');
                
                messageElement.textContent = message;
                popup.classList.remove('hidden');
                
                // Auto-close after 3 seconds
                setTimeout(() => {
                    popup.classList.add('hidden');
                }, 3000);
            }

            function startApp(appId) {
                currentAppId = appId;
                
                appIdDisplay.textContent = currentAppId;
                currentAppIdDisplay.textContent = currentAppId;

                startScreen.classList.add('hidden');
                mainView.classList.remove('hidden');
                pushNavigationState('main');

                setupFirestoreListeners(currentAppId);
                renderPlayers();
                updateUIForRole();
            }

            function forgetDataAndReset() {
                localStorage.removeItem('convocazioniAppId');
                localStorage.removeItem('userRole');
                localStorage.removeItem('joinAppId');
                localStorage.removeItem('companyCode');
                localStorage.removeItem('companyData');
                window.location.reload(); 
            }

            function logoutToCompanyWelcome() {
                // Check if we're in a company context
                if (currentCompanyCode && currentCompanyData) {
                    // Remove only session-specific data, keep company data
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('convocazioniAppId');
                    
                    // Reset user role
                    userRole = null;
                    
                    // Return to company welcome screen
                    showCompanyWelcome();
                } else {
                    // If not in company context, fall back to full reset
                    forgetDataAndReset();
                }
            }

            /**
             * Checks if the company is POLIS PIEVE 2010 by checking config.nome, nome, or id
             * @param {Object} companyData - The company data object
             * @returns {boolean} - True if the company is POLIS PIEVE 2010
             */
            function isPolisPieve2010(companyData) {
                const societa = companyData?.data;
                if (!societa) return false;
                
                const configNome = societa?.config?.nome || '';
                const nome = societa?.nome || '';
                const id = societa?.id || '';
                
                const isMatch = configNome === 'POLIS PIEVE 2010' || 
                               nome === 'POLIS PIEVE 2010' || 
                               id === 'POLIS PIEVE 2010';
                
                console.log('üîç DEBUG - isPolisPieve2010 check:', {
                    'config.nome': configNome,
                    'nome': nome,
                    'id': id,
                    'isPolisPieve2010': isMatch
                });
                
                return isMatch;
            }

            // --- Company Navigation Functions ---
            function showCompanyWelcome() {
                hideAllScreens();
                companyNameDisplay.textContent = currentCompanyData.name;
                
                // Set currentAppId correctly to avoid inconsistencies
                // Use document ID if available, otherwise use company code
                const expectedAppId = currentCompanyDocumentId || currentCompanyCode;
                if (currentAppId !== expectedAppId) {
                    console.log(`üîß Setting App ID to: ${expectedAppId} (was: ${currentAppId})`);
                    currentAppId = expectedAppId;
                }
                
                // Log societa data for debugging
                console.log('üìä DEBUG - Societa data at login:', {
                    societa: currentCompanyData?.data,
                    isGuestLogin: currentCompanyData?.isGuestLogin
                });
                
                // Show/hide elements based on guest login status
                const guestRoleIndicator = document.getElementById('guest-role-indicator');
                const normalLoginButtons = document.getElementById('normal-login-buttons');
                const guestAllowedButtons = document.getElementById('guest-allowed-buttons');
                const adminButtons = document.getElementById('admin-buttons');
                
                if (currentCompanyData.isGuestLogin) {
                    // Guest login: show indicator and hide admin functions
                    guestRoleIndicator.classList.remove('hidden');
                    normalLoginButtons.classList.add('hidden');
                    adminButtons.classList.add('hidden');
                    
                    // Set guest user state
                    isGuestUser = true;
                    userRole = 'guest';
                    
                    // Show only guest-allowed buttons for guest users
                    guestAllowedButtons.classList.remove('hidden');
                    
                    // V9.10: Training attendance button - COMMENTED OUT - Feature removed
                    // Hide training attendance button for guests by default
                    // trainingAttendanceButton.classList.add('hidden');
                    
                    // Show training attendance for specific companies and guests
                    const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                    const isPolisCompany = companyName === 'POLIS';
                    // Check if company is POLIS PIEVE 2010 (checks config.nome, nome, or id)
                    const isPolisPieveCompany = isPolisPieve2010(currentCompanyData);
                    
                    // V9.10: Training attendance button - COMMENTED OUT - Feature removed
                    // if (isPolisCompany) {
                    //     trainingAttendanceButton.classList.remove('hidden');
                    // }
                    
                    // Show/hide campionato button for POLIS PIEVE 2010 (also for guests)
                    if (isPolisPieveCompany) {
                        campionatoButton.classList.remove('hidden');
                        // V8.11: Change Campionato button color to yellow (same as Risultati) for PIEVE2010
                        // V9.7: Add text-black for better visibility on yellow background
                        campionatoButton.classList.remove('bg-purple-600', 'hover:bg-red-700', 'text-white');
                        campionatoButton.classList.add('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
                        console.log('üé® Campionato button color changed to yellow with black text for PIEVE2010');
                    } else {
                        campionatoButton.classList.add('hidden');
                        // Reset to purple if not PIEVE2010
                        campionatoButton.classList.remove('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
                        campionatoButton.classList.add('bg-purple-600', 'hover:bg-red-700', 'text-white');
                    }
                    
                    // Risultati button is always visible to all users including guests (no conditional logic needed)
                    // Button always shows and opens https://marcoc82.github.io/polis2013/ without pre-filled code
                    console.log('‚úì Risultati button is visible to all users including guests');
                    
                    console.log('üë§ Guest login detected - restricted UI enabled');
                } else {
                    // Normal login: hide guest indicator and show all options
                    guestRoleIndicator.classList.add('hidden');
                    normalLoginButtons.classList.remove('hidden');
                    adminButtons.classList.remove('hidden');
                    guestAllowedButtons.classList.remove('hidden');
                    
                    // Reset guest state
                    isGuestUser = false;
                    userRole = null;
                    
                    // V9.10: Training attendance button - COMMENTED OUT - Feature removed
                    // Show/hide training attendance button based on company name for normal users
                    const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                    const isPolisCompany = companyName === 'POLIS';
                    // Check if company is POLIS PIEVE 2010 (checks config.nome, nome, or id)
                    const isPolisPieveCompany = isPolisPieve2010(currentCompanyData);
                    
                    // V9.10: Training attendance button - COMMENTED OUT - Feature removed
                    // if (isPolisCompany) {
                    //     trainingAttendanceButton.classList.remove('hidden');
                    // } else {
                    //     trainingAttendanceButton.classList.add('hidden');
                    // }
                    
                    // Show/hide campionato button for POLIS PIEVE 2010
                    if (isPolisPieveCompany) {
                        campionatoButton.classList.remove('hidden');
                        // V8.11: Change Campionato button color to yellow (same as Risultati) for PIEVE2010
                        // V9.7: Add text-black for better visibility on yellow background
                        campionatoButton.classList.remove('bg-purple-600', 'hover:bg-red-700', 'text-white');
                        campionatoButton.classList.add('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
                        console.log('üé® Campionato button color changed to yellow with black text for PIEVE2010');
                    } else {
                        campionatoButton.classList.add('hidden');
                        // Reset to purple if not PIEVE2010
                        campionatoButton.classList.remove('bg-yellow-400', 'hover:bg-yellow-500', 'text-black');
                        campionatoButton.classList.add('bg-purple-600', 'hover:bg-red-700', 'text-white');
                    }
                    
                    console.log('üè¢ Normal company login - full UI enabled');
                }
                
                companyWelcomeScreen.classList.remove('hidden');
                pushNavigationState('company-welcome');
            }

            function showPasswordEntry(role) {
                hideAllScreens();
                pendingRole = role;
                rolePrompt.textContent = `Inserisci la password per ${role === 'mister' ? 'Mister' : 'Dirigente'}:`;
                passwordInput.value = '';
                passwordEntryScreen.classList.remove('hidden');
                pushNavigationState('password-entry');
                passwordInput.focus();
            }

            function showPlayerManagement() {
                hideAllScreens();
                playerManagementScreen.classList.remove('hidden');
                pushNavigationState('player-management');
                hidePlayerLoadingError(); // Clear any previous error messages
                renderCompanyPlayers();
                renderCompanyCoaches();
                renderCompanyDirectors();
                updateSavePlayersButtonState();
                updateSaveCoachesButtonState();
                updateSaveDirectorsButtonState();
            }

            function hideAllScreens() {
                companyEntryScreen.classList.add('hidden');
                companyWelcomeScreen.classList.add('hidden');
                passwordEntryScreen.classList.add('hidden');
                playerManagementScreen.classList.add('hidden');
                nameEntryScreen.classList.add('hidden');
                startScreen.classList.add('hidden');
                mainView.classList.add('hidden');
                historyView.classList.add('hidden');
                attendanceView.classList.add('hidden');
                // V9.10: Training attendance view - COMMENTED OUT - Feature removed
                // trainingAttendanceView.classList.add('hidden');
                campionatoView.classList.add('hidden');
                moduloView.classList.add('hidden'); // V8.12
            }

            // V9.9: Fetch injured players from Firestore
            // V9.11: Fetch injured players from Firestore (historical - all players injured during the season)
            async function fetchInjuredPlayersFromFirestore() {
                try {
                    if (!window.db) {
                        console.warn('‚ö†Ô∏è Firebase non ancora inizializzato');
                        return [];
                    }
                    
                    const availabilityBasePath = currentCompanyDocumentId 
                        ? `societa/${currentCompanyDocumentId}` 
                        : `artifacts/${currentAppId}/public/data`;
                    
                    const injuredDocRef = window.doc(window.db, `${availabilityBasePath}/availability`, "injured_players");
                    const injuredDoc = await window.getDoc(injuredDocRef);
                    
                    if (injuredDoc.exists()) {
                        const data = injuredDoc.data();
                        console.log(`üöë Caricati giocatori infortunati (storico): ${data.players?.length || 0}`);
                        return data.players || [];
                    } else {
                        console.log('üöë Nessun giocatore infortunato trovato');
                        return [];
                    }
                } catch (error) {
                    console.error('‚ùå Errore nel caricamento giocatori infortunati:', error);
                    return [];
                }
            }

            // Firebase Realtime Database integration for training attendance
            async function fetchTrainingAttendanceFromFirebase() {
                // URL del Firebase Realtime Database per i dati delle presenze allenamenti
                const FIREBASE_URL = 'https://polis-2013-default-rtdb.europe-west1.firebasedatabase.app/presenze.json';
                // URL per il totale degli allenamenti
                const FIREBASE_TOTAL_URL = 'https://polis-2013-default-rtdb.europe-west1.firebasedatabase.app/totale_allenamenti.json';
                
                try {
                    console.log('üìä Recupero dati presenze allenamenti da Firebase Realtime Database...');
                    
                    // Effettua le richieste fetch in parallelo per ottimizzare i tempi
                    const [presenzeResponse, totaleResponse] = await Promise.all([
                        fetch(FIREBASE_URL),
                        fetch(FIREBASE_TOTAL_URL)
                    ]);
                    
                    // Controlla se le risposte sono ok
                    if (!presenzeResponse.ok) {
                        throw new Error(`Errore API Firebase presenze: ${presenzeResponse.status} - ${presenzeResponse.statusText}`);
                    }
                    
                    // Parsa i dati JSON dalle risposte
                    const firebaseData = await presenzeResponse.json();
                    let totaleAllenamenti = 0;
                    
                    // Verifica se i dati esistono
                    if (!firebaseData || typeof firebaseData !== 'object') {
                        console.warn('‚ö†Ô∏è Nessun dato trovato nel database Firebase');
                        
                        // Tenta di recuperare il totale allenamenti dal secondo endpoint se il primo non ha dati
                        if (totaleResponse.ok) {
                            const totaleData = await totaleResponse.json();
                            totaleAllenamenti = parseInt(totaleData) || 0;
                            console.log(`üìä Totale allenamenti recuperato da endpoint separato: ${totaleAllenamenti}`);
                        }
                        
                        return { players: [], totalTrainings: totaleAllenamenti };
                    }
                    
                    // Controlla se i dati contengono la propriet√† "allenamentiTotali"
                    if (firebaseData.hasOwnProperty('allenamentiTotali')) {
                        totaleAllenamenti = parseInt(firebaseData.allenamentiTotali) || 0;
                        console.log(`üìä Totale allenamenti recuperato da propriet√† allenamentiTotali: ${totaleAllenamenti}`);
                    } else if (totaleResponse.ok) {
                        // Fallback al secondo endpoint se allenamentiTotali non √® presente nei dati principali
                        const totaleData = await totaleResponse.json();
                        totaleAllenamenti = parseInt(totaleData) || 0;
                        console.log(`üìä Totale allenamenti recuperato da endpoint separato: ${totaleAllenamenti}`);
                    } else {
                        console.warn('‚ö†Ô∏è Totale allenamenti non disponibile, usando valore predefinito 0');
                    }
                    
                    // Converte i dati Firebase nel formato atteso dall'applicazione
                    const trainingData = [];
                    
                    // Se i dati sono un oggetto con chiavi nome-giocatore e valori presenze
                    for (const [playerName, attendance] of Object.entries(firebaseData)) {
                        // Controlla che il nome sia valido e non sia "allenamentiTotali"
                        if (playerName && playerName.trim() !== '' && playerName.toLowerCase() !== 'allenamentitotali') {
                            trainingData.push({
                                name: playerName.trim(),
                                attendance: parseInt(attendance) || 0
                            });
                        }
                    }
                    
                    console.log(`‚úÖ Recuperati con successo ${trainingData.length} record delle presenze allenamenti da Firebase`);
                    return { players: trainingData, totalTrainings: totaleAllenamenti };
                    
                } catch (error) {
                    console.error('‚ùå Errore nel recupero dei dati delle presenze allenamenti da Firebase:', error);
                    throw error;
                }
            }

            function renderTrainingAttendanceData(data, totalTrainings, injuredPlayers = []) {
                const trainingAttendanceList = document.getElementById('training-attendance-list');
                const allenamentiTotaliValue = document.getElementById('allenamenti-totali-value');
                const mediaPresenzeValue = document.getElementById('media-presenze-value');
                trainingAttendanceList.innerHTML = '';
                
                // Display allenamentiTotali using the passed parameter
                if (totalTrainings && totalTrainings > 0) {
                    allenamentiTotaliValue.textContent = totalTrainings;
                } else {
                    allenamentiTotaliValue.textContent = '-';
                }
                
                if (!data || data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="3" class="px-3 sm:px-6 py-4 text-center text-gray-500 italic">
                            Nessun dato disponibile
                        </td>
                    `;
                    trainingAttendanceList.appendChild(row);
                    mediaPresenzeValue.textContent = '-';
                    return;
                }
                
                // Sort by attendance count (descending)
                data.sort((a, b) => b.attendance - a.attendance);
                
                // V6.9: Determine medal positions (gold, silver, bronze) with tie handling
                const attendanceValues = [...new Set(data.map(p => p.attendance))].sort((a, b) => b - a);
                const goldValue = attendanceValues[0];
                const silverValue = attendanceValues[1];
                const bronzeValue = attendanceValues[2];
                
                // Calculate average attendance percentage
                let totalPercentage = 0;
                
                data.forEach((player, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    // V7.4: Calculate percentage for this player (rounded up to integer)
                    const percentage = totalTrainings > 0 
                        ? Math.ceil((player.attendance / totalTrainings) * 100)
                        : 0;
                    
                    totalPercentage += percentage;
                    
                    // V6.9: Determine medal for this player
                    let medal = '';
                    if (player.attendance === goldValue) {
                        medal = 'ü•á ';
                    } else if (player.attendance === silverValue) {
                        medal = 'ü•à ';
                    } else if (player.attendance === bronzeValue) {
                        medal = 'ü•â ';
                    }
                    
                    // V9.11: Add ambulance icon if player was ever injured (shows all historical injured players)
                    const isInjured = injuredPlayers.includes(player.name);
                    const ambulanceIcon = isInjured ? 'üöë ' : '';
                    
                    row.innerHTML = `
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${medal}${player.name}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${ambulanceIcon}${player.attendance}</td>
                        <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${percentage}%</td>
                    `;
                    
                    trainingAttendanceList.appendChild(row);
                });
                
                // V7.4: Calculate and display average percentage (rounded up to integer)
                const averagePercentage = data.length > 0 
                    ? Math.ceil(totalPercentage / data.length)
                    : 0;
                mediaPresenzeValue.textContent = `${averagePercentage}%`;
                
                // Update last update time
                const lastUpdateElement = document.getElementById('training-last-update');
                lastUpdateElement.textContent = new Date().toLocaleString('it-IT');
            }

            async function loadTrainingAttendance() {
                const loadingElement = document.getElementById('training-attendance-loading');
                const errorElement = document.getElementById('training-attendance-error');
                const contentElement = document.getElementById('training-attendance-content');
                
                // Show loading state
                loadingElement.classList.remove('hidden');
                errorElement.classList.add('hidden');
                contentElement.style.opacity = '0.5';
                
                try {
                    // Check if Firebase is available (same check as other functions)
                    if (!window.db || !window.collection || !window.onSnapshot || !window.doc) {
                        console.log('üìä Firebase not available, using demo mode for training attendance');
                        loadTrainingAttendanceDemo();
                        return;
                    }
                    
                    // V9.11: Load training attendance and injured players in parallel (historical data)
                    const [result, injuredPlayers] = await Promise.all([
                        fetchTrainingAttendanceFromFirebase(),
                        fetchInjuredPlayersFromFirestore()
                    ]);
                    
                    renderTrainingAttendanceData(result.players, result.totalTrainings, injuredPlayers);
                    
                    // Hide loading, show content
                    loadingElement.classList.add('hidden');
                    contentElement.style.opacity = '1';
                    
                } catch (error) {
                    console.error('Error loading training attendance:', error);
                    
                    // Show error state
                    loadingElement.classList.add('hidden');
                    errorElement.classList.remove('hidden');
                    contentElement.style.opacity = '1';
                    
                    // Show empty state in table
                    renderTrainingAttendanceData([], 0, []);
                }
            }

            // Demo version for loadTrainingAttendance when Firebase is not available
            function loadTrainingAttendanceDemo() {
                const loadingElement = document.getElementById('training-attendance-loading');
                const contentElement = document.getElementById('training-attendance-content');
                
                console.log('üìä Loading demo training attendance data...');
                
                // Simulate realistic demo data
                const demoTrainingData = [
                    { name: '10 ROSSI MARIO', attendance: 11 },
                    { name: '7 BIANCHI LUIGI', attendance: 9 },
                    { name: '23 VERDI GIUSEPPE', attendance: 13 },
                    { name: '4 NERI ANTONIO', attendance: 8 },
                    { name: '18 AZZURRI MARCO', attendance: 12 },
                    { name: '2 GIALLI FRANCESCO', attendance: 6 },
                    { name: '15 VIOLA STEFANO', attendance: 10 }
                ];
                
                const demoTotalTrainings = 13;
                const demoInjuredPlayers = []; // No injured players in demo mode
                
                // Render the demo data
                renderTrainingAttendanceData(demoTrainingData, demoTotalTrainings, demoInjuredPlayers);
                
                // Hide loading, show content
                loadingElement.classList.add('hidden');
                contentElement.style.opacity = '1';
                
                console.log(`üìä Demo training attendance loaded: ${demoTrainingData.length} players, ${demoTotalTrainings} total trainings`);
            }

            // ============================================
            // V8.2: Allenamenti Management Functions
            // ============================================
            
            // Global variable to store training sessions
            let trainingSessions = [];
            
            // Load allenamenti data (sessions and report) - V8.11
            async function loadAllenamentiData() {
                console.log('üèÉ Loading Allenamenti data... (V8.11)');
                await Promise.all([
                    loadTrainingSessions(),
                    loadAllenamentiReport()
                ]);
                
                // V8.11: Handle guest read-only mode
                const addTrainingButton = document.getElementById('add-training-session-button');
                if (isGuestUser) {
                    // Hide "Nuovo" button for guests
                    if (addTrainingButton) {
                        addTrainingButton.classList.add('hidden');
                    }
                    console.log('üë§ Guest mode: Allenamenti in read-only mode');
                } else {
                    // Show "Nuovo" button for non-guests
                    if (addTrainingButton) {
                        addTrainingButton.classList.remove('hidden');
                    }
                }
            }
            
            // Load training sessions from Firebase
            async function loadTrainingSessions() {
                const loadingElement = document.getElementById('allenamenti-loading');
                const errorElement = document.getElementById('allenamenti-error');
                const containerElement = document.getElementById('training-sessions-container');
                
                loadingElement.classList.remove('hidden');
                errorElement.classList.add('hidden');
                
                try {
                    // Check if Firebase is available
                    if (!window.db || !currentCompanyDocumentId) {
                        console.log('üìä Firebase not available or no company, loading demo training sessions');
                        loadTrainingSessionsDemo();
                        return;
                    }
                    
                    // Fetch training sessions from Firestore (V8.3: using societa/ path)
                    const trainingsRef = window.collection(window.db, `societa/${currentCompanyDocumentId}/trainingSessions`);
                    const querySnapshot = await window.getDocs(trainingsRef);
                    
                    trainingSessions = [];
                    querySnapshot.forEach((doc) => {
                        trainingSessions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Sort by date/time (most recent first)
                    trainingSessions.sort((a, b) => {
                        const dateA = new Date(a.date + ' ' + a.time);
                        const dateB = new Date(b.date + ' ' + b.time);
                        return dateB - dateA;
                    });
                    
                    console.log(`‚úÖ Loaded ${trainingSessions.length} training sessions`);
                    renderTrainingSessions();
                    
                    loadingElement.classList.add('hidden');
                    
                } catch (error) {
                    console.error('‚ùå Error loading training sessions:', error);
                    loadingElement.classList.add('hidden');
                    errorElement.classList.remove('hidden');
                    loadTrainingSessionsDemo();
                }
            }
            
            // Demo version - load sample training sessions
            function loadTrainingSessionsDemo() {
                console.log('üìä Loading demo training sessions...');
                
                const today = new Date();
                const demoSessions = [];
                
                // Create 5 demo training sessions
                for (let i = 0; i < 5; i++) {
                    const sessionDate = new Date(today);
                    sessionDate.setDate(today.getDate() - (i * 3)); // Sessions every 3 days
                    
                    const attendance = {};
                    // Add demo attendance for demo players
                    ['10 ROSSI MARIO', '7 BIANCHI LUIGI', '23 VERDI GIUSEPPE', '4 NERI ANTONIO', '18 AZZURRI MARCO'].forEach(player => {
                        attendance[player] = Math.random() > 0.3; // 70% attendance rate
                    });
                    
                    demoSessions.push({
                        id: `demo-${i}`,
                        date: sessionDate.toISOString().split('T')[0],
                        time: '18:30',
                        attendance: attendance,
                        isDemo: true
                    });
                }
                
                trainingSessions = demoSessions;
                renderTrainingSessions();
                
                document.getElementById('allenamenti-loading').classList.add('hidden');
                console.log(`üìä Demo training sessions loaded: ${demoSessions.length} sessions`);
            }
            
            // Render training sessions as cards
            function renderTrainingSessions(expandSessionId = null) {
                const container = document.getElementById('training-sessions-container');
                container.innerHTML = '';
                
                if (trainingSessions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-lg">Nessun allenamento programmato</p>
                            <p class="text-sm mt-2">Usa il pulsante "+ Nuovo" per aggiungere un allenamento</p>
                        </div>
                    `;
                    return;
                }
                
                // V8.11: Filter sessions based on SESSIONS period (independent from report filter)
                const periodSelect = document.getElementById('sessions-period-select');
                const selectedPeriod = periodSelect ? periodSelect.value : 'all';
                const now = new Date();
                
                const filteredSessions = trainingSessions.filter(session => {
                    if (selectedPeriod === 'all') return true;
                    
                    const sessionDate = new Date(session.date);
                    if (selectedPeriod === 'week') {
                        // Get start of current week (Monday)
                        const startOfWeek = new Date(now);
                        const day = startOfWeek.getDay();
                        const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
                        startOfWeek.setDate(diff);
                        startOfWeek.setHours(0, 0, 0, 0);
                        
                        // Get end of current week (Sunday)
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23, 59, 59, 999);
                        
                        return sessionDate >= startOfWeek && sessionDate <= endOfWeek;
                    } else if (selectedPeriod === 'month') {
                        return sessionDate.getMonth() === now.getMonth() && 
                               sessionDate.getFullYear() === now.getFullYear();
                    } else if (selectedPeriod === 'year') {
                        return sessionDate.getFullYear() === now.getFullYear();
                    }
                    return true;
                });
                
                if (filteredSessions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-lg">Nessun allenamento nel periodo selezionato</p>
                            <p class="text-sm mt-2">Cambia il filtro periodo o aggiungi nuovi allenamenti</p>
                        </div>
                    `;
                    return;
                }
                
                // V8.4: Render sessions, expanding the specified one if provided
                filteredSessions.forEach((session, index) => {
                    const shouldExpand = expandSessionId && session.id === expandSessionId;
                    const card = createTrainingSessionCard(session, index, shouldExpand);
                    container.appendChild(card);
                });
            }
            
            // Create a training session card (V8.11: collapsible with accordion behavior, show present/absent when collapsed)
            function createTrainingSessionCard(session, index, expandByDefault = false) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-200';
                card.dataset.sessionId = session.id; // V8.4: Add data attribute for easier access
                
                // Format date
                const dateObj = new Date(session.date + ' ' + session.time);
                const formattedDate = dateObj.toLocaleDateString('it-IT', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Get players list (from company or demo)
                const players = companyPlayers.length > 0 
                    ? companyPlayers.map(p => typeof p === 'string' ? p : `${p.numero} ${p.nome}`)
                    : ['10 ROSSI MARIO', '7 BIANCHI LUIGI', '23 VERDI GIUSEPPE', '4 NERI ANTONIO', '18 AZZURRI MARCO'];
                
                // Calculate present/absent
                const attendance = session.attendance || {};
                let presentCount = 0;
                let absentCount = 0;
                
                players.forEach(player => {
                    if (attendance[player] === true) presentCount++;
                    else if (attendance[player] === false) absentCount++;
                });
                
                // V8.11: Build collapsible card HTML (support for expandByDefault, show present/absent when collapsed)
                let cardHTML = `
                    <!-- Card Header (always visible, clickable) -->
                    <div class="card-header p-4 cursor-pointer hover:bg-gray-50 rounded-xl transition-colors" data-session-id="${session.id}">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-800">üìÖ ${formattedDate}</h4>
                                <!-- V8.11: Show present/absent count when collapsed -->
                                <div class="attendance-summary text-sm mt-1 ${expandByDefault ? 'hidden' : ''}">
                                    <span class="text-green-600 font-semibold">Presenti: ${presentCount}</span>
                                    <span class="ml-3 text-red-600 font-semibold">Assenti: ${absentCount}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                ${session.isDemo ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Demo</span>' : ''}
                                <svg class="expand-icon w-6 h-6 text-gray-600 transform transition-transform ${expandByDefault ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Content (collapsible) -->
                    <div class="card-content ${expandByDefault ? '' : 'hidden'} p-4 pt-0">
                        <p class="text-sm text-gray-600 mb-3">üïê Orario: ${session.time}</p>
                        
                        <div class="mb-3 space-y-2">
                `;
                
                // Add player checkboxes
                players.forEach(player => {
                    const isChecked = attendance[player] === true;
                    cardHTML += `
                        <label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer">
                            <span class="text-sm text-gray-700">${player}</span>
                            <input type="checkbox" 
                                   class="training-attendance-checkbox w-5 h-5 text-green-600 rounded focus:ring-green-500" 
                                   data-session-id="${session.id}" 
                                   data-player="${player}"
                                   ${isChecked ? 'checked' : ''}>
                        </label>
                    `;
                });
                
                cardHTML += `
                        </div>
                        
                        <div class="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded">
                            <div class="text-sm">
                                <span class="text-green-600 font-semibold">‚úì Presenti: ${presentCount}</span>
                                <span class="ml-3 text-red-600 font-semibold">‚úó Assenti: ${absentCount}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 session-action-buttons">
                            <button class="mark-all-present-btn flex-1 bg-green-500 hover:bg-green-600 text-white text-sm py-2 rounded font-medium" data-session-id="${session.id}">
                                Tutti Presenti
                            </button>
                            <button class="mark-all-absent-btn flex-1 bg-red-500 hover:bg-red-600 text-white text-sm py-2 rounded font-medium" data-session-id="${session.id}">
                                Tutti Assenti
                            </button>
                            <button class="save-attendance-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 rounded font-medium" data-session-id="${session.id}">
                                üíæ Salva
                            </button>
                        </div>
                    </div>
                `;
                
                card.innerHTML = cardHTML;
                
                // V8.11: Handle guest read-only mode
                if (isGuestUser) {
                    // Disable all checkboxes for guests
                    const checkboxes = card.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.disabled = true;
                    });
                    
                    // Hide action buttons for guests
                    const actionButtons = card.querySelector('.session-action-buttons');
                    if (actionButtons) {
                        actionButtons.style.display = 'none';
                    }
                }
                
                // V8.11: Add click handler for collapsible functionality with accordion behavior
                const cardHeader = card.querySelector('.card-header');
                const cardContent = card.querySelector('.card-content');
                const expandIcon = card.querySelector('.expand-icon');
                const attendanceSummary = card.querySelector('.attendance-summary');
                
                cardHeader.addEventListener('click', () => {
                    const isExpanded = !cardContent.classList.contains('hidden');
                    if (isExpanded) {
                        // Collapse this card
                        cardContent.classList.add('hidden');
                        expandIcon.classList.remove('rotate-180');
                        // V8.11: Show attendance summary when collapsed
                        if (attendanceSummary) {
                            attendanceSummary.classList.remove('hidden');
                        }
                    } else {
                        // V8.11: Collapse all other cards first (accordion behavior)
                        const allCards = document.querySelectorAll('#training-sessions-container > div');
                        allCards.forEach(otherCard => {
                            if (otherCard !== card) {
                                const otherContent = otherCard.querySelector('.card-content');
                                const otherIcon = otherCard.querySelector('.expand-icon');
                                const otherSummary = otherCard.querySelector('.attendance-summary');
                                if (otherContent && !otherContent.classList.contains('hidden')) {
                                    otherContent.classList.add('hidden');
                                    otherIcon.classList.remove('rotate-180');
                                    // Show attendance summary on other cards when they collapse
                                    if (otherSummary) {
                                        otherSummary.classList.remove('hidden');
                                    }
                                }
                            }
                        });
                        
                        // Expand this card
                        cardContent.classList.remove('hidden');
                        expandIcon.classList.add('rotate-180');
                        // V8.11: Hide attendance summary when expanded
                        if (attendanceSummary) {
                            attendanceSummary.classList.add('hidden');
                        }
                    }
                });
                
                // Add event listeners to buttons
                const markAllPresentBtn = card.querySelector('.mark-all-present-btn');
                const markAllAbsentBtn = card.querySelector('.mark-all-absent-btn');
                const saveAttendanceBtn = card.querySelector('.save-attendance-btn');
                
                markAllPresentBtn.addEventListener('click', () => markAllAttendance(session.id, true));
                markAllAbsentBtn.addEventListener('click', () => markAllAttendance(session.id, false));
                saveAttendanceBtn.addEventListener('click', () => saveSessionAttendance(session.id));
                
                return card;
            }
            
            // Mark all players as present or absent
            function markAllAttendance(sessionId, isPresent) {
                const checkboxes = document.querySelectorAll(`input[data-session-id="${sessionId}"]`);
                checkboxes.forEach(checkbox => {
                    checkbox.checked = isPresent;
                });
                console.log(`üèÉ Marked all players as ${isPresent ? 'present' : 'absent'} for session ${sessionId}`);
            }
            
            // Save attendance for a session
            async function saveSessionAttendance(sessionId) {
                console.log(`üíæ Saving attendance for session ${sessionId}...`);
                
                // Get all checkboxes for this session
                const checkboxes = document.querySelectorAll(`input[data-session-id="${sessionId}"]`);
                const attendance = {};
                
                checkboxes.forEach(checkbox => {
                    const player = checkbox.dataset.player;
                    attendance[player] = checkbox.checked;
                });
                
                // Find the session
                const session = trainingSessions.find(s => s.id === sessionId);
                if (!session) {
                    console.error('Session not found:', sessionId);
                    return;
                }
                
                // Update local data
                session.attendance = attendance;
                
                try {
                    // Save to Firebase if available (V8.3: using societa/ path)
                    if (window.db && currentCompanyDocumentId && !session.isDemo) {
                        const sessionRef = window.doc(window.db, `societa/${currentCompanyDocumentId}/trainingSessions/${sessionId}`);
                        await window.setDoc(sessionRef, {
                            date: session.date,
                            time: session.time,
                            attendance: attendance
                        }, { merge: true });
                        console.log('‚úÖ Attendance saved to Firebase');
                    } else {
                        console.log('üìä Demo mode - attendance saved locally only');
                    }
                    
                    // Re-render to update counts
                    renderTrainingSessions();
                    
                    // Reload report to reflect changes
                    loadAllenamentiReport();
                    
                    // V9.12: Re-render players to update automatic training statuses
                    renderPlayers();
                    updateUnavailablePlayersView();
                    
                    // Show success message
                    alert('‚úÖ Presenze salvate con successo!');
                    
                } catch (error) {
                    console.error('‚ùå Error saving attendance:', error);
                    alert('‚ùå Errore nel salvataggio delle presenze');
                }
            }
            
            // Save new training session
            async function saveNewTrainingSession() {
                const date = document.getElementById('training-date').value;
                const time = document.getElementById('training-time').value;
                
                if (!date || !time) {
                    alert('‚ö†Ô∏è Inserisci data e orario');
                    return;
                }
                
                console.log(`üèÉ Creating new training session: ${date} ${time} (V8.11)`);
                
                // V8.6: Initialize attendance with all players present by default
                const players = companyPlayers.length > 0 
                    ? companyPlayers.map(p => typeof p === 'string' ? p : `${p.numero} ${p.nome}`)
                    : ['10 ROSSI MARIO', '7 BIANCHI LUIGI', '23 VERDI GIUSEPPE', '4 NERI ANTONIO', '18 AZZURRI MARCO'];
                
                const attendance = {};
                players.forEach(player => {
                    attendance[player] = true; // Default all players as present
                });
                
                const newSession = {
                    date: date,
                    time: time,
                    attendance: attendance
                };
                
                try {
                    // Save to Firebase if available (V8.3: using societa/ path)
                    if (window.db && currentCompanyDocumentId) {
                        const trainingsRef = window.collection(window.db, `societa/${currentCompanyDocumentId}/trainingSessions`);
                        const docRef = await window.addDoc(trainingsRef, newSession);
                        newSession.id = docRef.id;
                        console.log('‚úÖ Training session saved to Firebase:', docRef.id);
                    } else {
                        // Demo mode
                        newSession.id = `demo-${Date.now()}`;
                        newSession.isDemo = true;
                        console.log('üìä Demo mode - session saved locally only');
                    }
                    
                    // Add to local array
                    trainingSessions.unshift(newSession);
                    
                    // V8.11: Re-render with new session expanded and auto-refresh report
                    renderTrainingSessions(newSession.id);
                    loadAllenamentiReport(); // Auto-refresh report after saving new session
                    
                    // V9.12: Re-render players to update automatic training statuses
                    renderPlayers();
                    updateUnavailablePlayersView();
                    
                    // Close modal
                    document.getElementById('add-training-modal').classList.add('hidden');
                    
                    // Show success message
                    alert('‚úÖ Allenamento creato con successo!');
                    
                } catch (error) {
                    console.error('‚ùå Error creating training session:', error);
                    alert('‚ùå Errore nella creazione dell\'allenamento');
                }
            }
            
            // Load allenamenti report (V8.11: independent filter for report, auto-refresh on new session save, calculate average)
            async function loadAllenamentiReport() {
                console.log('üìä Loading Allenamenti report... (V9.17)');
                
                const reportBody = document.getElementById('allenamenti-report-body');
                const periodSelect = document.getElementById('report-period-select');
                const selectedPeriod = periodSelect.value;
                
                // V9.11: Fetch injured players for ambulance icon display (historical data - all injured players for the season)
                const injuredPlayers = await fetchInjuredPlayersFromFirestore();
                
                // V9.17: Fetch availability data for sorting (only for POLIS company)
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                let availabilityData = {};
                let availabilityDataNormalized = {};
                if (isPolisCompany) {
                    try {
                        const FIREBASE_CONVOCAZIONI_URL = 'https://polis-2013-default-rtdb.europe-west1.firebasedatabase.app/convocazioni.json';
                        const response = await fetch(FIREBASE_CONVOCAZIONI_URL);
                        if (response.ok) {
                            availabilityData = await response.json() || {};
                            Object.keys(availabilityData).forEach(key => {
                                const normalizedKey = normalizePlayerName(key);
                                availabilityDataNormalized[normalizedKey] = availabilityData[key];
                            });
                        }
                    } catch (error) {
                        console.error('üìä [V9.17] Errore nel caricamento dei dati disponibilit√†:', error);
                    }
                }
                
                // Calculate report data from training sessions
                const playerStats = {};
                
                // Filter sessions based on selected period (V8.11: independent report filter)
                const now = new Date();
                const filteredSessions = trainingSessions.filter(session => {
                    if (selectedPeriod === 'all') return true;
                    
                    const sessionDate = new Date(session.date);
                    if (selectedPeriod === 'week') {
                        // Get start of current week (Monday)
                        const startOfWeek = new Date(now);
                        const day = startOfWeek.getDay();
                        const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
                        startOfWeek.setDate(diff);
                        startOfWeek.setHours(0, 0, 0, 0);
                        
                        // Get end of current week (Sunday)
                        const endOfWeek = new Date(startOfWeek);
                        endOfWeek.setDate(startOfWeek.getDate() + 6);
                        endOfWeek.setHours(23, 59, 59, 999);
                        
                        return sessionDate >= startOfWeek && sessionDate <= endOfWeek;
                    } else if (selectedPeriod === 'month') {
                        return sessionDate.getMonth() === now.getMonth() && 
                               sessionDate.getFullYear() === now.getFullYear();
                    } else if (selectedPeriod === 'year') {
                        return sessionDate.getFullYear() === now.getFullYear();
                    }
                    return true;
                });
                
                const totalSessions = filteredSessions.length;
                
                // Calculate stats for each player
                filteredSessions.forEach(session => {
                    const attendance = session.attendance || {};
                    Object.entries(attendance).forEach(([player, isPresent]) => {
                        if (!playerStats[player]) {
                            playerStats[player] = { presences: 0, total: 0 };
                        }
                        playerStats[player].total++;
                        if (isPresent) playerStats[player].presences++;
                    });
                });
                
                // Render report table
                reportBody.innerHTML = '';
                
                if (Object.keys(playerStats).length === 0) {
                    reportBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-3 py-4 text-center text-gray-500 italic">
                                Nessun dato disponibile per il periodo selezionato
                            </td>
                        </tr>
                    `;
                    // V8.11: Set average to 0% when no data
                    const averageDisplay = document.getElementById('average-attendance-value');
                    if (averageDisplay) {
                        averageDisplay.textContent = '0%';
                    }
                    return;
                }
                
                // V9.17: Convert to array with availability data for sorting
                const statsArray = Object.entries(playerStats).map(([player, stats]) => {
                    const percentage = stats.total > 0 ? Math.round((stats.presences / stats.total) * 100) : 0;
                    
                    // Get availability percentage for POLIS company
                    let availabilityNumeric = -1; // For sorting purposes
                    if (isPolisCompany) {
                        let rawValue = availabilityData[player];
                        if (rawValue === undefined) {
                            const normalizedPlayerName = normalizePlayerName(player);
                            rawValue = availabilityDataNormalized[normalizedPlayerName];
                        }
                        if (rawValue !== undefined && rawValue !== null) {
                            if (typeof rawValue === 'number') {
                                availabilityNumeric = Math.ceil(rawValue <= 1 ? rawValue * 100 : rawValue);
                            } else if (typeof rawValue === 'string') {
                                const numValue = parseFloat(rawValue);
                                if (!isNaN(numValue)) {
                                    availabilityNumeric = Math.ceil(numValue <= 1 ? numValue * 100 : numValue);
                                }
                            }
                        }
                    }
                    
                    return {
                        player,
                        presences: stats.presences,
                        total: stats.total,
                        percentage,
                        availabilityNumeric
                    };
                });
                
                // V9.26: Sort by presences descending, then by availability percentage descending, then by attendance percentage descending, then alphabetically by name
                statsArray.sort((a, b) => {
                    if (b.presences !== a.presences) {
                        return b.presences - a.presences; // Primary sort: presences descending
                    }
                    if (b.availabilityNumeric !== a.availabilityNumeric) {
                        return b.availabilityNumeric - a.availabilityNumeric; // Secondary sort: availability percentage descending
                    }
                    if (b.percentage !== a.percentage) {
                        return b.percentage - a.percentage; // Tertiary sort: attendance percentage descending
                    }
                    // Quaternary sort: alphabetically by name (ignoring jersey number)
                    const nameA = a.player.replace(/^\d+\s*/, '').trim();
                    const nameB = b.player.replace(/^\d+\s*/, '').trim();
                    return nameA.localeCompare(nameB, 'it');
                });
                
                // V9.17: Ranking arrows - Compare with last week's ranking (using separate storage key for training)
                // V9.26: Calculate ranks considering ties (same presences + same availability + same attendance percentage = same rank)
                const currentRanking = [];
                let currentRank = 1;
                for (let i = 0; i < statsArray.length; i++) {
                    if (i > 0) {
                        const prevStat = statsArray[i - 1];
                        const currStat = statsArray[i];
                        // Check if tied (same presences AND same availability AND same attendance percentage)
                        if (prevStat.presences !== currStat.presences || 
                            prevStat.availabilityNumeric !== currStat.availabilityNumeric ||
                            prevStat.percentage !== currStat.percentage) {
                            currentRank = i + 1; // Move to next rank if not tied
                        }
                        // Otherwise keep same rank (tied)
                    }
                    currentRanking.push({
                        name: statsArray[i].player,
                        rank: currentRank
                    });
                }
                
                // Get last week's ranking from localStorage (company-specific, separate key for training report)
                const companyKey = currentCompanyCode || 'default';
                const lastWeekRankingStr = localStorage.getItem(`lastWeekRankingTraining_${companyKey}`);
                let lastWeekRanking = {};
                if (lastWeekRankingStr) {
                    try {
                        const rankingData = JSON.parse(lastWeekRankingStr);
                        lastWeekRanking = rankingData.ranking || {};
                    } catch (e) {
                        console.error('Error parsing last week training ranking:', e);
                    }
                }
                
                // Check if we need to update the weekly snapshot (every Monday)
                const lastUpdateStr = localStorage.getItem(`lastRankingUpdateTraining_${companyKey}`);
                let shouldUpdate = false;
                
                if (!lastUpdateStr) {
                    shouldUpdate = true;
                } else {
                    // Helper function to get Monday of a given week
                    const getMondayOfWeek = (date) => {
                        const d = new Date(date);
                        const day = d.getDay();
                        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
                        d.setDate(diff);
                        d.setHours(0, 0, 0, 0);
                        return d;
                    };
                    
                    const lastUpdate = new Date(lastUpdateStr);
                    const currentWeekMonday = getMondayOfWeek(now);
                    const lastUpdateWeekMonday = getMondayOfWeek(lastUpdate);
                    
                    // Update only if we're in a different week (comparing Mondays)
                    if (currentWeekMonday.getTime() !== lastUpdateWeekMonday.getTime()) {
                        shouldUpdate = true;
                    }
                }
                
                if (shouldUpdate) {
                    // Store current ranking as new baseline (company-specific)
                    const rankingMap = {};
                    currentRanking.forEach(item => {
                        rankingMap[item.name] = item.rank;
                    });
                    localStorage.setItem(`lastWeekRankingTraining_${companyKey}`, JSON.stringify({
                        ranking: rankingMap,
                        date: now.toISOString()
                    }));
                    localStorage.setItem(`lastRankingUpdateTraining_${companyKey}`, now.toISOString());
                    console.log(`üìä [V9.17] Updated weekly training ranking snapshot for ${companyKey}`);
                }
                
                // Calculate rank changes
                const rankChanges = {};
                currentRanking.forEach(item => {
                    const lastRank = lastWeekRanking[item.name];
                    if (lastRank !== undefined) {
                        const change = lastRank - item.rank; // Positive means moved up
                        rankChanges[item.name] = change;
                    }
                });
                
                // Render rows
                statsArray.forEach((stat, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    // V9.11: Add ambulance icon if player was ever injured (shows all historical injured players)
                    const isInjured = injuredPlayers.includes(stat.player);
                    const ambulanceIcon = isInjured ? 'üöë ' : '';
                    
                    // V9.17: Add ranking arrow
                    // V9.18: Show "=" for unchanged position
                    const rankChange = rankChanges[stat.player];
                    let arrowIcon = '';
                    if (rankChange !== undefined) {
                        if (rankChange > 0) {
                            arrowIcon = '<span style="color: green; margin-left: 4px;">‚ñ≤</span>';
                        } else if (rankChange < 0) {
                            arrowIcon = '<span style="color: red; margin-left: 4px;">‚ñº</span>';
                        } else {
                            // rankChange === 0: same position
                            arrowIcon = '<span style="color: gray; margin-left: 4px;">=</span>';
                        }
                    }
                    
                    // V9.22: Display only player name without jersey number
                    const playerNameOnly = stat.player.replace(/^\d+\s*/, '').trim();
                    
                    row.innerHTML = `
                        <td class="px-3 py-2 text-sm text-gray-900">${playerNameOnly}</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-center">${totalSessions}</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-center font-semibold">${ambulanceIcon}${stat.presences}${arrowIcon}</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-center font-semibold">${stat.percentage}%</td>
                    `;
                    reportBody.appendChild(row);
                });
                
                // V8.11: Calculate and display average attendance percentage
                let totalPresences = 0;
                let totalPossibleAttendances = 0;
                statsArray.forEach(stat => {
                    totalPresences += stat.presences;
                    totalPossibleAttendances += stat.total;
                });
                
                const averagePercentage = totalPossibleAttendances > 0 
                    ? Math.round((totalPresences / totalPossibleAttendances) * 100) 
                    : 0;
                
                const averageDisplay = document.getElementById('average-attendance-value');
                if (averageDisplay) {
                    averageDisplay.textContent = `${averagePercentage}%`;
                }
                
                console.log(`‚úÖ [V9.17] Report loaded: ${statsArray.length} players, ${totalSessions} sessions, ${averagePercentage}% average attendance`);
            }

            async function startApp(appId) {
                currentAppId = appId;
                
                appIdDisplay.textContent = currentAppId;
                currentAppIdDisplay.textContent = currentAppId;

                hideAllScreens();
                mainView.classList.remove('hidden');

                setupFirestoreListeners(currentAppId);
                
                // V9.13: Load training sessions at app start for automatic status calculation
                await loadTrainingSessions();
                
                // V9.14: Load company info at app start to ensure it's available for distinta
                await loadCompanyInfo();
                
                renderPlayers();
                updateUIForRole();
            }

            function renderCompanyPlayers() {
                companyPlayersList.innerHTML = '';
                
                // V7.6: Update players count in title
                const playersCountElement = document.getElementById('players-count');
                if (playersCountElement) {
                    playersCountElement.textContent = companyPlayers.length;
                }
                
                companyPlayers.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex items-center justify-between p-3 bg-white border border-gray-300 rounded-lg';
                    
                    let playerDisplay;
                    if (typeof player === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerDisplay = `
                            <div class="text-gray-700">
                                <div><span class="font-bold">${player}</span></div>
                                <div class="text-sm text-gray-500">Formato legacy</div>
                            </div>
                        `;
                    } else {
                        // New format: object with all fields
                        const birthDate = new Date(player.dataNascita);
                        const formattedDate = birthDate.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        
                        // V7.6: Player name in bold, icon next to matricola
                        playerDisplay = `
                            <div class="text-gray-700">
                                <div class="font-bold">${player.numero} ${player.nome}</div>
                                <div class="text-sm text-gray-500">
                                    üìÖ ${formattedDate} | üÜî ${player.matricola}
                                </div>
                            </div>
                        `;
                    }
                    
                    // V7.6: Show only pencil icon for edit
                    playerDiv.innerHTML = `
                        ${playerDisplay}
                        <div class="flex gap-2">
                            <button onclick="editPlayer(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="removePlayer(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                Rimuovi
                            </button>
                        </div>
                    `;
                    companyPlayersList.appendChild(playerDiv);
                });
                
                updateSavePlayersButtonState();
            }

            function updateSavePlayersButtonState() {
                // Enable the button only if there are players to save
                const hasPlayers = companyPlayers.length > 0;
                savePlayersButton.disabled = !hasPlayers;
                
                if (hasPlayers) {
                    savePlayersButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                } else {
                    savePlayersButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                }
            }

            window.removePlayer = async function(index) {
                if (confirm('Sei sicuro di voler rimuovere questo giocatore dalla lista?')) {
                    companyPlayers.splice(index, 1);
                    renderCompanyPlayers();
                    showMessage("Giocatore rimosso dalla lista. Ricorda di salvare!", "text-blue-600");
                }
            };

            window.editPlayer = async function(index) {
                const player = companyPlayers[index];
                
                if (typeof player === 'string') {
                    // Handle legacy format
                    const parts = player.split(' ');
                    const numero = parts[0];
                    const nome = parts.slice(1).join(' ');
                    
                    const newNumero = prompt('Numero giocatore:', numero);
                    if (newNumero === null) return; // User cancelled
                    
                    const newNome = prompt('Nome giocatore:', nome);
                    if (newNome === null) return; // User cancelled
                    
                    if (newNumero.trim() && newNome.trim()) {
                        companyPlayers[index] = `${newNumero.trim()} ${newNome.trim()}`;
                        renderCompanyPlayers();
                        showMessage("Giocatore modificato. Ricorda di salvare!", "text-green-600");
                    }
                } else {
                    // Handle new object format
                    const newNumero = prompt('Numero giocatore:', player.numero);
                    if (newNumero === null) return;
                    
                    const newNome = prompt('Nome giocatore:', player.nome);
                    if (newNome === null) return;
                    
                    const newDataNascita = prompt('Data nascita (YYYY-MM-DD):', player.dataNascita);
                    if (newDataNascita === null) return;
                    
                    const newMatricola = prompt('Matricola:', player.matricola);
                    if (newMatricola === null) return;
                    
                    if (newNumero.trim() && newNome.trim() && newDataNascita.trim() && newMatricola.trim()) {
                        companyPlayers[index] = {
                            numero: newNumero.trim(),
                            nome: newNome.trim(),
                            dataNascita: newDataNascita.trim(),
                            matricola: newMatricola.trim()
                        };
                        renderCompanyPlayers();
                        showMessage("Giocatore modificato. Ricorda di salvare!", "text-green-600");
                    }
                }
            };

            function renderCompanyCoaches() {
                companyCoachesList.innerHTML = '';
                
                // Update coaches count in title
                const coachesCountElement = document.getElementById('coaches-count');
                if (coachesCountElement) {
                    coachesCountElement.textContent = companyCoaches.length;
                }
                
                companyCoaches.forEach((coach, index) => {
                    const coachDiv = document.createElement('div');
                    // V7.6: Uniform styling
                    coachDiv.className = 'flex items-center justify-between p-3 bg-white border border-gray-300 rounded-lg';
                    
                    // Handle both old string format and new object format for backward compatibility
                    const coachName = typeof coach === 'string' ? coach : coach.name;
                    const coachMatricola = typeof coach === 'object' && coach.matricola ? coach.matricola : '';
                    
                    // V7.6: Bold name, use "Codice" instead of "Matricola", add icon
                    const coachInfoHtml = coachMatricola 
                        ? `<div class="text-gray-700">
                             <div class="font-bold">${coachName}</div>
                             <div class="text-sm text-gray-500">üÜî ${coachMatricola}</div>
                           </div>`
                        : `<div class="text-gray-700"><span class="font-bold">${coachName}</span></div>`;
                    
                    // V7.6: Show only pencil icon for edit
                    coachDiv.innerHTML = `
                        ${coachInfoHtml}
                        <div class="flex gap-2">
                            <button onclick="editCoach(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="removeCoach(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                Rimuovi
                            </button>
                        </div>
                    `;
                    companyCoachesList.appendChild(coachDiv);
                });
                
                updateSaveCoachesButtonState();
            }

            function updateSaveCoachesButtonState() {
                // Enable the button only if there are coaches to save
                const hasCoaches = companyCoaches.length > 0;
                saveCoachesButton.disabled = !hasCoaches;
                
                if (hasCoaches) {
                    saveCoachesButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                } else {
                    saveCoachesButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                }
            }

            window.removeCoach = async function(index) {
                if (confirm('Sei sicuro di voler rimuovere questo mister dalla lista?')) {
                    companyCoaches.splice(index, 1);
                    renderCompanyCoaches();
                    showCoachMessage("Mister rimosso dalla lista. Ricorda di salvare!", "text-blue-600");
                }
            };

            window.editCoach = async function(index) {
                const coach = companyCoaches[index];
                
                if (typeof coach === 'string') {
                    // Handle legacy string format
                    const newName = prompt('Nome mister:', coach);
                    if (newName === null) return; // User cancelled
                    
                    if (newName.trim()) {
                        companyCoaches[index] = newName.trim();
                        renderCompanyCoaches();
                        showCoachMessage("Mister modificato. Ricorda di salvare!", "text-green-600");
                    }
                } else {
                    // Handle object format
                    const newName = prompt('Nome mister:', coach.name || '');
                    if (newName === null) return;
                    
                    const newMatricola = prompt('Matricola:', coach.matricola || '');
                    if (newMatricola === null) return;
                    
                    if (newName.trim()) {
                        companyCoaches[index] = {
                            name: newName.trim(),
                            matricola: newMatricola.trim()
                        };
                        renderCompanyCoaches();
                        showCoachMessage("Mister modificato. Ricorda di salvare!", "text-green-600");
                    }
                }
            };

            function renderCompanyDirectors() {
                companyDirectorsList.innerHTML = '';
                
                // Update directors count in title
                const directorsCountElement = document.getElementById('directors-count');
                if (directorsCountElement) {
                    directorsCountElement.textContent = companyDirectors.length;
                }
                
                companyDirectors.forEach((director, index) => {
                    const directorDiv = document.createElement('div');
                    // V7.6: Uniform styling
                    directorDiv.className = 'flex items-center justify-between p-3 bg-white border border-gray-300 rounded-lg';
                    
                    const fullName = `${director.name || ''} ${director.surname || ''}`.trim();
                    const directorMatricola = director.matricola || '';
                    
                    // V7.6: Bold name, use icon with ID/Codice
                    const directorInfoHtml = `<div class="text-gray-700">
                                               <div class="font-bold">${fullName}</div>
                                               <div class="text-sm text-gray-500">üÜî ${directorMatricola}</div>
                                             </div>`;
                    
                    // V7.6: Show only pencil icon for edit
                    directorDiv.innerHTML = `
                        ${directorInfoHtml}
                        <div class="flex gap-2">
                            <button onclick="editDirector(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="removeDirector(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                Rimuovi
                            </button>
                        </div>
                    `;
                    companyDirectorsList.appendChild(directorDiv);
                });
                
                updateSaveDirectorsButtonState();
            }

            function updateSaveDirectorsButtonState() {
                // Enable the button only if there are directors to save
                const hasDirectors = companyDirectors.length > 0;
                saveDirectorsButton.disabled = !hasDirectors;
                
                if (hasDirectors) {
                    saveDirectorsButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                } else {
                    saveDirectorsButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                }
            }

            window.removeDirector = async function(index) {
                if (confirm('Sei sicuro di voler rimuovere questo dirigente dalla lista?')) {
                    companyDirectors.splice(index, 1);
                    renderCompanyDirectors();
                    showDirectorMessage("Dirigente rimosso dalla lista. Ricorda di salvare!", "text-blue-600");
                }
            };

            window.editDirector = async function(index) {
                const director = companyDirectors[index];
                
                const newName = prompt('Nome dirigente:', director.name || '');
                if (newName === null) return; // User cancelled
                
                const newSurname = prompt('Cognome dirigente:', director.surname || '');
                if (newSurname === null) return;
                
                const newMatricola = prompt('Matricola:', director.matricola || '');
                if (newMatricola === null) return;
                
                if (newName.trim() || newSurname.trim()) {
                    companyDirectors[index] = {
                        name: newName.trim(),
                        surname: newSurname.trim(),
                        matricola: newMatricola.trim()
                    };
                    renderCompanyDirectors();
                    showDirectorMessage("Dirigente modificato. Ricorda di salvare!", "text-green-600");
                }
            };

            function showDirectorMessage(message, className) {
                saveDirectorsMessageArea.textContent = message;
                saveDirectorsMessageArea.className = `mt-2 text-center text-sm font-medium ${className}`;
                saveDirectorsMessageArea.classList.remove('hidden');
                setTimeout(() => {
                    saveDirectorsMessageArea.classList.add('hidden');
                }, 5000);
            }

            function showMessage(message, className) {
                messageArea.textContent = message;
                messageArea.className = `mt-4 text-center text-sm font-medium ${className}`;
                messageArea.classList.remove('hidden');
                setTimeout(() => {
                    messageArea.classList.add('hidden');
                }, 5000);
            }

            function showSavePlayersMessage(message, className) {
                savePlayersMessageArea.textContent = message;
                savePlayersMessageArea.className = `mt-2 mb-4 text-center text-sm font-medium ${className}`;
                savePlayersMessageArea.classList.remove('hidden');
                setTimeout(() => {
                    savePlayersMessageArea.classList.add('hidden');
                }, 5000);
            }

            function showCoachMessage(message, className) {
                saveCoachesMessageArea.textContent = message;
                saveCoachesMessageArea.className = `mt-2 text-center text-sm font-medium ${className}`;
                saveCoachesMessageArea.classList.remove('hidden');
                setTimeout(() => {
                    saveCoachesMessageArea.classList.add('hidden');
                }, 5000);
            }

            // --- Modal Functions ---
            function showModal() {
                // V6.5: Pre-check existing statuses for this player
                // Supports both legacy single status (string) and new multiple statuses (array)
                const existingStatuses = unavailablePlayers.get(tempPlayerName);
                const statusArray = existingStatuses 
                    ? (Array.isArray(existingStatuses) ? existingStatuses : [existingStatuses])
                    : [];
                
                console.log('üîç [V6.5] Opening modal for:', tempPlayerName, 'with statuses:', statusArray);
                
                // V9.13: Check if there are training sessions in current week
                const hasCurrentWeekSessions = hasCurrentWeekTrainingSessions();
                console.log('üèÉ [V9.13] Has current week sessions:', hasCurrentWeekSessions);
                
                // V9.12: Get automatic training status for this player (only if sessions exist)
                const autoTrainingStatus = hasCurrentWeekSessions ? getAutomaticTrainingStatus(tempPlayerName) : null;
                console.log('üèÉ [V9.12] Auto training status:', autoTrainingStatus);
                
                // Reset all checkboxes first, then check the ones that match existing statuses
                statusCheckboxes.forEach(checkbox => {
                    const status = checkbox.dataset.status;
                    const isTrainingStatus = status === 'Zero allenamenti' || 
                                            status === 'Solo 1 allenamento' || 
                                            status === 'Solo 2 allenamenti';
                    
                    if (isTrainingStatus) {
                        // V9.13: Training status checkboxes behavior based on current week sessions
                        const label = checkbox.closest('label');
                        const parentDiv = checkbox.closest('.relative');
                        
                        if (hasCurrentWeekSessions) {
                            // If there are sessions in current week: disabled and auto-calculated
                            checkbox.checked = (status === autoTrainingStatus);
                            checkbox.disabled = true;
                            
                            // Update label classes to show disabled state
                            if (label) {
                                label.classList.remove('bg-white', 'border-2', 'border-gray-300', 'hover:bg-gray-50', 'cursor-pointer');
                                label.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed', 'opacity-60');
                                label.setAttribute('title', 'Calcolato automaticamente in base alle presenze agli allenamenti');
                            }
                            
                            // Show info icon
                            if (parentDiv) {
                                const infoIcon = parentDiv.querySelector('.absolute');
                                if (infoIcon) {
                                    infoIcon.classList.remove('hidden');
                                }
                            }
                        } else {
                            // If NO sessions in current week: enabled and manually selectable
                            checkbox.checked = statusArray.includes(status);
                            checkbox.disabled = false;
                            
                            // Update label classes to show enabled state (match manual status style)
                            if (label) {
                                label.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed', 'opacity-60');
                                label.classList.add('cursor-pointer');
                                label.removeAttribute('title');
                                
                                // Apply the correct color based on status
                                if (status === 'Solo 2 allenamenti') {
                                    label.classList.add('bg-white', 'border-2', 'border-gray-300', 'hover:bg-gray-50');
                                } else if (status === 'Solo 1 allenamento' || status === 'Zero allenamenti') {
                                    label.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                                }
                            }
                            
                            // Hide info icon
                            if (parentDiv) {
                                const infoIcon = parentDiv.querySelector('.absolute');
                                if (infoIcon) {
                                    infoIcon.classList.add('hidden');
                                }
                            }
                        }
                    } else {
                        // Manual status - check if it exists in the saved statuses
                        checkbox.checked = statusArray.includes(status);
                        checkbox.disabled = false;
                    }
                });
                
                // V9.13: Update info message based on whether sessions exist
                const infoMessage = document.querySelector('#status-modal .p-3.bg-blue-50');
                if (infoMessage) {
                    if (hasCurrentWeekSessions) {
                        infoMessage.innerHTML = '<p><strong>‚ÑπÔ∏è Nota:</strong> Gli stati degli allenamenti sono calcolati automaticamente in base alle presenze della settimana corrente e non possono essere modificati manualmente.</p>';
                        infoMessage.classList.remove('hidden');
                    } else {
                        infoMessage.innerHTML = '<p><strong>‚ÑπÔ∏è Nota:</strong> Nessuna sessione di allenamento registrata questa settimana. Gli stati degli allenamenti sono selezionabili manualmente.</p>';
                        infoMessage.classList.remove('hidden');
                    }
                }
                
                statusModal.classList.remove('hidden', 'opacity-0');
                statusModal.classList.add('flex', 'opacity-100');
            }

            function hideModal() {
                statusModal.classList.remove('flex', 'opacity-100');
                statusModal.classList.add('hidden', 'opacity-0');
                // Clear checkboxes when closing
                statusCheckboxes.forEach(checkbox => checkbox.checked = false);
            }

            function showUnavailablePlayerModal(playerName, reason) {
                unavailablePlayerName.textContent = playerName;
                // V6.6: Handle both single status (string) and multiple statuses (array)
                // Multiple statuses displayed as comma-separated list for Mister view
                const reasonText = Array.isArray(reason) ? reason.join(', ') : reason;
                unavailablePlayerReason.textContent = reasonText;
                
                // V6.6: Check if player is already selected (forced convocation)
                const playerItem = document.querySelector(`.player-item[data-player="${playerName}"]`);
                const isAlreadySelected = playerItem && playerItem.classList.contains('selected-mister');
                
                // Show/hide buttons based on selection status
                if (isAlreadySelected) {
                    // Player is already selected - show remove button, hide convoca button
                    convocaComunqueButton.classList.add('hidden');
                    togliConvocazioneButton.classList.remove('hidden');
                } else {
                    // Player is not selected - show convoca button, hide remove button
                    convocaComunqueButton.classList.remove('hidden');
                    togliConvocazioneButton.classList.add('hidden');
                }
                
                unavailablePlayerModal.classList.remove('hidden', 'opacity-0');
                unavailablePlayerModal.classList.add('flex', 'opacity-100');
                tempUnavailablePlayerName = playerName; // salva il nome per il "convoca comunque"
            }

            function hideUnavailablePlayerModal() {
                unavailablePlayerModal.classList.remove('flex', 'opacity-100');
                unavailablePlayerModal.classList.add('hidden', 'opacity-0');
                tempUnavailablePlayerName = null;
            }

            function showAlreadyCalledModal(playerName) {
                alreadyCalledPlayerName.textContent = playerName;
                alreadyCalledModal.classList.remove('hidden', 'opacity-0');
                alreadyCalledModal.classList.add('flex', 'opacity-100');
                tempAlreadyCalledPlayerName = playerName;
            }

            function hideAlreadyCalledModal() {
                alreadyCalledModal.classList.remove('flex', 'opacity-100');
                alreadyCalledModal.classList.add('hidden', 'opacity-0');
                tempAlreadyCalledPlayerName = null;
            }

            function showShareModal() {
                if (userRole !== 'mister') {
                    showMessage("Solo il Mister pu√≤ condividere le convocazioni.", "text-red-600");
                    return;
                }
                
                // Check if Web Share API is supported
                const isWebShareSupported = navigator.share && navigator.canShare;
                const shareSeparator = document.getElementById('share-separator');
                
                // Detect if user is on mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                 (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
                
                if (isWebShareSupported || navigator.share) {
                    webShareButton.classList.remove('hidden');
                    if (shareSeparator) shareSeparator.classList.remove('hidden');
                    
                    // On mobile with Web Share API, make it more prominent
                    if (isMobile) {
                        webShareButton.textContent = 'üì± Condividi';
                        webShareButton.classList.add('bg-green-600', 'hover:bg-green-700');
                        webShareButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    }
                } else {
                    webShareButton.classList.add('hidden');
                    if (shareSeparator) shareSeparator.classList.add('hidden');
                }
                
                shareModal.classList.remove('hidden', 'opacity-0');
                shareModal.classList.add('flex', 'opacity-100');
            }

            function hideShareModal() {
                shareModal.classList.remove('flex', 'opacity-100');
                shareModal.classList.add('hidden', 'opacity-0');
            }

            // Distinta Modal Functions
            function showDistintaLocationModal() {
                distintaLocationModal.classList.remove('hidden', 'opacity-0');
                distintaLocationModal.classList.add('flex', 'opacity-100');
            }

            function hideDistintaLocationModal() {
                distintaLocationModal.classList.remove('flex', 'opacity-100');
                distintaLocationModal.classList.add('hidden', 'opacity-0');
            }

            async function showDistintaDirigentiModal() {
                console.log('üë• DISTINTA FLOW: showDistintaDirigentiModal() called');
                console.log('üîç Current companyDirectors length:', companyDirectors?.length || 0);
                
                // Ensure companyDirectors is loaded before populating the list
                if (companyDirectors.length === 0) {
                    console.log('üì• DISTINTA FLOW: Loading company directors...');
                    companyDirectors = await loadCompanyDirectors();
                    console.log('‚úÖ DISTINTA FLOW: Company directors loaded, count:', companyDirectors?.length || 0);
                } else {
                    console.log('‚úÖ DISTINTA FLOW: Company directors already loaded, count:', companyDirectors.length);
                }
                
                console.log('üéØ Company directors data:', companyDirectors);
                
                console.log('üèóÔ∏è DISTINTA FLOW: Populating dirigenti selection...');
                // Populate the dirigenti list
                populateDirigentiSelection();
                console.log('‚úÖ DISTINTA FLOW: Dirigenti selection populated');
                
                console.log('üé≠ DISTINTA FLOW: Showing dirigenti modal...');
                distintaDirigentiModal.classList.remove('hidden', 'opacity-0');
                distintaDirigentiModal.classList.add('flex', 'opacity-100');
                console.log('‚úÖ DISTINTA FLOW: Dirigenti modal displayed');
            }

            function hideDistintaDirigentiModal() {
                distintaDirigentiModal.classList.remove('flex', 'opacity-100');
                distintaDirigentiModal.classList.add('hidden', 'opacity-0');
                // Note: selectedDirigenti is NOT cleared here to preserve selection for distinta generation
            }

            function showDistintaMatchInfoModal() {
                console.log('üìù DISTINTA FLOW: showDistintaMatchInfoModal() called');
                distintaMatchInfoModal.classList.remove('hidden', 'opacity-0');
                distintaMatchInfoModal.classList.add('flex', 'opacity-100');
            }

            function hideDistintaMatchInfoModal() {
                distintaMatchInfoModal.classList.remove('flex', 'opacity-100');
                distintaMatchInfoModal.classList.add('hidden', 'opacity-0');
            }

            function populateDirigentiSelection() {
                dirigentiSelectionList.innerHTML = '';
                
                if (companyDirectors.length === 0) {
                    dirigentiSelectionList.innerHTML = '<p class="text-gray-500 text-center">Nessun dirigente configurato per questa societ√†.</p>';
                    return;
                }

                companyDirectors.forEach((director, index) => {
                    const fullName = `${director.surname || ''} ${director.name || ''}`.trim() || 'Nome non specificato';
                    const checkboxId = `dirigente-${index}`;
                    
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center p-2 border border-gray-200 rounded hover:bg-gray-50';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" class="dirigente-checkbox mr-3" data-index="${index}">
                        <label for="${checkboxId}" class="flex-1 cursor-pointer">
                            <span class="font-medium">${fullName}</span>
                            ${director.matricola ? `<span class="text-sm text-gray-500 block">Matricola: ${director.matricola}</span>` : ''}
                        </label>
                    `;
                    dirigentiSelectionList.appendChild(checkboxDiv);
                });
            }

            function showDistintaDisplayModal() {
                distintaDisplayModal.classList.remove('hidden', 'opacity-0');
                distintaDisplayModal.classList.add('flex', 'opacity-100');
            }

            function hideDistintaDisplayModal() {
                distintaDisplayModal.classList.remove('flex', 'opacity-100');
                distintaDisplayModal.classList.add('hidden', 'opacity-0');
            }

            // V8.0: Stats Chart Modal Functions
            function showStatsChartModal() {
                statsChartModal.classList.remove('hidden', 'opacity-0');
                statsChartModal.classList.add('flex', 'opacity-100');
                generateStatsChart();
            }

            function hideStatsChartModal() {
                statsChartModal.classList.remove('flex', 'opacity-100');
                statsChartModal.classList.add('hidden', 'opacity-0');
                // Destroy chart instance if it exists
                if (window.statsChart) {
                    window.statsChart.destroy();
                    window.statsChart = null;
                }
            }

            // V8.0: Generate statistics chart for POLIS company
            function generateStatsChart() {
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                
                if (!isPolisCompany) {
                    console.log('üìä Stats chart only available for POLIS company');
                    return;
                }
                
                // Get data from attendance list
                const totalMatches = convocationHistory.length;
                const attendanceRows = document.querySelectorAll('#attendance-list tr');
                
                const playerData = [];
                attendanceRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const playerName = cells[0].textContent.trim();
                        const presences = parseInt(cells[1].textContent.trim()) || 0;
                        const convocationPercentage = parseInt(cells[2].textContent.replace('%', '').trim()) || 0;
                        const availabilityPercentage = cells[3] ? cells[3].textContent.replace('%', '').trim() : 'N/D';
                        
                        playerData.push({
                            name: playerName,
                            totalMatches: totalMatches,
                            presences: presences,
                            convocationPercentage: convocationPercentage,
                            availabilityPercentage: availabilityPercentage
                        });
                    }
                });
                
                // Sort by presences descending
                playerData.sort((a, b) => b.presences - a.presences);
                
                // V9.16: Show all players (removed top 15 limit)
                const displayData = playerData;
                
                // Populate table
                const statsTableBody = document.getElementById('stats-table-body');
                statsTableBody.innerHTML = displayData.map(player => `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${player.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${player.totalMatches}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${player.presences}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${player.convocationPercentage}%</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${player.availabilityPercentage}${player.availabilityPercentage !== 'N/D' ? '%' : ''}</td>
                    </tr>
                `).join('');
                
                // Create chart
                const ctx = document.getElementById('stats-chart-canvas').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.statsChart) {
                    window.statsChart.destroy();
                }
                
                // Prepare chart data
                const labels = displayData.map(p => p.name.length > 20 ? p.name.substring(0, 20) + '...' : p.name);
                const convocationData = displayData.map(p => p.convocationPercentage);
                const availabilityData = displayData.map(p => {
                    return p.availabilityPercentage === 'N/D' ? null : parseInt(p.availabilityPercentage);
                });
                
                window.statsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '% Convocazione',
                                data: convocationData,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2
                            },
                            {
                                label: '% Disponibilit√†',
                                data: availabilityData,
                                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: window.innerWidth < 640 ? 1 : 2,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Statistiche Giocatori',
                                font: {
                                    size: window.innerWidth < 640 ? 14 : 18
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const player = displayData[context.dataIndex];
                                        if (context.datasetIndex === 0) {
                                            return `Convocazioni: ${player.presences}/${player.totalMatches} (${context.parsed.y}%)`;
                                        } else {
                                            return context.parsed.y !== null ? `Disponibilit√†: ${context.parsed.y}%` : 'Disponibilit√†: N/D';
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: {
                                        size: window.innerWidth < 640 ? 9 : 11
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: window.innerWidth < 640 ? 8 : 10
                                    },
                                    maxRotation: window.innerWidth < 640 ? 90 : 45,
                                    minRotation: window.innerWidth < 640 ? 45 : 0
                                }
                            }
                        }
                    }
                });
                
                console.log('üìä Stats chart generated with', displayData.length, 'players');
            }

            // V8.1: Tornei Stats Chart Modal Functions
            function showTorneiStatsChartModal() {
                torneiStatsChartModal.classList.remove('hidden', 'opacity-0');
                torneiStatsChartModal.classList.add('flex', 'opacity-100');
                generateTorneiStatsChart();
            }

            function hideTorneiStatsChartModal() {
                torneiStatsChartModal.classList.remove('flex', 'opacity-100');
                torneiStatsChartModal.classList.add('hidden', 'opacity-0');
                // Destroy chart instance if it exists
                if (window.torneiStatsChart) {
                    window.torneiStatsChart.destroy();
                    window.torneiStatsChart = null;
                }
            }

            // V8.1: Generate Tornei statistics chart for POLIS company
            // V8.6: Fixed to show per-player tournament count instead of total for all
            function generateTorneiStatsChart() {
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                
                if (!isPolisCompany) {
                    console.log('üìä Tornei stats chart only available for POLIS company');
                    return;
                }
                
                // V8.6: Calculate per-player tournament count from convocationHistory
                const playerTorneiCount = {};
                convocationHistory.forEach(convocation => {
                    if (convocation.details?.tipo === 'Torneo') {
                        const players = convocation.players || [];
                        players.forEach(player => {
                            // Handle both old string format and new object format
                            let playerKey;
                            if (typeof player === 'string') {
                                playerKey = player;
                            } else {
                                playerKey = `${player.numero} ${player.nome}`;
                            }
                            playerTorneiCount[playerKey] = (playerTorneiCount[playerKey] || 0) + 1;
                        });
                    }
                });
                
                // Get data from tornei attendance table
                const attendanceRows = document.querySelectorAll('#attendance-list-tornei tr');
                
                const playerData = [];
                attendanceRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        const playerName = cells[0].textContent.trim();
                        const presences = parseInt(cells[1].textContent.trim()) || 0;
                        // For tornei, we only have presences and availability percentage (not convocation percentage)
                        const availabilityPercentage = cells[2] ? cells[2].textContent.replace('%', '').trim() : 'N/D';
                        
                        // V8.6: Use per-player tournament count
                        const totalTornei = playerTorneiCount[playerName] || 0;
                        
                        playerData.push({
                            name: playerName,
                            totalTornei: totalTornei,
                            presences: presences,
                            availabilityPercentage: availabilityPercentage
                        });
                    }
                });
                
                // Sort by presences descending
                playerData.sort((a, b) => b.presences - a.presences);
                
                // V9.16: Show all players (removed top 15 limit)
                const displayData = playerData;
                
                // Populate table
                const torneiStatsTableBody = document.getElementById('tornei-stats-table-body');
                torneiStatsTableBody.innerHTML = displayData.map(player => `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${player.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${player.totalTornei}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${player.presences}</td>
                        <td class="px-4 py-3 text-sm text-gray-500 text-center">${player.availabilityPercentage}${player.availabilityPercentage !== 'N/D' ? '%' : ''}</td>
                    </tr>
                `).join('');
                
                // Create chart
                const ctx = document.getElementById('tornei-stats-chart-canvas').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.torneiStatsChart) {
                    window.torneiStatsChart.destroy();
                }
                
                // Prepare chart data
                const labels = displayData.map(p => p.name.length > 20 ? p.name.substring(0, 20) + '...' : p.name);
                const presencesData = displayData.map(p => p.presences);
                const availabilityData = displayData.map(p => {
                    return p.availabilityPercentage === 'N/D' ? null : parseInt(p.availabilityPercentage);
                });
                
                window.torneiStatsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Presenze ai Tornei',
                                data: presencesData,
                                backgroundColor: 'rgba(234, 179, 8, 0.6)',
                                borderColor: 'rgba(234, 179, 8, 1)',
                                borderWidth: 2,
                                yAxisID: 'y-presences'
                            },
                            {
                                label: '% Disponibilit√†',
                                data: availabilityData,
                                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 2,
                                yAxisID: 'y-percentage'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: window.innerWidth < 640 ? 1 : 2,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: 'Statistiche Tornei - Top 15',
                                font: {
                                    size: window.innerWidth < 640 ? 14 : 18
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const player = displayData[context.dataIndex];
                                        if (context.datasetIndex === 0) {
                                            return `Presenze: ${player.presences}/${player.totalTornei}`;
                                        } else {
                                            return context.parsed.y !== null ? `Disponibilit√†: ${context.parsed.y}%` : 'Disponibilit√†: N/D';
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            'y-presences': {
                                type: 'linear',
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Presenze',
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: window.innerWidth < 640 ? 9 : 11
                                    }
                                }
                            },
                            'y-percentage': {
                                type: 'linear',
                                position: 'right',
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: '% Disponibilit√†',
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: {
                                        size: window.innerWidth < 640 ? 9 : 11
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: window.innerWidth < 640 ? 8 : 10
                                    },
                                    maxRotation: window.innerWidth < 640 ? 90 : 45,
                                    minRotation: window.innerWidth < 640 ? 45 : 0
                                }
                            }
                        }
                    }
                });
                
                console.log('üìä Tornei stats chart generated with', displayData.length, 'players');
            }

            // Distinta Generation Functions
            async function selectDistintaLocation(location) {
                console.log('üìç DISTINTA FLOW: selectDistintaLocation() called with location:', location);
                console.log('üîç Current state before location selection:');
                console.log('   - currentDistintaData exists:', !!window.currentDistintaData);
                console.log('   - userRole:', userRole);
                console.log('   - companyDirectors loaded:', companyDirectors?.length || 0);
                
                hideDistintaLocationModal();
                selectedDistintaLocation = location;
                console.log('‚úÖ DISTINTA FLOW: Location set to:', selectedDistintaLocation);
                
                console.log('üë• DISTINTA FLOW: About to show dirigenti modal...');
                await showDistintaDirigentiModal();
                console.log('‚úÖ DISTINTA FLOW: Dirigenti modal should now be visible');
            }

            function confirmDirigentiSelection() {
                console.log('üîÑ DISTINTA FLOW: confirmDirigentiSelection() called');
                console.log('üéØ Current state - userRole:', userRole);
                console.log('üéØ Current state - currentDistintaData exists:', !!window.currentDistintaData);
                console.log('üéØ Current state - selectedDistintaLocation:', selectedDistintaLocation);
                console.log('üéØ Current state - companyDirectors length:', companyDirectors?.length || 0);
                
                const checkboxes = document.querySelectorAll('.dirigente-checkbox:checked');
                console.log('üìä Found checked dirigente checkboxes:', checkboxes.length);
                
                if (checkboxes.length === 0) {
                    console.warn('‚ö†Ô∏è DISTINTA FLOW WARNING: No dirigenti selected');
                    alert('Devi selezionare almeno un dirigente per continuare.');
                    return;
                }

                selectedDirigenti = [];
                checkboxes.forEach((checkbox, index) => {
                    const dataIndex = parseInt(checkbox.getAttribute('data-index'));
                    console.log(`üìã Processing checkbox ${index}: data-index=${dataIndex}`);
                    if (companyDirectors[dataIndex]) {
                        selectedDirigenti.push(companyDirectors[dataIndex]);
                        console.log(`‚úÖ Added dirigente: ${companyDirectors[dataIndex].name} ${companyDirectors[dataIndex].surname}`);
                    } else {
                        console.error(`‚ùå No dirigente found at index ${dataIndex}`);
                    }
                });

                console.log('üéØ Final selectedDirigenti:', selectedDirigenti);
                console.log('üéØ Selected dirigenti count:', selectedDirigenti.length);
                console.log('üéØ Selected dirigenti names:', selectedDirigenti.map(d => `${d.name} ${d.surname}`));

                console.log('üö™ DISTINTA FLOW: Hiding dirigenti modal...');
                hideDistintaDirigentiModal();
                
                console.log('üìù DISTINTA FLOW: About to show match info modal for Girone and Giornata...');
                showDistintaMatchInfoModal();
            }

            function confirmMatchInfo() {
                console.log('üîÑ DISTINTA FLOW: confirmMatchInfo() called');
                
                selectedGirone = distintaGironeSelect.value;
                selectedGiornata = distintaGiornataInput.value;
                
                console.log('üìù Girone selected:', selectedGirone);
                console.log('üìù Giornata selected:', selectedGiornata);
                
                // Validate that at least one field is filled
                if (!selectedGirone && !selectedGiornata) {
                    alert('Inserisci almeno il girone o il numero della giornata.');
                    return;
                }
                
                console.log('üö™ DISTINTA FLOW: Hiding match info modal...');
                hideDistintaMatchInfoModal();
                
                console.log('üéØ DISTINTA FLOW: About to call generateDistinta()');
                console.log('üîç Pre-generateDistinta state check:');
                console.log('   - currentDistintaData exists:', !!window.currentDistintaData);
                console.log('   - selectedDistintaLocation:', selectedDistintaLocation);
                console.log('   - selectedDirigenti count:', selectedDirigenti.length);
                console.log('   - selectedGirone:', selectedGirone);
                console.log('   - selectedGiornata:', selectedGiornata);
                
                generateDistinta();
            }

            function generateDistinta() {
                console.log('üöÄ DISTINTA FLOW: generateDistinta() function called');
                console.log('üìä Function entry state:');
                console.log('   - currentDistintaData:', window.currentDistintaData);
                console.log('   - selectedDistintaLocation:', selectedDistintaLocation);
                console.log('   - selectedDirigenti:', selectedDirigenti);
                console.log('   - selectedDirigenti length:', selectedDirigenti?.length || 0);
                
                // Validation check 1: currentDistintaData
                if (!window.currentDistintaData) {
                    console.error('‚ùå DISTINTA FLOW ERROR: currentDistintaData not available');
                    console.log('üîç window.currentDistintaData value:', window.currentDistintaData);
                    showMessage("Errore: dati convocazione non disponibili.", "text-red-600");
                    return;
                }
                console.log('‚úÖ DISTINTA FLOW: currentDistintaData validation passed');
                
                // Validation check 2: selectedDistintaLocation
                if (!selectedDistintaLocation) {
                    console.error('‚ùå DISTINTA FLOW ERROR: selectedDistintaLocation not available');
                    console.log('üîç selectedDistintaLocation value:', selectedDistintaLocation);
                    showMessage("Errore: ubicazione partita non selezionata.", "text-red-600");
                    return;
                }
                console.log('‚úÖ DISTINTA FLOW: selectedDistintaLocation validation passed');

                // Validation check 3: selectedDirigenti
                if (selectedDirigenti.length === 0) {
                    console.error('‚ùå DISTINTA FLOW ERROR: no dirigenti selected');
                    console.log('üîç selectedDirigenti:', selectedDirigenti);
                    console.log('üîç selectedDirigenti length:', selectedDirigenti.length);
                    showMessage("Errore: nessun dirigente selezionato.", "text-red-600");
                    return;
                }
                console.log('‚úÖ DISTINTA FLOW: selectedDirigenti validation passed');
                console.log('üéØ All validations passed, proceeding with distinta generation...');
                
                const convocationData = window.currentDistintaData;
                console.log('üìã Using convocation data for distinta generation:', convocationData);
                console.log('üìç Using location for distinta generation:', selectedDistintaLocation);
                
                console.log('üèóÔ∏è DISTINTA FLOW: Calling createDistintaContent()...');
                const content = createDistintaContent(convocationData, selectedDistintaLocation);
                console.log('‚úÖ DISTINTA FLOW: createDistintaContent() completed');
                console.log('üìÑ Generated content length:', content?.length || 0);
                console.log('üìÑ Generated content preview (first 200 chars):', content?.substring(0, 200) || 'No content');
                
                console.log('üñºÔ∏è DISTINTA FLOW: Setting innerHTML on distintaContent element...');
                if (distintaContent) {
                    distintaContent.innerHTML = content;
                    console.log('‚úÖ DISTINTA FLOW: distintaContent.innerHTML set successfully');
                } else {
                    console.error('‚ùå DISTINTA FLOW ERROR: distintaContent element not found');
                    return;
                }
                
                console.log('üéâ DISTINTA FLOW: Showing distinta display modal...');
                showDistintaDisplayModal();
                console.log('üéä DISTINTA FLOW COMPLETE: Distinta should now be visible to user');
            }
            
            function createDistintaContent(convocationData, location) {
                console.log('üèóÔ∏è CREATE DISTINTA: createDistintaContent() called');
                console.log('üìã Input convocation data:', convocationData);
                console.log('üìç Input location:', location);
                
                // Get company info
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || 'Societ√† Demo';
                const companyCategory = localStorage.getItem(`categoria_${currentCompanyCode}`) || '';
                console.log('üè¢ Company info - name:', companyName, 'category:', companyCategory);
                
                // Get complete company information from localStorage
                let companyInfo = {};
                try {
                    const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                    if (savedInfo) {
                        companyInfo = JSON.parse(savedInfo);
                        console.log('‚úÖ CREATE DISTINTA: Company info loaded from localStorage:', companyInfo);
                    } else {
                        console.log('‚ÑπÔ∏è CREATE DISTINTA: No company info in localStorage, using defaults from currentCompanyData');
                        // V9.14: Fallback to basic company info if not saved in Gestione Squadra
                        companyInfo = {
                            ragioneSociale: companyName,
                            categoria: companyCategory
                        };
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è CREATE DISTINTA: Could not parse company info:', error);
                    // V9.14: Fallback to basic company info on error
                    companyInfo = {
                        ragioneSociale: companyName,
                        categoria: companyCategory
                    };
                }
                
                // Format match date
                console.log('üìÖ CREATE DISTINTA: Formatting match date...');
                let formattedMatchDate = convocationData.details.data;
                if (convocationData.details.data && convocationData.details.data !== 'N/D') {
                    const matchDate = new Date(convocationData.details.data + 'T00:00:00');
                    const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                    const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                    const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                    formattedMatchDate = `${dayOfWeek} ${dateString}`;
                }
                console.log('üìÖ CREATE DISTINTA: Formatted match date:', formattedMatchDate);
                
                // Create player rows with proper formatting
                console.log('üë• CREATE DISTINTA: Creating player rows...');
                const playerRows = createPlayerRows(convocationData.players);
                console.log('üë• CREATE DISTINTA: Player rows created, length:', playerRows?.length || 0);
                
                // Create coach rows with only match-specific coaches
                console.log('üëî CREATE DISTINTA: Creating staff rows...');
                const staffRows = createStaffRows(convocationData);
                console.log('üëî CREATE DISTINTA: Staff rows created, length:', staffRows?.length || 0);
                
                const locationText = location === 'casa' ? 'IN CASA' : 'IN TRASFERTA';
                console.log('üìç CREATE DISTINTA: Location text:', locationText);
                
                console.log('üèóÔ∏è CREATE DISTINTA: Building HTML content...');
                
                return `
                    <div style="font-family: Arial, Helvetica, sans-serif; line-height: 1.3; font-size: 11px; width: 180mm; margin: 10mm auto; padding: 10mm;">
                        <div style="text-align: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 8px;">
                            <h1 style="font-size: 16px; font-weight: bold; margin: 0 0 4px 0;">${companyInfo.ragioneSociale || companyName}</h1>
                            ${companyInfo.indirizzo ? `<p style="font-size: 11px; margin: 2px 0;">${companyInfo.indirizzo}</p>` : ''}
                            ${companyInfo.telefono || companyInfo.mail ? `<p style="font-size: 11px; margin: 2px 0;">Tel: ${companyInfo.telefono || 'N/D'} - Email: ${companyInfo.mail || 'N/D'}</p>` : ''}
                            ${companyInfo.partitaIva ? `<p style="font-size: 11px; margin: 2px 0;">P.IVA: ${companyInfo.partitaIva}</p>` : ''}
                            ${companyCategory ? `<p style="font-size: 11px; margin: 3px 0;"><strong>Categoria:</strong> ${companyCategory}</p>` : ''}
                            <h2 style="font-size: 14px; font-weight: bold; margin: 5px 0;">DISTINTA UFFICIALE</h2>
                            <p style="font-size: 12px; margin: 3px 0;"><strong>Partita ${locationText}</strong></p>
                            
                            <!-- Team positioning based on home/away - Compact for PDF -->
                            <div style="margin: 8px 0; display: flex; justify-content: space-between; align-items: center; border: 2px solid #000; padding: 12px; background-color: #f8f9fa;">
                                ${location === 'casa' ? 
                                    `<div style="text-align: left; font-weight: bold; font-size: 13px; width: 45%;">${companyName.toUpperCase()}</div>
                                     <div style="text-align: center; font-weight: bold; font-size: 15px; width: 10%;">VS</div>
                                     <div style="text-align: right; font-weight: bold; font-size: 13px; width: 45%;">${(convocationData.details.avversario || 'N/D').toUpperCase()}</div>` :
                                    `<div style="text-align: left; font-weight: bold; font-size: 13px; width: 45%;">${(convocationData.details.avversario || 'N/D').toUpperCase()}</div>
                                     <div style="text-align: center; font-weight: bold; font-size: 15px; width: 10%;">VS</div>
                                     <div style="text-align: right; font-weight: bold; font-size: 13px; width: 45%;">${companyName.toUpperCase()}</div>`
                                }
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px; font-size: 11px; line-height: 1.4;">
                            <p style="margin: 2px 0;"><strong>Data:</strong> ${formattedMatchDate}</p>
                            <p style="margin: 2px 0;"><strong>Orario:</strong> ${convocationData.details.orarioPartita || 'N/D'}</p>
                            <p style="margin: 2px 0;"><strong>Campo:</strong> ${convocationData.details.campo || 'N/D'}</p>
                            
                            ${companyInfo.categoria ? `<p style="margin: 2px 0;"><strong>Categoria:</strong> ${companyInfo.categoria}</p>` : ''}
                            <p style="margin: 2px 0;"><strong>Girone:</strong> ${selectedGirone || '_____'}</p>
                            <p style="margin: 2px 0;"><strong>Giornata:</strong> ${selectedGiornata || '_____'}</p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 11px; page-break-inside: avoid;">
                            <thead>
                                <tr style="border-bottom: 2px solid #000;">
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 6%; line-height: 1.3;">N¬∞</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 26%; line-height: 1.3;">COGNOME E NOME</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 16%; line-height: 1.3;">DATA NASCITA</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 16%; line-height: 1.3;">MATRICOLA</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 12%; line-height: 1.3;">CAPITANO</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 12%; line-height: 1.3;">AMMONITO</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 12%; line-height: 1.3;">ESPULSO</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${playerRows}
                            </tbody>
                        </table>
                        
                        <div style="margin: 10px 0;">
                            <h3 style="font-size: 12px; font-weight: bold; margin-bottom: 6px;">STAFF TECNICO:</h3>
                            ${staffRows}
                        </div>
                        
                        <div style="margin-top: 12px; margin-bottom: 10px;">
                            <p style="font-size: 11px; text-align: justify; line-height: 1.4;">
                                Io sottoscritto dirigente accompagnatore Ufficiale, dichiaro che i giocatori sopraindicati sono regolarmente tesserati e partecipano alla gara sotto la responsabilit√† della Societ√† di appartenenza giusto le norme vigenti.
                            </p>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                            <div style="text-align: center; width: 45%;">
                                <p style="border-bottom: 1px solid #000; padding-bottom: 25px; margin-bottom: 3px;"></p>
                                <p style="font-size: 11px; font-weight: bold;">FIRMA ARBITRO</p>
                            </div>
                            <div style="text-align: center; width: 45%;">
                                <p style="border-bottom: 1px solid #000; padding-bottom: 25px; margin-bottom: 3px;"></p>
                                <p style="font-size: 11px; font-weight: bold;">FIRMA DIRIGENTE</p>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ CREATE DISTINTA: HTML content template generation completed successfully');
                return content;
            }
            
            function createPlayerRows(players) {
                let rows = '';
                let playerNumber = 1;
                
                // Get extended player data if available
                const extendedPlayers = getExtendedPlayerData();
                
                players.forEach(playerString => {
                    // Extract player info from the string format "NUMBER NAME"
                    const parts = playerString.split(' ');
                    const number = parts[0];
                    const name = parts.slice(1).join(' ');
                    
                    // Try to find extended data for this player
                    const extendedData = extendedPlayers.find(p => 
                        p.name === name || 
                        p.name === playerString ||
                        (p.numero && p.numero.toString() === number)
                    );
                    
                    let birthDate = '___/___/______';
                    if (extendedData?.dataNascita) {
                        // Format the birth date as DD/MM/YYYY
                        const date = new Date(extendedData.dataNascita);
                        if (!isNaN(date.getTime())) {
                            birthDate = date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        } else {
                            // If the date is already in string format, use it as is
                            birthDate = extendedData.dataNascita;
                        }
                    }
                    const matricola = extendedData?.matricola || '__________';
                    
                    rows += `
                        <tr style="border-bottom: 1px solid #000;">
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${number}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${name}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${birthDate}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${matricola}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;"></td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;"></td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;"></td>
                        </tr>
                    `;
                });
                
                return rows;
            }
            
            function createStaffRows(convocationData) {
                let rows = '';
                
                // Function to get coach matricola by name
                function getCoachMatricola(coachName) {
                    if (!companyCoaches || !coachName) return '__________';
                    
                    const coach = companyCoaches.find(c => 
                        (typeof c === 'string' ? c : c.name) === coachName
                    );
                    
                    if (coach && typeof coach === 'object' && coach.matricola) {
                        return coach.matricola;
                    }
                    return '__________';
                }
                
                // Get match-specific coaches from convocation data
                // Look for mister information in the match details
                const misterPartita = convocationData?.details?.misterPartita;
                const misterTipo = convocationData?.details?.misterTipo;
                
                // Left side: Coaches
                let coachesRows = '';
                
                // Show both coaches as "Allenatore"
                if (misterPartita && misterPartita !== 'N/D' && misterPartita !== 'Seleziona mister') {
                    const matricola = getCoachMatricola(misterPartita);
                    coachesRows += `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Allenatore:</strong> ${misterPartita} - Matricola: ${matricola}
                        </p>
                    `;
                }
                
                if (misterTipo && misterTipo !== 'N/D' && misterTipo !== 'Seleziona mister' && misterTipo !== misterPartita) {
                    const matricola = getCoachMatricola(misterTipo);
                    coachesRows += `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Allenatore:</strong> ${misterTipo} - Matricola: ${matricola}
                        </p>
                    `;
                }
                
                // If no specific coaches are assigned, show default empty fields
                if (!coachesRows) {
                    coachesRows = `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Allenatore:</strong> ________________ - Matricola: __________
                        </p>
                    `;
                }
                
                // Right side: Directors (only selected ones)
                let directorsRows = '';
                if (selectedDirigenti && selectedDirigenti.length > 0) {
                    selectedDirigenti.forEach(director => {
                        const fullName = `${director.name || ''} ${director.surname || ''}`.trim();
                        const matricola = director.matricola || '__________';
                        directorsRows += `
                            <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                                <strong>Dirigente:</strong> ${fullName} - Matricola: ${matricola}
                            </p>
                        `;
                    });
                } else {
                    directorsRows = `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Dirigente:</strong> ________________ - Matricola: __________
                        </p>
                    `;
                }
                
                // Combine both sides with proper layout
                rows = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="width: 48%;">
                            ${coachesRows}
                        </div>
                        <div style="width: 48%;">
                            ${directorsRows}
                        </div>
                    </div>
                `;
                
                return rows;
            }
            
            function getExtendedPlayerData() {
                // Try to get full player data from various sources
                let players = [];
                
                // Try from companyPlayers first
                if (companyPlayers && companyPlayers.length > 0) {
                    players = companyPlayers;
                } else {
                    // Fallback: try to get from localStorage
                    try {
                        const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                        if (savedPlayers) {
                            players = JSON.parse(savedPlayers);
                        }
                    } catch (error) {
                        console.warn('Could not parse saved players:', error);
                    }
                }
                
                return players;
            }
            
            // Distinta Action Functions
            function copyDistintaToClipboard() {
                const content = distintaContent.innerText;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(content).then(() => {
                        showMessage("Distinta copiata negli appunti!", "text-green-600");
                    }).catch(err => {
                        console.error('Errore nel copiare negli appunti:', err);
                        fallbackCopyText(content);
                    });
                } else {
                    fallbackCopyText(content);
                }
            }
            
            function fallbackCopyText(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showMessage("Distinta copiata negli appunti!", "text-green-600");
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    showMessage("Errore nel copiare negli appunti.", "text-red-600");
                }
                
                document.body.removeChild(textArea);
            }
            
            function printDistinta() {
                const content = distintaContent.innerHTML;
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Distinta Ufficiale</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                margin: 20px;
                                line-height: 1.4;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                            }
                            th, td { 
                                border: 1px solid #000; 
                                padding: 8px; 
                                text-align: left; 
                            }
                            @media print {
                                body { margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            }
            
            function shareDistinta() {
                shareDistintaAsPDF();
            }
            
            async function shareDistintaAsPDF() {
                try {
                    // Generate PDF from distinta content
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Get the distinta content element
                    const element = distintaContent;
                    
                    // Use html2canvas to convert to image first, then add to PDF
                    // Optimized settings for compact A4 formatting
                    const canvas = await html2canvas(element, {
                        scale: 1.5, // Reduced scale for better single-page fit
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        allowTaint: true,
                        width: element.scrollWidth,
                        height: element.scrollHeight,
                        scrollX: 0,
                        scrollY: 0
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Calculate dimensions to fit single A4 page with margins
                    const margins = 10; // Reduced margins for more space
                    const imgWidth = 210 - (margins * 2); // A4 width minus margins
                    const maxHeight = 297 - (margins * 2); // A4 height minus margins
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Scale down if content is too tall to fit on single page
                    let finalWidth = imgWidth;
                    let finalHeight = imgHeight;
                    
                    if (imgHeight > maxHeight) {
                        // Scale down to fit height
                        finalHeight = maxHeight;
                        finalWidth = (canvas.width * finalHeight) / canvas.height;
                        
                        // Center horizontally if scaled down
                        const xOffset = margins + (imgWidth - finalWidth) / 2;
                        pdf.addImage(imgData, 'PNG', xOffset, margins, finalWidth, finalHeight);
                    } else {
                        // Center vertically if content doesn't fill page
                        const yOffset = margins + (maxHeight - finalHeight) / 2;
                        pdf.addImage(imgData, 'PNG', margins, yOffset, finalWidth, finalHeight);
                    }
                    
                    // Generate filename with match details
                    const matchDate = document.getElementById('share-data-partita')?.textContent || new Date().toLocaleDateString('it-IT');
                    const opponent = document.getElementById('share-avversario')?.textContent || 'Partita';
                    const filename = `Distinta_${opponent.replace(/\s+/g, '_')}_${matchDate.replace(/\//g, '-')}.pdf`;
                    
                    // Check if device supports Web Share API with files
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert PDF to blob
                            const pdfBlob = pdf.output('blob');
                            const file = new File([pdfBlob], filename, { type: 'application/pdf' });
                            
                            const shareData = {
                                title: 'Distinta Ufficiale',
                                text: 'Distinta ufficiale della partita',
                                files: [file]
                            };
                            
                            if (navigator.canShare(shareData)) {
                                await navigator.share(shareData);
                                showMessage("Distinta PDF condivisa con successo!", "text-green-600");
                                console.log('‚úÖ PDF shared successfully via Web Share API');
                                return;
                            }
                        } catch (webShareError) {
                            console.log('Web Share with PDF failed:', webShareError);
                        }
                    }
                    
                    // Fallback: download the PDF
                    pdf.save(filename);
                    showMessage("PDF della distinta scaricato!", "text-green-600");
                    console.log('üìÅ PDF downloaded:', filename);
                    
                } catch (error) {
                    console.error('‚ùå Error generating PDF:', error);
                    // Fallback to the old image method if PDF generation fails
                    try {
                        console.log('üîÑ Falling back to image sharing...');
                        await shareDistintaAsImage();
                        showMessage("Errore PDF, condivisa come immagine!", "text-orange-600");
                    } catch (fallbackError) {
                        console.error('‚ùå Image fallback also failed:', fallbackError);
                        showMessage("Errore nella generazione del file. Usa 'Copia Distinta' come alternativa.", "text-red-600");
                        // Final fallback to text copy
                        copyDistintaToClipboard();
                    }
                }
            }
            
            async function shareDistintaAsImage() {
                try {
                    // Generate image from distinta content
                    const canvas = await html2canvas(distintaContent, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    });
                    
                    const imageDataUrl = canvas.toDataURL("image/png");
                    
                    // Prepare share text for distinta
                    const shareText = `üìã Distinta Ufficiale\n\n‚öΩ Rosterkick`;

                    // Detect if user is on mobile device
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                     (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));

                    // Try Web Share API first (prioritize on mobile)
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert data URL to blob
                            const response = await fetch(imageDataUrl);
                            const blob = await response.blob();
                            const file = new File([blob], `distinta-ufficiale-${new Date().toLocaleDateString('it-IT')}.png`, { type: 'image/png' });

                            const shareDataWithFile = {
                                title: 'Distinta Ufficiale',
                                text: shareText,
                                files: [file]
                            };

                            // Check if sharing with files is supported
                            if (navigator.canShare(shareDataWithFile)) {
                                await navigator.share(shareDataWithFile);
                                showMessage("Distinta condivisa con successo!", "text-green-600");
                                return;
                            }
                        } catch (fileShareError) {
                            console.log('File sharing failed for distinta, trying text sharing');
                        }

                        // Try text sharing without file
                        try {
                            await navigator.share({
                                title: 'Distinta Ufficiale',
                                text: shareText
                            });
                            
                            // Download image separately since we couldn't share it directly
                            downloadDistintaImage(imageDataUrl);
                            showMessage("Condivisione avviata! L'immagine √® stata scaricata separatamente.", "text-blue-600");
                            return;
                        } catch (textShareError) {
                            console.log('Text sharing failed for distinta, falling back to download');
                        }
                    }
                    
                    // Final fallback: download the image
                    downloadDistintaImage(imageDataUrl);
                    showMessage("Web Share non disponibile. Immagine della distinta scaricata!", "text-orange-600");
                    
                } catch (error) {
                    console.error('Errore nella condivisione della distinta:', error);
                    showMessage("Errore nella generazione dell'immagine. Usa il pulsante 'Copia Distinta' come alternativa.", "text-red-600");
                    // Fallback to text copy
                    copyDistintaToClipboard();
                }
            }
            
            // Helper function to download distinta image
            function downloadDistintaImage(imageDataUrl) {
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = `distinta-ufficiale-${new Date().toLocaleDateString('it-IT')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Event listeners for new company-based navigation
            verifyCompanyButton.addEventListener('click', async () => {
                const companyCode = companyCodeInput.value.trim();
                if (!companyCode) {
                    companyEntryMessageArea.textContent = "Inserisci un codice societ√†.";
                    companyEntryMessageArea.classList.remove('hidden');
                    companyEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                    return;
                }

                try {
                    const companyData = await verifyCompanyCode(companyCode);
                    if (companyData) {
                        currentCompanyCode = companyCode;
                        window.currentCompanyCode = currentCompanyCode;
                        currentCompanyData = companyData;
                        
                        // Store document ID if available (from Firebase/cercaSocietaDaCodice)
                        if (currentCompanyData.data && currentCompanyData.data.id) {
                            currentCompanyDocumentId = currentCompanyData.data.id;
                        } else {
                            // Fallback to company code for demo mode
                            currentCompanyDocumentId = companyCode;
                        }
                        
                        // Populate passwords from data.config if available
                        if (currentCompanyData.data && currentCompanyData.data.config) {
                            currentCompanyData.passwords = {
                                ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                dirigente: currentCompanyData.data.config.dirigentePassword,
                                mister: currentCompanyData.data.config.misterPassword
                            };
                        }
                        
                        window.currentCompanyData = currentCompanyData;
                        companyPlayers = await loadCompanyPlayers();
                        companyCoaches = await loadCompanyCoaches();
                        companyDirectors = await loadCompanyDirectors();
                        
                        if (rememberCompanyCheckbox.checked) {
                            localStorage.setItem('companyCode', companyCode);
                            localStorage.setItem('companyData', JSON.stringify(companyData));
                            localStorage.setItem('rememberCompanyPreference', 'true');
                            // Show confirmation message
                            setTimeout(() => {
                                companyEntryMessageArea.textContent = "Codice societ√† salvato!";
                                companyEntryMessageArea.classList.remove('hidden', 'text-red-600');
                                companyEntryMessageArea.classList.add('text-green-600');
                                setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 3000);
                            }, 500);
                        } else {
                            localStorage.removeItem('companyCode');
                            localStorage.removeItem('companyData');
                            localStorage.setItem('rememberCompanyPreference', 'false');
                        }
                        
                        // Hide any error messages
                        companyEntryMessageArea.classList.add('hidden');
                        companyEntryMessageArea.classList.remove('text-red-600');
                        
                        showCompanyWelcome();
                    } else {
                        companyEntryMessageArea.textContent = "Codice societ√† non valido.";
                        companyEntryMessageArea.classList.remove('hidden');
                        companyEntryMessageArea.classList.add('text-red-600');
                        setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                    }
                } catch (error) {
                    companyEntryMessageArea.textContent = "Errore nella verifica. Riprova.";
                    companyEntryMessageArea.classList.remove('hidden');
                    companyEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                }
            });

            enterMisterButton.addEventListener('click', () => {
                showPasswordEntry('mister');
            });

            enterDirigenteButton.addEventListener('click', () => {
                showPasswordEntry('dirigente');
            });

            viewHistoryButton.addEventListener('click', () => {
                // Use document ID as app ID (fallback to company code for demo mode)
                const companyAppId = currentCompanyDocumentId || currentCompanyCode;
                currentAppId = companyAppId;
                historyPreviousView = 'welcome'; // track that we came from welcome screen
                hideAllScreens();
                historyView.classList.remove('hidden');
                pushNavigationState('history');
                setupFirestoreListeners(companyAppId);
            });

            welcomeAttendanceButton.addEventListener('click', () => {
                // üîç DIAGNOSTIC LOG: Opening Riepilogo Presenze with company info from welcome screen
                console.log(`üìä [DIAGNOSTIC] Apertura Riepilogo Presenze da schermata benvenuto:`);
                console.log(`   üè¢ Societ√† corrente - Codice: ${currentCompanyCode}`);
                console.log(`   üè¢ Societ√† corrente - Document ID: ${currentCompanyDocumentId}`);
                console.log(`   üè¢ Societ√† corrente - Nome: ${currentCompanyData?.name || currentCompanyData?.data?.nome || 'N/A'}`);
                console.log(`   üìã App ID utilizzato per i dati: ${currentAppId}`);
                console.log(`   üë§ Ruolo utente: ${userRole}`);
                
                // Check if company IDs are consistent
                const expectedAppId = currentCompanyDocumentId || currentCompanyCode;
                if (currentAppId !== expectedAppId) {
                    console.warn(`‚ö†Ô∏è [DIAGNOSTIC] INCONSISTENZA RILEVATA:`);
                    console.warn(`   App ID attuale: ${currentAppId}`);
                    console.warn(`   App ID atteso: ${expectedAppId}`);
                    console.warn(`   Correggendo l'App ID per visualizzare i dati corretti`);
                    
                    // Fix the inconsistency by updating currentAppId and refreshing listeners
                    currentAppId = expectedAppId;
                    console.log(`üîß [DIAGNOSTIC] App ID corretto a: ${currentAppId}`);
                    
                    // Refresh Firestore listeners with correct company ID
                    setupFirestoreListeners(currentAppId);
                }
                
                attendancePreviousView = 'welcome'; // track that we came from welcome screen
                // Hide all screens and show attendance view
                hideAllScreens();
                attendanceView.classList.remove('hidden');
                pushNavigationState('attendance');
                
                // Show loading spinner, hide content
                const loadingElement = document.getElementById('attendance-totale-loading');
                const contentElement = document.getElementById('attendance-totale-content');
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (contentElement) contentElement.classList.add('hidden');
                
                // Ensure convocation history is loaded before updating tables
                ensureConvocationHistoryLoaded().then(() => {
                    // Update total attendance table (Riepilogo Totale)
                    loadAttendance(null);
                    // Update filtered attendance tables with current data
                    updateAttendanceTables();
                });
            });

            // V9.10: Training attendance button event listener - COMMENTED OUT - Feature removed
            // trainingAttendanceButton.addEventListener('click', () => {
            //     console.log('üìä Opening Training Attendance View...');
            //     hideAllScreens();
            //     trainingAttendanceView.classList.remove('hidden');
            //     loadTrainingAttendance(); // Load data when opening the view
            // });

            allenamentiButton.addEventListener('click', () => {
                console.log('üèÉ Opening Allenamenti Management View... (V8.11)');
                hideAllScreens();
                allenamentiView.classList.remove('hidden');
                pushNavigationState('allenamenti');
                loadAllenamentiData(); // Load training sessions and report data
            });

            campionatoButton.addEventListener('click', () => {
                console.log('‚öΩ Opening Campionato View...');
                hideAllScreens();
                campionatoView.classList.remove('hidden');
                pushNavigationState('campionato');
                
                // Center "Risultati" widget only for PIEVE2010 company
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                if (companyName === 'PIEVE2010') {
                    const risultatiContainer = document.getElementById('risultati-widget-container');
                    if (risultatiContainer) {
                        risultatiContainer.style.display = 'flex';
                        risultatiContainer.style.justifyContent = 'center';
                        risultatiContainer.style.alignItems = 'center';
                        console.log('üéØ Risultati widget centered for POLIS PIEVE 2010');
                    }
                }
            });

            managePlayersButton.addEventListener('click', () => {
                showPlayerManagement();
            });

            // Risultati button handler - Opens Polis2013 site in new tab (no pre-filled code)
            // This button is ALWAYS visible to ALL users regardless of company
            areaPolis2013Button.addEventListener('click', () => {
                console.log('üîó Opening Risultati (Polis2013 page)...');
                
                // Open main page in new tab (without pre-filled code)
                // Users must manually enter their access code
                const url = 'https://marcoc82.github.io/polis2013/';
                console.log('üîó Opening:', url);
                window.open(url, '_blank');
            });

            companyLogoutButton.addEventListener('click', () => {
                // Always remove session-specific data
                localStorage.removeItem('userRole');
                localStorage.removeItem('convocazioniAppId');
                
                // Check if user wants to remember company code
                const rememberPreference = localStorage.getItem('rememberCompanyPreference');
                if (rememberPreference !== 'true') {
                    // If user doesn't want to remember, remove company data
                    localStorage.removeItem('companyCode');
                    localStorage.removeItem('companyData');
                }
                
                // Reset application state
                currentCompanyCode = null;
                window.currentCompanyCode = currentCompanyCode;
                currentCompanyData = null;
                window.currentCompanyData = currentCompanyData;
                companyPlayers = [];
                userRole = null;
                hideAllScreens();
                companyEntryScreen.classList.remove('hidden'); // mostra schermata di login/codice societ√†
                // Trigger login animations sequence
                setTimeout(() => startLoginAnimations(), 100);
            });

            // Common password validation function for main script
            async function handlePasswordSubmissionMain() {
                const password = passwordInput.value.trim();
                if (!password) {
                    passwordEntryMessageArea.textContent = "Inserisci la password.";
                    passwordEntryMessageArea.classList.remove('hidden');
                    passwordEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => passwordEntryMessageArea.classList.add('hidden'), 5000);
                    return;
                }

                const isValid = await verifyPassword(pendingRole, password);
                if (isValid) {
                    userRole = pendingRole;
                    localStorage.setItem('userRole', userRole);
                    
                    // üîç DIAGNOSTIC LOG: Login as mister/dirigente with company info
                    console.log(`üîë [DIAGNOSTIC] Login come ${userRole}:`);
                    console.log(`   üè¢ Societ√† attiva - Codice: ${currentCompanyCode}`);
                    console.log(`   üè¢ Societ√† attiva - Document ID: ${currentCompanyDocumentId}`);
                    console.log(`   üè¢ Societ√† attiva - Nome: ${currentCompanyData?.name || currentCompanyData?.data?.nome || 'N/A'}`);
                    console.log(`   üìã App ID che verr√† utilizzato: ${currentCompanyDocumentId || currentCompanyCode}`);
                    
                    // Register biometric authentication if not already enrolled
                    if (isBiometricSupported() && !hasBiometricEnrolled(currentCompanyCode, userRole)) {
                        console.log('üì± Attempting to register biometric authentication...');
                        const registered = await registerBiometric(currentCompanyCode, userRole, password);
                        if (registered) {
                            showMessage(passwordEntryMessageArea, "‚úÖ Autenticazione biometrica attivata per i prossimi accessi!", false);
                            setTimeout(() => passwordEntryMessageArea.classList.add('hidden'), 3000);
                        }
                    }
                    
                    // Load company players from Firebase database
                    companyPlayers = await loadCompanyPlayers();
                    companyCoaches = await loadCompanyCoaches();
                    companyDirectors = await loadCompanyDirectors();
                    
                    // Use document ID as app ID (fallback to company code for demo mode)
                    const companyAppId = currentCompanyDocumentId || currentCompanyCode;
                    localStorage.setItem('convocazioniAppId', companyAppId);
                    startApp(companyAppId);
                } else {
                    passwordEntryMessageArea.textContent = "Password errata.";
                    passwordEntryMessageArea.classList.remove('hidden');
                    passwordEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => passwordEntryMessageArea.classList.add('hidden'), 5000);
                }
            }

            confirmPasswordButton.addEventListener('click', handlePasswordSubmissionMain);

            // Handle form submission (Enter key)
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent default form submission
                handlePasswordSubmissionMain();
            });
            
            // Biometric login button handler
            if (biometricLoginButton) {
                biometricLoginButton.addEventListener('click', async () => {
                if (!pendingRole || !currentCompanyCode) {
                    showMessage(passwordEntryMessageArea, "Errore: dati di autenticazione mancanti.");
                    return;
                }
                
                // Show loading state
                biometricLoginButton.disabled = true;
                biometricLoginButton.innerHTML = `
                    <svg class="animate-spin h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Autenticazione in corso...</span>
                `;
                
                try {
                    const password = await authenticateWithBiometric(currentCompanyCode, pendingRole);
                    
                    if (password) {
                        // Biometric authentication successful, verify password
                        const isValid = await verifyPassword(pendingRole, password);
                        
                        if (isValid) {
                            userRole = pendingRole;
                            localStorage.setItem('userRole', userRole);
                            
                            console.log(`üîë [BIOMETRIC] Login come ${userRole} tramite impronta digitale`);
                            console.log(`   üè¢ Societ√† attiva - Codice: ${currentCompanyCode}`);
                            
                            // Load company data
                            companyPlayers = await loadCompanyPlayers();
                            companyCoaches = await loadCompanyCoaches();
                            companyDirectors = await loadCompanyDirectors();
                            
                            const companyAppId = currentCompanyDocumentId || currentCompanyCode;
                            localStorage.setItem('convocazioniAppId', companyAppId);
                            startApp(companyAppId);
                        } else {
                            // Stored password is invalid (may have been changed)
                            showMessage(passwordEntryMessageArea, "‚ö†Ô∏è Credenziali biometriche non valide. Inserisci la password.");
                            clearBiometricCredentials(currentCompanyCode, pendingRole);
                            if (biometricLoginContainer) {
                                biometricLoginContainer.classList.add('hidden');
                            }
                        }
                    } else {
                        // Biometric authentication failed or was cancelled
                        showMessage(passwordEntryMessageArea, "Autenticazione biometrica fallita. Inserisci la password.");
                    }
                } catch (error) {
                    console.error('Errore durante autenticazione biometrica:', error);
                    showMessage(passwordEntryMessageArea, "Errore nell'autenticazione biometrica. Usa la password.");
                } finally {
                    // Reset button state
                    biometricLoginButton.disabled = false;
                    biometricLoginButton.innerHTML = `
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"></path>
                        </svg>
                        <span>Accedi con impronta digitale</span>
                    `;
                }
            });
            }

            cancelPasswordButton.addEventListener('click', () => {
                pendingRole = null;
                passwordInput.value = '';
                showCompanyWelcome();
            });

            addPlayerButton.addEventListener('click', async () => {
                // Get values from form fields
                const numero = playerNumeroInput.value.trim();
                const nome = playerNomeInput.value.trim();
                const dataNascita = playerDataNascitaInput.value.trim();
                const matricola = playerMatricolaInput.value.trim();
                
                // Validate required fields
                if (!numero || !nome || !dataNascita || !matricola) {
                    showMessage("Tutti i campi sono obbligatori: numero, nome, data di nascita, matricola.", "text-red-600");
                    return;
                }
                
                // Check if number is already used
                const playerExists = companyPlayers.some(player => {
                    // Handle both old string format and new object format
                    if (typeof player === 'string') {
                        const playerNumber = player.split(' ')[0];
                        return playerNumber === numero;
                    } else {
                        return player.numero === numero;
                    }
                });
                
                if (playerExists) {
                    showMessage(`Giocatore con numero ${numero} gi√† presente nella lista.`, "text-red-600");
                    return;
                }
                
                // Create player object
                const newPlayer = {
                    numero: numero,
                    nome: nome.toUpperCase(),
                    dataNascita: dataNascita,
                    matricola: matricola.toUpperCase()
                };
                
                companyPlayers.push(newPlayer);
                companyPlayers = sortPlayersByName(companyPlayers); // Keep players in alphabetical order by name
                
                // Clear form fields
                playerNumeroInput.value = '';
                playerNomeInput.value = '';
                playerDataNascitaInput.value = '';
                playerMatricolaInput.value = '';
                
                renderCompanyPlayers();
                showMessage("Giocatore aggiunto alla lista. Ricorda di salvare!", "text-blue-600");
            });

            savePlayersButton.addEventListener('click', async () => {
                if (companyPlayers.length === 0) {
                    showSavePlayersMessage("Nessun giocatore da salvare.", "text-orange-600");
                    return;
                }

                savePlayersButton.disabled = true;
                savePlayersButton.textContent = "Salvataggio in corso...";
                
                try {
                    await saveCompanyPlayers(companyPlayers);
                    showSavePlayersMessage("Giocatori salvati con successo!", "text-green-600");
                } catch (error) {
                    console.error("Errore nel salvataggio:", error);
                    showSavePlayersMessage("Errore nel salvataggio dei giocatori.", "text-red-600");
                } finally {
                    savePlayersButton.disabled = false;
                    savePlayersButton.textContent = "Salva Giocatori";
                    updateSavePlayersButtonState();
                }
            });

            backFromPlayersButton.addEventListener('click', () => {
                showCompanyWelcome();
            });
            
            topBackFromPlayersButton.addEventListener('click', () => {
                showCompanyWelcome();
            });

            // Company information event handlers
            const saveCompanyInfoButton = document.getElementById('save-company-info-button');
            const saveCompanyMessageArea = document.getElementById('save-company-message-area');
            const teamCategoriaInput = document.getElementById('team-categoria');
            const companyRagioneSocialeInput = document.getElementById('company-ragione-sociale');
            const companyIndirizzoInput = document.getElementById('company-indirizzo');
            const companyTelefonoInput = document.getElementById('company-telefono');
            const companyMailInput = document.getElementById('company-mail');
            const companyPartitaIvaInput = document.getElementById('company-partita-iva');

            // Function to save company information
            async function saveCompanyInfo() {
                if (!currentCompanyCode) {
                    console.error("Codice societ√† non disponibile");
                    saveCompanyMessageArea.textContent = "Errore: Codice societ√† non disponibile.";
                    saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                    saveCompanyMessageArea.classList.remove('hidden');
                    setTimeout(() => {
                        saveCompanyMessageArea.classList.add('hidden');
                    }, 5000);
                    return;
                }

                const companyInfo = {
                    categoria: teamCategoriaInput.value.trim(),
                    ragioneSociale: companyRagioneSocialeInput.value.trim(),
                    indirizzo: companyIndirizzoInput.value.trim(),
                    telefono: companyTelefonoInput.value.trim(),
                    mail: companyMailInput.value.trim(),
                    partitaIva: companyPartitaIvaInput.value.trim(),
                    lastUpdated: new Date().toISOString()
                };

                // Demo mode - save to localStorage only
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    try {
                        console.log("Demo mode: company info saved locally", companyInfo);
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        
                        saveCompanyMessageArea.textContent = "Informazioni societ√† salvate con successo! (Modalit√† Demo)";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-green-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    } catch (error) {
                        console.error("Error saving company info in demo mode:", error);
                        saveCompanyMessageArea.textContent = "Errore nel salvataggio. Riprova.";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    }
                }

                // Firebase mode - save to Firebase with localStorage fallback
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving company info to localStorage as fallback");
                    try {
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        
                        saveCompanyMessageArea.textContent = "Informazioni societ√† salvate localmente (Firebase non disponibile).";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-orange-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        saveCompanyMessageArea.textContent = "Errore nel salvataggio. Riprova.";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    }
                }

                try {
                    // Save to Firebase - company info document in subcollection
                    const companyInfoRef = window.doc(window.db, "societa", currentCompanyDocumentId, "companyInfo", "main");
                    await window.setDoc(companyInfoRef, companyInfo);
                    
                    // Also save to localStorage as backup
                    localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                    
                    console.log("‚úÖ Company information saved to Firebase:", companyInfo);
                    
                    saveCompanyMessageArea.textContent = "Informazioni societ√† salvate con successo su Firebase!";
                    saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-green-600";
                    saveCompanyMessageArea.classList.remove('hidden');
                    setTimeout(() => {
                        saveCompanyMessageArea.classList.add('hidden');
                    }, 5000);
                    
                } catch (firebaseError) {
                    console.error("‚ùå Firebase save failed, using localStorage fallback:", firebaseError);
                    // Fallback to localStorage
                    try {
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        console.log("Company info saved to localStorage as fallback");
                        
                        saveCompanyMessageArea.textContent = "Informazioni salvate localmente (errore Firebase).";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-orange-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        saveCompanyMessageArea.textContent = "Errore nel salvataggio. Riprova.";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                    }
                }
            }

            // Function to load company information
            async function loadCompanyInfo() {
                if (!currentCompanyCode) {
                    console.log("Nessun codice societ√† disponibile per caricare le informazioni");
                    return;
                }
                
                console.log(`üè¢ Caricamento informazioni societ√† per: ${currentCompanyCode}`);

                // Demo mode - load from localStorage only
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    try {
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("üìÅ Demo mode: company info loaded from localStorage:", companyInfo);
                        }
                    } catch (error) {
                        console.error("Error loading company info in demo mode:", error);
                    }
                    return;
                }

                // Firebase mode - load from Firebase with localStorage fallback
                if (!window.db) {
                    // Firebase not available, try localStorage fallback
                    console.log("Firebase not available, trying localStorage fallback");
                    try {
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("üìÅ Company info loaded from localStorage fallback:", companyInfo);
                        }
                    } catch (error) {
                        console.error("Error loading company info from localStorage fallback:", error);
                    }
                    return;
                }

                try {
                    // Try to load from Firebase first
                    const companyInfoRef = window.doc(window.db, "societa", currentCompanyDocumentId, "companyInfo", "main");
                    const companyInfoSnap = await window.getDoc(companyInfoRef);
                    
                    if (companyInfoSnap.exists()) {
                        const companyInfo = companyInfoSnap.data();
                        teamCategoriaInput.value = companyInfo.categoria || '';
                        companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                        companyIndirizzoInput.value = companyInfo.indirizzo || '';
                        companyTelefonoInput.value = companyInfo.telefono || '';
                        companyMailInput.value = companyInfo.mail || '';
                        companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                        
                        // Also save to localStorage as backup
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        
                        console.log("‚úÖ Company info loaded from Firebase:", companyInfo);
                    } else {
                        console.log("üîç No company info found in Firebase, trying localStorage fallback");
                        
                        // Try localStorage fallback
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("üìÅ Company info loaded from localStorage fallback:", companyInfo);
                        } else {
                            console.log("‚ÑπÔ∏è No company info found in Firebase or localStorage - starting with empty fields");
                        }
                    }
                    
                } catch (firebaseError) {
                    console.error("‚ùå Firebase load failed, using localStorage fallback:", firebaseError);
                    
                    // Fallback to localStorage
                    try {
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("üîÑ Fallback: company info loaded from localStorage after Firebase error");
                        }
                    } catch (parseError) {
                        console.error("‚ùå Error parsing localStorage fallback:", parseError);
                    }
                }
            }

            saveCompanyInfoButton.addEventListener('click', async () => {
                await saveCompanyInfo();
            });

            // Load company info when switching to player management screen
            const originalShowPlayerManagement = showPlayerManagement;
            showPlayerManagement = async function() {
                originalShowPlayerManagement.call(this);
                await loadCompanyInfo();
            };

            // Coach management event listeners
            addCoachButton.addEventListener('click', async () => {
                const coachName = newCoachInput.value.trim();
                const coachMatricola = newCoachMatricolaInput.value.trim();
                
                if (!coachName) {
                    showCoachMessage("Inserisci il nome del mister.", "text-red-600");
                    return;
                }

                if (!coachMatricola) {
                    showCoachMessage("Inserisci la matricola del mister.", "text-red-600");
                    return;
                }

                // Check if coach with same name already exists
                const existingCoach = companyCoaches.find(coach => 
                    (typeof coach === 'string' ? coach : coach.name) === coachName
                );
                if (existingCoach) {
                    showCoachMessage("Mister gi√† presente nella lista.", "text-red-600");
                    return;
                }

                // Check if coach with same matricola already exists
                const existingMatricola = companyCoaches.find(coach => 
                    typeof coach === 'object' && coach.matricola === coachMatricola
                );
                if (existingMatricola) {
                    showCoachMessage("Matricola gi√† presente nella lista.", "text-red-600");
                    return;
                }

                // Create coach object with name and matricola
                const coachObj = {
                    name: coachName,
                    matricola: coachMatricola
                };

                companyCoaches.push(coachObj);
                companyCoaches.sort((a, b) => {
                    const nameA = typeof a === 'string' ? a : a.name;
                    const nameB = typeof b === 'string' ? b : b.name;
                    return nameA.localeCompare(nameB);
                });
                newCoachInput.value = '';
                newCoachMatricolaInput.value = '';
                renderCompanyCoaches();
                showCoachMessage("Mister aggiunto alla lista. Ricorda di salvare!", "text-blue-600");
            });

            saveCoachesButton.addEventListener('click', async () => {
                if (companyCoaches.length === 0) {
                    showCoachMessage("Nessun mister da salvare.", "text-orange-600");
                    return;
                }

                saveCoachesButton.disabled = true;
                saveCoachesButton.textContent = "Salvataggio in corso...";
                
                try {
                    await saveCompanyCoaches(companyCoaches);
                    showCoachMessage("Mister salvati con successo!", "text-green-600");
                } catch (error) {
                    console.error("Errore nel salvataggio mister:", error);
                    showCoachMessage("Errore nel salvataggio dei mister.", "text-red-600");
                } finally {
                    saveCoachesButton.disabled = false;
                    saveCoachesButton.textContent = "Salva Mister";
                    updateSaveCoachesButtonState();
                }
            });

            // Directors event listeners
            addDirectorButton.addEventListener('click', async () => {
                const directorName = newDirectorNameInput.value.trim();
                const directorSurname = newDirectorSurnameInput.value.trim();
                const directorMatricola = newDirectorMatricolaInput.value.trim();
                
                if (!directorName) {
                    showDirectorMessage("Inserisci il nome del dirigente.", "text-red-600");
                    return;
                }

                if (!directorSurname) {
                    showDirectorMessage("Inserisci il cognome del dirigente.", "text-red-600");
                    return;
                }

                if (!directorMatricola) {
                    showDirectorMessage("Inserisci la matricola del dirigente.", "text-red-600");
                    return;
                }

                // Check if director with same name and surname already exists
                const fullName = `${directorName} ${directorSurname}`;
                const existingDirector = companyDirectors.find(director => 
                    `${director.name} ${director.surname}` === fullName
                );
                if (existingDirector) {
                    showDirectorMessage("Dirigente gi√† presente nella lista.", "text-red-600");
                    return;
                }

                // Check if director with same matricola already exists
                const existingMatricola = companyDirectors.find(director => 
                    director.matricola === directorMatricola
                );
                if (existingMatricola) {
                    showDirectorMessage("Matricola gi√† presente nella lista.", "text-red-600");
                    return;
                }

                // Add new director
                const directorObj = {
                    name: directorName,
                    surname: directorSurname,
                    matricola: directorMatricola
                };

                companyDirectors.push(directorObj);
                companyDirectors.sort((a, b) => {
                    const surnameCompare = (a.surname || '').localeCompare(b.surname || '');
                    if (surnameCompare !== 0) return surnameCompare;
                    return (a.name || '').localeCompare(b.name || '');
                });
                newDirectorNameInput.value = '';
                newDirectorSurnameInput.value = '';
                newDirectorMatricolaInput.value = '';
                renderCompanyDirectors();
                showDirectorMessage("Dirigente aggiunto alla lista. Ricorda di salvare!", "text-blue-600");
            });

            saveDirectorsButton.addEventListener('click', async () => {
                if (companyDirectors.length === 0) {
                    showDirectorMessage("Nessun dirigente da salvare.", "text-orange-600");
                    return;
                }

                saveDirectorsButton.disabled = true;
                saveDirectorsButton.textContent = "Salvataggio in corso...";
                
                try {
                    await saveCompanyDirectors(companyDirectors);
                    showDirectorMessage("Dirigenti salvati con successo!", "text-green-600");
                } catch (error) {
                    console.error("Errore nel salvataggio dirigenti:", error);
                    showDirectorMessage("Errore nel salvataggio dei dirigenti.", "text-red-600");
                } finally {
                    saveDirectorsButton.disabled = false;
                    saveDirectorsButton.textContent = "Salva Dirigenti";
                    updateSaveDirectorsButtonState();
                }
            });

            // Event listener for remember company checkbox
            rememberCompanyCheckbox.addEventListener('change', () => {
                if (rememberCompanyCheckbox.checked) {
                    localStorage.setItem('rememberCompanyPreference', 'true');
                } else {
                    localStorage.setItem('rememberCompanyPreference', 'false');
                    // If unchecked, remove saved company data immediately
                    localStorage.removeItem('companyCode');
                    localStorage.removeItem('companyData');
                }
            });

            // Event listeners for view switching
            enterButton.addEventListener('click', () => {
                const name = nameInput.value.trim().toLowerCase();
                if (name === 'mister' || name === 'marco') {
                    userRole = name;
                    
                    if (rememberMeCheckbox.checked) {
                        localStorage.setItem('userRole', userRole);
                    } else {
                        localStorage.removeItem('userRole');
                    }
                    
                    nameEntryScreen.classList.add('hidden');
                    const savedAppId = localStorage.getItem('convocazioniAppId');
                    if (savedAppId) {
                         startApp(savedAppId);
                    } else {
                         startScreen.classList.remove('hidden');
                    }
                } else {
                    nameEntryMessageArea.textContent = "Nome non valido.";
                    nameEntryMessageArea.classList.remove('hidden');
                    nameEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => {
                        nameEntryMessageArea.classList.add('hidden');
                    }, 5000);
                }
            });
            
            const savedJoinAppId = localStorage.getItem('joinAppId');
            if (savedJoinAppId) {
                joinAppIdInput.value = savedJoinAppId;
                rememberTeamIdCheckbox.checked = true;
            }

            createTeamButton.addEventListener('click', () => {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('convocazioniAppId', window.appId);
                } else {
                    localStorage.removeItem('convocazioniAppId');
                }
                startApp(window.appId);
            });

            joinTeamButton.addEventListener('click', () => {
                const joinedId = joinAppIdInput.value.trim();
                if (joinedId.length > 0) {
                     if (rememberTeamIdCheckbox.checked) {
                        localStorage.setItem('joinAppId', joinedId);
                    } else {
                        localStorage.removeItem('joinAppId');
                    }
                     if (rememberMeCheckbox.checked) {
                        localStorage.setItem('convocazioniAppId', joinedId);
                    } else {
                        localStorage.removeItem('convocazioniAppId');
                    }
                    startApp(joinedId);
                } else {
                    startMessageArea.textContent = "Per favore, inserisci un ID app valido.";
                    startMessageArea.classList.remove('hidden');
                    startMessageArea.classList.add('text-red-600');
                    setTimeout(() => {
                        startMessageArea.classList.add('hidden');
                    }, 5000);
                }
            });

            forgetDataButton.addEventListener('click', forgetDataAndReset);
            changeTeamButton.addEventListener('click', logoutToCompanyWelcome);
            resetSelectionsButton.addEventListener('click', resetPlayerSelections);
            esciButton.addEventListener('click', logoutToCompanyWelcome);
            
            // Enhanced share button handler - prioritizes Web Share API on mobile
            async function handleMainShareButton() {
                if (userRole !== 'mister') {
                    showMessage("Solo il Mister pu√≤ condividere le convocazioni.", "text-red-600");
                    return;
                }
                
                // Detect if user is on mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                 (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
                
                // On mobile devices, try Web Share API directly first
                if (isMobile && navigator.share) {
                    try {
                        await handleWebShare();
                        return; // Success, no need to show modal
                    } catch (error) {
                        console.log('Direct Web Share failed, showing modal:', error);
                        // Continue to show modal as fallback
                    }
                }
                
                // Default behavior: show the sharing modal
                showShareModal();
            }
            
            saveButton.addEventListener('click', saveData);
            shareButton.addEventListener('click', handleMainShareButton);
            
            // Handle tipo-partita selection change for Mister role
            const tipoPartitaSelect = document.getElementById('tipo-partita');
            const avversarioInput = document.getElementById('avversario');
            
            tipoPartitaSelect.addEventListener('change', () => {
                if (userRole === 'mister') {
                    const selectedType = tipoPartitaSelect.value;
                    if (selectedType === 'Torneo') {
                        // Clear avversario field and set trophy emoji
                        avversarioInput.value = 'üèÜ';
                        avversarioInput.readOnly = true;
                        avversarioInput.style.backgroundColor = '#f9fafb';
                        avversarioInput.style.textAlign = 'center';
                        avversarioInput.style.fontSize = '1.5rem';
                    } else {
                        // Restore normal avversario field functionality
                        if (avversarioInput.value === 'üèÜ') {
                            avversarioInput.value = '';
                        }
                        avversarioInput.readOnly = false;
                        avversarioInput.style.backgroundColor = 'white';
                        avversarioInput.style.textAlign = 'left';
                        avversarioInput.style.fontSize = '';
                    }
                }
            });
            historyButton.addEventListener('click', () => {
                historyPreviousView = 'main'; // track that we came from main view
                mainView.classList.add('hidden');
                historyView.classList.remove('hidden');
                attendanceView.classList.add('hidden');
            });
            // V8.13: Modulo button event handler
            moduloButton.addEventListener('click', () => {
                console.log('‚öΩ Opening Modulo/Tactics view (V8.13)');
                mainView.classList.add('hidden');
                moduloView.classList.remove('hidden');
            });
            attendanceButton.addEventListener('click', () => {
                // üîç DIAGNOSTIC LOG: Opening Riepilogo Presenze with company info
                console.log(`üìä [DIAGNOSTIC] Apertura Riepilogo Presenze:`);
                console.log(`   üè¢ Societ√† corrente - Codice: ${currentCompanyCode}`);
                console.log(`   üè¢ Societ√† corrente - Document ID: ${currentCompanyDocumentId}`);
                console.log(`   üè¢ Societ√† corrente - Nome: ${currentCompanyData?.name || currentCompanyData?.data?.nome || 'N/A'}`);
                console.log(`   üìã App ID utilizzato per i dati: ${currentAppId}`);
                console.log(`   üë§ Ruolo utente: ${userRole}`);
                
                // Check if company IDs are consistent
                const expectedAppId = currentCompanyDocumentId || currentCompanyCode;
                if (currentAppId !== expectedAppId) {
                    console.warn(`‚ö†Ô∏è [DIAGNOSTIC] INCONSISTENZA RILEVATA:`);
                    console.warn(`   App ID attuale: ${currentAppId}`);
                    console.warn(`   App ID atteso: ${expectedAppId}`);
                    console.warn(`   Correggendo l'App ID per visualizzare i dati corretti`);
                    
                    // Fix the inconsistency by updating currentAppId and refreshing listeners
                    currentAppId = expectedAppId;
                    console.log(`üîß [DIAGNOSTIC] App ID corretto a: ${currentAppId}`);
                    
                    // Refresh Firestore listeners with correct company ID
                    setupFirestoreListeners(currentAppId);
                }
                
                attendancePreviousView = 'main'; // track that we came from main view
                mainView.classList.add('hidden');
                historyView.classList.add('hidden');
                attendanceView.classList.remove('hidden');
                
                // Show loading spinner, hide content
                const loadingElement = document.getElementById('attendance-totale-loading');
                const contentElement = document.getElementById('attendance-totale-content');
                if (loadingElement) loadingElement.classList.remove('hidden');
                if (contentElement) contentElement.classList.add('hidden');
                
                // Ensure convocation history is loaded before updating tables
                ensureConvocationHistoryLoaded().then(() => {
                    // Update total attendance table (Riepilogo Totale)
                    loadAttendance(null);
                    // Update filtered attendance tables with current data
                    updateAttendanceTables();
                });
            });
            backFromHistoryButton.addEventListener('click', () => {
                historyView.classList.add('hidden');
                if (historyPreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                historyPreviousView = null; // reset for next time
            });
            
            topBackFromHistoryButton.addEventListener('click', () => {
                historyView.classList.add('hidden');
                if (historyPreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                historyPreviousView = null; // reset for next time
            });
            
            // History period filter event listener
            const historyPeriodSelect = document.getElementById('history-period-select');
            if (historyPeriodSelect) {
                historyPeriodSelect.addEventListener('change', () => {
                    renderFilteredHistory();
                });
            }
            
            // Collapsible sections for attendance summary
            const amichevoliHeader = document.getElementById('amichevoli-section-header');
            const amichevoliContent = document.getElementById('amichevoli-content');
            const amichevoliIcon = document.getElementById('amichevoli-expand-icon');
            
            const torneiHeader = document.getElementById('tornei-section-header');
            const torneiContent = document.getElementById('tornei-content');
            const torneiIcon = document.getElementById('tornei-expand-icon');
            
            const campionatoHeader = document.getElementById('campionato-section-header');
            const campionatoContent = document.getElementById('campionato-content');
            const campionatoIcon = document.getElementById('campionato-expand-icon');
            
            // Collapsible sections for Gestione Squadra
            const playersHeader = document.getElementById('players-section-header');
            const playersContent = document.getElementById('players-content');
            const playersIcon = document.getElementById('players-expand-icon');
            const playersButtonsSection = document.getElementById('players-buttons-section');
            
            const coachesHeader = document.getElementById('coaches-section-header');
            const coachesContent = document.getElementById('coaches-content');
            const coachesIcon = document.getElementById('coaches-expand-icon');
            
            const directorsHeader = document.getElementById('directors-section-header');
            const directorsContent = document.getElementById('directors-content');
            const directorsIcon = document.getElementById('directors-expand-icon');
            
            if (amichevoliHeader) {
                amichevoliHeader.addEventListener('click', () => {
                    const isHidden = amichevoliContent.classList.contains('hidden');
                    if (isHidden) {
                        amichevoliContent.classList.remove('hidden');
                        amichevoliIcon.classList.add('rotate-180');
                    } else {
                        amichevoliContent.classList.add('hidden');
                        amichevoliIcon.classList.remove('rotate-180');
                    }
                });
            }
            
            if (torneiHeader) {
                torneiHeader.addEventListener('click', () => {
                    const isHidden = torneiContent.classList.contains('hidden');
                    if (isHidden) {
                        torneiContent.classList.remove('hidden');
                        torneiIcon.classList.add('rotate-180');
                    } else {
                        torneiContent.classList.add('hidden');
                        torneiIcon.classList.remove('rotate-180');
                    }
                });
            }
            
            if (campionatoHeader) {
                campionatoHeader.addEventListener('click', () => {
                    const isHidden = campionatoContent.classList.contains('hidden');
                    if (isHidden) {
                        campionatoContent.classList.remove('hidden');
                        campionatoIcon.classList.add('rotate-180');
                    } else {
                        campionatoContent.classList.add('hidden');
                        campionatoIcon.classList.remove('rotate-180');
                    }
                });
            }
            
            // Collapsible sections for Gestione Squadra
            if (playersHeader) {
                playersHeader.addEventListener('click', () => {
                    const isHidden = playersContent.classList.contains('hidden');
                    if (isHidden) {
                        playersContent.classList.remove('hidden');
                        playersIcon.classList.add('rotate-180');
                        playersButtonsSection.classList.remove('hidden');
                    } else {
                        playersContent.classList.add('hidden');
                        playersIcon.classList.remove('rotate-180');
                        playersButtonsSection.classList.add('hidden');
                    }
                });
            }
            
            if (coachesHeader) {
                coachesHeader.addEventListener('click', () => {
                    const isHidden = coachesContent.classList.contains('hidden');
                    if (isHidden) {
                        coachesContent.classList.remove('hidden');
                        coachesIcon.classList.add('rotate-180');
                    } else {
                        coachesContent.classList.add('hidden');
                        coachesIcon.classList.remove('rotate-180');
                    }
                });
            }
            
            if (directorsHeader) {
                directorsHeader.addEventListener('click', () => {
                    const isHidden = directorsContent.classList.contains('hidden');
                    if (isHidden) {
                        directorsContent.classList.remove('hidden');
                        directorsIcon.classList.add('rotate-180');
                    } else {
                        directorsContent.classList.add('hidden');
                        directorsIcon.classList.remove('rotate-180');
                    }
                });
            }
            
            backFromAttendanceButton.addEventListener('click', () => {
                attendanceView.classList.add('hidden');
                if (attendancePreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                attendancePreviousView = null; // reset for next time
            });
            
            topBackFromAttendanceButton.addEventListener('click', () => {
                attendanceView.classList.add('hidden');
                if (attendancePreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                attendancePreviousView = null; // reset for next time
            });

            closeModalButton.addEventListener('click', hideModal);
            closeUnavailableModalButton.addEventListener('click', hideUnavailablePlayerModal);
            closeShareModalButton.addEventListener('click', hideShareModal);
            confirmAlreadyCalledButton.addEventListener('click', confirmAlreadyCalledSelection);
            cancelAlreadyCalledButton.addEventListener('click', hideAlreadyCalledModal);
            saveNotesButton.addEventListener('click', saveNotes);
            
            // V9.19: Legend modal handlers
            legendButton.addEventListener('click', () => {
                legendModal.classList.remove('hidden');
                setTimeout(() => {
                    legendModal.classList.add('opacity-100');
                    legendModal.querySelector('.transform').classList.remove('scale-95');
                    legendModal.querySelector('.transform').classList.add('scale-100');
                }, 10);
            });
            
            closeLegendModalButton.addEventListener('click', () => {
                legendModal.classList.remove('opacity-100');
                legendModal.querySelector('.transform').classList.remove('scale-100');
                legendModal.querySelector('.transform').classList.add('scale-95');
                setTimeout(() => {
                    legendModal.classList.add('hidden');
                }, 300);
            });
            
            // Auto-resize notes textarea
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.max(textarea.scrollHeight, 80) + 'px';
            }
            
            // Add input event listener for auto-resize and comma-to-newline
            notesTextarea.addEventListener('input', function(e) {
                // Check if a comma was just typed
                const cursorPosition = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPosition);
                const textAfterCursor = this.value.substring(cursorPosition);
                
                // If the last character before cursor is a comma, replace it with comma + newline
                if (textBeforeCursor.endsWith(',') && e.inputType === 'insertText' && e.data === ',') {
                    this.value = textBeforeCursor + '\n' + textAfterCursor;
                    // Restore cursor position after the newline
                    this.selectionStart = this.selectionEnd = cursorPosition + 1;
                }
                
                autoResizeTextarea(this);
            });
            
            // Initial resize when notes are loaded
            if (notesTextarea) {
                autoResizeTextarea(notesTextarea);
            }

            // Distinta Modal Event Listeners
            closeDistintaLocationModalButton.addEventListener('click', hideDistintaLocationModal);
            closeDistintaDirigentiModalButton.addEventListener('click', hideDistintaDirigentiModal);
            confirmDirigentiSelectionButton.addEventListener('click', confirmDirigentiSelection);
            closeDistintaMatchInfoModalButton.addEventListener('click', hideDistintaMatchInfoModal);
            confirmMatchInfoButton.addEventListener('click', confirmMatchInfo);
            closeDistintaDisplayModalButton.addEventListener('click', hideDistintaDisplayModal);
            distintaHomeButton.addEventListener('click', async () => await selectDistintaLocation('casa'));
            distintaAwayButton.addEventListener('click', async () => await selectDistintaLocation('trasferta'));
            copyDistintaButton.addEventListener('click', copyDistintaToClipboard);
            printDistintaButton.addEventListener('click', printDistinta);
            shareDistintaButton.addEventListener('click', shareDistinta);

            // V8.0: Stats Chart Modal Event Listeners
            statsChartButton.addEventListener('click', showStatsChartModal);
            closeStatsChartModalButton.addEventListener('click', hideStatsChartModal);

            // V8.1: Tornei Stats Chart Modal Event Listeners
            torneiStatsChartButton.addEventListener('click', showTorneiStatsChartModal);
            closeTorneiStatsChartModalButton.addEventListener('click', hideTorneiStatsChartModal);

            // Close modals when clicking outside of them
            statusModal.addEventListener('click', (e) => {
                if (e.target === statusModal) {
                    hideModal();
                }
            });

            unavailablePlayerModal.addEventListener('click', (e) => {
                if (e.target === unavailablePlayerModal) {
                    hideUnavailablePlayerModal();
                }
            });

            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    hideShareModal();
                }
            });

            alreadyCalledModal.addEventListener('click', (e) => {
                if (e.target === alreadyCalledModal) {
                    hideAlreadyCalledModal();
                }
            });

            distintaLocationModal.addEventListener('click', (e) => {
                if (e.target === distintaLocationModal) {
                    hideDistintaLocationModal();
                }
            });

            distintaDisplayModal.addEventListener('click', (e) => {
                if (e.target === distintaDisplayModal) {
                    hideDistintaDisplayModal();
                }
            });

            // V8.0: Close stats modal when clicking outside
            statsChartModal.addEventListener('click', (e) => {
                if (e.target === statsChartModal) {
                    hideStatsChartModal();
                }
            });

            // Share modal button event listeners
            webShareButton.addEventListener('click', handleWebShare);
            whatsappShareButton.addEventListener('click', handleWhatsAppShare);
            telegramShareButton.addEventListener('click', handleTelegramShare);
            emailShareButton.addEventListener('click', handleEmailShare);
            copyLinkButton.addEventListener('click', handleCopyLink);
            downloadImageButton.addEventListener('click', handleDownloadImage);

            // NEW V6.5: Multi-select status handler for Dirigente/Marco with checkboxes
            // This replaces the old single-select button approach
            // Confirm button handler - applies selected statuses to player
            confirmStatusButton.addEventListener('click', () => {
                console.log('‚úÖ [V6.5] Confermando selezione indisponibilit√† per:', tempPlayerName);
                const currentPlayerItem = document.querySelector(`.player-item[data-player="${tempPlayerName}"]`);
                
                // V9.13: Check if there are sessions in current week
                const hasCurrentWeekSessions = hasCurrentWeekTrainingSessions();
                
                // Get all checked statuses from checkboxes
                // V9.13: If there are sessions in current week, exclude disabled training checkboxes (auto-calculated)
                // V9.13: If there are NO sessions, include training checkboxes (manually selectable)
                const selectedStatuses = Array.from(statusCheckboxes)
                    .filter(checkbox => {
                        if (!checkbox.checked) return false;
                        
                        // If sessions exist in current week, exclude disabled checkboxes (auto-calculated)
                        if (hasCurrentWeekSessions && checkbox.disabled) return false;
                        
                        return true;
                    })
                    .map(checkbox => checkbox.dataset.status);
                
                console.log('üìã [V9.13] Selected statuses:', selectedStatuses, '(sessions exist:', hasCurrentWeekSessions + ')');
                
                // Store as array if multiple statuses, or single string for backward compatibility
                if (selectedStatuses.length === 0) {
                    // No manual status selected - remove from unavailablePlayers
                    // V9.12: Auto training status will still be applied in renderPlayers (if sessions exist)
                    unavailablePlayers.delete(tempPlayerName);
                } else if (selectedStatuses.length === 1) {
                    // Single status - store as string for backward compatibility
                    unavailablePlayers.set(tempPlayerName, selectedStatuses[0]);
                } else {
                    // Multiple statuses - store as array
                    unavailablePlayers.set(tempPlayerName, selectedStatuses);
                }
                
                // V9.12: Re-render players to apply both manual and automatic statuses
                renderPlayers();
                updateUnavailablePlayersView();
                hideModal();
                tempPlayerName = null;
            });
            
            // Clear status button - marks player as available
            clearStatusButton.addEventListener('click', () => {
                console.log('‚úÖ [V9.12] Rendendo disponibile:', tempPlayerName);
                
                // V9.12: Only clear manual statuses, auto training status will still apply
                unavailablePlayers.delete(tempPlayerName);
                
                // Re-render to apply auto training status if exists
                renderPlayers();
                updateUnavailablePlayersView();
                hideModal();
                tempPlayerName = null;
            });
            
            // V6.5: Helper function to apply visual styles based on player statuses
            // Supports both single status (backward compatible) and multiple statuses (gradient)
            // V9.7: Updated color logic for specific statuses
            function applyPlayerStatusStyle(playerItem, statuses) {
                // Ensure statuses is always an array for consistent processing
                const statusArray = Array.isArray(statuses) ? statuses : [statuses];
                
                // Remove all existing status classes
                playerItem.classList.remove('selected-marco', 'selected-marco-orange', 'selected-marco-black', 'selected-marco-purple', 'selected-marco-blue-dark', 'selected-marco-red', 'selected-marco-white', 'selected-marco-yellow', 'multi-status');
                playerItem.style.background = ''; // Clear any gradient
                
                if (statusArray.length === 1) {
                    // Single status - apply single color class (backward compatible)
                    const status = statusArray[0];
                    // V9.10: Updated color logic
                    if (status === 'Infortunato') {
                        playerItem.classList.add('selected-marco-black'); // Black for injured
                    } else if (status === 'Squalificato') {
                        playerItem.classList.add('selected-marco-yellow'); // Yellow for suspended
                    } else if (status === 'Non disponibile Domenica') {
                        playerItem.classList.add('selected-marco-blue-dark'); // Dark blue for unavailable Sunday
                    } else if (status === 'Non disponibile Sabato') {
                        playerItem.classList.add('selected-marco-purple'); // Purple for unavailable Saturday
                    } else if (status === 'Non disponibile Weekend') {
                        playerItem.classList.add('selected-marco-red'); // Red for unavailable weekend
                    } else if (status === 'Solo 1 allenamento') {
                        playerItem.classList.add('selected-marco-red'); // Red for only 1 training
                    } else if (status === 'Zero allenamenti') {
                        playerItem.classList.add('selected-marco-red'); // Red for zero trainings
                    } else if (status === 'Solo 2 allenamenti') {
                        playerItem.classList.add('selected-marco-white'); // White for only 2 trainings
                    } else {
                        playerItem.classList.add('selected-marco'); // Default red for other cases
                    }
                } else {
                    // Multiple statuses - create gradient background (NEW in V6.5)
                    // V9.10: Updated color mapping for gradients
                    playerItem.classList.add('multi-status');
                    const colors = statusArray.map(status => {
                        if (status === 'Infortunato') {
                            return '#1f2937'; // black
                        } else if (status === 'Squalificato') {
                            return '#fbbf24'; // yellow
                        } else if (status === 'Non disponibile Domenica') {
                            return '#1e3a8a'; // dark blue
                        } else if (status === 'Non disponibile Sabato') {
                            return '#8b5cf6'; // purple
                        } else if (status === 'Non disponibile Weekend') {
                            return '#dc2626'; // red
                        } else if (status === 'Solo 1 allenamento') {
                            return '#dc2626'; // red
                        } else if (status === 'Zero allenamenti') {
                            return '#dc2626'; // red
                        } else if (status === 'Solo 2 allenamenti') {
                            return '#ffffff'; // white
                        } else {
                            return '#fecaca'; // default light red
                        }
                    });
                    
                    // V9.19: Fix text color for gradients containing both white and dark colors
                    // If gradient has white + dark blue (common case: "Solo 2 allenamenti" + "Non disponibile Domenica")
                    // use dark text with white shadow for blue section, making it readable on both parts
                    const hasWhite = colors.includes('#ffffff');
                    const hasDarkBlue = colors.includes('#1e3a8a');
                    
                    if (hasWhite && hasDarkBlue) {
                        // Special case: blue-white gradient needs contrasting text on each half
                        // Use dark text with white text-shadow to make it readable on blue part
                        playerItem.style.color = '#1f2937'; // dark text for white section
                        playerItem.style.textShadow = '1px 1px 2px rgba(255, 255, 255, 0.8), -1px -1px 2px rgba(255, 255, 255, 0.8)'; // white shadow for blue section
                    } else if (hasWhite) {
                        // Other gradients with white: use dark text
                        playerItem.style.color = '#1f2937'; // dark text
                        playerItem.style.textShadow = ''; // no shadow needed
                    } else {
                        // No white: use white text as usual
                        playerItem.style.color = '#ffffff'; // white text
                        playerItem.style.textShadow = ''; // no shadow needed
                    }
                    
                    // Create gradient with equal segments for each status
                    const step = 100 / colors.length;
                    const gradientStops = colors.map((color, index) => {
                        const start = index * step;
                        const end = (index + 1) * step;
                        return `${color} ${start}%, ${color} ${end}%`;
                    }).join(', ');
                    
                    playerItem.style.background = `linear-gradient(90deg, ${gradientStops})`;
                }
            }

            // *** MODIFICA: Gestione pulsante "Convoca ugualmente" ***
            convocaComunqueButton.addEventListener('click', () => {
                // V6.6: Seleziona il giocatore come convocato anche se non disponibile
                // V7.5: Add distinctive blue border for unavailable players called up
                if (typeof tempUnavailablePlayerName === 'string' && tempUnavailablePlayerName.length > 0) {
                    const playerItem = document.querySelector(`.player-item[data-player="${tempUnavailablePlayerName}"]`);
                    if (playerItem) {
                        playerItem.classList.add('selected-mister', 'unavailable-forced');
                        updateSelectedPlayersLiveList(tempUnavailablePlayerName, true);
                    }
                }
                hideUnavailablePlayerModal();
            });

            // V6.6: Gestione pulsante "Togli dalla convocazione"
            // V7.5: Remove blue border class when removing unavailable player
            togliConvocazioneButton.addEventListener('click', () => {
                // Rimuove il giocatore dalla convocazione
                if (typeof tempUnavailablePlayerName === 'string' && tempUnavailablePlayerName.length > 0) {
                    const playerItem = document.querySelector(`.player-item[data-player="${tempUnavailablePlayerName}"]`);
                    if (playerItem) {
                        playerItem.classList.remove('selected-mister', 'unavailable-forced');
                        updateSelectedPlayersLiveList(tempUnavailablePlayerName, false);
                    }
                }
                hideUnavailablePlayerModal();
            });

            // *** NUOVA: Gestione conferma giocatore gi√† convocato oggi ***
            function confirmAlreadyCalledSelection() {
                if (typeof tempAlreadyCalledPlayerName === 'string' && tempAlreadyCalledPlayerName.length > 0) {
                    const playerItem = document.querySelector(`.player-item[data-player="${tempAlreadyCalledPlayerName}"]`);
                    if (playerItem) {
                        playerItem.classList.add('selected-mister');
                        updateSelectedPlayersLiveList(tempAlreadyCalledPlayerName, true);
                    }
                }
                hideAlreadyCalledModal();
            }

            function copyAppId() {
                const tempInput = document.createElement('textarea');
                tempInput.value = appIdDisplay.textContent;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    const success = document.execCommand('copy');
                    if (success) {
                        const originalText = appIdDisplay.textContent;
                        appIdDisplay.textContent = 'Copiato!';
                        setTimeout(() => {
                            appIdDisplay.textContent = originalText;
                        }, 1000);
                    } else {
                        console.error('Errore nella copia: document.execCommand("copy") failed.');
                        showMessage("Impossibile copiare. Il browser non lo supporta.", "text-red-600");
                    }
                } catch (err) {
                    console.error('Errore nella copia: ', err);
                    showMessage("Errore durante la copia. Controlla la console.", "text-red-600");
                } finally {
                    document.body.removeChild(tempInput);
                }
            }
            window.copyAppId = copyAppId;

            // Debug function to display saved players for current company
            async function debugMostraGiocatoriSalvati() {
                console.log('üîç DEBUG - Funzione debugMostraGiocatoriSalvati() avviata');
                
                if (!currentCompanyCode) {
                    console.log('‚ùå DEBUG - Nessuna societ√† selezionata (currentCompanyCode √® null/undefined)');
                    console.log("üí° DEBUG - Per utilizzare questa funzione, prima seleziona una societ√† nell'applicazione");
                    return;
                }
                
                console.log(`üè¢ DEBUG - Societ√† selezionata: ${currentCompanyCode}`);
                
                // Check if Firebase is available
                if (!window.db) {
                    console.log('‚ùå DEBUG - Firebase non disponibile, controllo localStorage...');
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            const players = JSON.parse(savedPlayers);
                            console.log(`üìÅ DEBUG - Giocatori trovati in localStorage (${players.length}):`, players);
                        } catch (error) {
                            console.error('‚ùå DEBUG - Errore nel parsing dei dati localStorage:', error);
                        }
                    } else {
                        console.log('‚ùå DEBUG - Nessun dato trovato in localStorage');
                    }
                    return;
                }
                
                try {
                    console.log(`üî• DEBUG - Tentativo di lettura da Firebase subcollection...`);
                    console.log(`üìÑ DEBUG - Leggendo subcollection: societa/${currentCompanyDocumentId}/giocatori`);
                    console.log(`üè∑Ô∏è DEBUG - Codice societ√† inserito (campo 'codici'): ${currentCompanyCode}`);
                    
                    // Read from Firebase societa subcollection using document ID
                    const playersCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "giocatori");
                    const playersSnapshot = await window.getDocs(playersCollectionRef);
                    
                    if (!playersSnapshot.empty) {
                        const players = [];
                        const playerDetails = [];
                        playersSnapshot.forEach((doc) => {
                            const playerData = doc.data();
                            const playerName = playerData.name || playerData.nome || doc.id;
                            players.push(playerName);
                            playerDetails.push({
                                id: doc.id,
                                name: playerName,
                                data: playerData
                            });
                        });
                        
                        console.log('‚úÖ DEBUG - Subcollection giocatori trovata in Firebase');
                        console.log(`üë• DEBUG - Giocatori salvati nella subcollection (${players.length}):`);
                        
                        // Sort players by name only for consistent display
                        sortPlayersByName(players);
                        console.log('üìã DEBUG - Lista giocatori (ordinata alfabeticamente per nome):', players);
                        
                        // Print each player with index for better readability
                        players.forEach((player, index) => {
                            console.log(`   ${index + 1}. ${player}`);
                        });
                        
                        console.log('üìä DEBUG - Dettagli completi dei documenti nella subcollection:', playerDetails);
                    } else {
                        console.log(`üìù DEBUG - Subcollection societa/${currentCompanyDocumentId}/giocatori vuota o non trovata`);
                        console.log('üí° DEBUG - Verifica che la subcollection esista e contenga documenti');
                    }
                } catch (error) {
                    console.error('üí• DEBUG - Errore durante la lettura dalla subcollection Firebase:', error);
                    console.log('üîÑ DEBUG - Tentativo di fallback su localStorage...');
                    
                    // Fallback to localStorage
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            const players = JSON.parse(savedPlayers);
                            console.log(`üìÅ DEBUG - Fallback: Giocatori trovati in localStorage (${players.length}):`, players);
                        } catch (parseError) {
                            console.error('‚ùå DEBUG - Errore nel parsing del fallback localStorage:', parseError);
                        }
                    } else {
                        console.log('‚ùå DEBUG - Nessun fallback disponibile in localStorage');
                    }
                }
                
                console.log('üîç DEBUG - Funzione debugMostraGiocatoriSalvati() completata');
            }
            
            // Expose debug function globally for console access
            window.debugMostraGiocatoriSalvati = debugMostraGiocatoriSalvati;

            // V9.10: Training attendance event listeners - COMMENTED OUT - Feature removed
            // const backFromTrainingAttendanceButton = document.getElementById('back-from-training-attendance-button');
            // const topBackFromTrainingAttendanceButton = document.getElementById('top-back-from-training-attendance-button');
            // const refreshTrainingButton = document.getElementById('refresh-training-button');

            // backFromTrainingAttendanceButton.addEventListener('click', () => {
            //     trainingAttendanceView.classList.add('hidden');
            //     // Always go back to company welcome screen since training attendance is only available from there
            //     if (currentCompanyCode) {
            //         showCompanyWelcome();
            //     } else {
            //         mainView.classList.remove('hidden');
            //     }
            // });
            
            // topBackFromTrainingAttendanceButton.addEventListener('click', () => {
            //     trainingAttendanceView.classList.add('hidden');
            //     // Always go back to company welcome screen since training attendance is only available from there
            //     if (currentCompanyCode) {
            //         showCompanyWelcome();
            //     } else {
            //         mainView.classList.remove('hidden');
            //     }
            // });

            // refreshTrainingButton.addEventListener('click', () => {
            //     loadTrainingAttendance();
            // });
            
            // Allenamenti management event listeners (V8.2)
            const backFromAllenamentiButton = document.getElementById('back-from-allenamenti-button');
            const topBackFromAllenamentiButton = document.getElementById('top-back-from-allenamenti-button');
            const addTrainingSessionButton = document.getElementById('add-training-session-button');
            const addTrainingModal = document.getElementById('add-training-modal');
            const saveTrainingSessionButton = document.getElementById('save-training-session-button');
            const cancelTrainingSessionButton = document.getElementById('cancel-training-session-button');
            const refreshReportButton = document.getElementById('refresh-report-button');
            
            backFromAllenamentiButton.addEventListener('click', () => {
                allenamentiView.classList.add('hidden');
                if (currentCompanyCode) {
                    showCompanyWelcome();
                } else {
                    mainView.classList.remove('hidden');
                }
            });
            
            topBackFromAllenamentiButton.addEventListener('click', () => {
                allenamentiView.classList.add('hidden');
                if (currentCompanyCode) {
                    showCompanyWelcome();
                } else {
                    mainView.classList.remove('hidden');
                }
            });
            
            // V8.13: Modulo back button event handlers
            const backFromModuloButton = document.getElementById('back-from-modulo-button');
            const topBackFromModuloButton = document.getElementById('top-back-from-modulo-button');
            
            backFromModuloButton.addEventListener('click', () => {
                moduloView.classList.add('hidden');
                mainView.classList.remove('hidden');
            });
            
            topBackFromModuloButton.addEventListener('click', () => {
                moduloView.classList.add('hidden');
                mainView.classList.remove('hidden');
            });
            
            // V8.15: Modulo functionality with improved tactical positioning
            const matchTypeSelect = document.getElementById('match-type-select');
            const formationInput = document.getElementById('formation-input');
            const generateFieldButton = document.getElementById('generate-field-button');
            const soccerFieldContainer = document.getElementById('soccer-field-container');
            const fieldPlayersContainer = document.getElementById('field-players-container');
            const moduloPlayerModal = document.getElementById('modulo-player-modal');
            const moduloPlayerList = document.getElementById('modulo-player-list');
            const closeModuloModal = document.getElementById('close-modulo-modal');
            
            let currentPlayerPosition = null;
            let playerPositions = {}; // Track player assignments
            
            // V8.13: Auto-format formation input (433 ‚Üí 4-3-3)
            formationInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9]/g, ''); // Keep only numbers
                if (value.length > 0) {
                    // Add hyphens between digits
                    value = value.split('').join('-');
                }
                e.target.value = value;
            });
            
            // Get available players from the current company
            async function getAvailablePlayers() {
                try {
                    console.log('üîÑ V9.5: getAvailablePlayers() - Loading players for tactics page');
                    
                    if (demoMode) {
                        const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                        if (savedPlayers) {
                            // V9.5: Parse and ensure we extract names if objects are stored
                            const parsed = JSON.parse(savedPlayers);
                            if (Array.isArray(parsed)) {
                                // Ensure all items are formatted as "numero nome"
                                const formatted = parsed.map(item => {
                                    if (typeof item === 'string') {
                                        return item;
                                    } else if (typeof item === 'object' && item !== null) {
                                        // Format as "numero nome" if both exist
                                        if (item.numero && item.nome) {
                                            return `${item.numero} ${item.nome}`;
                                        }
                                        return item.name || item.nome || String(item);
                                    }
                                    return String(item);
                                });
                                // V9.5: Sort alphabetically by name (not by number)
                                return formatted.sort((a, b) => {
                                    const nameA = a.split(' ').slice(1).join(' ').toLowerCase();
                                    const nameB = b.split(' ').slice(1).join(' ').toLowerCase();
                                    return nameA.localeCompare(nameB);
                                });
                            }
                        }
                        return DEMO_PLAYERS.slice().sort((a, b) => {
                            const nameA = a.split(' ').slice(1).join(' ').toLowerCase();
                            const nameB = b.split(' ').slice(1).join(' ').toLowerCase();
                            return nameA.localeCompare(nameB);
                        });
                    } else {
                        // V9.5: Load from Firestore with correct database structure
                        if (!currentCompanyDocumentId) {
                            console.error('‚ùå V9.5: currentCompanyDocumentId is not set');
                            return [];
                        }
                        
                        console.log(`üìç V9.5: Loading players from societa/${currentCompanyDocumentId}/giocatori`);
                        const playersCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "giocatori");
                        const playersSnapshot = await window.getDocs(playersCollectionRef);
                        const players = [];
                        playersSnapshot.forEach((doc) => {
                            const playerData = doc.data();
                            // V9.5: Extract from nome object structure (nome.nome, nome.numero)
                            // Database structure: giocatori collection has documents with 'nome' field as object
                            if (playerData.nome && typeof playerData.nome === 'object') {
                                const numero = playerData.nome.numero;
                                const nome = playerData.nome.nome;
                                // Format as "numero nome" like in edit_convocation.html
                                if (numero && nome) {
                                    players.push(`${numero} ${nome}`);
                                }
                            }
                        });
                        console.log(`‚úÖ V9.5: Loaded ${players.length} players for tactics page`);
                        // V9.5: Sort alphabetically by name (not by number)
                        return players.sort((a, b) => {
                            const nameA = a.split(' ').slice(1).join(' ').toLowerCase();
                            const nameB = b.split(' ').slice(1).join(' ').toLowerCase();
                            return nameA.localeCompare(nameB);
                        });
                    }
                } catch (error) {
                    console.error('‚ùå V8.17: Error loading players for modulo:', error);
                    return [];
                }
            }
            
            // Parse formation string (e.g., "2-2", "2-3-2", "4-4-2")
            function parseFormation(formationStr) {
                const parts = formationStr.split('-').map(n => parseInt(n.trim()));
                if (parts.some(isNaN)) {
                    return null;
                }
                return parts; // [defenders, midfielders, forwards]
            }
            
            // Generate the soccer field with player positions
            generateFieldButton.addEventListener('click', () => {
                const matchType = matchTypeSelect.value;
                const formationStr = formationInput.value.trim();
                
                if (!matchType) {
                    alert('Seleziona il tipo di partita');
                    return;
                }
                
                if (!formationStr) {
                    alert('Inserisci il modulo tattico (es. 2-2, 4-4-2)');
                    return;
                }
                
                const formation = parseFormation(formationStr);
                if (!formation) {
                    alert('Formato modulo non valido. Usa il formato: 2-2, 2-3-2, 4-4-2, ecc.');
                    return;
                }
                
                const expectedPlayers = parseInt(matchType);
                const formationTotal = formation.reduce((a, b) => a + b, 0) + 1; // +1 for goalkeeper
                
                if (formationTotal !== expectedPlayers) {
                    alert(`Il modulo ${formationStr} ha ${formationTotal} giocatori ma il tipo di partita richiede ${expectedPlayers} giocatori`);
                    return;
                }
                
                console.log(`‚öΩ V8.15: Generating field for ${matchType} players with formation ${formationStr}`);
                generateField(formation);
            });
            
            // Generate field visualization with player icons
            function generateField(formation) {
                fieldPlayersContainer.innerHTML = '';
                playerPositions = {}; // Reset assignments
                soccerFieldContainer.classList.remove('hidden');
                
                // V9.5: Create goalkeeper (positioned lower on the field)
                createPlayerIcon('GK', 50, 92, 'Portiere');
                
                // V9.16: New logic - First number = defenders, Last number = attackers, Middle numbers = midfield lines
                const numLines = formation.length;
                const numMidfieldLines = numLines - 2; // All lines except first (defenders) and last (attackers)
                
                // Counters for player numbering
                let defenderCount = 0;
                let midfielderCount = 0;
                let attackerCount = 0;
                
                formation.forEach((lineCount, lineIndex) => {
                    let yPosition, xSpacing;
                    let positionLabel, positionName;
                    let playerStartIndex;
                    
                    if (lineIndex === 0) {
                        // First line: Defenders - Y=80%, increased spacing for better separation
                        yPosition = 80;
                        xSpacing = 95;
                        positionLabel = 'D';
                        positionName = 'Difensore';
                        playerStartIndex = defenderCount;
                        defenderCount += lineCount;
                    } else if (lineIndex === numLines - 1) {
                        // Last line: Attackers - further forward (Y=10%), increased spacing
                        yPosition = 10;
                        xSpacing = 95;
                        positionLabel = 'A';
                        positionName = 'Attaccante';
                        playerStartIndex = attackerCount;
                        attackerCount += lineCount;
                    } else {
                        // Middle lines: Midfielders - distribute evenly between defenders and attackers
                        // Calculate which midfield line this is (0-indexed from defensive midfield)
                        const midfieldLineIndex = lineIndex - 1; // 0 for first midfield line, 1 for second, etc.
                        
                        // Distribute midfield lines between Y=62% (near defenders) and Y=20% (near attackers)
                        // Increased range for better spacing between lines
                        const midfieldStartY = 62;
                        const midfieldEndY = 20;
                        const midfieldRange = midfieldStartY - midfieldEndY;
                        
                        if (numMidfieldLines === 1) {
                            // Single midfield line - center it
                            yPosition = 48;
                        } else {
                            // Multiple midfield lines - distribute evenly
                            yPosition = midfieldStartY - (midfieldRange * midfieldLineIndex / (numMidfieldLines - 1));
                        }
                        
                        xSpacing = 120; // Wider spacing for midfielders for better readability
                        positionLabel = 'C';
                        positionName = 'Centrocampista';
                        playerStartIndex = midfielderCount;
                        midfielderCount += lineCount;
                    }
                    
                    // Create players for this line
                    const xStep = xSpacing / (lineCount + 1);
                    for (let i = 0; i < lineCount; i++) {
                        const xPosition = (100 - xSpacing) / 2 + xStep * (i + 1);
                        createPlayerIcon(`${positionLabel}${playerStartIndex + i + 1}`, xPosition, yPosition, positionName);
                    }
                });
                
                console.log(`‚öΩ V9.17: Field generated with improved spacing (D=80%/95%, C=62-20%/120%, A=10%/95%)`);
            }
            
            // Create a player icon on the field
            function createPlayerIcon(positionId, xPercent, yPercent, positionName) {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-icon absolute cursor-pointer transition-all duration-200 hover:scale-110';
                playerDiv.style.left = `${xPercent}%`;
                playerDiv.style.top = `${yPercent}%`;
                playerDiv.style.transform = 'translate(-50%, -50%)';
                playerDiv.dataset.position = positionId;
                
                // V9.5: Determine color based on position
                let bgColor = 'bg-blue-600'; // Default for attackers
                if (positionId === 'GK') {
                    bgColor = 'bg-yellow-500';
                } else if (positionId.startsWith('D')) {
                    bgColor = 'bg-red-600';
                } else if (positionId.startsWith('C')) {
                    bgColor = 'bg-gray-600';
                }
                
                playerDiv.innerHTML = `
                    <div class="text-center" style="display: flex; flex-direction: column; align-items: center;">
                        <div class="player-badge w-12 h-12 ${bgColor} border-3 border-white rounded-full flex items-center justify-center text-white font-bold shadow-lg mb-1">
                            <span class="text-xs">${positionId}</span>
                        </div>
                        <div class="player-name-display text-white text-xs font-semibold bg-black bg-opacity-60 px-2 py-1 rounded min-h-[24px] max-w-[120px] leading-tight" style="text-shadow: 1px 1px 2px black; text-align: center;">
                            ${positionName}
                        </div>
                    </div>
                `;
                
                playerDiv.addEventListener('click', () => handlePlayerIconClick(positionId));
                fieldPlayersContainer.appendChild(playerDiv);
            }
            
            // Handle click on player icon
            async function handlePlayerIconClick(positionId) {
                currentPlayerPosition = positionId;
                const currentAssignment = playerPositions[positionId];
                
                if (currentAssignment && currentAssignment.length >= 2) {
                    // Already has 2 players, show option to remove
                    if (confirm(`Rimuovere i giocatori da questa posizione?`)) {
                        delete playerPositions[positionId];
                        updatePlayerIconDisplay(positionId);
                    }
                    return;
                }
                
                // Show player selection modal
                const players = await getAvailablePlayers();
                moduloPlayerList.innerHTML = '';
                
                // V9.5: Filter out already assigned players
                const assignedPlayers = new Set();
                Object.values(playerPositions).forEach(assignment => {
                    if (Array.isArray(assignment)) {
                        assignment.forEach(playerName => assignedPlayers.add(playerName));
                    }
                });
                
                const availablePlayers = players.filter(playerName => !assignedPlayers.has(playerName));
                
                if (availablePlayers.length === 0) {
                    moduloPlayerList.innerHTML = '<div class="text-center text-gray-500 py-4">Tutti i giocatori sono gi√† stati assegnati</div>';
                } else {
                    availablePlayers.forEach(playerName => {
                        const button = document.createElement('button');
                        button.className = 'w-full text-left px-4 py-2 bg-gray-100 hover:bg-blue-100 rounded-lg transition-colors duration-200';
                        button.textContent = playerName;
                        button.addEventListener('click', () => {
                            assignPlayerToPosition(positionId, playerName);
                            moduloPlayerModal.classList.add('hidden');
                        });
                        moduloPlayerList.appendChild(button);
                    });
                }
                
                // Add remove option if there's already a player assigned
                if (currentAssignment && currentAssignment.length > 0) {
                    const removeButton = document.createElement('button');
                    removeButton.className = 'w-full text-left px-4 py-2 bg-red-100 hover:bg-red-200 rounded-lg transition-colors duration-200 mt-2';
                    removeButton.textContent = '‚ùå Rimuovi giocatore';
                    removeButton.addEventListener('click', () => {
                        // Remove the last added player
                        currentAssignment.pop();
                        if (currentAssignment.length === 0) {
                            delete playerPositions[positionId];
                        }
                        updatePlayerIconDisplay(positionId);
                        moduloPlayerModal.classList.add('hidden');
                    });
                    moduloPlayerList.appendChild(removeButton);
                }
                
                moduloPlayerModal.classList.remove('hidden');
            }
            
            // Assign player to position
            function assignPlayerToPosition(positionId, playerName) {
                if (!playerPositions[positionId]) {
                    playerPositions[positionId] = [];
                }
                
                if (playerPositions[positionId].length < 2) {
                    playerPositions[positionId].push(playerName);
                    console.log(`‚öΩ V9.5: Assigned ${playerName} to position ${positionId}`);
                    updatePlayerIconDisplay(positionId);
                }
            }
            
            // Update player icon display with assigned names
            function updatePlayerIconDisplay(positionId) {
                const playerIcon = document.querySelector(`.player-icon[data-position="${positionId}"]`);
                if (!playerIcon) return;
                
                const nameDisplay = playerIcon.querySelector('.player-name-display');
                const badge = playerIcon.querySelector('.player-badge span');
                const assignment = playerPositions[positionId];
                
                if (assignment && assignment.length > 0) {
                    // V9.5: Format each player name with numero/nome/cognome on separate lines
                    nameDisplay.innerHTML = assignment.map(fullName => {
                        const parts = fullName.split(' ');
                        if (parts.length >= 3) {
                            // Format: "numero nome cognome" -> display as 3 lines
                            const numero = parts[0];
                            const nome = parts[1];
                            const cognome = parts.slice(2).join(' ');
                            return `<div style="line-height: 1.2;">${numero}<br>${nome}<br>${cognome}</div>`;
                        } else if (parts.length === 2) {
                            // Format: "numero nome" -> display as 2 lines
                            return `<div style="line-height: 1.2;">${parts[0]}<br>${parts[1]}</div>`;
                        } else {
                            // Single part, display as-is
                            return `<div>${fullName}</div>`;
                        }
                    }).join('<div style="margin: 4px 0; border-top: 1px solid rgba(255,255,255,0.3);"></div>');
                    
                    // V9.5: Show jersey number on badge from first assigned player
                    const firstPlayer = assignment[0];
                    const jerseyNumber = firstPlayer.split(' ')[0]; // Extract number (e.g., "10" from "10 Mario Rossi")
                    badge.textContent = jerseyNumber;
                } else {
                    // Reset to position name and position ID
                    const positionName = positionId === 'GK' ? 'Portiere' : 
                                       positionId.startsWith('D') ? 'Difensore' :
                                       positionId.startsWith('C') ? 'Centrocampista' : 'Attaccante';
                    nameDisplay.textContent = positionName;
                    badge.textContent = positionId;
                }
            }
            
            // Close modal
            closeModuloModal.addEventListener('click', () => {
                moduloPlayerModal.classList.add('hidden');
            });
            
            addTrainingSessionButton.addEventListener('click', () => {
                console.log('üèÉ Opening add training session modal...');
                // Set default date and time to now
                const now = new Date();
                document.getElementById('training-date').valueAsDate = now;
                document.getElementById('training-time').value = now.toTimeString().slice(0, 5);
                addTrainingModal.classList.remove('hidden');
            });
            
            cancelTrainingSessionButton.addEventListener('click', () => {
                addTrainingModal.classList.add('hidden');
            });
            
            saveTrainingSessionButton.addEventListener('click', async () => {
                await saveNewTrainingSession();
            });
            
            refreshReportButton.addEventListener('click', () => {
                // V8.11: Update only report when report filter changes
                loadAllenamentiReport();
            });
            
            // V8.11: Add event listener for sessions filter
            const sessionsPeriodSelect = document.getElementById('sessions-period-select');
            if (sessionsPeriodSelect) {
                sessionsPeriodSelect.addEventListener('change', () => {
                    console.log('üîÑ Sessions filter changed (V8.11)');
                    renderTrainingSessions();
                });
            }
            
            // Campionato event listeners
            const backFromCampionatoButton = document.getElementById('back-from-campionato-button');
            
            backFromCampionatoButton.addEventListener('click', () => {
                campionatoView.classList.add('hidden');
                // Always go back to company welcome screen since campionato is only available from there
                if (currentCompanyCode) {
                    showCompanyWelcome();
                } else {
                    mainView.classList.remove('hidden');
                }
            });
            
            // Load history convocations when returning from edit page
            function loadHistoryConvocations() {
                console.log('üìä Loading history convocations after navigation');
                console.log('   üè¢ Company Document ID:', currentCompanyDocumentId);
                console.log('   üë§ User Role:', userRole);
                console.log('   üÜî App ID:', currentAppId);
                
                // Setup Firestore listeners to load history data
                setupFirestoreListeners(currentAppId);
            }
            
            // Check for hash navigation (returning from edit_convocation.html)
            function checkHashNavigation() {
                const hash = window.location.hash;
                const returnToHistory = sessionStorage.getItem('returnToHistory');
                
                console.log('üîç checkHashNavigation() called');
                console.log('   üìç Hash:', hash);
                console.log('   üîÑ returnToHistory:', returnToHistory);
                
                if (hash === '#history' && returnToHistory === 'true') {
                    // Clear the flag
                    sessionStorage.removeItem('returnToHistory');
                    
                    // Restore saved state - check new companyDocId first, then fall back to editCompanyDocId
                    let editCompanyDocId = sessionStorage.getItem('companyDocId') || sessionStorage.getItem('editCompanyDocId');
                    let editUserRole = sessionStorage.getItem('editUserRole');
                    let editAppId = sessionStorage.getItem('editAppId');
                    
                    console.log('   üè¢ editCompanyDocId:', editCompanyDocId);
                    console.log('   üë§ editUserRole:', editUserRole);
                    console.log('   üÜî editAppId:', editAppId);
                    
                    // If missing userRole or appId, try to get from localStorage as fallback
                    if (editCompanyDocId && (!editUserRole || !editAppId)) {
                        console.log('   ‚ö†Ô∏è Missing userRole or appId, checking localStorage...');
                        if (!editUserRole) {
                            editUserRole = localStorage.getItem('userRole');
                            console.log('   üë§ userRole from localStorage:', editUserRole);
                        }
                        if (!editAppId) {
                            editAppId = localStorage.getItem('convocazioniAppId');
                            console.log('   üÜî appId from localStorage:', editAppId);
                        }
                    }
                    
                    if (editCompanyDocId && editUserRole && editAppId) {
                        console.log('‚úÖ All required data present, showing history view');
                        
                        // Set current state
                        currentCompanyDocumentId = editCompanyDocId;
                        userRole = editUserRole;
                        currentAppId = editAppId;
                        
                        // Clear edit state from sessionStorage
                        sessionStorage.removeItem('companyDocId');
                        sessionStorage.removeItem('editCompanyDocId');
                        sessionStorage.removeItem('editUserRole');
                        sessionStorage.removeItem('editAppId');
                        sessionStorage.removeItem('editOrigin');
                        
                        // Hide ALL login/welcome screens and views explicitly
                        console.log('   ‚úÖ Hiding ALL login/welcome screens explicitly');
                        companyEntryScreen.classList.add('hidden');
                        companyWelcomeScreen.classList.add('hidden');
                        passwordEntryScreen.classList.add('hidden');
                        playerManagementScreen.classList.add('hidden');
                        nameEntryScreen.classList.add('hidden');
                        startScreen.classList.add('hidden');
                        hideAllScreens(); // This ensures all screens ending with "-screen" are hidden
                        
                        // Hide ALL views except history
                        mainView.classList.add('hidden');
                        attendanceView.classList.add('hidden');
                        trainingAttendanceView.classList.add('hidden');
                        campionatoView.classList.add('hidden');
                        
                        // Show ONLY history view explicitly
                        console.log('   ‚úÖ Showing ONLY history view explicitly');
                        historyView.classList.remove('hidden');
                        
                        console.log('   üìä Loading history data...');
                        // Load history data
                        loadHistoryConvocations();
                        
                        // Clear the hash from URL
                        history.replaceState(null, null, ' ');
                    } else {
                        console.log('‚ùå Missing required data for history view');
                        console.log('   üè¢ companyDocId:', editCompanyDocId);
                        console.log('   üë§ userRole:', editUserRole);
                        console.log('   üÜî appId:', editAppId);
                    }
                }
            }
            
            // Check hash on page load
            checkHashNavigation();
            
            // Also check hash when it changes
            window.addEventListener('hashchange', checkHashNavigation);
            
            // Handle physical back button press (Android/iOS/browser)
            window.addEventListener('popstate', (event) => {
                console.log('üì± [BACK BUTTON] Popstate event triggered', event.state);
                isNavigatingBack = true;
                
                // Handle the back navigation
                const handled = handleBackButton();
                
                // If we're at the root and didn't handle it, allow default behavior (close app)
                if (!handled && navigationStack.length === 0) {
                    console.log('üì± [BACK BUTTON] At root level, allowing app to close');
                    // Don't push any state - let it close
                }
                // V9.21: Don't push new state after handling back - popstate already handled history
                // This prevents creating duplicate history entries and navigation confusion
                
                isNavigatingBack = false;
            });
            
            // Initialize with first state
            const initialView = getCurrentView();
            if (initialView) {
                history.replaceState({ view: initialView }, '', '');
                navigationStack.push(initialView);
                console.log('üì± [BACK BUTTON] Initial state:', initialView);
            }
        });
    </script>
</body>
</html>




































