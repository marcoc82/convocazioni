<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rosterkick</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- CONFIGURAZIONE FIREBASE -->
    <script type="module">
  import { cercaSocietaDaCodice } from './cercaSocietaDaCodice.js';
  window.cercaSocietaDaCodice = cercaSocietaDaCodice;
</script>
    <!-- debug -->
    <script>
    window.__firebase_config = JSON.stringify({
      apiKey: "AIzaSyD87fLjZfQO1gDOzqJZAdvlqSthBYN3XSU",
      authDomain: "polis-2013.firebaseapp.com",
      projectId: "polis-2013",
      storageBucket: "polis-2013.appspot.com",
      messagingSenderId: "607738543737",
      appId: "1:607738543737:web:9b108502b8f1b61ef4dea8",
      measurementId: "G-94FT2YQNBM"
    });
    </script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Espone le funzioni Firebase Auth globalmente per evitare ReferenceError
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getAuth = getAuth;

        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app, db, auth;
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.onSnapshot = onSnapshot;
            window.collection = collection;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.doc = doc;
            window.getDoc = getDoc;
            window.setDoc = setDoc;
            window.increment = increment;
            window.deleteDoc = deleteDoc;
        } else {
            console.error("Firebase configuration not available. Some features will not work.");
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .player-item {
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease-in-out, background-color 0.2s;
        }
        .player-item.selected-mister {
            background-color: #d1e5f4;
            color: #1e40af;
            font-weight: bold;
            border-color: #3b82f6;
        }
        .player-item.selected-marco {
            background-color: #fecaca;
            color: #b91c1c;
            font-weight: bold;
            border-color: #ef4444;
        }
        .player-item.selected-marco-orange {
            background-color: #fed7aa;
            color: #ea580c;
            font-weight: bold;
            border-color: #f97316;
        }
        .player-item.selected-marco-black {
            background-color: #1f2937;
            color: #ffffff;
            font-weight: bold;
            border-color: #374151;
        }
        .player-item.selected-marco-purple {
            background-color: #8b5cf6;
            color: #ffffff;
            font-weight: bold;
            border-color: #7c3aed;
        }
        .player-item:hover:not(.selected-mister):not(.selected-marco):not(.selected-marco-orange):not(.selected-marco-black):not(.selected-marco-purple) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center justify-center">

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-2xl">
        <!-- Rosterkick Logo -->
        <div class="text-center mb-4">
            <img src="logo Rosterkick.jpg" alt="Rosterkick Logo" class="mx-auto w-40 h-40 rounded-lg">
        </div>
        <!-- Application Title -->
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">Rosterkick</h1>
        
        <!-- Company Code Entry Screen -->
        <div id="company-entry-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Inserisci il codice società</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4">
                    <input type="text" id="company-code-input" placeholder="Codice società" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-company" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-company" class="text-gray-700">Ricorda codice</label>
                    </div>
                    <button id="verify-company-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Verifica
                    </button>
                </div>
            </div>
            <div id="company-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Company Welcome Screen -->
        <div id="company-welcome-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Benvenuto</h2>
            <div class="p-6 bg-blue-50 rounded-xl mb-6 shadow-sm border border-blue-200 text-center">
                <h3 id="company-name-display" class="text-lg font-bold text-blue-800 mb-4"></h3>
                <div class="grid grid-cols-1 gap-3">
                    <button id="enter-mister-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra come Mister
                    </button>
                    <button id="enter-dirigente-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra come Dirigente
                    </button>
                    <button id="view-history-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Vedi Storico
                    </button>
                    <button id="manage-players-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Gestione Giocatori
                    </button>
                    <button id="company-logout-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Password Entry Screen -->
        <div id="password-entry-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Inserisci la password</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4">
                    <p id="role-prompt" class="text-center text-gray-600"></p>
                    <input type="password" id="password-input" placeholder="Password" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex gap-2">
                        <button id="confirm-password-button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                            Conferma
                        </button>
                        <button id="cancel-password-button" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                            Annulla
                        </button>
                    </div>
                </div>
            </div>
            <div id="password-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Player Management Screen -->
        <div id="player-management-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Gestione Giocatori</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4 mb-4">
                    <input type="text" id="new-player-input" placeholder="Nome e numero giocatore (es. 10 ROSSI MARIO)" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="add-player-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Aggiungi Giocatore
                    </button>
                </div>
                <div id="company-players-list" class="space-y-2">
                    <!-- Company players will be loaded here -->
                </div>
            </div>
            <button id="save-players-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mb-4 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Salva Giocatori
            </button>
            <div id="save-players-message-area" class="mt-2 mb-4 text-center text-sm font-medium text-gray-600 hidden"></div>
            <button id="back-from-players-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Torna al Menu
            </button>
        </div>

        <!-- Name Entry Screen (deprecated, keeping for compatibility) -->
        <div id="name-entry-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Inserisci il tuo nome</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4">
                    <input type="text" id="name-input" placeholder="" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-me" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-me" class="text-gray-700">Ricordami</label>
                    </div>
                    <button id="enter-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra
                    </button>
                </div>
            </div>
            <div id="name-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Start Screen View -->
        <div id="start-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Seleziona una squadra</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200 text-center">
                <p class="text-gray-600 mb-2">ID App attuale (il tuo ID):</p>
                <div class="flex flex-col items-center">
                    <span id="app-id-display" class="font-bold text-lg text-blue-600 mb-4 cursor-pointer" onclick="copyAppId()"></span>
                    <button id="create-team-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra
                    </button>
                </div>
            </div>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Partecipa a una squadra esistente</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="join-app-id-input" placeholder="Incolla l'ID app qui" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="join-team-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Partecipa
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="remember-team-id" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-team-id" class="text-gray-700">Ricorda ID squadra</label>
                </div>
            </div>
            <button id="forget-data-button" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Dimentica i dati salvati
            </button>
            <div id="start-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Main Form View -->
        <div id="main-view" class="hidden">
            <!-- App Info Section -->
            <div class="bg-gray-50 p-4 rounded-xl mb-6 shadow-sm border border-gray-200">
                <p class="text-gray-600 mb-2">ID Squadra attuale:</p>
                <div class="flex flex-col items-center">
                    <span id="current-app-id-display" class="font-bold text-lg text-blue-600 mb-4 cursor-pointer" onclick="copyAppId()"></span>
                    <button id="change-team-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Esci senza salvare
                    </button>
                </div>
            </div>

            <div id="role-message" class="mt-4 p-3 bg-blue-100 border border-blue-200 rounded-lg text-blue-800 text-sm font-medium hidden"></div>

            <!-- Notes section (editable by marco, viewable by mister) -->
            <div id="notes-section" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Note (Segnalate dal Dirigente)</h3>
                <div id="notes-editable" class="hidden">
                    <textarea id="notes-textarea" placeholder="Inserisci le tue note qui..." class="w-full p-3 border border-yellow-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-yellow-500" rows="3"></textarea>
                    <button id="save-notes-button" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                        Salva Note
                    </button>
                </div>
                <div id="notes-readonly" class="hidden">
                    <div id="notes-display" class="p-3 bg-white border border-yellow-300 rounded-lg min-h-[80px] text-gray-700"></div>
                </div>
            </div>

            <!-- View of unavailable players (visible to both Mister and Marco) -->
            <div id="unavailable-players-view" class="bg-red-100 p-4 rounded-xl mb-6 shadow-sm border border-red-200 hidden">
                <h2 id="unavailable-players-title" class="text-lg font-semibold text-red-700 mb-2">Giocatori Non Disponibili (Segnalati dal Dirigente)</h2>
                <ul id="unavailable-players-list" class="space-y-1 text-red-600">
                    <!-- Non-available players will be listed here -->
                </ul>
            </div>
            
            <!-- Match Details Section -->
            <div id="match-details-section" class="bg-gray-50 p-4 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Dettagli Partita</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="campo" class="block text-sm font-medium text-gray-700">Campo</label>
                        <input type="text" id="campo" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="avversario" class="block text-sm font-medium text-gray-700">Avversario</label>
                        <input type="text" id="avversario" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="data-partita" class="block text-sm font-medium text-gray-700">Data Partita</label>
                        <input type="date" id="data-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="orario-convocazione" class="block text-sm font-medium text-gray-700">Orario Convocazione</label>
                        <input type="time" id="orario-convocazione" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="orario-partita" class="block text-sm font-medium text-gray-700">Orario Partita</label>
                        <input type="time" id="orario-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- Players List Section -->
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Lista Giocatori</h2>
            <p class="text-sm text-gray-500 mb-4" id="players-list-message">Clicca sui nomi per selezionare i convocati.</p>
            <div id="players-list-container" class="bg-gray-50 rounded-xl p-4 mb-6 shadow-sm border border-gray-200">
                <ul id="players-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    <!-- Player items will be inserted here by JavaScript -->
                </ul>
            </div>
            
            <!-- Live Selected Players List -->
            <div id="selected-players-container" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-200">
                <h2 id="selected-players-title" class="text-lg font-semibold text-gray-700 mb-2">Giocatori Convocati</h2>
                <ul id="selected-players-live-list" class="space-y-2 text-gray-600">
                    <!-- Selected players will appear here in real-time -->
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                    Salva
                </button>
                <button id="share-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                    Condividi le convocazioni
                </button>
            </div>
            <button id="history-button" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Storico Convocazioni
            </button>
            <button id="attendance-button" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Riepilogo Presenze
            </button>
            <div id="message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Success Popup -->
        <div id="success-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 mx-4 max-w-sm w-full">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Successo!</h3>
                <p id="success-popup-message" class="text-gray-600 text-center">Salvataggio effettuato con successo</p>
            </div>
        </div>

        <!-- Convocations History View (using Firestore) -->
        <div id="history-view" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Storico Convocazioni</h2>
            <div id="history-list" class="space-y-4">
                <!-- History items will be populated here -->
            </div>
            <button id="back-from-history-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Torna Indietro
            </button>
        </div>

        <!-- Attendance Summary View -->
        <div id="attendance-view" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Riepilogo Presenze</h2>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list" class="bg-white divide-y divide-gray-200">
                        <!-- Attendance data will be populated here -->
                    </tbody>
                </table>
            </div>
            <button id="back-from-attendance-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Torna Indietro
            </button>
        </div>

        <!-- Shareable View (Hidden for image generation) -->
        <div id="share-view" class="absolute w-[600px] h-auto top-[-9999px] left-[-9999px] bg-white rounded-xl shadow-2xl p-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Convocazioni Ufficiali</h2>
            
            <div id="share-details" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-gray-700 mb-2">Campo: <span id="share-campo" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">Avversario: <span id="share-avversario" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">Data Partita: <span id="share-data-partita" class="font-semibold"></span></p>
                <p class="text-700 mb-2">Orario Convocazione: <span id="share-orario-convocazione" class="font-semibold"></span></p>
                <p class="text-gray-700">Orario Partita: <span id="share-orario-partita" class="font-semibold"></span></p>
            </div>

            <div class="mb-4">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Giocatori Convocati:</h3>
                <ul id="share-players-list" class="space-y-2 text-gray-600">
                    <!-- Selected players will be inserted here -->
                </ul>
            </div>
            <p class="text-sm text-gray-500 text-center mt-6">Rosterkick</p>
        </div>

        <!-- Modal for Marco's Status -->
        <div id="status-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
                <h2 class="text-xl font-bold mb-4">Seleziona lo stato del giocatore</h2>
                <div class="space-y-4">
                    <button data-status="Infortunato" class="w-full py-3 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Infortunato
                    </button>
                    <button data-status="Non disponibile Sabato" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Non disponibile Sabato
                    </button>
                    <button data-status="Non disponibile Domenica" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Non disponibile Domenica
                    </button>
                    <button data-status="Non disponibile Weekend" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Non disponibile WE
                    </button>
                    <button data-status="Solo 2 allenamenti" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Solo 2 allenamenti
                    </button>
                    <button data-status="Solo 1 allenamento" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Solo 1 allenamento
                    </button>

                    <button data-status="Disponibile" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Disponibile
                    </button>
                </div>
                <button id="close-modal" class="mt-6 w-full py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                    Annulla
                </button>
            </div>
        </div>

        <!-- Modal for Mister's Unavailable Player Info -->
        <div id="unavailable-player-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
                <h2 class="text-xl font-bold mb-4 text-center text-red-600">Giocatore Non Disponibile</h2>
                <div class="text-center mb-6">
                    <p class="text-lg font-semibold text-gray-800 mb-2" id="unavailable-player-name">Nome Giocatore</p>
                    <p class="text-gray-600">Motivo:</p>
                    <p class="text-lg font-medium text-red-600" id="unavailable-player-reason">Motivo indisponibilità</p>
                </div>
                <button id="convoca-comunque-button" class="w-full py-3 mb-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    Convoca ugualmente
                </button>
                <button id="close-unavailable-modal" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                    Ok
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript for app logic -->
    <script>
        // Fallback initialization when Firebase modules don't load
        document.addEventListener('DOMContentLoaded', () => {
            // If Firebase modules didn't load, initialize in demo mode
            if (typeof window.signInAnonymously === 'undefined') {
                console.log("Firebase modules not available, initializing in demo mode");
                initializeDemoMode();
            }
        });

        function initializeDemoMode() {
            // Demo mode initialization
            const companyEntryScreen = document.getElementById('company-entry-screen');
            const companyCodeInput = document.getElementById('company-code-input');
            const verifyCompanyButton = document.getElementById('verify-company-button');
            const companyEntryMessageArea = document.getElementById('company-entry-message-area');
            const rememberCompanyCheckbox = document.getElementById('remember-company');
            
            const companyWelcomeScreen = document.getElementById('company-welcome-screen');
            const companyNameDisplay = document.getElementById('company-name-display');
            const enterMisterButton = document.getElementById('enter-mister-button');
            const enterDirigenteButton = document.getElementById('enter-dirigente-button');
            
            const passwordEntryScreen = document.getElementById('password-entry-screen');
            const rolePrompt = document.getElementById('role-prompt');
            const passwordInput = document.getElementById('password-input');
            const confirmPasswordButton = document.getElementById('confirm-password-button');
            const cancelPasswordButton = document.getElementById('cancel-password-button');
            const passwordEntryMessageArea = document.getElementById('password-entry-message-area');

            let currentCompanyCode = null;
            let currentCompanyData = null;
            let pendingRole = null;

            // Show company entry screen
            companyEntryScreen.classList.remove('hidden');

            function hideAllScreens() {
                document.querySelectorAll('[id$="-screen"]').forEach(screen => {
                    screen.classList.add('hidden');
                });
            }

            function showMessage(element, message, isError = true) {
                element.textContent = message;
                element.classList.remove('hidden');
                element.classList.toggle('text-red-600', isError);
                element.classList.toggle('text-green-600', !isError);
                setTimeout(() => element.classList.add('hidden'), 5000);
            }

            // Demo company verification
            function verifyCompanyCode(code) {
                if (code === "DEMO" || code === "demo") {
                    return {
                        name: "Società Demo",
                        passwords: {
                            mister: "mister123",
                            marco: "marco123"
                        }
                    };
                }
                return null;
            }

            function showCompanyWelcome() {
                hideAllScreens();
                companyNameDisplay.textContent = currentCompanyData.name;
                companyWelcomeScreen.classList.remove('hidden');
            }

            function showPasswordEntry(role) {
                hideAllScreens();
                pendingRole = role;
                rolePrompt.textContent = `Inserisci la password per ${role === 'mister' ? 'Mister' : 'Dirigente'}:`;
                passwordInput.value = '';
                passwordEntryScreen.classList.remove('hidden');
                passwordInput.focus();
            }

            // Event listeners
            verifyCompanyButton.addEventListener('click', async () => {
                const companyCode = companyCodeInput.value.trim();
                if (!companyCode) {
                    showMessage(companyEntryMessageArea, "Inserisci un codice società.");
                    return;
                }

                try {
                    const companyData = await verifyCompanyCode(companyCode);
                    if (companyData) {
                        currentCompanyCode = companyCode;
                        currentCompanyData = companyData;
                        
                        // Populate passwords from data.config if available
                        if (currentCompanyData.data && currentCompanyData.data.config) {
                            currentCompanyData.passwords = {
                                ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                dirigente: currentCompanyData.data.config.dirigentePassword,
                                mister: currentCompanyData.data.config.misterPassword
                            };
                        }
                        
                        window.currentCompanyData = currentCompanyData;
                        
                        if (rememberCompanyCheckbox.checked) {
                            localStorage.setItem('companyCode', companyCode);
                            localStorage.setItem('companyData', JSON.stringify(companyData));
                        }
                        
                        // Hide any error messages
                        companyEntryMessageArea.style.display = 'none';
                        companyEntryMessageArea.classList.add('hidden');
                        
                        showCompanyWelcome();
                    } else {
                        showMessage(companyEntryMessageArea, "Codice società non valido.");
                    }
                } catch (error) {
                    console.error("Errore nella verifica:", error);
                    showMessage(companyEntryMessageArea, "Errore nella verifica. Riprova.");
                }
            });

            enterMisterButton.addEventListener('click', () => {
                showPasswordEntry('mister');
            });

            enterDirigenteButton.addEventListener('click', () => {
                showPasswordEntry('dirigente');
            });

            confirmPasswordButton.addEventListener('click', () => {
                const password = passwordInput.value.trim();
                if (!password) {
                    showMessage(passwordEntryMessageArea, "Inserisci la password.");
                    return;
                }

                let isValid = currentCompanyData.passwords[pendingRole] === password;
                
                // For backward compatibility: if role is 'dirigente' and not found, try 'marco'
                if (!isValid && pendingRole === 'dirigente' && currentCompanyData.passwords['marco'] === password) {
                    isValid = true;
                }
                
                if (isValid) {
                    showMessage(passwordEntryMessageArea, "Accesso effettuato! (Demo mode)", false);
                    setTimeout(() => {
                        alert(`Benvenuto ${pendingRole === 'mister' ? 'Mister' : 'Dirigente'}!\n\nIn modalità demo, le funzionalità complete sarebbero disponibili con Firebase attivo.\n\nCodici di prova:\n- Codice società: DEMO\n- Password Mister: mister123\n- Password Dirigente: marco123`);
                    }, 1000);
                } else {
                    showMessage(passwordEntryMessageArea, "Password errata.");
                }
            });

            cancelPasswordButton.addEventListener('click', () => {
                pendingRole = null;
                passwordInput.value = '';
                showCompanyWelcome();
            });

            // Check for saved data
            const savedCompanyCode = localStorage.getItem('companyCode');
            const savedCompanyData = localStorage.getItem('companyData');
            
            if (savedCompanyCode && savedCompanyData) {
                currentCompanyCode = savedCompanyCode;
                currentCompanyData = JSON.parse(savedCompanyData);
                
                // Populate passwords from data.config if available
                if (currentCompanyData.data && currentCompanyData.data.config) {
                    currentCompanyData.passwords = {
                        ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                        dirigente: currentCompanyData.data.config.dirigentePassword,
                        mister: currentCompanyData.data.config.misterPassword
                    };
                }
                
                window.currentCompanyData = currentCompanyData;
                companyCodeInput.value = savedCompanyCode;
                rememberCompanyCheckbox.checked = true;
                showCompanyWelcome();
            }
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const players = [
                "99 ALPA FEDERICO", "78 BECCARIS SEBASTIANO", "32 BEN MABROUK KEVIN", "23 BERLUSCONI NOAH",
                "1 BERNUCCI ROMEO", "18 BOERO GUGLIELMO", "22 BRIANO COSTANTINO", "28 CABASSI ROBERTO",
                "7 CALLIKU ANDREA", "4 CAZZULO MICHELE", "46 CONGIU ALESSIO", "20 DHAOUI OMAR",
                "5 DI DATO SIMONE", "77 DONALD BRYAN", "6 ESPOSITO EMANUELE", "25 GARDELLA ANDREA",
                "13 GENNARO EDOARDO", "91 GIOIA LEONARDO", "17 KHAY ADAM", "2 LAMKHAYAR AMIN",
                "29 LANNA MARK", "19 MARCHESE MATTEO", "47 MELLO CHRISTIAN", "61 MELLUSO MATTIA",
                "14 MONTEFIORI EDOARDO", "3 ODAGLIA ANDREA", "11 PELLICCI FRANCESCO", "90 PIGA GIOVANNI",
                "45 PINASCO ALESSANDRO", "10 POLLIO CESARE", "9 SCALA FEDERICO", "16 STANCHI FEDERICO",
                "21 TONINI LORENZO"
            ];

            // UI Elements
            const companyEntryScreen = document.getElementById('company-entry-screen');
            const companyCodeInput = document.getElementById('company-code-input');
            const verifyCompanyButton = document.getElementById('verify-company-button');
            const companyEntryMessageArea = document.getElementById('company-entry-message-area');
            const rememberCompanyCheckbox = document.getElementById('remember-company');
            
            const companyWelcomeScreen = document.getElementById('company-welcome-screen');
            const companyNameDisplay = document.getElementById('company-name-display');
            const enterMisterButton = document.getElementById('enter-mister-button');
            const enterDirigenteButton = document.getElementById('enter-dirigente-button');
            const viewHistoryButton = document.getElementById('view-history-button');
            const managePlayersButton = document.getElementById('manage-players-button');
            const companyLogoutButton = document.getElementById('company-logout-button');
            
            const passwordEntryScreen = document.getElementById('password-entry-screen');
            const rolePrompt = document.getElementById('role-prompt');
            const passwordInput = document.getElementById('password-input');
            const confirmPasswordButton = document.getElementById('confirm-password-button');
            const cancelPasswordButton = document.getElementById('cancel-password-button');
            const passwordEntryMessageArea = document.getElementById('password-entry-message-area');
            
            const playerManagementScreen = document.getElementById('player-management-screen');
            const newPlayerInput = document.getElementById('new-player-input');
            const addPlayerButton = document.getElementById('add-player-button');
            const companyPlayersList = document.getElementById('company-players-list');
            const savePlayersButton = document.getElementById('save-players-button');
            const savePlayersMessageArea = document.getElementById('save-players-message-area');
            const backFromPlayersButton = document.getElementById('back-from-players-button');
            
            const nameEntryScreen = document.getElementById('name-entry-screen');
            const nameInput = document.getElementById('name-input');
            const enterButton = document.getElementById('enter-button');
            const nameEntryMessageArea = document.getElementById('name-entry-message-area');
            const rememberMeCheckbox = document.getElementById('remember-me');

            const startScreen = document.getElementById('start-screen');
            const mainView = document.getElementById('main-view');
            const historyView = document.getElementById('history-view');
            const attendanceView = document.getElementById('attendance-view');
            const playersList = document.getElementById('players-list');
            const playersListMessage = document.getElementById('players-list-message');
            const selectedPlayersLiveList = document.getElementById('selected-players-live-list');
            const selectedPlayersTitle = document.getElementById('selected-players-title');

            const saveButton = document.getElementById('save-button');
            const shareButton = document.getElementById('share-button');
            const historyButton = document.getElementById('history-button');
            const attendanceButton = document.getElementById('attendance-button');
            const backFromHistoryButton = document.getElementById('back-from-history-button');
            const backFromAttendanceButton = document.getElementById('back-from-attendance-button');
            const historyList = document.getElementById('history-list');
            const attendanceList = document.getElementById('attendance-list');
            const shareView = document.getElementById('share-view');
            const messageArea = document.getElementById('message-area');
            const startMessageArea = document.getElementById('start-message-area');
            const appIdDisplay = document.getElementById('app-id-display');
            const currentAppIdDisplay = document.getElementById('current-app-id-display');
            const createTeamButton = document.getElementById('create-team-button');
            const joinTeamButton = document.getElementById('join-team-button');
            const joinAppIdInput = document.getElementById('join-app-id-input');
            const rememberTeamIdCheckbox = document.getElementById('remember-team-id');
            const changeTeamButton = document.getElementById('change-team-button');
            const forgetDataButton = document.getElementById('forget-data-button');
            const roleMessage = document.getElementById('role-message');
            const unavailablePlayersView = document.getElementById('unavailable-players-view');
            const unavailablePlayersList = document.getElementById('unavailable-players-list');
            const unavailablePlayersTitle = document.getElementById('unavailable-players-title');
            const matchDetailsSection = document.getElementById('match-details-section');
            
            // Notes Elements
            const notesSection = document.getElementById('notes-section');
            const notesEditable = document.getElementById('notes-editable');
            const notesReadonly = document.getElementById('notes-readonly');
            const notesTextarea = document.getElementById('notes-textarea');
            const notesDisplay = document.getElementById('notes-display');
            const saveNotesButton = document.getElementById('save-notes-button');
            
            // Modal Elements
            const statusModal = document.getElementById('status-modal');
            const closeModalButton = document.getElementById('close-modal');
            const statusButtons = statusModal.querySelectorAll('[data-status]');
            
            // Unavailable Player Modal Elements
            const unavailablePlayerModal = document.getElementById('unavailable-player-modal');
            const closeUnavailableModalButton = document.getElementById('close-unavailable-modal');
            const unavailablePlayerName = document.getElementById('unavailable-player-name');
            const unavailablePlayerReason = document.getElementById('unavailable-player-reason');
            const convocaComunqueButton = document.getElementById('convoca-comunque-button'); // nuovo bottone

            // --- App State ---
            let userRole = null;
            let currentAppId = window.appId;
            let currentCompanyCode = null;
            let currentCompanyData = null;
            let companyPlayers = [];
            let pendingRole = null; // for password verification
            let unavailablePlayers = new Map();
            let currentNotes = '';
            let tempPlayerName = null;
            let tempUnavailablePlayerName = null; // per "convoca comunque"
            let unsubscribeListeners = [];

            // Initial Firebase setup
             async function initApp() {
                if (window.auth) {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await window.signInWithCustomToken(window.auth, token);
                        } else {
                            await window.signInAnonymously(window.auth);
                        }
                        
                        console.log("Firebase initialized and user authenticated.");
                        
                        // Check for saved company data
                        const savedCompanyCode = localStorage.getItem('companyCode');
                        const savedCompanyData = localStorage.getItem('companyData');
                        const savedRole = localStorage.getItem('userRole');
                        const savedAppId = localStorage.getItem('convocazioniAppId');
                        
                        if (savedCompanyCode && savedCompanyData && savedRole && savedAppId) {
                            // Restore full session
                            currentCompanyCode = savedCompanyCode;
                            currentCompanyData = JSON.parse(savedCompanyData);
                            
                            // Populate passwords from data.config if available
                            if (currentCompanyData.data && currentCompanyData.data.config) {
                                currentCompanyData.passwords = {
                                    ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                    dirigente: currentCompanyData.data.config.dirigentePassword,
                                    mister: currentCompanyData.data.config.misterPassword
                                };
                            }
                            
                            window.currentCompanyData = currentCompanyData;
                            userRole = savedRole;
                            companyPlayers = await loadCompanyPlayers();
                            startApp(savedAppId);
                        } else if (savedCompanyCode && savedCompanyData) {
                            // Show welcome screen with company data
                            currentCompanyCode = savedCompanyCode;
                            currentCompanyData = JSON.parse(savedCompanyData);
                            
                            // Populate passwords from data.config if available
                            if (currentCompanyData.data && currentCompanyData.data.config) {
                                currentCompanyData.passwords = {
                                    ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                    dirigente: currentCompanyData.data.config.dirigentePassword,
                                    mister: currentCompanyData.data.config.misterPassword
                                };
                            }
                            
                            window.currentCompanyData = currentCompanyData;
                            companyPlayers = await loadCompanyPlayers();
                            showCompanyWelcome();
                        } else {
                            // Show company entry screen
                            if (savedCompanyCode) {
                                companyCodeInput.value = savedCompanyCode;
                                rememberCompanyCheckbox.checked = true;
                            }
                            companyEntryScreen.classList.remove('hidden');
                        }
                    } catch (err) {
                        console.error("Firebase authentication failed:", err);
                        companyEntryScreen.classList.remove('hidden');
                    }
                } else {
                    console.error("Firebase configuration not available. Some features will not work.");
                    companyEntryScreen.classList.remove('hidden');
                }
            }

            initApp();
            
            
            // Company verification functions
            async function verifyCompanyCode(companyCode) {
                // Try to use cercaSocietaDaCodice function if available
                if (window.cercaSocietaDaCodice) {
                    try {
                        const societa = await window.cercaSocietaDaCodice(companyCode);
                        
                        // Check if company exists and is active
                        if (!societa) {
                            return null;
                        }
                        
                        if (societa.attiva === false) {
                            return null;
                        }
                        
                        // Convert to expected format for compatibility
                        const companyData = {
                            name: societa.nome || "Società Sconosciuta",
                            passwords: societa.passwords || {},
                            data: societa // Keep original data
                        };
                        
                        // Populate passwords from data.config if available
                        if (societa.config) {
                            companyData.passwords = {
                                ...companyData.passwords, // Keep existing passwords for backward compatibility
                                dirigente: societa.config.dirigentePassword,
                                mister: societa.config.misterPassword
                            };
                        }
                        
                        return companyData;
                    } catch (error) {
                        console.error("Errore nella ricerca società:", error);
                        // Fall back to old method
                    }
                }

                // Fallback: Demo mode when Firebase is not available or cercaSocietaDaCodice fails
                if (!window.db) {
                    console.log("Firebase not available, using demo mode");
                    if (companyCode === "DEMO" || companyCode === "demo") {
                        return {
                            name: "Società Demo",
                            passwords: {
                                mister: "mister123",
                                marco: "marco123",
                                dirigente: "marco123"
                            }
                        };
                    } else {
                        return null;
                    }
                }
                
                try {
                    const companyDocRef = window.doc(window.db, "companies", companyCode);
                    const companyDoc = await window.getDoc(companyDocRef);
                    
                    if (companyDoc.exists()) {
                        const data = companyDoc.data();
                        // Check if company is active
                        if (data.attiva === false) {
                            return null;
                        }
                        return data;
                    } else {
                        return null;
                    }
                } catch (error) {
                    console.error("Errore nella verifica del codice società:", error);
                    throw error;
                }
            }
            
            async function verifyPassword(role, password) {
                if (!currentCompanyData) {
                    return false;
                }
                
                const passwords = currentCompanyData.passwords || {};
                
                // First, try the requested role
                if (passwords[role] === password) {
                    return true;
                }
                
                // For backward compatibility: if role is 'dirigente' and not found, try 'marco'
                if (role === 'dirigente' && passwords['marco'] === password) {
                    return true;
                }
                
                return false;
            }
            
            async function loadCompanyPlayers() {
                if (!currentCompanyCode) {
                    return [];
                }
                
                // Demo mode - load from localStorage or return defaults
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    // Try to load from localStorage first
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            return JSON.parse(savedPlayers);
                        } catch (error) {
                            console.error("Error parsing saved players from localStorage:", error);
                        }
                    }
                    // Return default demo players if nothing saved
                    return [
                        "1 ROSSI MARIO", "2 BIANCHI LUIGI", "3 VERDI GIUSEPPE", 
                        "4 NERI ANTONIO", "5 GIALLI FRANCESCO", "6 BLU MARCO",
                        "7 VIOLA STEFANO", "8 ROSA ANDREA", "9 GRIGIO PAOLO", "10 AZZURRI LUCA"
                    ];
                }
                
                // Firebase mode - load from giocatori property in company document
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            return JSON.parse(savedPlayers);
                        } catch (error) {
                            console.error("Error parsing saved players from localStorage fallback:", error);
                        }
                    }
                    return [];
                }
                
                try {
                    // Load giocatori from the main company document
                    const companyDocRef = window.doc(window.db, "companies", currentCompanyCode);
                    const companyDoc = await window.getDoc(companyDocRef);
                    
                    if (companyDoc.exists()) {
                        const data = companyDoc.data();
                        // Return the giocatori array or empty array if not present
                        return data.giocatori || [];
                    } else {
                        console.log("Company document not found, returning empty players list");
                        return [];
                    }
                } catch (error) {
                    console.error("Errore nel caricamento giocatori da Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            console.log("Loading players from localStorage fallback");
                            return JSON.parse(savedPlayers);
                        } catch (parseError) {
                            console.error("Error parsing saved players from localStorage fallback:", parseError);
                        }
                    }
                    return [];
                }
            }
            
            async function saveCompanyPlayers(playersList) {
                if (!currentCompanyCode) {
                    throw new Error("Codice società non disponibile");
                }
                
                // Demo mode - save to localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("Demo mode: players saved locally", playersList);
                    localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                    return;
                }
                
                // Firebase mode - update giocatori property in companies collection
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving to localStorage as fallback");
                    localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                    return;
                }
                
                try {
                    // Update the giocatori property in the company document using updateDoc
                    const companyDocRef = window.doc(window.db, "companies", currentCompanyCode);
                    await window.updateDoc(companyDocRef, { giocatori: playersList });
                    console.log("Players saved to Firebase successfully");
                } catch (error) {
                    console.error("Errore nel salvataggio giocatori su Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    console.log("Falling back to localStorage due to Firebase error");
                    try {
                        localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                        console.log("Players saved to localStorage as fallback");
                        // Don't throw error since localStorage save succeeded
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        throw new Error("Salvataggio fallito sia su Firebase che su localStorage");
                    }
                }
            }

            // Set up real-time listeners for all necessary data
            function setupFirestoreListeners(appId) {
                // Clear old listeners
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                // Use company-specific paths
                const basePath = currentCompanyCode ? `companies/${currentCompanyCode}/data` : `artifacts/${appId}/public/data`;

                // Listener for Mister's convocations history
                const historyCollectionRef = window.collection(window.db, `${basePath}/convocations_history`);
                const historyUnsub = window.onSnapshot(historyCollectionRef, (querySnapshot) => {
                    loadHistory(querySnapshot);
                });
                unsubscribeListeners.push(historyUnsub);

                // Listener for player attendance
                const attendanceCollectionRef = window.collection(window.db, `${basePath}/player_attendance`);
                const attendanceUnsub = window.onSnapshot(attendanceCollectionRef, (querySnapshot) => {
                    loadAttendance(querySnapshot);
                });
                unsubscribeListeners.push(attendanceUnsub);
                
                // Listener for Marco's unavailable players list
                const unavailableDocRef = window.doc(window.db, `${basePath}/availability`, "marco_unavailable");
                const unavailableUnsub = window.onSnapshot(unavailableDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().players) {
                        unavailablePlayers = new Map(Object.entries(docSnap.data().players));
                    } else {
                        unavailablePlayers = new Map();
                    }
                    renderPlayers(); // Re-render players with new unavailable status
                    updateUnavailablePlayersView(); // Update Mister's view
                });
                unsubscribeListeners.push(unavailableUnsub);
                
                // Listener for notes
                const notesDocRef = window.doc(window.db, `${basePath}/notes`, "marco_notes");
                const notesUnsub = window.onSnapshot(notesDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().content) {
                        currentNotes = docSnap.data().content;
                    } else {
                        currentNotes = '';
                    }
                    updateNotesDisplay();
                });
                unsubscribeListeners.push(notesUnsub);
            }

            // Function to save data based on role
            async function saveData() {
                if (!window.db || !window.auth.currentUser) {
                    showMessage("Errore: Firebase non è ancora pronto. Riprova tra un attimo.", "text-red-600");
                    return;
                }

                // Use company-specific paths
                const basePath = currentCompanyCode ? `companies/${currentCompanyCode}/data` : `artifacts/${currentAppId}/public/data`;

                if (userRole === 'mister') {
                    const matchDetails = getMatchDetails();
                    const selectedPlayers = getSelectedPlayers();
                    
                    if (!matchDetails.avversario || selectedPlayers.length === 0) {
                        showMessage("Inserisci l'avversario e seleziona almeno un giocatore per salvare.", "text-red-600");
                        return;
                    }

                    try {
                        await window.addDoc(window.collection(window.db, `${basePath}/convocations_history`), {
                            details: matchDetails,
                            players: selectedPlayers,
                            createdAt: new Date().toISOString()
                        });

                        for (const player of selectedPlayers) {
                            const playerDocRef = window.doc(window.db, `${basePath}/player_attendance`, player);
                            await window.setDoc(playerDocRef, { count: window.increment(1) }, { merge: true });
                        }

                        showSuccessPopup("Convocazione salvata e presenze aggiornate!");
                    } catch (e) {
                        console.error("Errore salvataggio su Firestore: ", e);
                        showMessage("Errore durante il salvataggio. Controlla la console.", "text-red-600");
                    }
                } else if (userRole === 'marco') {
                    const unavailablePlayersObject = Object.fromEntries(unavailablePlayers);
                    const unavailableDocRef = window.doc(window.db, `${basePath}/availability`, "marco_unavailable");
                    
                    try {
                        await window.setDoc(unavailableDocRef, { players: unavailablePlayersObject });
                        showSuccessPopup("Lista di giocatori non disponibili salvata!");
                    } catch (e) {
                        console.error("Errore salvataggio su Firestore: ", e);
                        showMessage("Errore durante il salvataggio. Controlla la console.", "text-red-600");
                    }
                }
            }

            // Function to load and display history from Firestore
            function loadHistory(querySnapshot) {
                historyList.innerHTML = '';
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Nessuna convocazione salvata.</p>';
                    return;
                }
                const history = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    history.push({ ...data, id: doc.id });
                });
                // Sort by createdAt descending
                history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                history.forEach(data => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                    const createdAt = new Date(data.createdAt);
                    const formattedDate = createdAt.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
                    const formattedTime = createdAt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                    // Format match date with uppercase day of week
                    let formattedMatchDate = data.details.data;
                    if (data.details.data !== 'N/D') {
                        const matchDate = new Date(data.details.data + 'T00:00:00');
                        const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                        const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                        const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                        formattedMatchDate = `${dayOfWeek} ${dateString}`;
                    }

                    item.innerHTML = `
                        <div class="font-bold text-lg mb-2 text-gray-800">${data.details.avversario}</div>
                        <div class="text-sm text-gray-600 mb-2">
                            <p>Salvataggio: ${formattedDate} alle ${formattedTime}</p>
                            <p>Campo: ${data.details.campo}</p>
                            <p>Data Partita: ${formattedMatchDate}</p>
                            <p>Orario Convocazione: ${data.details.orarioConvocazione}</p>
                            <p>Orario Partita: ${data.details.orarioPartita}</p>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p class="font-semibold mb-1">Giocatori:</p>
                            <ul class="list-disc list-inside space-y-0.5">
                                ${data.players.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button class="share-history-btn bg-blue-500 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded" data-convocation='${JSON.stringify(data)}'>Condividi</button>
                            ${userRole === 'marco' ? `<button class="delete-history-btn bg-red-500 hover:bg-red-700 text-white text-xs px-3 py-1 rounded" data-docid="${data.id}">Elimina</button>` : ''}
                        </div>
                    `;
                    historyList.appendChild(item);
                });

                // Listener sui pulsanti "Elimina"
                if (userRole === 'marco') {
                    const deleteButtons = historyList.querySelectorAll('.delete-history-btn');
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const docId = btn.getAttribute('data-docid');
                            if (confirm('Vuoi davvero eliminare questa partita dallo storico?')) {
                                try {
                                    // Recupera i giocatori coinvolti e aggiorna le presenze
                                    const docRef = window.doc(window.db, `artifacts/${currentAppId}/public/data/convocations_history`, docId);
                                    const docSnap = await window.getDoc(docRef);
                                    if (docSnap.exists()) {
                                        const convocazione = docSnap.data();
                                        for (const player of convocazione.players) {
                                            const playerDocRef = window.doc(window.db, `artifacts/${currentAppId}/public/data/player_attendance`, player);
                                            await window.setDoc(playerDocRef, { count: window.increment(-1) }, { merge: true });
                                        }
                                    }
                                    await window.deleteDoc(docRef);
                                    showMessage('Partita eliminata e presenze aggiornate!', 'text-green-600');
                                } catch (err) {
                                    showMessage('Errore eliminazione: ' + err, 'text-red-600');
                                }
                            }
                        });
                    });
                }

                // Listener sui pulsanti "Condividi" per singole convocazioni
                const shareButtons = historyList.querySelectorAll('.share-history-btn');
                shareButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const convocationData = JSON.parse(btn.getAttribute('data-convocation'));
                        generateHistoryShareImage(convocationData);
                    });
                });
            }

            // Function to load and display attendance summary from Firestore
            function loadAttendance(querySnapshot) {
                attendanceList.innerHTML = '';
                const attendanceData = {};
                querySnapshot.forEach(doc => {
                    attendanceData[doc.id] = doc.data().count;
                });
                
                const sortedPlayers = players.map(p => ({
                    name: p,
                    count: attendanceData[p] || 0
                })).sort((a, b) => b.count - a.count);

                sortedPlayers.forEach(player => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.count}</td>
                    `;
                    attendanceList.appendChild(row);
                });
            }

            function renderPlayers() {
                playersList.innerHTML = '';
                const playersToRender = companyPlayers.length > 0 ? companyPlayers : players;
                playersToRender.forEach(playerName => {
                    const li = document.createElement('li');
                    li.textContent = playerName;
                    li.className = 'player-item p-3 bg-white text-gray-800 rounded-lg shadow-sm border border-gray-200';
                    li.dataset.player = playerName;
                    
                    if (unavailablePlayers.has(playerName)) {
                        const status = unavailablePlayers.get(playerName);
                        if (status === 'Infortunato') {
                            li.classList.add('selected-marco-black');
                        } else if (status === 'Non disponibile Sabato' || status === 'Non disponibile Domenica') {
                            li.classList.add('selected-marco-purple');
                        } else if (status === 'Solo 2 allenamenti') {
                            li.classList.add('selected-marco-orange');
                        } else {
                            li.classList.add('selected-marco');
                        }
                    }

                    li.addEventListener('click', () => {
                        if (userRole === 'mister') {
                            if (unavailablePlayers.has(playerName)) {
                                const status = unavailablePlayers.get(playerName);
                                showUnavailablePlayerModal(playerName, status);
                                return; // Don't allow selection of unavailable players (unless forzato)
                            }
                            li.classList.toggle('selected-mister');
                            updateSelectedPlayersLiveList(playerName, li.classList.contains('selected-mister'));
                        } else if (userRole === 'marco') {
                            tempPlayerName = playerName;
                            showModal();
                        }
                    });
                    playersList.appendChild(li);
                });
            }

            function updateSelectedPlayersLiveList(playerName, isSelected) {
                const liveId = `live-${playerName.replace(/\s+/g, '-')}`;
                if (isSelected) {
                    const newLi = document.createElement('li');
                    newLi.textContent = playerName;
                    newLi.id = liveId;
                    newLi.className = "font-medium p-1";
                    selectedPlayersLiveList.appendChild(newLi);
                } else {
                    const playerToRemove = document.getElementById(liveId);
                    if (playerToRemove) {
                        playerToRemove.remove();
                    }
                }
            }

            function getSelectedPlayers() {
                if (userRole === 'mister') {
                    return Array.from(document.querySelectorAll('.player-item.selected-mister')).map(item => item.textContent);
                }
                return Array.from(unavailablePlayers.keys());
            }

            function getMatchDetails() {
                return {
                    campo: document.getElementById('campo').value || 'N/D',
                    avversario: document.getElementById('avversario').value || 'N/D',
                    data: document.getElementById('data-partita').value || 'N/D',
                    orarioConvocazione: document.getElementById('orario-convocazione').value || 'N/D',
                    orarioPartita: document.getElementById('orario-partita').value || 'N/D',
                };
            }

            function generateShareImage() {
                if (userRole !== 'mister') {
                    showMessage("Solo il Mister può condividere le convocazioni.", "text-red-600");
                    return;
                }

                const selectedPlayers = getSelectedPlayers();
                const matchDetails = getMatchDetails();
                const sharePlayersList = document.getElementById('share-players-list');
                sharePlayersList.innerHTML = '';
                document.getElementById('share-campo').textContent = matchDetails.campo;
                document.getElementById('share-avversario').textContent = matchDetails.avversario;
                
                let formattedDate = 'N/D';
                if (matchDetails.data !== 'N/D') {
                    const dateObj = new Date(matchDetails.data + 'T00:00:00'); 
                    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                    formattedDate = dateObj.toLocaleDateString('it-IT', options);
                }
                
                document.getElementById('share-data-partita').textContent = formattedDate;
                document.getElementById('share-orario-convocazione').textContent = matchDetails.orarioConvocazione;
                document.getElementById('share-orario-partita').textContent = matchDetails.orarioPartita;

                if (selectedPlayers.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = "Nessun giocatore convocato.";
                    li.className = "text-gray-500 italic text-center";
                    sharePlayersList.appendChild(li);
                } else {
                    selectedPlayers.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = player;
                        li.className = 'font-medium';
                        sharePlayersList.appendChild(li);
                    });
                }
                shareView.style.position = 'relative';
                shareView.style.top = '0';
                shareView.style.left = '0';
                html2canvas(shareView, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `convocazioni-${matchDetails.avversario}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    shareView.style.position = 'absolute';
                    shareView.style.top = '-9999px';
                    shareView.style.left = '-9999px';
                    showMessage("Immagine generata e scaricata!", "text-green-600");
                });
            }

            function generateHistoryShareImage(convocationData) {
                const sharePlayersList = document.getElementById('share-players-list');
                sharePlayersList.innerHTML = '';
                document.getElementById('share-campo').textContent = convocationData.details.campo;
                document.getElementById('share-avversario').textContent = convocationData.details.avversario;
                
                // Format match date with uppercase day of week for share image
                let formattedDate = convocationData.details.data;
                if (convocationData.details.data !== 'N/D') {
                    const matchDate = new Date(convocationData.details.data + 'T00:00:00');
                    const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                    const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                    const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                    formattedDate = `${dayOfWeek} ${dateString}`;
                }
                
                document.getElementById('share-data-partita').textContent = formattedDate;
                document.getElementById('share-orario-convocazione').textContent = convocationData.details.orarioConvocazione;
                document.getElementById('share-orario-partita').textContent = convocationData.details.orarioPartita;

                if (convocationData.players.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = "Nessun giocatore convocato.";
                    li.className = "text-gray-500 italic text-center";
                    sharePlayersList.appendChild(li);
                } else {
                    convocationData.players.forEach(player => {
                        const li = document.createElement('li');
                        li.textContent = player;
                        li.className = 'font-medium';
                        sharePlayersList.appendChild(li);
                    });
                }
                shareView.style.position = 'relative';
                shareView.style.top = '0';
                shareView.style.left = '0';
                html2canvas(shareView, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const image = canvas.toDataURL("image/png");
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `convocazioni-${convocationData.details.avversario}-${new Date(convocationData.createdAt).toLocaleDateString('it-IT')}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    shareView.style.position = 'absolute';
                    shareView.style.top = '-9999px';
                    shareView.style.left = '-9999px';
                    showMessage("Immagine storico generata e scaricata!", "text-green-600");
                });
            }

            function updateUIForRole() {
                if (userRole === 'mister') {
                    selectedPlayersTitle.textContent = "Giocatori Convocati";
                    playersListMessage.textContent = "Clicca sui nomi per selezionare i convocati.";
                    roleMessage.textContent = "Ciao Mister!! Qui puoi creare e salvare le convocazioni.";
                    roleMessage.classList.remove('hidden');
                    saveButton.textContent = "Salva Convocazione";
                    shareButton.disabled = false;
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    shareButton.classList.replace('bg-gray-400', 'bg-blue-600');
                    historyButton.classList.replace('bg-gray-400', 'bg-gray-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    unavailablePlayersView.classList.remove('hidden');
                    unavailablePlayersView.style.display = ''; // Show for Mister
                    unavailablePlayersTitle.textContent = "Giocatori Non Disponibili (Segnalati dal Dirigente)";
                    matchDetailsSection.classList.remove('hidden');
                    matchDetailsSection.style.display = ''; // Show match details for Mister

                    // Show notes section for Mister (readonly)
                    notesSection.classList.remove('hidden');
                    notesEditable.classList.add('hidden');
                    notesReadonly.classList.remove('hidden');

                } else if (userRole === 'marco') {
                    selectedPlayersTitle.textContent = "";
                    playersListMessage.textContent = "Clicca sui nomi per segnalare l'indisponibilità.";
                    roleMessage.textContent = "Sei entrato come Dirigente. Puoi segnare e salvare i giocatori non disponibili.";
                    roleMessage.classList.remove('hidden');
                    saveButton.textContent = "Salva Indisponibilità";
                    shareButton.disabled = true;
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    shareButton.classList.replace('bg-blue-600', 'bg-gray-400');
                    historyButton.classList.replace('bg-gray-400', 'bg-gray-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    unavailablePlayersView.classList.remove('hidden');
                    unavailablePlayersView.style.display = ''; // Show unavailable players view for Marco
                    matchDetailsSection.classList.add('hidden');
                    matchDetailsSection.style.display = 'none'; // Hide match details for Marco
                    unavailablePlayersTitle.textContent = "Giocatori che hai segnato come non disponibili";

                    // Show notes section for Marco (editable)
                    notesSection.classList.remove('hidden');
                    notesEditable.classList.remove('hidden');
                    notesReadonly.classList.add('hidden');
                }
                
                updateNotesDisplay();
            }

            function updateUnavailablePlayersView() {
                unavailablePlayersList.innerHTML = '';
                if (unavailablePlayers.size === 0) {
                    unavailablePlayersList.innerHTML = '<li class="text-sm italic text-red-500">Nessun giocatore segnalato.</li>';
                    return;
                }
                unavailablePlayers.forEach((status, player) => {
                    const li = document.createElement('li');
                    li.textContent = `${player}: ${status}`;
                    li.className = 'font-medium';
                    unavailablePlayersList.appendChild(li);
                });
            }

            function updateNotesDisplay() {
                if (userRole === 'marco') {
                    notesTextarea.value = currentNotes;
                } else if (userRole === 'mister') {
                    if (currentNotes.trim() === '') {
                        notesDisplay.innerHTML = '<span class="text-gray-500 italic">Nessuna nota disponibile</span>';
                    } else {
                        notesDisplay.textContent = currentNotes;
                    }
                }
            }

            async function saveNotes() {
                if (!window.db || !window.auth.currentUser) {
                    showMessage("Errore: Firebase non è ancora pronto. Riprova tra un attimo.", "text-red-600");
                    return;
                }

                if (userRole !== 'marco') {
                    showMessage("Solo Marco può modificare le note.", "text-red-600");
                    return;
                }

                const notesContent = notesTextarea.value.trim();
                const basePath = currentCompanyCode ? `companies/${currentCompanyCode}/data` : `artifacts/${currentAppId}/public/data`;
                const notesDocRef = window.doc(window.db, `${basePath}/notes`, "marco_notes");
                
                try {
                    await window.setDoc(notesDocRef, { content: notesContent });
                    showSuccessPopup("Note salvate con successo!");
                } catch (e) {
                    console.error("Errore salvataggio note su Firestore: ", e);
                    showMessage("Errore durante il salvataggio delle note. Controlla la console.", "text-red-600");
                }
            }

            function showMessage(msg, colorClass) {
                messageArea.textContent = msg;
                messageArea.className = `mt-4 text-center text-sm font-medium ${colorClass}`;
                messageArea.style.display = 'block';
                setTimeout(() => {
                    messageArea.style.display = 'none';
                }, 5000);
            }

            function showSuccessPopup(message = "Salvataggio effettuato con successo") {
                const popup = document.getElementById('success-popup');
                const messageElement = document.getElementById('success-popup-message');
                
                messageElement.textContent = message;
                popup.classList.remove('hidden');
                
                // Auto-close after 3 seconds
                setTimeout(() => {
                    popup.classList.add('hidden');
                }, 3000);
            }

            function startApp(appId) {
                currentAppId = appId;
                
                appIdDisplay.textContent = currentAppId;
                currentAppIdDisplay.textContent = currentAppId;

                startScreen.classList.add('hidden');
                mainView.classList.remove('hidden');

                setupFirestoreListeners(currentAppId);
                renderPlayers();
                updateUIForRole();
            }

            function forgetDataAndReset() {
                localStorage.removeItem('convocazioniAppId');
                localStorage.removeItem('userRole');
                localStorage.removeItem('joinAppId');
                localStorage.removeItem('companyCode');
                localStorage.removeItem('companyData');
                window.location.reload(); 
            }

            // --- Company Navigation Functions ---
            function showCompanyWelcome() {
                hideAllScreens();
                companyNameDisplay.textContent = currentCompanyData.name;
                companyWelcomeScreen.classList.remove('hidden');
            }

            function showPasswordEntry(role) {
                hideAllScreens();
                pendingRole = role;
                rolePrompt.textContent = `Inserisci la password per ${role === 'mister' ? 'Mister' : 'Dirigente'}:`;
                passwordInput.value = '';
                passwordEntryScreen.classList.remove('hidden');
                passwordInput.focus();
            }

            function showPlayerManagement() {
                hideAllScreens();
                playerManagementScreen.classList.remove('hidden');
                renderCompanyPlayers();
                updateSavePlayersButtonState();
            }

            function hideAllScreens() {
                companyEntryScreen.classList.add('hidden');
                companyWelcomeScreen.classList.add('hidden');
                passwordEntryScreen.classList.add('hidden');
                playerManagementScreen.classList.add('hidden');
                nameEntryScreen.classList.add('hidden');
                startScreen.classList.add('hidden');
                mainView.classList.add('hidden');
                historyView.classList.add('hidden');
                attendanceView.classList.add('hidden');
            }

            function startApp(appId) {
                currentAppId = appId;
                
                appIdDisplay.textContent = currentAppId;
                currentAppIdDisplay.textContent = currentAppId;

                hideAllScreens();
                mainView.classList.remove('hidden');

                setupFirestoreListeners(currentAppId);
                renderPlayers();
                updateUIForRole();
            }

            function renderCompanyPlayers() {
                companyPlayersList.innerHTML = '';
                
                companyPlayers.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex items-center justify-between p-2 bg-white border border-gray-300 rounded-lg';
                    playerDiv.innerHTML = `
                        <span class="text-gray-700">${player}</span>
                        <button onclick="removePlayer(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                            Rimuovi
                        </button>
                    `;
                    companyPlayersList.appendChild(playerDiv);
                });
                
                updateSavePlayersButtonState();
            }

            function updateSavePlayersButtonState() {
                // Enable the button only if there are players to save
                const hasPlayers = companyPlayers.length > 0;
                savePlayersButton.disabled = !hasPlayers;
                
                if (hasPlayers) {
                    savePlayersButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                } else {
                    savePlayersButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                }
            }

            window.removePlayer = async function(index) {
                companyPlayers.splice(index, 1);
                renderCompanyPlayers();
                showMessage("Giocatore rimosso dalla lista. Ricorda di salvare!", "text-blue-600");
            };

            function showMessage(message, className) {
                messageArea.textContent = message;
                messageArea.className = `mt-4 text-center text-sm font-medium ${className}`;
                messageArea.classList.remove('hidden');
                setTimeout(() => {
                    messageArea.classList.add('hidden');
                }, 5000);
            }

            function showSavePlayersMessage(message, className) {
                savePlayersMessageArea.textContent = message;
                savePlayersMessageArea.className = `mt-2 mb-4 text-center text-sm font-medium ${className}`;
                savePlayersMessageArea.classList.remove('hidden');
                setTimeout(() => {
                    savePlayersMessageArea.classList.add('hidden');
                }, 5000);
            }

            // --- Modal Functions ---
            function showModal() {
                statusModal.classList.remove('hidden', 'opacity-0');
                statusModal.classList.add('flex', 'opacity-100');
            }

            function hideModal() {
                statusModal.classList.remove('flex', 'opacity-100');
                statusModal.classList.add('hidden', 'opacity-0');
            }

            function showUnavailablePlayerModal(playerName, reason) {
                unavailablePlayerName.textContent = playerName;
                unavailablePlayerReason.textContent = reason;
                unavailablePlayerModal.classList.remove('hidden', 'opacity-0');
                unavailablePlayerModal.classList.add('flex', 'opacity-100');
                tempUnavailablePlayerName = playerName; // salva il nome per il "convoca comunque"
            }

            function hideUnavailablePlayerModal() {
                unavailablePlayerModal.classList.remove('flex', 'opacity-100');
                unavailablePlayerModal.classList.add('hidden', 'opacity-0');
                tempUnavailablePlayerName = null;
            }

            // Event listeners for new company-based navigation
            verifyCompanyButton.addEventListener('click', async () => {
                const companyCode = companyCodeInput.value.trim();
                if (!companyCode) {
                    companyEntryMessageArea.textContent = "Inserisci un codice società.";
                    companyEntryMessageArea.classList.remove('hidden');
                    companyEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                    return;
                }

                try {
                    const companyData = await verifyCompanyCode(companyCode);
                    if (companyData) {
                        currentCompanyCode = companyCode;
                        currentCompanyData = companyData;
                        
                        // Populate passwords from data.config if available
                        if (currentCompanyData.data && currentCompanyData.data.config) {
                            currentCompanyData.passwords = {
                                ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                dirigente: currentCompanyData.data.config.dirigentePassword,
                                mister: currentCompanyData.data.config.misterPassword
                            };
                        }
                        
                        window.currentCompanyData = currentCompanyData;
                        companyPlayers = await loadCompanyPlayers();
                        
                        if (rememberCompanyCheckbox.checked) {
                            localStorage.setItem('companyCode', companyCode);
                            localStorage.setItem('companyData', JSON.stringify(companyData));
                        }
                        
                        // Hide any error messages
                        companyEntryMessageArea.classList.add('hidden');
                        companyEntryMessageArea.classList.remove('text-red-600');
                        
                        showCompanyWelcome();
                    } else {
                        companyEntryMessageArea.textContent = "Codice società non valido.";
                        companyEntryMessageArea.classList.remove('hidden');
                        companyEntryMessageArea.classList.add('text-red-600');
                        setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                    }
                } catch (error) {
                    companyEntryMessageArea.textContent = "Errore nella verifica. Riprova.";
                    companyEntryMessageArea.classList.remove('hidden');
                    companyEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                }
            });

            enterMisterButton.addEventListener('click', () => {
                showPasswordEntry('mister');
            });

            enterDirigenteButton.addEventListener('click', () => {
                showPasswordEntry('dirigente');
            });

            viewHistoryButton.addEventListener('click', () => {
                // Use company-specific app ID or create one
                const companyAppId = currentCompanyCode;
                currentAppId = companyAppId;
                hideAllScreens();
                historyView.classList.remove('hidden');
                setupFirestoreListeners(companyAppId);
            });

            managePlayersButton.addEventListener('click', () => {
                showPlayerManagement();
            });

            companyLogoutButton.addEventListener('click', () => {
                localStorage.removeItem('userRole');
                localStorage.removeItem('convocazioniAppId');
                currentCompanyCode = null;
                currentCompanyData = null;
                window.currentCompanyData = currentCompanyData;
                companyPlayers = [];
                userRole = null;
                showCompanyWelcome();
            });

            confirmPasswordButton.addEventListener('click', async () => {
                const password = passwordInput.value.trim();
                if (!password) {
                    passwordEntryMessageArea.textContent = "Inserisci la password.";
                    passwordEntryMessageArea.classList.remove('hidden');
                    passwordEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => passwordEntryMessageArea.classList.add('hidden'), 5000);
                    return;
                }

                const isValid = await verifyPassword(pendingRole, password);
                if (isValid) {
                    userRole = pendingRole;
                    localStorage.setItem('userRole', userRole);
                    
                    // Use company code as app ID
                    const companyAppId = currentCompanyCode;
                    localStorage.setItem('convocazioniAppId', companyAppId);
                    startApp(companyAppId);
                } else {
                    passwordEntryMessageArea.textContent = "Password errata.";
                    passwordEntryMessageArea.classList.remove('hidden');
                    passwordEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => passwordEntryMessageArea.classList.add('hidden'), 5000);
                }
            });

            cancelPasswordButton.addEventListener('click', () => {
                pendingRole = null;
                passwordInput.value = '';
                showCompanyWelcome();
            });

            addPlayerButton.addEventListener('click', async () => {
                const playerName = newPlayerInput.value.trim();
                if (!playerName) {
                    showMessage("Inserisci il nome del giocatore.", "text-red-600");
                    return;
                }

                if (companyPlayers.includes(playerName)) {
                    showMessage("Giocatore già presente nella lista.", "text-red-600");
                    return;
                }

                companyPlayers.push(playerName);
                newPlayerInput.value = '';
                renderCompanyPlayers();
                showMessage("Giocatore aggiunto alla lista. Ricorda di salvare!", "text-blue-600");
            });

            savePlayersButton.addEventListener('click', async () => {
                if (companyPlayers.length === 0) {
                    showSavePlayersMessage("Nessun giocatore da salvare.", "text-orange-600");
                    return;
                }

                savePlayersButton.disabled = true;
                savePlayersButton.textContent = "Salvataggio in corso...";
                
                try {
                    await saveCompanyPlayers(companyPlayers);
                    showSavePlayersMessage("Giocatori salvati con successo!", "text-green-600");
                } catch (error) {
                    console.error("Errore nel salvataggio:", error);
                    showSavePlayersMessage("Errore nel salvataggio dei giocatori.", "text-red-600");
                } finally {
                    savePlayersButton.disabled = false;
                    savePlayersButton.textContent = "Salva Giocatori";
                    updateSavePlayersButtonState();
                }
            });

            backFromPlayersButton.addEventListener('click', () => {
                showCompanyWelcome();
            });

            // Event listeners for view switching
            enterButton.addEventListener('click', () => {
                const name = nameInput.value.trim().toLowerCase();
                if (name === 'mister' || name === 'marco') {
                    userRole = name;
                    
                    if (rememberMeCheckbox.checked) {
                        localStorage.setItem('userRole', userRole);
                    } else {
                        localStorage.removeItem('userRole');
                    }
                    
                    nameEntryScreen.classList.add('hidden');
                    const savedAppId = localStorage.getItem('convocazioniAppId');
                    if (savedAppId) {
                         startApp(savedAppId);
                    } else {
                         startScreen.classList.remove('hidden');
                    }
                } else {
                    nameEntryMessageArea.textContent = "Nome non valido.";
                    nameEntryMessageArea.classList.remove('hidden');
                    nameEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => {
                        nameEntryMessageArea.classList.add('hidden');
                    }, 5000);
                }
            });
            
            const savedJoinAppId = localStorage.getItem('joinAppId');
            if (savedJoinAppId) {
                joinAppIdInput.value = savedJoinAppId;
                rememberTeamIdCheckbox.checked = true;
            }

            createTeamButton.addEventListener('click', () => {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('convocazioniAppId', window.appId);
                } else {
                    localStorage.removeItem('convocazioniAppId');
                }
                startApp(window.appId);
            });

            joinTeamButton.addEventListener('click', () => {
                const joinedId = joinAppIdInput.value.trim();
                if (joinedId.length > 0) {
                     if (rememberTeamIdCheckbox.checked) {
                        localStorage.setItem('joinAppId', joinedId);
                    } else {
                        localStorage.removeItem('joinAppId');
                    }
                     if (rememberMeCheckbox.checked) {
                        localStorage.setItem('convocazioniAppId', joinedId);
                    } else {
                        localStorage.removeItem('convocazioniAppId');
                    }
                    startApp(joinedId);
                } else {
                    startMessageArea.textContent = "Per favore, inserisci un ID app valido.";
                    startMessageArea.classList.remove('hidden');
                    startMessageArea.classList.add('text-red-600');
                    setTimeout(() => {
                        startMessageArea.classList.add('hidden');
                    }, 5000);
                }
            });

            forgetDataButton.addEventListener('click', forgetDataAndReset);
            changeTeamButton.addEventListener('click', forgetDataAndReset);
            
            saveButton.addEventListener('click', saveData);
            shareButton.addEventListener('click', generateShareImage);
            historyButton.addEventListener('click', () => {
                mainView.classList.add('hidden');
                historyView.classList.remove('hidden');
                attendanceView.classList.add('hidden');
            });
            attendanceButton.addEventListener('click', () => {
                mainView.classList.add('hidden');
                historyView.classList.add('hidden');
                attendanceView.classList.remove('hidden');
            });
            backFromHistoryButton.addEventListener('click', () => {
                historyView.classList.add('hidden');
                mainView.classList.remove('hidden');
            });
            backFromAttendanceButton.addEventListener('click', () => {
                attendanceView.classList.add('hidden');
                mainView.classList.remove('hidden');
            });

            closeModalButton.addEventListener('click', hideModal);
            closeUnavailableModalButton.addEventListener('click', hideUnavailablePlayerModal);
            saveNotesButton.addEventListener('click', saveNotes);

            // Close modals when clicking outside of them
            statusModal.addEventListener('click', (e) => {
                if (e.target === statusModal) {
                    hideModal();
                }
            });

            unavailablePlayerModal.addEventListener('click', (e) => {
                if (e.target === unavailablePlayerModal) {
                    hideUnavailablePlayerModal();
                }
            });

            // PATCH: gestione status per Marco, incluso "Disponibile"
            statusButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const status = event.target.dataset.status;
                    const currentPlayerItem = document.querySelector(`.player-item[data-player="${tempPlayerName}"]`);
                    
                    if (status === 'Disponibile') {
                        unavailablePlayers.delete(tempPlayerName);
                        currentPlayerItem.classList.remove('selected-marco', 'selected-marco-orange', 'selected-marco-black', 'selected-marco-purple');
                    } else {
                        unavailablePlayers.set(tempPlayerName, status);
                        currentPlayerItem.classList.remove('selected-marco', 'selected-marco-orange', 'selected-marco-black', 'selected-marco-purple');
                        if (status === 'Infortunato') {
                            currentPlayerItem.classList.add('selected-marco-black');
                        } else if (status === 'Non disponibile Sabato' || status === 'Non disponibile Domenica') {
                            currentPlayerItem.classList.add('selected-marco-purple');
                        } else if (status === 'Solo 2 allenamenti') {
                            currentPlayerItem.classList.add('selected-marco-orange');
                        } else {
                            currentPlayerItem.classList.add('selected-marco');
                        }
                    }
                    
                    updateUnavailablePlayersView();
                    hideModal();
                    tempPlayerName = null;
                });
            });

            // *** MODIFICA: Gestione pulsante "Convoca ugualmente" ***
            convocaComunqueButton.addEventListener('click', () => {
                // Seleziona il giocatore come convocato anche se non disponibile
                if (typeof tempUnavailablePlayerName === 'string' && tempUnavailablePlayerName.length > 0) {
                    const playerItem = document.querySelector(`.player-item[data-player="${tempUnavailablePlayerName}"]`);
                    if (playerItem) {
                        playerItem.classList.add('selected-mister');
                        updateSelectedPlayersLiveList(tempUnavailablePlayerName, true);
                    }
                }
                hideUnavailablePlayerModal();
            });

            function copyAppId() {
                const tempInput = document.createElement('textarea');
                tempInput.value = appIdDisplay.textContent;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    const success = document.execCommand('copy');
                    if (success) {
                        const originalText = appIdDisplay.textContent;
                        appIdDisplay.textContent = 'Copiato!';
                        setTimeout(() => {
                            appIdDisplay.textContent = originalText;
                        }, 1000);
                    } else {
                        console.error('Errore nella copia: document.execCommand("copy") failed.');
                        showMessage("Impossibile copiare. Il browser non lo supporta.", "text-red-600");
                    }
                } catch (err) {
                    console.error('Errore nella copia: ', err);
                    showMessage("Errore durante la copia. Controlla la console.", "text-red-600");
                } finally {
                    document.body.removeChild(tempInput);
                }
            }
            window.copyAppId = copyAppId;
        });
    </script>
</body>
</html>











