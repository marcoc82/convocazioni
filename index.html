<!DOCTYPE html>
<!-- Version: 2024-01-22 - V5.9: Improved distinta PDF quality with sans-serif font, increased spacing and readability for print -->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rosterkick</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="192x192" href="favicon-192x192.png">
    <meta name="msapplication-TileImage" content="favicon-192x192.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- CONFIGURAZIONE FIREBASE -->
    <script type="module">
  import { cercaSocietaDaCodice } from './cercaSocietaDaCodice.js';
  window.cercaSocietaDaCodice = cercaSocietaDaCodice;
</script>
    <!-- debug -->
    <script>
    window.__firebase_config = JSON.stringify({
      apiKey: "AIzaSyD87fLjZfQO1gDOzqJZAdvlqSthBYN3XSU",
      authDomain: "polis-2013.firebaseapp.com",
      projectId: "polis-2013",
      storageBucket: "polis-2013.appspot.com",
      messagingSenderId: "607738543737",
      appId: "1:607738543737:web:9b108502b8f1b61ef4dea8",
      measurementId: "G-94FT2YQNBM"
    });
    </script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc, increment, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Espone le funzioni Firebase Auth globalmente per evitare ReferenceError
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getAuth = getAuth;

        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app, db, auth;
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.onSnapshot = onSnapshot;
            window.collection = collection;
            window.addDoc = addDoc;
            window.updateDoc = updateDoc;
            window.doc = doc;
            window.getDoc = getDoc;
            window.setDoc = setDoc;
            window.increment = increment;
            window.deleteDoc = deleteDoc;
            window.getDocs = getDocs;
        } else {
            console.error("Firebase configuration not available. Some features will not work.");
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .player-item {
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s ease-in-out, background-color 0.2s;
        }
        .player-item.selected-mister {
            background-color: #d1e5f4;
            color: #1e40af;
            font-weight: bold;
            border-color: #3b82f6;
        }
        .player-item.selected-marco {
            background-color: #fecaca;
            color: #b91c1c;
            font-weight: bold;
            border-color: #ef4444;
        }
        .player-item.selected-marco-orange {
            background-color: #fed7aa;
            color: #ea580c;
            font-weight: bold;
            border-color: #f97316;
        }
        .player-item.selected-marco-black {
            background-color: #1f2937;
            color: #ffffff;
            font-weight: bold;
            border-color: #374151;
        }
        .player-item.selected-marco-purple {
            background-color: #8b5cf6;
            color: #ffffff;
            font-weight: bold;
            border-color: #7c3aed;
        }
        .player-item.already-called-today {
            background-color: #d1d5db;
            color: #6b7280;
            font-weight: normal;
            border-color: #9ca3af;
        }
        .player-item:hover:not(.selected-mister):not(.selected-marco):not(.selected-marco-orange):not(.selected-marco-black):not(.selected-marco-purple):not(.already-called-today) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .player-item.already-called-today:hover {
            background-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Login Animations */
        @keyframes dropBounce {
            0% {
                transform: translateY(-100px);
                opacity: 0;
            }
            50% {
                transform: translateY(10px);
                opacity: 1;
            }
            65% {
                transform: translateY(-5px);
            }
            80% {
                transform: translateY(2px);
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            0% {
                transform: translateX(50px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInLeft {
            0% {
                transform: translateX(-50px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animate-drop-bounce {
            animation: dropBounce 1.2s ease-out forwards;
        }
        
        .animate-slide-in-right {
            animation: slideInRight 0.8s ease-out forwards;
        }
        
        .animate-slide-in-left {
            animation: slideInLeft 0.8s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center justify-center">

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-2xl">
        
        <!-- Company Code Entry Screen -->
        <div id="company-entry-screen" class="hidden">
            <!-- Animated Logo - larger and positioned above title -->
            <div class="flex justify-center mb-6">
                <img id="animated-logo" src="logo Rosterkick.png" alt="Rosterkick Logo" class="w-32 h-32 object-contain opacity-0 transform translate-y-[-100px]">
            </div>
            <!-- Animated Title -->
            <h1 id="animated-title" class="text-4xl font-bold text-gray-800 text-center mb-2 opacity-0 transform translate-x-full">Rosterkick</h1>
            <!-- Animated Subtitle -->
            <h2 id="animated-subtitle" class="text-xl font-semibold text-center text-gray-700 mb-6 opacity-0 transform translate-x-full">Inserisci il codice società</h2>
            <!-- Animated Form -->
            <div id="animated-form" class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200 opacity-0 transform translate-x-[-50px]">
                <div class="flex flex-col gap-4">
                    <input type="text" id="company-code-input" placeholder="Codice società o codice ospite" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-company" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-company" class="text-gray-700">Ricorda codice</label>
                    </div>
                    <button id="verify-company-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Verifica
                    </button>
                </div>
            </div>
            <div id="company-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
            
            <!-- Application Version - Only visible on login screen -->
            <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                <span class="text-sm font-semibold text-gray-500 bg-gray-100 px-3 py-1 rounded-full">V 5.9</span>
            </div>
        </div>

        <!-- Company Welcome Screen -->
        <div id="company-welcome-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Benvenuto</h2>
            <!-- Guest Role Indicator -->
            <div id="guest-role-indicator" class="mb-4 p-3 bg-yellow-100 border border-yellow-200 rounded-lg text-yellow-800 text-sm font-medium text-center hidden">
                👤 Accesso Ospite - Funzionalità Limitate
            </div>
            <div class="p-6 bg-blue-50 rounded-xl mb-6 shadow-sm border border-blue-200 text-center">
                <h3 id="company-name-display" class="text-lg font-bold text-blue-800 mb-2"></h3>
                <div id="company-details" class="text-sm text-blue-600 mb-4 hidden">
                    <div>ID: <span id="company-document-id" class="font-mono bg-blue-100 px-2 py-1 rounded"></span></div>
                    <div>Codice: <span id="company-code-display" class="font-mono bg-blue-100 px-2 py-1 rounded"></span></div>
                </div>
                <!-- Normal login buttons (hidden for guests) -->
                <div id="normal-login-buttons" class="grid grid-cols-1 gap-3 mb-4">
                    <button id="enter-mister-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra come Mister
                    </button>
                    <button id="enter-dirigente-button" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra come Dirigente
                    </button>
                </div>
                <!-- Guest buttons (shown for both normal and guest users, but restricted for guests) -->
                <div id="guest-allowed-buttons" class="grid grid-cols-1 gap-3 mb-4">
                    <button id="view-history-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Storico Convocazioni
                    </button>
                    <button id="welcome-attendance-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Riepilogo Convocazioni
                    </button>
                    <button id="training-attendance-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                        Presenze Allenamenti
                    </button>
                </div>
                <!-- Campionato button (shown for POLIS PIEVE 2010 regardless of login type) -->
                <div id="campionato-container" class="grid grid-cols-1 gap-3">
                    <button id="campionato-button" class="w-full bg-purple-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                        ⚽ Campionato
                    </button>
                </div>
                <!-- Admin buttons (hidden for guests) -->
                <div id="admin-buttons" class="grid grid-cols-1 gap-3">
                    <button id="manage-players-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Gestione Squadra
                    </button>
                </div>
                <button id="company-logout-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mt-3">
                    Logout
                </button>
            </div>
        </div>

        <!-- Password Entry Screen -->
        <div id="password-entry-screen" class="hidden">
            <div class="flex justify-center mb-4">
                <img src="logo Rosterkick.png" alt="Rosterkick Logo" class="w-20 h-20 object-contain">
            </div>
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Inserisci la password</h2>
            <form id="password-form" class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4">
                    <p id="role-prompt" class="text-center text-gray-600"></p>
                    <input type="text" id="username-input" autocomplete="username" style="display: none;" aria-hidden="true">
                    <input type="password" id="password-input" placeholder="Password" autocomplete="current-password" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex gap-2">
                        <button type="submit" id="confirm-password-button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                            Conferma
                        </button>
                        <button type="button" id="cancel-password-button" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                            Annulla
                        </button>
                    </div>
                </div>
            </form>
            <div id="password-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Player Management Screen -->
        <div id="player-management-screen" class="hidden">
            <button id="top-back-from-players-button" class="w-full mb-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Gestione Squadra</h2>
            
            <!-- Team Category Section -->
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Categoria Squadra</h3>
                <div class="mb-4">
                    <label for="team-categoria" class="block text-sm font-medium text-gray-700">🏆 Categoria</label>
                    <input type="text" id="team-categoria" placeholder="Inserisci categoria (es. Juniores, Senior, etc.)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
            </div>

            <!-- Company Information Section -->
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Informazioni Società</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="company-ragione-sociale" class="block text-sm font-medium text-gray-700">🏢 Ragione Sociale</label>
                        <input type="text" id="company-ragione-sociale" placeholder="Nome completo della società" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="company-indirizzo" class="block text-sm font-medium text-gray-700">📍 Indirizzo</label>
                        <input type="text" id="company-indirizzo" placeholder="Via, Città, CAP" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="company-telefono" class="block text-sm font-medium text-gray-700">📞 Telefono</label>
                        <input type="tel" id="company-telefono" placeholder="+39 123 456 7890" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="company-mail" class="block text-sm font-medium text-gray-700">📧 Email</label>
                        <input type="email" id="company-mail" placeholder="info@societa.it" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="company-partita-iva" class="block text-sm font-medium text-gray-700">🆔 Partita IVA</label>
                        <input type="text" id="company-partita-iva" placeholder="IT12345678901" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                </div>
                <button id="save-company-info-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mb-4">
                    Salva Informazioni Società
                </button>
                <div id="save-company-message-area" class="mt-2 mb-4 text-center text-sm font-medium text-gray-600 hidden"></div>
            </div>

            <!-- Player Management Section -->
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Gestione Giocatori</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="player-numero" class="block text-sm font-medium text-gray-700">🔢 Numero</label>
                        <input type="number" id="player-numero" placeholder="10" min="1" max="99" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="player-nome" class="block text-sm font-medium text-gray-700">👤 Nome</label>
                        <input type="text" id="player-nome" placeholder="ROSSI MARIO" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="player-data-nascita" class="block text-sm font-medium text-gray-700">📅 Data di Nascita</label>
                        <input type="date" id="player-data-nascita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="player-matricola" class="block text-sm font-medium text-gray-700">🆔 Matricola</label>
                        <input type="text" id="player-matricola" placeholder="ABC123456" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                </div>
                <button id="add-player-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mb-4">
                    Aggiungi Giocatore
                </button>
                <div id="company-players-list" class="space-y-2">
                    <!-- Company players will be loaded here -->
                </div>
            </div>
            <button id="save-players-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 mb-4 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Salva Giocatori
            </button>
            <div id="save-players-message-area" class="mt-2 mb-4 text-center text-sm font-medium text-gray-600 hidden"></div>
            
            <!-- Coach Management Section -->
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Gestione Mister</h3>
                <div class="flex flex-col gap-4 mb-4">
                    <input type="text" id="new-coach-input" placeholder="Nome mister" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <input type="text" id="new-coach-matricola-input" placeholder="Matricola mister" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="add-coach-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Aggiungi Mister
                    </button>
                </div>
                <div id="company-coaches-list" class="space-y-2 mb-4">
                    <!-- Company coaches will be loaded here -->
                </div>
                <button id="save-coaches-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Salva Mister
                </button>
                <div id="save-coaches-message-area" class="mt-2 text-center text-sm font-medium text-gray-600 hidden"></div>
            </div>
            
            <!-- Directors Management Section -->
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Gestione Dirigenti</h3>
                <div class="flex flex-col gap-4 mb-4">
                    <input type="text" id="new-director-name-input" placeholder="Nome dirigente" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <input type="text" id="new-director-surname-input" placeholder="Cognome dirigente" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <input type="text" id="new-director-matricola-input" placeholder="Matricola dirigente" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="add-director-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Aggiungi Dirigente
                    </button>
                </div>
                <div id="company-directors-list" class="space-y-2 mb-4">
                    <!-- Company directors will be loaded here -->
                </div>
                <button id="save-directors-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Salva Dirigenti
                </button>
                <div id="save-directors-message-area" class="mt-2 text-center text-sm font-medium text-gray-600 hidden"></div>
            </div>
            
            <button id="back-from-players-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- Name Entry Screen (deprecated, keeping for compatibility) -->
        <div id="name-entry-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Inserisci il tuo nome</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <div class="flex flex-col gap-4">
                    <input type="text" id="name-input" placeholder="" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="remember-me" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-me" class="text-gray-700">Ricordami</label>
                    </div>
                    <button id="enter-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra
                    </button>
                </div>
            </div>
            <div id="name-entry-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Start Screen View -->
        <div id="start-screen" class="hidden">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-6">Seleziona una squadra</h2>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200 text-center">
                <p class="text-gray-600 mb-2">ID App attuale (il tuo ID):</p>
                <div class="flex flex-col items-center">
                    <span id="app-id-display" class="font-bold text-lg text-blue-600 mb-4 cursor-pointer" onclick="copyAppId()"></span>
                    <button id="create-team-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Entra
                    </button>
                </div>
            </div>
            <div class="p-6 bg-gray-50 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Partecipa a una squadra esistente</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="join-app-id-input" placeholder="Incolla l'ID app qui" class="flex-grow px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    <button id="join-team-button" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Partecipa
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-2">
                        <input type="checkbox" id="remember-team-id" class="rounded text-blue-500 focus:ring-blue-500">
                        <label for="remember-team-id" class="text-gray-700">Ricorda ID squadra</label>
                </div>
            </div>
            <button id="forget-data-button" class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Dimentica i dati salvati
            </button>
            <div id="start-message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Main Form View -->
        <div id="main-view" class="hidden">
            <!-- App Info Section -->
            <div class="bg-gray-50 p-4 rounded-xl mb-6 shadow-sm border border-gray-200">
                <p class="text-gray-600 mb-2">ID Squadra attuale:</p>
                <div class="flex flex-col items-center">
                    <span id="current-app-id-display" class="font-bold text-lg text-blue-600 mb-4 cursor-pointer" onclick="copyAppId()"></span>
                    <button id="change-team-button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                        Esci
                    </button>
                    <button id="reset-selections-button" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                        RESET
                    </button>
                </div>
            </div>

            <div id="role-message" class="mt-4 p-3 bg-blue-100 border border-blue-200 rounded-lg text-blue-800 text-sm font-medium hidden"></div>

            <!-- Notes section (editable by dirigente/marco, viewable by mister) -->
            <div id="notes-section" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Note (Segnate dal Dirigente)</h3>
                <div id="notes-editable" class="hidden">
                    <textarea id="notes-textarea" placeholder="Inserisci le tue note qui..." class="w-full p-3 border border-yellow-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-yellow-500" rows="3"></textarea>
                    <button id="save-notes-button" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                        Salva Note
                    </button>
                </div>
                <div id="notes-readonly" class="hidden">
                    <div id="notes-display" class="p-3 bg-white border border-yellow-300 rounded-lg min-h-[80px] text-gray-700"></div>
                </div>
            </div>

            <!-- View of unavailable players (visible to both Mister and Marco) -->
            <div id="unavailable-players-view" class="bg-red-100 p-4 rounded-xl mb-6 shadow-sm border border-red-200 hidden">
                <h2 id="unavailable-players-title" class="text-lg font-semibold text-red-700 mb-2">Giocatori Non Disponibili (Segnalati dal Dirigente)</h2>
                <ul id="unavailable-players-list" class="space-y-1 text-red-600">
                    <!-- Non-available players will be listed here -->
                </ul>
            </div>
            
            <!-- Match Details Section -->
            <div id="match-details-section" class="bg-gray-50 p-4 rounded-xl mb-6 shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Dettagli Partita</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="campo" class="block text-sm font-medium text-gray-700">🏟️ Campo</label>
                        <input type="text" id="campo" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="avversario" class="block text-sm font-medium text-gray-700">🆚 Avversario</label>
                        <input type="text" id="avversario" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="data-partita" class="block text-sm font-medium text-gray-700">📅 Data Partita</label>
                        <input type="date" id="data-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="orario-convocazione" class="block text-sm font-medium text-gray-700">🕒 Orario Convocazione</label>
                        <input type="time" id="orario-convocazione" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="orario-partita" class="block text-sm font-medium text-gray-700">🕒 Orario Partita</label>
                        <input type="time" id="orario-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tipo-partita" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipo-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="">Seleziona tipo</option>
                            <option value="Amichevole">🤝 Amichevole</option>
                            <option value="Torneo">🏆 Torneo</option>
                            <option value="Campionato">⚽️ Campionato</option>
                        </select>
                    </div>
                    <div id="mister-selection-1" class="hidden">
                        <label for="mister-partita" class="block text-sm font-medium text-gray-700">👤 Mister</label>
                        <select id="mister-partita" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="">Seleziona mister</option>
                        </select>
                    </div>
                    <div id="mister-selection-2" class="hidden">
                        <label for="mister-tipo" class="block text-sm font-medium text-gray-700">👤 Mister</label>
                        <select id="mister-tipo" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500">
                            <option value="">Seleziona mister</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Players List Section -->
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Lista Giocatori</h2>
            <p class="text-sm text-gray-500 mb-4" id="players-list-message">Clicca sui nomi per selezionare i convocati.</p>
            <div id="players-list-container" class="bg-gray-50 rounded-xl p-4 mb-6 shadow-sm border border-gray-200">
                <ul id="players-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    <!-- Player items will be inserted here by JavaScript -->
                </ul>
            </div>
            
            <!-- Live Selected Players List -->
            <div id="selected-players-container" class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-200">
                <h2 id="selected-players-title" class="text-lg font-semibold text-gray-700 mb-2">Giocatori Convocati</h2>
                <ul id="selected-players-live-list" class="space-y-2 text-gray-600">
                    <!-- Selected players will appear here in real-time -->
                </ul>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                    Salva
                </button>
                <button id="share-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                    Condividi le convocazioni
                </button>
            </div>
            <button id="history-button" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Storico Convocazioni
            </button>
            <button id="attendance-button" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Riepilogo Convocazioni
            </button>
            <button id="esci-button" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 hidden">
                ESCI
            </button>
            <div id="message-area" class="mt-4 text-center text-sm font-medium text-gray-600 hidden"></div>
        </div>

        <!-- Success Popup -->
        <div id="success-popup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 mx-4 max-w-sm w-full">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Successo!</h3>
                <p id="success-popup-message" class="text-gray-600 text-center">Salvataggio effettuato con successo</p>
            </div>
        </div>

        <!-- Convocations History View (using Firestore) -->
        <div id="history-view" class="hidden">
            <button id="top-back-from-history-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Storico Convocazioni</h2>
            <div id="history-list" class="space-y-4">
                <!-- History items will be populated here -->
            </div>
            <button id="back-from-history-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- Attendance Summary View -->
        <div id="attendance-view" class="hidden">
            <button id="top-back-from-attendance-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Riepilogo Convocazioni</h2>
            
            <!-- Total Attendance Table -->
            <h3 class="text-lg font-semibold text-gray-700 mb-3">📊 Riepilogo Totale</h3>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list" class="bg-white divide-y divide-gray-200">
                        <!-- Attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Amichevoli Attendance Table -->
            <h3 class="text-lg font-semibold text-gray-700 mb-3">🤝 Riepilogo Presenze Amichevoli</h3>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list-amichevoli" class="bg-white divide-y divide-gray-200">
                        <!-- Amichevoli attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Tornei Attendance Table -->
            <h3 class="text-lg font-semibold text-gray-700 mb-3">🏆 Riepilogo Presenze Tornei</h3>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list-tornei" class="bg-white divide-y divide-gray-200">
                        <!-- Tornei attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Campionato Attendance Table -->
            <h3 class="text-lg font-semibold text-gray-700 mb-3">⚽️ Riepilogo Presenze Campionato</h3>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list-campionato" class="bg-white divide-y divide-gray-200">
                        <!-- Campionato attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <button id="back-from-attendance-button" class="w-full mt-6 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- Training Attendance View -->
        <div id="training-attendance-view" class="hidden">
            <button id="top-back-from-training-attendance-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Presenze Allenamenti</h2>
            
            <!-- Display allenamentiTotali prominently -->
            <div id="allenamenti-totali-display" class="text-center mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-lg font-semibold text-blue-800">
                    Allenamenti Totali: <span id="allenamenti-totali-value" class="text-2xl font-bold text-blue-900">-</span>
                </p>
            </div>
            
            <div id="training-attendance-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Caricamento dati allenamenti...</p>
            </div>

            <div id="training-attendance-error" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 hidden">
                <p class="text-red-800 text-center">Errore nel caricamento dei dati. Riprova più tardi.</p>
            </div>
            
            <!-- Training Attendance Table -->
            <div id="training-attendance-content" class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-xl">Giocatore</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-xl">Presenze Allenamenti</th>
                        </tr>
                    </thead>
                    <tbody id="training-attendance-list" class="bg-white divide-y divide-gray-200">
                        <!-- Training attendance data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="text-center text-sm text-gray-500 mb-4">
                <p>Ultimo aggiornamento: <span id="training-last-update">Mai</span></p>
                <button id="refresh-training-button" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                    Aggiorna Dati
                </button>
            </div>

            <button id="back-from-training-attendance-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
        </div>

        <!-- Campionato View -->
        <div id="campionato-view" class="hidden">
            <button id="back-from-campionato-button" class="w-full mb-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2">
                Indietro
            </button>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">⚽ Campionato</h2>
            
            <!-- Risultati Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">📊 Risultati</h3>
                <div id="risultati-widget-container" class="text-center text-gray-600">
                    <iframe src='https://www.tuttocampo.it/WidgetV2/Risultati/4736d246-7989-4f4d-acb7-464de2591ce7'
                        width='90%' 
                        height='600' 
                        style="min-width: 400px;"
                        scrolling='no' 
                        frameborder='0' 
                        loading='lazy'>
                    </iframe>
                </div>
            </div>
            
            <!-- Classifica Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">🏆 Classifica</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/Classifica/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="15%" 
                            height="800" 
                            style="min-width: 350px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
            
            <!-- Marcatori Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">⚽ Marcatori</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/Marcatori/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="10%" 
                            height="700" 
                            style="min-width: 350px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
            
            <!-- Ultima Partita Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">🎯 Ultima Partita</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/Partita/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="5%" 
                            height="400" 
                            style="min-width: 350px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
            
            <!-- Prossima Partita Section -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">🔜 Prossima Partita</h3>
                <div class="w-full overflow-x-auto">
                    <iframe src="https://www.tuttocampo.it/WidgetV2/ProssimaPartita/4736d246-7989-4f4d-acb7-464de2591ce7" 
                            width="5%" 
                            height="400" 
                            style="min-width: 350px;" 
                            scrolling="no" 
                            frameborder="0" 
                            loading="lazy">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- Shareable View (Hidden for image generation) -->
        <div id="share-view" class="absolute w-[600px] h-auto top-[-9999px] left-[-9999px] bg-white rounded-xl shadow-2xl p-6 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Convocazioni Ufficiali</h2>
            
            <div id="share-details" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-gray-700 mb-2">🏟️ Campo: <span id="share-campo" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">🆚 Avversario: <span id="share-avversario" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">📅 Data Partita: <span id="share-data-partita" class="font-semibold"></span></p>
                <p class="text-700 mb-2">🕒 Orario Convocazione: <span id="share-orario-convocazione" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">🕒 Orario Partita: <span id="share-orario-partita" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">Tipo: <span id="share-tipo" class="font-semibold"></span></p>
                <p class="text-gray-700 mb-2">👤 Mister: <span id="share-mister-partita" class="font-semibold"></span></p>
                <p class="text-gray-700">👤 Mister: <span id="share-mister-tipo" class="font-semibold"></span></p>
            </div>

            <div class="mb-4">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Giocatori Convocati:</h3>
                <ul id="share-players-list" class="space-y-2 text-gray-600">
                    <!-- Selected players will be inserted here -->
                </ul>
            </div>
            <p class="text-sm text-gray-500 text-center mt-6">Rosterkick By Marco</p>
        </div>

        <!-- Modal for Marco's Status -->
        <div id="status-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
                <h2 class="text-xl font-bold mb-4">Seleziona lo stato del giocatore</h2>
                <div class="space-y-4">
                    <button data-status="Infortunato" class="w-full py-3 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Infortunato 🚑️
                    </button>
                    <button data-status="Squalificato" class="w-full py-3 bg-gray-900 hover:bg-gray-800 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Squalificato 🟥
                    </button>
                    <button data-status="Non disponibile Sabato" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Non disponibile Sabato
                    </button>
                    <button data-status="Non disponibile Domenica" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Non disponibile Domenica
                    </button>
                    <button data-status="Non disponibile Weekend" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Non disponibile WE 
                    </button>
                    <button data-status="Solo 2 allenamenti" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Solo 2 allenamenti
                    </button>
                    <button data-status="Solo 1 allenamento" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Solo 1 allenamento
                    </button>
                    <button data-status="Zero allenamenti" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Zero allenamenti ❌
                    </button>

                    <button data-status="Disponibile" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                        Disponibile 👍🏻
                    </button>
                </div>
                <button id="close-modal" class="mt-6 w-full py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                    Annulla
                </button>
            </div>
        </div>

        <!-- Modal for Mister's Unavailable Player Info -->
        <div id="unavailable-player-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
                <h2 class="text-xl font-bold mb-4 text-center text-red-600">⚠️Giocatore Non Disponibile⚠️</h2>
                <div class="text-center mb-6">
                    <p class="text-lg font-semibold text-gray-800 mb-2" id="unavailable-player-name">Nome Giocatore</p>
                    <p class="text-gray-600">Motivo:</p>
                    <p class="text-lg font-medium text-red-600" id="unavailable-player-reason">Motivo indisponibilità</p>
                </div>
                <button id="convoca-comunque-button" class="w-full py-3 mb-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    Convoca ugualmente
                </button>
                <button id="close-unavailable-modal" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                    Ok
                </button>
            </div>
        </div>
    </div>

    <!-- Already Called Today Confirmation Modal -->
    <div id="already-called-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center text-orange-600">⚠️ Giocatore Già Convocato ⚠️</h2>
            <div class="text-center mb-6">
                <p class="text-lg font-semibold text-gray-800 mb-2" id="already-called-player-name">Nome Giocatore</p>
                <p class="text-gray-600 mb-2">Questo giocatore è già stato convocato oggi.</p>
                <p class="text-sm text-gray-500">Vuoi confermarlo ugualmente?</p>
            </div>
            <button id="confirm-already-called-button" class="w-full py-3 mb-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                Conferma Convocazione
            </button>
            <button id="cancel-already-called-button" class="w-full py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                Annulla
            </button>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center">Condividi le convocazioni</h2>
            <div class="space-y-3">
                <!-- Web Share API button (will be shown only if supported) -->
                <button id="web-share-button" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200 hidden">
                    📱 Condividi con app
                </button>
                
                <!-- Separator line when Web Share is available -->
                <div id="share-separator" class="border-t border-gray-200 pt-3 hidden">
                    <p class="text-sm text-gray-500 text-center mb-3">Oppure scegli un servizio specifico:</p>
                </div>
                
                <!-- Manual sharing options -->
                <button id="whatsapp-share-button" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    💬 Condividi su WhatsApp
                </button>
                
                <button id="telegram-share-button" class="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    ✈️ Condividi su Telegram
                </button>
                
                <button id="email-share-button" class="w-full py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    📧 Condividi via Email
                </button>
                
                <button id="copy-link-button" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    📋 Copia link immagine
                </button>
                
                <button id="download-image-button" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    💾 Scarica immagine
                </button>
            </div>
            <button id="close-share-modal" class="mt-6 w-full py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                Annulla
            </button>
        </div>
    </div>

    <!-- Modal for Home/Away Selection -->
    <div id="distinta-location-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center">Tipo di Partita</h2>
            <p class="text-gray-600 text-center mb-6">Seleziona se la partita è in casa o in trasferta:</p>
            <div class="space-y-3">
                <button id="distinta-home-button" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    🏠 In Casa
                </button>
                <button id="distinta-away-button" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    ✈️ In Trasferta
                </button>
            </div>
            <button id="close-distinta-location-modal" class="mt-4 w-full py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                Annulla
            </button>
        </div>
    </div>

    <!-- Modal for Dirigenti Selection -->
    <div id="distinta-dirigenti-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 text-center">Selezione Dirigenti</h2>
            <p class="text-gray-600 text-center mb-6">Seleziona i dirigenti da includere nella distinta (minimo 1):</p>
            <div id="dirigenti-selection-list" class="space-y-2 mb-6 max-h-60 overflow-y-auto">
                <!-- Dirigenti checkboxes will be added here -->
            </div>
            <div class="flex space-x-3">
                <button id="confirm-dirigenti-selection" class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md transition-colors duration-200">
                    Conferma
                </button>
                <button id="close-distinta-dirigenti-modal" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors duration-200">
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Modal for Distinta Display -->
    <div id="distinta-display-modal" class="fixed inset-0 hidden modal flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out opacity-0">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Distinta Ufficiale</h2>
                <button id="close-distinta-display-modal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Distinta Content -->
            <div id="distinta-content" class="bg-white p-6 border-2 border-gray-300 rounded-lg font-mono text-sm leading-relaxed">
                <!-- Content will be generated here -->
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
                <button id="copy-distinta-button" class="flex-1 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                    📋 Copia Distinta
                </button>
                <button id="print-distinta-button" class="flex-1 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200">
                    🖨️ Stampa
                </button>
                <button id="share-distinta-button" class="flex-1 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors duration-200">
                    📤 Condividi
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript for app logic -->
    <script>

        
        // Vibration Functions
        function vibrateOnClick(element) {
            // Check if the clicked element is a save button (contains "Salva" text)
            const isSaveButton = element && (
                element.textContent?.includes('Salva') || 
                element.id?.includes('save') ||
                element.classList?.contains('save-button')
            );
            
            if (navigator.vibrate) {
                if (isSaveButton) {
                    // Triple vibration for save buttons: [50ms on, 50ms off, 50ms on, 50ms off, 50ms on, 50ms off]
                    navigator.vibrate([50, 50, 50, 50, 50, 50]);
                } else {
                    // Single vibration for all other buttons/keys
                    navigator.vibrate(50);
                }
            }
        }
        
        // Global event listener for all clicks and key presses
        document.addEventListener('click', function(event) {
            // Only vibrate for interactive elements
            const interactiveElements = ['BUTTON', 'A', 'INPUT', 'TEXTAREA', 'SELECT'];
            if (interactiveElements.includes(event.target.tagName) || 
                event.target.hasAttribute('onclick') ||
                event.target.classList.contains('clickable')) {
                vibrateOnClick(event.target);
            }
        });
        
        // Global event listener for key presses
        document.addEventListener('keydown', function(event) {
            // Vibrate on any key press (single vibration since keys are never save actions)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
        
        // Fallback initialization when Firebase modules don't load
        document.addEventListener('DOMContentLoaded', () => {
            // If Firebase modules didn't load, initialize in demo mode
            if (typeof window.signInAnonymously === 'undefined') {
                console.log("Firebase modules not available, initializing in demo mode");
                initializeDemoMode();
            }
        });

        function initializeDemoMode() {
            // Demo mode initialization
            const companyEntryScreen = document.getElementById('company-entry-screen');
            const companyCodeInput = document.getElementById('company-code-input');
            const verifyCompanyButton = document.getElementById('verify-company-button');
            const companyEntryMessageArea = document.getElementById('company-entry-message-area');
            const rememberCompanyCheckbox = document.getElementById('remember-company');
            
            const companyWelcomeScreen = document.getElementById('company-welcome-screen');
            const companyNameDisplay = document.getElementById('company-name-display');
            const enterMisterButton = document.getElementById('enter-mister-button');
            const enterDirigenteButton = document.getElementById('enter-dirigente-button');
            const trainingAttendanceButton = document.getElementById('training-attendance-button');
            const campionatoButton = document.getElementById('campionato-button');
            
            const passwordEntryScreen = document.getElementById('password-entry-screen');
            const rolePrompt = document.getElementById('role-prompt');
            const passwordInput = document.getElementById('password-input');
            const passwordForm = document.getElementById('password-form');
            const confirmPasswordButton = document.getElementById('confirm-password-button');
            const cancelPasswordButton = document.getElementById('cancel-password-button');
            const passwordEntryMessageArea = document.getElementById('password-entry-message-area');

            let currentCompanyCode = null;
            window.currentCompanyCode = currentCompanyCode;
            let currentCompanyData = null;
            let currentCompanyDocumentId = null;
            let pendingRole = null;

            // Show company entry screen
            companyEntryScreen.classList.remove('hidden');
            
            // Trigger login animations sequence
            setTimeout(() => startLoginAnimations(), 100);

            // Initialize checkbox state based on saved preference
            const savedRememberPreference = localStorage.getItem('rememberCompanyPreference');
            if (savedRememberPreference === 'true') {
                rememberCompanyCheckbox.checked = true;
                // If remember is true and there's saved data, fill in the company code
                const savedCompanyCode = localStorage.getItem('companyCode');
                if (savedCompanyCode) {
                    companyCodeInput.value = savedCompanyCode;
                }
            } else {
                rememberCompanyCheckbox.checked = false;
            }

            function hideAllScreens() {
                document.querySelectorAll('[id$="-screen"]').forEach(screen => {
                    screen.classList.add('hidden');
                });
            }

            function showMessage(element, message, isError = true) {
                element.textContent = message;
                element.classList.remove('hidden');
                element.classList.toggle('text-red-600', isError);
                element.classList.toggle('text-green-600', !isError);
                setTimeout(() => element.classList.add('hidden'), 5000);
            }

            // Demo company verification
            function verifyCompanyCode(code) {
                if (code === "DEMO" || code === "demo") {
                    return {
                        name: "Società Demo",
                        passwords: {
                            mister: "mister123",
                            marco: "marco123"
                        }
                    };
                }
                // Test PIEVE2010 company for campionato functionality
                if (code === "PIEVE2010" || code === "pieve2010") {
                    return {
                        name: "PIEVE2010",
                        passwords: {
                            mister: "mister123",
                            marco: "marco123"
                        }
                    };
                }
                // Test Polis company for visibility functionality
                if (code && code.toUpperCase().includes("POLIS")) {
                    return {
                        name: "POLIS Società Test",
                        passwords: {
                            mister: "mister123",
                            marco: "marco123"
                        }
                    };
                }
                return null;
            }

            /**
             * Checks if the company is POLIS PIEVE 2010 by checking config.nome, nome, or id
             * @param {Object} companyData - The company data object
             * @returns {boolean} - True if the company is POLIS PIEVE 2010
             */
            function isPolisPieve2010(companyData) {
                const societa = companyData?.data;
                if (!societa) return false;
                
                const configNome = societa?.config?.nome || '';
                const nome = societa?.nome || '';
                const id = societa?.id || '';
                
                const isMatch = configNome === 'POLIS PIEVE 2010' || 
                               nome === 'POLIS PIEVE 2010' || 
                               id === 'POLIS PIEVE 2010';
                
                console.log('🔍 DEBUG - isPolisPieve2010 check:', {
                    'config.nome': configNome,
                    'nome': nome,
                    'id': id,
                    'isPolisPieve2010': isMatch
                });
                
                return isMatch;
            }

            function showCompanyWelcome() {
                hideAllScreens();
                companyNameDisplay.textContent = currentCompanyData.name;
                
                // Show/hide training attendance button based on company name
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                const isPolisCompany = companyName === 'POLIS';
                // Check if company is POLIS PIEVE 2010 (checks config.nome, nome, or id)
                const isPolisPieveCompany = isPolisPieve2010(currentCompanyData);
                
                if (isPolisCompany) {
                    trainingAttendanceButton.classList.remove('hidden');
                } else {
                    trainingAttendanceButton.classList.add('hidden');
                }
                
                // Show/hide campionato button for POLIS PIEVE 2010
                if (isPolisPieveCompany) {
                    campionatoButton.classList.remove('hidden');
                } else {
                    campionatoButton.classList.add('hidden');
                }
                
                // Show company details with document ID and codici field
                const companyDetails = document.getElementById('company-details');
                const companyDocumentIdSpan = document.getElementById('company-document-id');
                const companyCodeSpan = document.getElementById('company-code-display');
                
                if (currentCompanyData.data) {
                    companyDocumentIdSpan.textContent = currentCompanyDocumentId || 'N/A';
                    companyCodeSpan.textContent = currentCompanyData.data.codici || currentCompanyCode;
                if (currentCompanyData.data) {
                    companyDocumentIdSpan.textContent = currentCompanyDocumentId || 'N/A';
                    companyCodeSpan.textContent = currentCompanyData.data.codici || currentCompanyCode;
                    companyDetails.classList.remove('hidden');
                } else {
                    companyDetails.classList.add('hidden');
                }
                
                companyWelcomeScreen.classList.remove('hidden');
            }

            function showPasswordEntry(role) {
                hideAllScreens();
                pendingRole = role;
                rolePrompt.textContent = `Inserisci la password per ${role === 'mister' ? 'Mister' : 'Dirigente'}:`;
                passwordInput.value = '';
                passwordEntryScreen.classList.remove('hidden');
                passwordInput.focus();
            }

            // Event listeners
            verifyCompanyButton.addEventListener('click', async () => {
                const companyCode = companyCodeInput.value.trim();
                if (!companyCode) {
                    showMessage(companyEntryMessageArea, "Inserisci un codice società.");
                    return;
                }

                try {
                    const companyData = await verifyCompanyCode(companyCode);
                    if (companyData) {
                        currentCompanyCode = companyCode;
                        window.currentCompanyCode = currentCompanyCode;
                        currentCompanyData = companyData;
                        
                        // Store document ID if available (from Firebase/cercaSocietaDaCodice)
                        if (currentCompanyData.data && currentCompanyData.data.id) {
                            currentCompanyDocumentId = currentCompanyData.data.id;
                        } else {
                            // Fallback to company code for demo mode
                            currentCompanyDocumentId = companyCode;
                        }
                        
                        // Populate passwords from data.config if available
                        if (currentCompanyData.data && currentCompanyData.data.config) {
                            currentCompanyData.passwords = {
                                ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                dirigente: currentCompanyData.data.config.dirigentePassword,
                                mister: currentCompanyData.data.config.misterPassword
                            };
                        }
                        
                        window.currentCompanyData = currentCompanyData;
                        
                        if (rememberCompanyCheckbox.checked) {
                            localStorage.setItem('companyCode', companyCode);
                            localStorage.setItem('companyData', JSON.stringify(companyData));
                            localStorage.setItem('rememberCompanyPreference', 'true');
                            // Show confirmation message
                            setTimeout(() => {
                                showMessage(companyEntryMessageArea, "Codice società salvato!", false);
                            }, 500);
                        } else {
                            localStorage.removeItem('companyCode');
                            localStorage.removeItem('companyData');
                            localStorage.setItem('rememberCompanyPreference', 'false');
                        }
                        
                        // Hide any error messages
                        companyEntryMessageArea.style.display = 'none';
                        companyEntryMessageArea.classList.add('hidden');
                        
                        showCompanyWelcome();
                    } else {
                        showMessage(companyEntryMessageArea, "Codice società non valido.");
                    }
                } catch (error) {
                    console.error("Errore nella verifica:", error);
                    showMessage(companyEntryMessageArea, "Errore nella verifica. Riprova.");
                }
            });

            enterMisterButton.addEventListener('click', () => {
                showPasswordEntry('mister');
            });

            enterDirigenteButton.addEventListener('click', () => {
                showPasswordEntry('dirigente');
            });

            // Common password validation function for demo mode
            function handlePasswordSubmissionDemo() {
                const password = passwordInput.value.trim();
                if (!password) {
                    showMessage(passwordEntryMessageArea, "Inserisci la password.");
                    return;
                }

                // Case-sensitive password validation
                let isValid = currentCompanyData.passwords[pendingRole] === password;
                
                // For backward compatibility: if role is 'dirigente' and not found, try 'marco'
                if (!isValid && pendingRole === 'dirigente' && currentCompanyData.passwords['marco'] === password) {
                    isValid = true;
                }
                
                if (isValid) {
                    showMessage(passwordEntryMessageArea, "Accesso effettuato! (Demo mode)", false);
                    setTimeout(() => {
                        alert(`Benvenuto ${pendingRole === 'mister' ? 'Mister' : 'Dirigente'}!\n\nIn modalità demo, le funzionalità complete sarebbero disponibili con Firebase attivo.\n\nCodici di prova:\n- Codice società: DEMO\n- Password Mister: mister123\n- Password Dirigente: marco123`);
                    }, 1000);
                } else {
                    showMessage(passwordEntryMessageArea, "Password errata.");
                }
            }

            confirmPasswordButton.addEventListener('click', handlePasswordSubmissionDemo);

            // Handle form submission (Enter key)
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent default form submission
                handlePasswordSubmissionDemo();
            });

            cancelPasswordButton.addEventListener('click', () => {
                pendingRole = null;
                passwordInput.value = '';
                showCompanyWelcome();
            });

            // Check for saved data
            const savedCompanyCode = localStorage.getItem('companyCode');
            const savedCompanyData = localStorage.getItem('companyData');
            const rememberPreference = localStorage.getItem('rememberCompanyPreference');
            
            if (savedCompanyCode && savedCompanyData && rememberPreference === 'true') {
                currentCompanyCode = savedCompanyCode;
                window.currentCompanyCode = currentCompanyCode;
                currentCompanyData = JSON.parse(savedCompanyData);
                
                // Populate passwords from data.config if available
                if (currentCompanyData.data && currentCompanyData.data.config) {
                    currentCompanyData.passwords = {
                        ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                        dirigente: currentCompanyData.data.config.dirigentePassword,
                        mister: currentCompanyData.data.config.misterPassword
                    };
                }
                
                window.currentCompanyData = currentCompanyData;
                companyCodeInput.value = savedCompanyCode;
                rememberCompanyCheckbox.checked = true;
                showCompanyWelcome();
            }
        }
    } // End of initializeDemoMode function
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const players = [
                "99 ALPA FEDERICO", "78 BECCARIS SEBASTIANO", "32 BEN MABROUK KEVIN", "23 BERLUSCONI NOAH",
                "1 BERNUCCI ROMEO", "18 BOERO GUGLIELMO", "22 BRIANO COSTANTINO", "28 CABASSI ROBERTO",
                "7 CALLIKU ANDREA", "4 CAZZULO MICHELE", "46 CONGIU ALESSIO", "20 DHAOUI OMAR",
                "5 DI DATO SIMONE", "77 DONALD BRYAN", "6 ESPOSITO EMANUELE", "25 GARDELLA ANDREA",
                "13 GENNARO EDOARDO", "91 GIOIA LEONARDO", "17 KHAY ADAM", "2 LAMKHAYAR AMIN",
                "29 LANNA MARK", "19 MARCHESE MATTEO", "47 MELLO CHRISTIAN", "61 MELLUSO MATTIA",
                "14 MONTEFIORI EDOARDO", "3 ODAGLIA ANDREA", "11 PELLICCI FRANCESCO", "90 PIGA GIOVANNI",
                "45 PINASCO ALESSANDRO", "10 POLLIO CESARE", "9 SCALA FEDERICO", "16 STANCHI FEDERICO",
                "21 TONINI LORENZO"
            ];

            // UI Elements
            const companyEntryScreen = document.getElementById('company-entry-screen');
            const companyCodeInput = document.getElementById('company-code-input');
            const verifyCompanyButton = document.getElementById('verify-company-button');
            const companyEntryMessageArea = document.getElementById('company-entry-message-area');
            const rememberCompanyCheckbox = document.getElementById('remember-company');
            
            const companyWelcomeScreen = document.getElementById('company-welcome-screen');
            const companyNameDisplay = document.getElementById('company-name-display');
            const enterMisterButton = document.getElementById('enter-mister-button');
            const enterDirigenteButton = document.getElementById('enter-dirigente-button');
            const viewHistoryButton = document.getElementById('view-history-button');
            const welcomeAttendanceButton = document.getElementById('welcome-attendance-button');
            const trainingAttendanceButton = document.getElementById('training-attendance-button');
            const campionatoButton = document.getElementById('campionato-button');
            const managePlayersButton = document.getElementById('manage-players-button');
            const companyLogoutButton = document.getElementById('company-logout-button');
            
            const passwordEntryScreen = document.getElementById('password-entry-screen');
            const rolePrompt = document.getElementById('role-prompt');
            const passwordInput = document.getElementById('password-input');
            const passwordForm = document.getElementById('password-form');
            const confirmPasswordButton = document.getElementById('confirm-password-button');
            const cancelPasswordButton = document.getElementById('cancel-password-button');
            const passwordEntryMessageArea = document.getElementById('password-entry-message-area');
            
            const playerManagementScreen = document.getElementById('player-management-screen');
            const playerNumeroInput = document.getElementById('player-numero');
            const playerNomeInput = document.getElementById('player-nome');
            const playerDataNascitaInput = document.getElementById('player-data-nascita');
            const playerMatricolaInput = document.getElementById('player-matricola');
            const addPlayerButton = document.getElementById('add-player-button');
            const companyPlayersList = document.getElementById('company-players-list');
            const savePlayersButton = document.getElementById('save-players-button');
            const savePlayersMessageArea = document.getElementById('save-players-message-area');
            const backFromPlayersButton = document.getElementById('back-from-players-button');
            const topBackFromPlayersButton = document.getElementById('top-back-from-players-button');
            
            // Coach management elements
            const newCoachInput = document.getElementById('new-coach-input');
            const newCoachMatricolaInput = document.getElementById('new-coach-matricola-input');
            const addCoachButton = document.getElementById('add-coach-button');
            const companyCoachesList = document.getElementById('company-coaches-list');
            const saveCoachesButton = document.getElementById('save-coaches-button');
            const saveCoachesMessageArea = document.getElementById('save-coaches-message-area');
            
            // Director management elements
            const newDirectorNameInput = document.getElementById('new-director-name-input');
            const newDirectorSurnameInput = document.getElementById('new-director-surname-input');
            const newDirectorMatricolaInput = document.getElementById('new-director-matricola-input');
            const addDirectorButton = document.getElementById('add-director-button');
            const companyDirectorsList = document.getElementById('company-directors-list');
            const saveDirectorsButton = document.getElementById('save-directors-button');
            const saveDirectorsMessageArea = document.getElementById('save-directors-message-area');
            
            const nameEntryScreen = document.getElementById('name-entry-screen');
            const nameInput = document.getElementById('name-input');
            const enterButton = document.getElementById('enter-button');
            const nameEntryMessageArea = document.getElementById('name-entry-message-area');
            const rememberMeCheckbox = document.getElementById('remember-me');

            const startScreen = document.getElementById('start-screen');
            const mainView = document.getElementById('main-view');
            const historyView = document.getElementById('history-view');
            const attendanceView = document.getElementById('attendance-view');
            const trainingAttendanceView = document.getElementById('training-attendance-view');
            const campionatoView = document.getElementById('campionato-view');
            const playersList = document.getElementById('players-list');
            const playersListMessage = document.getElementById('players-list-message');
            const selectedPlayersLiveList = document.getElementById('selected-players-live-list');
            const selectedPlayersTitle = document.getElementById('selected-players-title');

            const saveButton = document.getElementById('save-button');
            const shareButton = document.getElementById('share-button');
            const historyButton = document.getElementById('history-button');
            const attendanceButton = document.getElementById('attendance-button');
            const esciButton = document.getElementById('esci-button');
            const backFromHistoryButton = document.getElementById('back-from-history-button');
            const topBackFromHistoryButton = document.getElementById('top-back-from-history-button');
            const backFromAttendanceButton = document.getElementById('back-from-attendance-button');
            const topBackFromAttendanceButton = document.getElementById('top-back-from-attendance-button');
            const historyList = document.getElementById('history-list');
            const attendanceList = document.getElementById('attendance-list');
            const attendanceListAmichevoli = document.getElementById('attendance-list-amichevoli');
            const attendanceListTornei = document.getElementById('attendance-list-tornei');
            const attendanceListCampionato = document.getElementById('attendance-list-campionato');
            const shareView = document.getElementById('share-view');
            const messageArea = document.getElementById('message-area');
            const startMessageArea = document.getElementById('start-message-area');
            const appIdDisplay = document.getElementById('app-id-display');
            const currentAppIdDisplay = document.getElementById('current-app-id-display');
            const createTeamButton = document.getElementById('create-team-button');
            const joinTeamButton = document.getElementById('join-team-button');
            const joinAppIdInput = document.getElementById('join-app-id-input');
            const rememberTeamIdCheckbox = document.getElementById('remember-team-id');
            const changeTeamButton = document.getElementById('change-team-button');
            const resetSelectionsButton = document.getElementById('reset-selections-button');
            const forgetDataButton = document.getElementById('forget-data-button');
            const roleMessage = document.getElementById('role-message');
            const unavailablePlayersView = document.getElementById('unavailable-players-view');
            const unavailablePlayersList = document.getElementById('unavailable-players-list');
            const unavailablePlayersTitle = document.getElementById('unavailable-players-title');
            const matchDetailsSection = document.getElementById('match-details-section');
            
            // Notes Elements
            const notesSection = document.getElementById('notes-section');
            const notesEditable = document.getElementById('notes-editable');
            const notesReadonly = document.getElementById('notes-readonly');
            const notesTextarea = document.getElementById('notes-textarea');
            const notesDisplay = document.getElementById('notes-display');
            const saveNotesButton = document.getElementById('save-notes-button');
            
            // Modal Elements
            const statusModal = document.getElementById('status-modal');
            const closeModalButton = document.getElementById('close-modal');
            const statusButtons = statusModal.querySelectorAll('[data-status]');
            
            // Unavailable Player Modal Elements
            const unavailablePlayerModal = document.getElementById('unavailable-player-modal');
            const closeUnavailableModalButton = document.getElementById('close-unavailable-modal');
            const unavailablePlayerName = document.getElementById('unavailable-player-name');
            const unavailablePlayerReason = document.getElementById('unavailable-player-reason');
            const convocaComunqueButton = document.getElementById('convoca-comunque-button'); // nuovo bottone

            // Already Called Today Modal Elements
            const alreadyCalledModal = document.getElementById('already-called-modal');
            const alreadyCalledPlayerName = document.getElementById('already-called-player-name');
            const confirmAlreadyCalledButton = document.getElementById('confirm-already-called-button');
            const cancelAlreadyCalledButton = document.getElementById('cancel-already-called-button');

            // Share Modal Elements
            const shareModal = document.getElementById('share-modal');
            const closeShareModalButton = document.getElementById('close-share-modal');
            const webShareButton = document.getElementById('web-share-button');
            const whatsappShareButton = document.getElementById('whatsapp-share-button');
            const telegramShareButton = document.getElementById('telegram-share-button');
            const emailShareButton = document.getElementById('email-share-button');
            const copyLinkButton = document.getElementById('copy-link-button');
            const downloadImageButton = document.getElementById('download-image-button');

            // Distinta Modal Elements
            const distintaLocationModal = document.getElementById('distinta-location-modal');
            const distintaHomeButton = document.getElementById('distinta-home-button');
            const distintaAwayButton = document.getElementById('distinta-away-button');
            const closeDistintaLocationModalButton = document.getElementById('close-distinta-location-modal');
            
            const distintaDirigentiModal = document.getElementById('distinta-dirigenti-modal');
            const dirigentiSelectionList = document.getElementById('dirigenti-selection-list');
            const confirmDirigentiSelectionButton = document.getElementById('confirm-dirigenti-selection');
            const closeDistintaDirigentiModalButton = document.getElementById('close-distinta-dirigenti-modal');
            
            const distintaDisplayModal = document.getElementById('distinta-display-modal');
            const distintaContent = document.getElementById('distinta-content');
            const closeDistintaDisplayModalButton = document.getElementById('close-distinta-display-modal');
            const copyDistintaButton = document.getElementById('copy-distinta-button');
            const printDistintaButton = document.getElementById('print-distinta-button');
            const shareDistintaButton = document.getElementById('share-distinta-button');

            // --- App State ---
            let userRole = null;
            let isGuestUser = false; // New: track if user is logged in as guest
            let currentAppId = window.appId;
            let currentCompanyCode = null;
            window.currentCompanyCode = currentCompanyCode;
            let currentCompanyData = null;
            let companyPlayers = [];
            let companyCoaches = [];
            let companyDirectors = [];
            let pendingRole = null; // for password verification
            let unavailablePlayers = new Map();
            let currentNotes = '';
            let tempPlayerName = null;
            let tempUnavailablePlayerName = null; // per "convoca comunque"
            let tempAlreadyCalledPlayerName = null; // per giocatori già convocati oggi
            let unsubscribeListeners = [];
            let selectedDistintaLocation = null; // home/away selection for distinta
            let selectedDirigenti = []; // selected dirigenti for distinta
            let historyPreviousView = null; // track where history was accessed from
            let attendancePreviousView = null; // track where attendance was accessed from
            let convocationHistory = []; // store convocation history data for attendance filtering
            
            // Distinta-related global variables
            window.currentDistintaData = null;

            // Helper function to check if user is a guest
            function isGuest() {
                return isGuestUser;
            }

            // Helper function to check if user has dirigente/marco privileges
            function isDirigente() {
                return !isGuestUser && (userRole === 'marco' || userRole === 'dirigente');
            }

            // Helper function to check if user can access distinta functionality (both mister and dirigente, not guests)
            function canAccessDistinta() {
                return !isGuestUser && (userRole === 'marco' || userRole === 'dirigente' || userRole === 'mister');
            }

            // Helper function to check if user can share content (not guests)
            function canShare() {
                return !isGuestUser && userRole === 'mister';
            }

            // Helper function to check if user can share historical convocations (mister and dirigente)
            function canShareHistory() {
                return !isGuestUser && (userRole === 'mister' || userRole === 'dirigente');
            }

            // Helper function to check if a player was already called up today
            function isPlayerCalledToday(playerName) {
                if (!convocationHistory || convocationHistory.length === 0) {
                    return false;
                }
                
                const today = new Date();
                const todayDateString = today.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                // Check each convocation in history
                for (const convocation of convocationHistory) {
                    if (!convocation.createdAt || !convocation.players) {
                        continue;
                    }
                    
                    // Compare convocation creation date with today's date (not match date)
                    const convocationDate = new Date(convocation.createdAt);
                    const convocationDateString = convocationDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                    if (convocationDateString === todayDateString) {
                        // Check if player is in the players list
                        const isInList = convocation.players.some(player => {
                            if (typeof player === 'string') {
                                return player === playerName;
                            } else {
                                return `${player.numero} ${player.nome}` === playerName;
                            }
                        });
                        
                        if (isInList) {
                            return true;
                        }
                    }
                }
                
                return false;
            }

            // Initial Firebase setup
             async function initApp() {
                if (window.auth) {
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await window.signInWithCustomToken(window.auth, token);
                        } else {
                            await window.signInAnonymously(window.auth);
                        }
                        
                        console.log("Firebase initialized and user authenticated.");
                        
                        // Check for saved company data
                        const savedCompanyCode = localStorage.getItem('companyCode');
                        const savedCompanyData = localStorage.getItem('companyData');
                        const savedRole = localStorage.getItem('userRole');
                        const savedAppId = localStorage.getItem('convocazioniAppId');
                        
                        if (savedCompanyCode && savedCompanyData && savedRole && savedAppId) {
                            // Restore full session
                            currentCompanyCode = savedCompanyCode;
                            window.currentCompanyCode = currentCompanyCode;
                            currentCompanyData = JSON.parse(savedCompanyData);
                            
                            // Populate passwords from data.config if available
                            if (currentCompanyData.data && currentCompanyData.data.config) {
                                currentCompanyData.passwords = {
                                    ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                    dirigente: currentCompanyData.data.config.dirigentePassword,
                                    mister: currentCompanyData.data.config.misterPassword
                                };
                            }
                            
                            window.currentCompanyData = currentCompanyData;
                            userRole = savedRole;
                            companyPlayers = await loadCompanyPlayers();
                            companyCoaches = await loadCompanyCoaches();
                            companyDirectors = await loadCompanyDirectors();
                            startApp(savedAppId);
                        } else if (savedCompanyCode && savedCompanyData) {
                            // Show welcome screen with company data
                            currentCompanyCode = savedCompanyCode;
                            window.currentCompanyCode = currentCompanyCode;
                            currentCompanyData = JSON.parse(savedCompanyData);
                            
                            // Populate passwords from data.config if available
                            if (currentCompanyData.data && currentCompanyData.data.config) {
                                currentCompanyData.passwords = {
                                    ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                    dirigente: currentCompanyData.data.config.dirigentePassword,
                                    mister: currentCompanyData.data.config.misterPassword
                                };
                            }
                            
                            window.currentCompanyData = currentCompanyData;
                            companyPlayers = await loadCompanyPlayers();
                            companyCoaches = await loadCompanyCoaches();
                            companyDirectors = await loadCompanyDirectors();
                            showCompanyWelcome();
                        } else {
                            // Show company entry screen
                            const savedCompanyCode = localStorage.getItem('companyCode');
                            const rememberPreference = localStorage.getItem('rememberCompanyPreference');
                            if (savedCompanyCode && rememberPreference === 'true') {
                                companyCodeInput.value = savedCompanyCode;
                                rememberCompanyCheckbox.checked = true;
                            }
                            companyEntryScreen.classList.remove('hidden');
                            // Trigger login animations sequence
                            setTimeout(() => startLoginAnimations(), 100);
                        }
                    } catch (err) {
                        console.error("Firebase authentication failed:", err);
                        companyEntryScreen.classList.remove('hidden');
                        // Trigger login animations sequence
                        setTimeout(() => startLoginAnimations(), 100);
                    }
                } else {
                    console.error("Firebase configuration not available. Some features will not work.");
                    companyEntryScreen.classList.remove('hidden');
                    // Trigger login animations sequence
                    setTimeout(() => startLoginAnimations(), 100);
                }
            }

            // Global function for login animations - moved here to be available before initApp() call
            function startLoginAnimations() {
                const logo = document.getElementById('animated-logo');
                const title = document.getElementById('animated-title');
                const subtitle = document.getElementById('animated-subtitle');
                const form = document.getElementById('animated-form');
                
                // Only proceed if elements exist
                if (!logo || !title || !subtitle || !form) return;
                
                // Reset all elements to initial state
                logo.classList.remove('animate-drop-bounce');
                title.classList.remove('animate-slide-in-right');
                subtitle.classList.remove('animate-slide-in-right');
                form.classList.remove('animate-slide-in-left');
                
                // Step 1: Logo drops and bounces (starts immediately)
                logo.classList.add('animate-drop-bounce');
                
                // Step 2: Title slides in from right (after 0.8s)
                setTimeout(() => {
                    title.classList.add('animate-slide-in-right');
                }, 800);
                
                // Step 3: Subtitle slides in from right (after 1.2s)
                setTimeout(() => {
                    subtitle.classList.add('animate-slide-in-right');
                }, 1200);
                
                // Step 4: Form slides in from left (after 1.8s)
                setTimeout(() => {
                    form.classList.add('animate-slide-in-left');
                }, 1800);
            }

            initApp();
            
            
            // Company verification functions
            async function verifyCompanyCode(companyCode) {
                // Try to use cercaSocietaDaCodice function if available
                if (window.cercaSocietaDaCodice) {
                    try {
                        const societa = await window.cercaSocietaDaCodice(companyCode);
                        
                        // Check if company exists and is active
                        if (!societa) {
                            return null;
                        }
                        
                        if (societa.attiva === false) {
                            return null;
                        }
                        
                        // Convert to expected format for compatibility
                        const companyData = {
                            name: societa.nome || "Società Sconosciuta",
                            passwords: societa.passwords || {},
                            data: societa, // Keep original data
                            isGuestLogin: societa.isGuestLogin || false // Include guest login flag
                        };
                        
                        // Populate passwords from data.config if available
                        if (societa.config) {
                            companyData.passwords = {
                                ...companyData.passwords, // Keep existing passwords for backward compatibility
                                dirigente: societa.config.dirigentePassword,
                                mister: societa.config.misterPassword
                            };
                        }
                        
                        return companyData;
                    } catch (error) {
                        console.error("Errore nella ricerca società:", error);
                        // Fall back to old method
                    }
                }

                // Fallback: Demo mode when Firebase is not available or cercaSocietaDaCodice fails
                if (!window.db) {
                    console.log("Firebase not available, using demo mode");
                    if (companyCode === "DEMO" || companyCode === "demo") {
                        return {
                            name: "Società Demo",
                            passwords: {
                                mister: "mister123",
                                marco: "marco123",
                                dirigente: "marco123"
                            },
                            isGuestLogin: false,
                            data: {
                                id: "demo-demo",
                                nome: "Società Demo",
                                codici: "DEMO",
                                config: { 
                                    tema: "light", 
                                    notifiche: true, 
                                    demo: true,
                                    misterPassword: "mister123",
                                    dirigentePassword: "marco123"
                                },
                                giocatori: ["1 DEMO MARIO", "2 TEST LUIGI", "3 EXAMPLE GIUSEPPE", "4 SAMPLE ANTONIO"],
                                attiva: true,
                                dataCreazione: "2024-01-01"
                            }
                        };
                    } else if (companyCode === "GUEST" || companyCode === "guest") {
                        // Demo guest code for testing
                        return {
                            name: "Società Demo",
                            passwords: {},
                            isGuestLogin: true,
                            data: {
                                id: "demo-demo",
                                nome: "Società Demo",
                                codici: "DEMO",
                                ospitecode: "GUEST",
                                config: { 
                                    tema: "light", 
                                    notifiche: true, 
                                    demo: true,
                                    misterPassword: "mister123",
                                    dirigentePassword: "marco123"
                                },
                                giocatori: ["1 DEMO MARIO", "2 TEST LUIGI", "3 EXAMPLE GIUSEPPE", "4 SAMPLE ANTONIO"],
                                attiva: true,
                                dataCreazione: "2024-01-01"
                            }
                        };
                    } else {
                        return null;
                    }
                }
                
                try {
                    const companyDocRef = window.doc(window.db, "societa", companyCode);
                    const companyDoc = await window.getDoc(companyDocRef);
                    
                    if (companyDoc.exists()) {
                        const data = companyDoc.data();
                        // Check if company is active
                        if (data.attiva === false) {
                            return null;
                        }
                        return {
                            ...data,
                            isGuestLogin: false // Default to false for Firebase fallback
                        };
                    } else {
                        return null;
                    }
                } catch (error) {
                    console.error("Errore nella verifica del codice società:", error);
                    throw error;
                }
            }
            
            async function verifyPassword(role, password) {
                if (!currentCompanyData) {
                    return false;
                }
                
                const passwords = currentCompanyData.passwords || {};
                
                // Case-sensitive password validation
                // First, try the requested role
                if (passwords[role] === password) {
                    return true;
                }
                
                // For backward compatibility: if role is 'dirigente' and not found, try 'marco'
                if (role === 'dirigente' && passwords['marco'] === password) {
                    return true;
                }
                
                return false;
            }
            
            // Functions to handle player loading error messages in UI
            function showPlayerLoadingError(message) {
                // Show error in the player management screen if it exists
                const playerManagementScreen = document.getElementById('player-management-screen');
                let errorDiv = document.getElementById('player-loading-error');
                
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = 'player-loading-error';
                    errorDiv.className = 'mt-4 p-3 bg-red-100 border border-red-200 rounded-lg text-red-800 text-sm font-medium';
                    
                    // Insert at the top of player management screen if it exists
                    if (playerManagementScreen) {
                        playerManagementScreen.insertBefore(errorDiv, playerManagementScreen.firstChild);
                    }
                }
                
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">❌</span>
                        <span><strong>Errore caricamento giocatori:</strong> ${message}</span>
                    </div>
                `;
                errorDiv.classList.remove('hidden');
                
                console.error(`🚨 UI Error: ${message}`);
            }
            
            function hidePlayerLoadingError() {
                const errorDiv = document.getElementById('player-loading-error');
                if (errorDiv) {
                    errorDiv.classList.add('hidden');
                }
            }

            /**
             * Custom sorting function for players that sorts alphabetically by name,
             * handling both old string format ("1 ROSSI MARIO") and new object format
             * @param {(string|object)[]} players - Array of player strings or objects
             * @returns {(string|object)[]} - Sorted array of players
             */
            function sortPlayersByName(players) {
                return players.sort((a, b) => {
                    let nameA, nameB;
                    
                    // Handle old string format: "NUMBER SURNAME NAME"
                    if (typeof a === 'string') {
                        nameA = a.replace(/^\d+\s+/, '').trim();
                    } else {
                        // Handle new object format
                        nameA = a.nome;
                    }
                    
                    if (typeof b === 'string') {
                        nameB = b.replace(/^\d+\s+/, '').trim();
                    } else {
                        // Handle new object format
                        nameB = b.nome;
                    }
                    
                    // Compare the names alphabetically (case-insensitive)
                    return nameA.localeCompare(nameB, 'it', { sensitivity: 'base' });
                });
            }

            async function loadCompanyPlayers() {
                console.log("🔄 loadCompanyPlayers() chiamata");
                
                if (!currentCompanyCode) {
                    console.log("❌ Nessun codice società disponibile (currentCompanyCode è null/undefined)");
                    showPlayerLoadingError("Codice società non disponibile");
                    return [];
                }
                
                console.log(`🏢 Caricamento giocatori per società: ${currentCompanyCode}`);
                
                // Demo mode - load from localStorage or return defaults
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("🎭 Modalità DEMO attivata");
                    // Try to load from localStorage first
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            console.log("📁 Caricamento giocatori da localStorage (modalità demo)");
                            return sortPlayersByName(JSON.parse(savedPlayers)); // Sort players by name only
                        } catch (error) {
                            console.error("❌ Errore nel parsing localStorage (modalità demo):", error);
                        }
                    }
                    // Return default demo players if nothing saved
                    console.log("🎲 Utilizzo giocatori predefiniti per modalità demo");
                    return sortPlayersByName([
                        "1 ROSSI MARIO", "2 BIANCHI LUIGI", "3 VERDI GIUSEPPE", 
                        "4 NERI ANTONIO", "5 GIALLI FRANCESCO", "6 BLU MARCO",
                        "7 VIOLA STEFANO", "8 ROSA ANDREA", "9 GRIGIO PAOLO", "10 AZZURRI LUCA"
                    ]); // Sort demo players by name only
                }
                
                // Firebase mode - load from players subcollection
                if (!window.db) {
                    console.log("❌ Firebase non disponibile, tentativo fallback localStorage");
                    // Firebase not available, fallback to localStorage
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            console.log("📁 Fallback: caricamento da localStorage");
                            return sortPlayersByName(JSON.parse(savedPlayers)); // Sort players by name only
                        } catch (error) {
                            console.error("❌ Errore nel parsing localStorage fallback:", error);
                            showPlayerLoadingError("Errore nel caricamento dei dati salvati localmente");
                        }
                    } else {
                        console.log("❌ Nessun dato disponibile in localStorage");
                        showPlayerLoadingError("Firebase non disponibile e nessun dato locale trovato");
                    }
                    return [];
                }
                
                // Log the complete subcollection path using document ID
                const subcollectionPath = `societa/${currentCompanyDocumentId}/giocatori`;
                console.log(`📄 Lettura subcollection Firebase da percorso completo: ${subcollectionPath}`);
                console.log(`🔗 Percorso completo della subcollection: societa/${currentCompanyDocumentId}/giocatori`);
                console.log(`📋 Caricando giocatori dalla subcollection con document ID società: ${currentCompanyDocumentId}`);
                console.log(`🏷️ Codice inserito dall'utente (campo 'codici'): ${currentCompanyCode}`);
                
                try {
                    // Load giocatori from the giocatori subcollection using document ID
                    const playersCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "giocatori");
                    const playersSnapshot = await window.getDocs(playersCollectionRef);
                    
                    if (!playersSnapshot.empty) {
                        const players = [];
                        playersSnapshot.forEach((doc) => {
                            const playerData = doc.data();
                            // Use the player name from the document data, or fallback to document ID
                            const playerName = playerData.name || playerData.nome || doc.id;
                            players.push(playerName);
                        });
                        
                        console.log(`✅ Subcollection trovata: societa/${currentCompanyDocumentId}/giocatori`);
                        console.log(`👥 Giocatori trovati nella subcollection (${players.length}):`, players);
                        hidePlayerLoadingError();
                        return sortPlayersByName(players); // Sort players by name only
                    } else {
                        console.log(`📝 Subcollection 'giocatori' vuota per società document ID ${currentCompanyDocumentId}, ritorno array vuoto`);
                        hidePlayerLoadingError();
                        return [];
                    }
                } catch (error) {
                    console.error(`💥 Errore nel caricamento giocatori dalla subcollection Firebase (percorso: societa/${currentCompanyDocumentId}/giocatori):`, error);
                    showPlayerLoadingError(`Errore di connessione a Firebase subcollection: ${error.message}`);
                    
                    // Fallback to localStorage if Firebase fails
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            console.log("🔄 Fallback: caricamento da localStorage dopo errore Firebase");
                            return sortPlayersByName(JSON.parse(savedPlayers)); // Sort players by name only
                        } catch (parseError) {
                            console.error("❌ Errore nel parsing localStorage fallback:", parseError);
                        }
                    }
                    return [];
                }
            }
            
            async function saveCompanyPlayers(playersList) {
                if (!currentCompanyCode) {
                    throw new Error("Codice società non disponibile");
                }
                
                // Demo mode - save to localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("Demo mode: players saved locally", playersList);
                    localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                    return;
                }
                
                // Firebase mode - save to players subcollection
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving to localStorage as fallback");
                    localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                    return;
                }
                
                try {
                    // First, get existing players from subcollection to identify what to remove
                    const playersCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "giocatori");
                    const existingPlayersSnapshot = await window.getDocs(playersCollectionRef);
                    
                    // Create a set of existing player names for comparison
                    const existingPlayerNames = new Set();
                    const existingPlayerDocs = new Map();
                    existingPlayersSnapshot.forEach((doc) => {
                        const playerData = doc.data();
                        const playerName = playerData.name || playerData.nome || doc.id;
                        existingPlayerNames.add(playerName);
                        existingPlayerDocs.set(playerName, doc.id);
                    });
                    
                    // Add new players to subcollection
                    for (const playerName of playersList) {
                        if (!existingPlayerNames.has(playerName)) {
                            // Create a new document for this player
                            const playerDocRef = window.doc(playersCollectionRef);
                            await window.setDoc(playerDocRef, {
                                name: playerName,
                                nome: playerName, // Keep both for compatibility
                                createdAt: new Date().toISOString(),
                                active: true
                            });
                            console.log(`✅ Nuovo giocatore aggiunto alla subcollection: ${playerName}`);
                        }
                    }
                    
                    // Remove players that are no longer in the list
                    for (const existingPlayerName of existingPlayerNames) {
                        if (!playersList.includes(existingPlayerName)) {
                            const docId = existingPlayerDocs.get(existingPlayerName);
                            const playerDocRef = window.doc(window.db, "societa", currentCompanyDocumentId, "giocatori", docId);
                            await window.deleteDoc(playerDocRef);
                            console.log(`🗑️ Giocatore rimosso dalla subcollection: ${existingPlayerName}`);
                        }
                    }
                    
                    console.log(`✅ Giocatori salvati nella subcollection societa/${currentCompanyDocumentId}/giocatori`);
                } catch (error) {
                    console.error("Errore nel salvataggio giocatori nella subcollection Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    console.log("Falling back to localStorage due to Firebase error");
                    try {
                        localStorage.setItem(`players_${currentCompanyCode}`, JSON.stringify(playersList));
                        console.log("Players saved to localStorage as fallback");
                        // Don't throw error since localStorage save succeeded
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        throw new Error("Salvataggio fallito sia su Firebase che su localStorage");
                    }
                }
            }

            async function saveCompanyCoaches(coachesList) {
                if (!currentCompanyCode) {
                    throw new Error("Codice società non disponibile");
                }
                
                // Demo mode - save to localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("Demo mode: coaches saved locally", coachesList);
                    localStorage.setItem(`coaches_${currentCompanyCode}`, JSON.stringify(coachesList));
                    return;
                }
                
                // Firebase mode - save to coaches subcollection
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving coaches to localStorage as fallback");
                    localStorage.setItem(`coaches_${currentCompanyCode}`, JSON.stringify(coachesList));
                    return;
                }
                
                try {
                    // First, get existing coaches from subcollection to identify what to remove
                    const coachesCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "mister");
                    const existingCoachesSnapshot = await window.getDocs(coachesCollectionRef);
                    
                    // Create a set of existing coach names for comparison
                    const existingCoachNames = new Set();
                    const existingCoachDocs = new Map();
                    existingCoachesSnapshot.forEach((doc) => {
                        const coachData = doc.data();
                        const coachName = coachData.name || coachData.nome || doc.id;
                        existingCoachNames.add(coachName);
                        existingCoachDocs.set(coachName, doc.id);
                    });
                    
                    // Add new coaches to subcollection
                    for (const coach of coachesList) {
                        const coachName = typeof coach === 'string' ? coach : coach.name;
                        const coachMatricola = typeof coach === 'object' && coach.matricola ? coach.matricola : '';
                        
                        if (!existingCoachNames.has(coachName)) {
                            // Create a new document for this coach
                            const coachDocRef = window.doc(coachesCollectionRef);
                            const coachData = {
                                name: coachName,
                                nome: coachName, // Keep both for compatibility
                                createdAt: new Date().toISOString(),
                                active: true
                            };
                            
                            // Add matricola if available
                            if (coachMatricola) {
                                coachData.matricola = coachMatricola;
                            }
                            
                            await window.setDoc(coachDocRef, coachData);
                            console.log(`Mister aggiunto: ${coachName}${coachMatricola ? ` (Matricola: ${coachMatricola})` : ''}`);
                        }
                    }
                    
                    // Remove coaches that are no longer in the list
                    for (const [coachName, docId] of existingCoachDocs) {
                        const stillExists = coachesList.some(coach => {
                            const currentCoachName = typeof coach === 'string' ? coach : coach.name;
                            return currentCoachName === coachName;
                        });
                        
                        if (!stillExists) {
                            const coachDocRef = window.doc(window.db, "societa", currentCompanyDocumentId, "mister", docId);
                            await window.deleteDoc(coachDocRef);
                            console.log(`Mister rimosso: ${coachName}`);
                        }
                    }
                    
                    console.log("Mister salvati con successo nella subcollection Firebase");
                } catch (error) {
                    console.error("Errore nel salvataggio mister nella subcollection Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    console.log("Falling back to localStorage due to Firebase error");
                    try {
                        localStorage.setItem(`coaches_${currentCompanyCode}`, JSON.stringify(coachesList));
                        console.log("Coaches saved to localStorage as fallback");
                        // Don't throw error since localStorage save succeeded
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        throw new Error("Salvataggio mister fallito sia su Firebase che su localStorage");
                    }
                }
            }

            async function saveCompanyDirectors(directorsList) {
                if (!currentCompanyCode) {
                    throw new Error("Codice società non disponibile");
                }
                
                // Demo mode - save to localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    console.log("Demo mode: directors saved locally", directorsList);
                    localStorage.setItem(`directors_${currentCompanyCode}`, JSON.stringify(directorsList));
                    return;
                }
                
                // Firebase mode - save to directors subcollection
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving directors to localStorage as fallback");
                    localStorage.setItem(`directors_${currentCompanyCode}`, JSON.stringify(directorsList));
                    return;
                }
                
                try {
                    // First, get existing directors from subcollection to identify what to remove
                    const directorsCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "dirigenti");
                    const existingDirectorsSnapshot = await window.getDocs(directorsCollectionRef);
                    
                    // Create a set of existing director full names for comparison
                    const existingDirectorNames = new Set();
                    const existingDirectorDocs = new Map();
                    existingDirectorsSnapshot.forEach((doc) => {
                        const directorData = doc.data();
                        const fullName = `${directorData.name || ''} ${directorData.surname || ''}`.trim();
                        existingDirectorNames.add(fullName);
                        existingDirectorDocs.set(fullName, doc.id);
                    });
                    
                    // Add new directors to subcollection
                    for (const director of directorsList) {
                        const fullName = `${director.name || ''} ${director.surname || ''}`.trim();
                        
                        if (!existingDirectorNames.has(fullName)) {
                            // Create a new document for this director
                            const directorDocRef = window.doc(directorsCollectionRef);
                            const directorData = {
                                name: director.name || '',
                                surname: director.surname || '',
                                matricola: director.matricola || '',
                                createdAt: new Date().toISOString(),
                                active: true
                            };
                            
                            await window.setDoc(directorDocRef, directorData);
                            console.log(`Dirigente aggiunto: ${fullName} (Matricola: ${director.matricola})`);
                        }
                    }
                    
                    // Remove directors that are no longer in the list
                    for (const [fullName, docId] of existingDirectorDocs) {
                        const stillExists = directorsList.some(director => {
                            const currentFullName = `${director.name || ''} ${director.surname || ''}`.trim();
                            return currentFullName === fullName;
                        });
                        
                        if (!stillExists) {
                            const directorDocRef = window.doc(window.db, "societa", currentCompanyDocumentId, "dirigenti", docId);
                            await window.deleteDoc(directorDocRef);
                            console.log(`Dirigente rimosso: ${fullName}`);
                        }
                    }
                    
                    console.log("Dirigenti salvati con successo nella subcollection Firebase");
                } catch (error) {
                    console.error("Errore nel salvataggio dirigenti nella subcollection Firebase:", error);
                    // Fallback to localStorage if Firebase fails
                    console.log("Falling back to localStorage due to Firebase error");
                    try {
                        localStorage.setItem(`directors_${currentCompanyCode}`, JSON.stringify(directorsList));
                        console.log("Directors saved to localStorage as fallback");
                        // Don't throw error since localStorage save succeeded
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        throw new Error("Salvataggio dirigenti fallito sia su Firebase che su localStorage");
                    }
                }
            }

            async function loadCompanyCoaches() {
                if (!currentCompanyCode) {
                    console.log("Nessun codice società disponibile per caricare i mister");
                    return [];
                }

                // Demo mode - load from localStorage
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    const storedCoaches = localStorage.getItem(`coaches_${currentCompanyCode}`);
                    return storedCoaches ? JSON.parse(storedCoaches) : [];
                }

                // Firebase mode - load from coaches subcollection
                if (!window.db) {
                    // Firebase not available, try localStorage fallback
                    const storedCoaches = localStorage.getItem(`coaches_${currentCompanyCode}`);
                    return storedCoaches ? JSON.parse(storedCoaches) : [];
                }

                try {
                    const coachesCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "mister");
                    const coachesSnapshot = await window.getDocs(coachesCollectionRef);
                    
                    const coaches = [];
                    coachesSnapshot.forEach((doc) => {
                        const coachData = doc.data();
                        const coachName = coachData.name || coachData.nome || doc.id;
                        if (coachData.active !== false) { // Include active coaches or those without active field
                            if (coachData.matricola) {
                                // New format: object with name and matricola
                                coaches.push({
                                    name: coachName,
                                    matricola: coachData.matricola
                                });
                            } else {
                                // Old format: just the name (for backward compatibility)
                                coaches.push(coachName);
                            }
                        }
                    });
                    
                    // Sort coaches by name
                    return coaches.sort((a, b) => {
                        const nameA = typeof a === 'string' ? a : a.name;
                        const nameB = typeof b === 'string' ? b : b.name;
                        return nameA.localeCompare(nameB);
                    });
                } catch (error) {
                    console.error("Errore nel caricamento mister da Firebase:", error);
                    // Try localStorage fallback
                    const storedCoaches = localStorage.getItem(`coaches_${currentCompanyCode}`);
                    return storedCoaches ? JSON.parse(storedCoaches) : [];
                }
            }

            async function loadCompanyDirectors() {
                if (!currentCompanyCode) {
                    console.log("Nessun codice società disponibile per caricare i dirigenti");
                    return [];
                }

                // Demo mode - load from localStorage or provide defaults
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    const storedDirectors = localStorage.getItem(`directors_${currentCompanyCode}`);
                    if (storedDirectors) {
                        return JSON.parse(storedDirectors);
                    } else {
                        // Provide default directors for demo mode
                        const defaultDirectors = [
                            { name: "Marco", surname: "Dirigente", matricola: "DIR001" },
                            { name: "Giuseppe", surname: "Presidente", matricola: "DIR002" },
                            { name: "Antonio", surname: "Segretario", matricola: "DIR003" }
                        ];
                        return defaultDirectors;
                    }
                }

                // Firebase mode - load from directors subcollection
                if (!window.db) {
                    // Firebase not available, try localStorage fallback
                    const storedDirectors = localStorage.getItem(`directors_${currentCompanyCode}`);
                    return storedDirectors ? JSON.parse(storedDirectors) : [];
                }

                try {
                    const directorsCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "dirigenti");
                    const directorsSnapshot = await window.getDocs(directorsCollectionRef);
                    
                    const directors = [];
                    directorsSnapshot.forEach((doc) => {
                        const directorData = doc.data();
                        if (directorData.active !== false) { // Include active directors or those without active field
                            directors.push({
                                name: directorData.name || directorData.nome,
                                surname: directorData.surname || directorData.cognome,
                                matricola: directorData.matricola
                            });
                        }
                    });

                    // Sort directors by surname, then name
                    return directors.sort((a, b) => {
                        const surnameCompare = (a.surname || '').localeCompare(b.surname || '');
                        if (surnameCompare !== 0) return surnameCompare;
                        return (a.name || '').localeCompare(b.name || '');
                    });
                } catch (error) {
                    console.error("Errore nel caricamento dirigenti da Firebase:", error);
                    // Try localStorage fallback
                    const storedDirectors = localStorage.getItem(`directors_${currentCompanyCode}`);
                    return storedDirectors ? JSON.parse(storedDirectors) : [];
                }
            }

            // Set up real-time listeners for all necessary data
            function setupFirestoreListeners(appId) {
                console.log(`🔄 [DIAGNOSTIC] setupFirestoreListeners chiamata con appId: ${appId}`);
                console.log(`   🏢 Company variables - Codice: ${currentCompanyCode}, Document ID: ${currentCompanyDocumentId}`);
                
                // Clear old listeners
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                // Check if Firebase is available
                if (!window.db || !window.collection || !window.onSnapshot || !window.doc) {
                    console.log('Firebase not available, using demo mode for history/attendance');
                    // In demo mode, initialize with empty data
                    loadHistoryDemo();
                    loadAttendanceDemo();
                    // Initialize unavailable players view with empty state message
                    unavailablePlayers = new Map();
                    updateUnavailablePlayersView();
                    console.log('📝 Demo mode: Initialized availability with empty state message');
                    return;
                }

                // Use company-specific paths
                const basePath = currentCompanyCode ? `societa/${currentCompanyCode}` : `artifacts/${appId}/public/data`;
                
                // For availability subcollection, use document ID instead of company code
                const availabilityBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;

                // Log the paths being used for debugging
                console.log(`🏢 Società corrente - Codice: ${currentCompanyCode}, Document ID: ${currentCompanyDocumentId}`);
                console.log(`📂 Percorso base convocazioni/presenze: ${basePath}`);
                console.log(`📂 Percorso base availability (con Document ID): ${availabilityBasePath}`);

                // Listener for Mister's convocations history - using document ID path like giocatori and availability
                const historyBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;
                const historyCollectionRef = window.collection(window.db, `${historyBasePath}/convocations_history`);
                console.log(`📍 Percorso completo subcollection convocations_history: ${historyBasePath}/convocations_history`);
                const historyUnsub = window.onSnapshot(historyCollectionRef, (querySnapshot) => {
                    loadHistory(querySnapshot);
                });
                unsubscribeListeners.push(historyUnsub);

                // Listener for player attendance - using document ID path like other subcollections
                const attendanceBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;
                const attendanceCollectionRef = window.collection(window.db, `${attendanceBasePath}/player_attendance`);
                console.log(`📍 Percorso completo subcollection player_attendance: ${attendanceBasePath}/player_attendance`);
                const attendanceUnsub = window.onSnapshot(attendanceCollectionRef, (querySnapshot) => {
                    loadAttendance(querySnapshot);
                });
                unsubscribeListeners.push(attendanceUnsub);
                
                // Listener for Marco's unavailable players list - using document ID path
                const unavailableDocRef = window.doc(window.db, `${availabilityBasePath}/availability`, "marco_unavailable");
                console.log(`📍 Percorso completo subcollection availability: ${availabilityBasePath}/availability/marco_unavailable`);
                const unavailableUnsub = window.onSnapshot(unavailableDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().players) {
                        unavailablePlayers = new Map(Object.entries(docSnap.data().players));
                        console.log(`✅ Caricata availability subcollection da: ${availabilityBasePath}/availability/marco_unavailable (${unavailablePlayers.size} giocatori non disponibili)`);
                    } else {
                        unavailablePlayers = new Map();
                        console.log(`📝 Subcollection 'availability' vuota o non trovata per società document ID ${currentCompanyDocumentId}`);
                    }
                    renderPlayers(); // Re-render players with new unavailable status
                    updateUnavailablePlayersView(); // Update Mister's view
                });
                unsubscribeListeners.push(unavailableUnsub);
                
                // Listener for notes - using document ID path like giocatori and availability
                const notesBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${appId}/public/data`;
                const notesDocRef = window.doc(window.db, `${notesBasePath}/notes`, "marco_notes");
                console.log(`📍 Percorso completo subcollection notes: ${notesBasePath}/notes/marco_notes`);
                const notesUnsub = window.onSnapshot(notesDocRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().content) {
                        currentNotes = docSnap.data().content;
                        console.log(`✅ Caricata notes subcollection da: ${notesBasePath}/notes/marco_notes`);
                    } else {
                        currentNotes = '';
                        console.log(`📝 Subcollection 'notes' vuota o non trovata per società document ID ${currentCompanyDocumentId}`);
                    }
                    updateNotesDisplay();
                });
                unsubscribeListeners.push(notesUnsub);
            }

            // Function to save data based on role
            async function saveData() {
                if (!window.db || !window.auth.currentUser) {
                    showMessage("Errore: Firebase non è ancora pronto. Riprova tra un attimo.", "text-red-600");
                    return;
                }

                // Use company-specific paths
                const basePath = currentCompanyCode ? `societa/${currentCompanyCode}` : `artifacts/${currentAppId}/public/data`;
                
                // For availability subcollection, use document ID instead of company code
                const availabilityBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;

                if (userRole === 'mister') {
                    const matchDetails = getMatchDetails();
                    const selectedPlayers = getSelectedPlayers();
                    
                    // For Torneo type, avversario field should contain trophy emoji or be considered valid
                    const isValidAvversario = matchDetails.tipo === 'Torneo' ? 
                        (matchDetails.avversario === '🏆' || matchDetails.avversario) :
                        matchDetails.avversario;
                    
                    if (!isValidAvversario || selectedPlayers.length === 0) {
                        const missingFields = [];
                        if (!isValidAvversario) {
                            missingFields.push(matchDetails.tipo === 'Torneo' ? 'tipo torneo' : 'avversario');
                        }
                        if (selectedPlayers.length === 0) {
                            missingFields.push('almeno un giocatore');
                        }
                        showMessage(`Inserisci ${missingFields.join(' e ')} per salvare.`, "text-red-600");
                        return;
                    }

                    // Sort players alphabetically ignoring numbers before names
                    const sortedPlayers = selectedPlayers.sort((a, b) => a.replace(/^\d+\s*/, '').localeCompare(b.replace(/^\d+\s*/, '')));

                    try {
                        // Use document ID path for convocations_history like giocatori and availability
                        const historyBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;
                        console.log(`💾 Salvando convocazione per società document ID: ${currentCompanyDocumentId}`);
                        console.log(`📂 Percorso salvataggio convocations_history: ${historyBasePath}/convocations_history`);
                        
                        await window.addDoc(window.collection(window.db, `${historyBasePath}/convocations_history`), {
                            details: matchDetails,
                            players: sortedPlayers,
                            createdAt: new Date().toISOString()
                        });

                        for (const player of sortedPlayers) {
                            const playerDocRef = window.doc(window.db, `${historyBasePath}/player_attendance`, player);
                            await window.setDoc(playerDocRef, { count: window.increment(1) }, { merge: true });
                        }

                        showSuccessPopup("Convocazione salvata e presenze aggiornate!");
                        
                        // Auto-reset fields after successful save for Mister role only
                        resetMisterSelectionsWithoutConfirm();
                    } catch (e) {
                        console.error("Errore salvataggio su Firestore: ", e);
                        showMessage("Errore durante il salvataggio. Controlla la console.", "text-red-600");
                    }
                } else if (isDirigente()) {
                    const unavailablePlayersObject = Object.fromEntries(unavailablePlayers);
                    const unavailableDocRef = window.doc(window.db, `${availabilityBasePath}/availability`, "marco_unavailable");
                    
                    console.log(`💾 Salvando lista giocatori non disponibili per società document ID: ${currentCompanyDocumentId}`);
                    console.log(`📂 Percorso salvataggio availability: ${availabilityBasePath}/availability/marco_unavailable`);
                    
                    try {
                        await window.setDoc(unavailableDocRef, { players: unavailablePlayersObject });
                        showSuccessPopup("Lista di giocatori non disponibili salvata!");
                        console.log(`✅ Lista giocatori non disponibili salvata con successo (${Object.keys(unavailablePlayersObject).length} giocatori)`);
                    } catch (e) {
                        console.error("Errore salvataggio su Firestore: ", e);
                        showMessage("Errore durante il salvataggio. Controlla la console.", "text-red-600");
                    }
                }
            }

            // Function to load and display history from Firestore
            function loadHistory(querySnapshot) {
                historyList.innerHTML = '';
                convocationHistory = []; // reset convocation history data
                if (querySnapshot.empty) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Nessuna convocazione registrata.</p>';
                    console.log(`📝 Subcollection 'convocations_history' vuota o non trovata per società document ID ${currentCompanyDocumentId}`);
                    // Update attendance tables even if no history (to show empty state)
                    updateAttendanceTables();
                    return;
                }
                const history = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const historyItem = { ...data, id: doc.id };
                    history.push(historyItem);
                    convocationHistory.push(historyItem); // store for attendance filtering
                });
                // Sort by createdAt descending
                history.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                history.forEach(data => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                    const createdAt = new Date(data.createdAt);
                    const formattedDate = createdAt.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
                    const formattedTime = createdAt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                    // Format match date with uppercase day of week
                    let formattedMatchDate = data.details.data;
                    if (data.details.data !== 'N/D') {
                        const matchDate = new Date(data.details.data + 'T00:00:00');
                        const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                        const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                        const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                        formattedMatchDate = `${dayOfWeek} ${dateString}`;
                    }

                    item.innerHTML = `
                        <div class="font-bold text-lg mb-2 text-gray-800">${data.details.avversario}</div>
                        <div class="text-sm text-gray-600 mb-2">
                            <p>Salvataggio: ${formattedDate} alle ${formattedTime}</p>
                            <p>🏟️ Campo: ${data.details.campo}</p>
                            <p>📅 Data Partita: ${formattedMatchDate}</p>
                            <p>🕒 Orario Convocazione: ${data.details.orarioConvocazione}</p>
                            <p>🕒 Orario Partita: ${data.details.orarioPartita}</p>
                            <p>Tipo: ${data.details.tipo || 'N/D'}</p>
                            <p>👤 Mister: ${data.details.misterPartita || 'N/D'}</p>
                            <p>👤 Mister: ${data.details.misterTipo || 'N/D'}</p>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p class="font-semibold mb-1">Giocatori:</p>
                            <ul class="list-disc list-inside space-y-0.5">
                                ${data.players.map(p => {
                                    if (typeof p === 'string') {
                                        return `<li>${p}</li>`;
                                    } else {
                                        return `<li>${p.numero} ${p.nome}</li>`;
                                    }
                                }).join('')}
                            </ul>
                        </div>
                        <div class="mt-3 flex gap-2">
                            ${canShareHistory() ? `<button class="share-history-btn bg-blue-500 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded" data-convocation='${safeJSONStringify(data)}'>Condividi</button>` : ''}
                            ${canAccessDistinta() ? `<button class="distinta-history-btn bg-green-500 hover:bg-green-700 text-white text-xs px-3 py-1 rounded" data-convocation='${safeJSONStringify(data)}'>Distinta</button>` : ''}
                            ${isDirigente() ? `<button class="delete-history-btn bg-red-500 hover:bg-red-700 text-white text-xs px-3 py-1 rounded" data-docid="${data.id}">Elimina</button>` : ''}
                        </div>
                    `;
                    historyList.appendChild(item);
                });

                // Listener sui pulsanti "Elimina"
                if (isDirigente()) {
                    const deleteButtons = historyList.querySelectorAll('.delete-history-btn');
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const docId = btn.getAttribute('data-docid');
                            if (confirm('Vuoi davvero eliminare questa partita dallo storico?')) {
                                try {
                                    // Use document ID path for convocations_history like other subcollections
                                    const historyBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;
                                    console.log(`🗑️ Eliminando convocazione per società document ID: ${currentCompanyDocumentId}`);
                                    console.log(`📂 Percorso eliminazione: ${historyBasePath}/convocations_history/${docId}`);
                                    
                                    // Recupera i giocatori coinvolti e aggiorna le presenze
                                    const docRef = window.doc(window.db, `${historyBasePath}/convocations_history`, docId);
                                    const docSnap = await window.getDoc(docRef);
                                    if (docSnap.exists()) {
                                        const convocazione = docSnap.data();
                                        for (const player of convocazione.players) {
                                            const playerDocRef = window.doc(window.db, `${historyBasePath}/player_attendance`, player);
                                            await window.setDoc(playerDocRef, { count: window.increment(-1) }, { merge: true });
                                        }
                                    }
                                    await window.deleteDoc(docRef);
                                    showMessage('Partita eliminata e presenze aggiornate!', 'text-green-600');
                                } catch (err) {
                                    showMessage('Errore eliminazione: ' + err, 'text-red-600');
                                }
                            }
                        });
                    });
                }

                // Listener sui pulsanti "Condividi" per singole convocazioni
                const shareButtons = historyList.querySelectorAll('.share-history-btn');
                shareButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const convocationData = safeJSONParse(btn.getAttribute('data-convocation'));
                        if (convocationData) {
                            generateHistoryShareImage(convocationData);
                        } else {
                            showMessage("Errore nel recupero dei dati per la condivisione.", "text-red-600");
                        }
                    });
                });

                // Listener sui pulsanti "Distinta" per singole convocazioni
                if (canAccessDistinta()) {
                    const distintaButtons = historyList.querySelectorAll('.distinta-history-btn');
                    distintaButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            console.log('🎯 DISTINTA FLOW START: Distinta button clicked from storico convocazioni');
                            console.log('👤 User role:', userRole);
                            console.log('🏢 Company code:', currentCompanyCode);
                            
                            const convocationData = safeJSONParse(btn.getAttribute('data-convocation'));
                            console.log('📊 Raw convocation data from button attribute:', btn.getAttribute('data-convocation'));
                            console.log('📋 Parsed convocation data:', convocationData);
                            
                            if (convocationData) {
                                // Store the convocation data globally for the distinta generation
                                window.currentDistintaData = convocationData;
                                console.log('✅ DISTINTA FLOW: currentDistintaData stored globally:', window.currentDistintaData);
                                console.log('📍 DISTINTA FLOW: Showing location modal...');
                                showDistintaLocationModal();
                            } else {
                                console.error('❌ DISTINTA FLOW ERROR: Failed to parse convocation data');
                                showMessage("Errore nel recupero dei dati per la distinta.", "text-red-600");
                            }
                        });
                    });
                }
                
                // Update filtered attendance tables after loading history data
                updateAttendanceTables();
                
                // Re-render players to apply already-called-today styling
                if (userRole === 'mister') {
                    renderPlayers();
                }
            }

            // Function to load and display attendance summary from Firestore
            function loadAttendance(querySnapshot) {
                console.log(`📊 [DIAGNOSTIC] loadAttendance chiamata, caricamento dati presenze...`);
                attendanceList.innerHTML = '';
                const attendanceData = {};
                querySnapshot.forEach(doc => {
                    attendanceData[doc.id] = doc.data().count;
                });
                
                // Use companyPlayers instead of global players array to show correct company data
                const playersToShow = companyPlayers.length > 0 ? companyPlayers : players;
                console.log(`📊 [DIAGNOSTIC] Visualizzazione presenze per ${playersToShow.length} giocatori della società`);
                
                const sortedPlayers = playersToShow.map(p => {
                    // Handle both old string format and new object format
                    let playerName, playerKey;
                    if (typeof p === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerName = p;
                        playerKey = p;
                    } else {
                        // New format: object with numero, nome, etc.
                        playerName = `${p.numero} ${p.nome}`;
                        playerKey = playerName; // Use the display name as key for compatibility
                    }
                    
                    return {
                        name: playerName,
                        count: attendanceData[playerKey] || 0
                    };
                }).sort((a, b) => b.count - a.count);

                sortedPlayers.forEach(player => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${player.count}</td>
                    `;
                    attendanceList.appendChild(row);
                });
                
                console.log(`📊 [DIAGNOSTIC] Tabella presenze aggiornata con ${sortedPlayers.length} giocatori`);
                
                // Update filtered attendance tables
                updateAttendanceTables();
            }

            // Function to update filtered attendance tables based on convocation history
            function updateAttendanceTables() {
                console.log(`📊 [DIAGNOSTIC] updateAttendanceTables chiamata con ${convocationHistory.length} convocazioni storiche`);
                
                // Clear all tables
                attendanceListAmichevoli.innerHTML = '';
                attendanceListTornei.innerHTML = '';
                attendanceListCampionato.innerHTML = '';
                
                // Calculate filtered attendance data
                const amichevoliData = {};
                const torneiData = {};
                const campionatoData = {};
                
                // Process each convocation and count players by type
                convocationHistory.forEach(convocation => {
                    const tipo = convocation.details?.tipo || 'N/D';
                    const players = convocation.players || [];
                    
                    players.forEach(player => {
                        // Handle both old string format and new object format
                        let playerKey;
                        if (typeof player === 'string') {
                            // Old format: "10 ROSSI MARIO"
                            playerKey = player;
                        } else {
                            // New format: object with numero, nome, etc.
                            playerKey = `${player.numero} ${player.nome}`;
                        }
                        
                        if (tipo === 'Amichevole') {
                            amichevoliData[playerKey] = (amichevoliData[playerKey] || 0) + 1;
                        } else if (tipo === 'Torneo') {
                            torneiData[playerKey] = (torneiData[playerKey] || 0) + 1;
                        } else if (tipo === 'Campionato') {
                            campionatoData[playerKey] = (campionatoData[playerKey] || 0) + 1;
                        }
                    });
                });
                
                // Use companyPlayers instead of global players array to show correct company data
                const playersToShow = companyPlayers.length > 0 ? companyPlayers : players;
                
                // Populate Amichevoli table
                populateAttendanceTable(attendanceListAmichevoli, playersToShow, amichevoliData, 'Amichevoli');
                
                // Populate Tornei table
                populateAttendanceTable(attendanceListTornei, playersToShow, torneiData, 'Tornei');
                
                // Populate Campionato table
                populateAttendanceTable(attendanceListCampionato, playersToShow, campionatoData, 'Campionato');
                
                console.log(`📊 [DIAGNOSTIC] Tabelle presenze filtrate aggiornate`);
            }

            // Helper function to populate a specific attendance table
            function populateAttendanceTable(tableElement, players, attendanceData, tableType) {
                const sortedPlayers = players.map(p => {
                    // Handle both old string format and new object format
                    let playerName, playerKey;
                    if (typeof p === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerName = p;
                        playerKey = p;
                    } else {
                        // New format: object with numero, nome, etc.
                        playerName = `${p.numero} ${p.nome}`;
                        playerKey = playerName; // Use the display name as key for compatibility
                    }
                    
                    return {
                        name: playerName,
                        count: attendanceData[playerKey] || 0
                    };
                }).sort((a, b) => b.count - a.count);

                if (sortedPlayers.length === 0) {
                    // Show empty state message only if no players at all
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="2" class="px-6 py-4 text-center text-gray-500 italic">
                            Nessun giocatore disponibile per ${tableType}
                        </td>
                    `;
                    tableElement.appendChild(row);
                } else {
                    // Show ALL players including those with 0 attendance
                    sortedPlayers.forEach(player => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${player.count}</td>
                        `;
                        tableElement.appendChild(row);
                    });
                }
            }

            // Demo version for loadHistory when Firebase is not available
            function loadHistoryDemo() {
                historyList.innerHTML = '';
                // Get today's date in YYYY-MM-DD format
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                
                // Create sample demo data for history using consistent player names from attendance data
                const demoHistory = [
                    {
                        id: 'demo-today',
                        createdAt: new Date().toISOString(),
                        details: {
                            avversario: 'Test Oggi',
                            campo: 'Campo Oggi',
                            data: todayString, // TODAY'S DATE
                            orarioConvocazione: '14:30',
                            orarioPartita: '15:00',
                            tipo: 'Amichevole'
                        },
                        players: ['10 AZZURRI LUCA', '1 ROSSI MARIO'] // Players called up today
                    },
                    {
                        id: 'demo-1',
                        createdAt: new Date(2024, 1, 15, 14, 30).toISOString(),
                        details: {
                            avversario: 'FC Demo Avversario',
                            campo: 'Campo Comunale Demo',
                            data: '2024-02-20',
                            orarioConvocazione: '14:30',
                            orarioPartita: '15:00',
                            tipo: 'Campionato'
                        },
                        players: ['1 ROSSI MARIO', '2 BIANCHI LUIGI', '3 VERDI GIUSEPPE']
                    },
                    {
                        id: 'demo-2',
                        createdAt: new Date(2024, 1, 8, 10, 15).toISOString(),
                        details: {
                            avversario: 'Squadra Test',
                            campo: 'Centro Sportivo',
                            data: '2024-02-10',
                            orarioConvocazione: '09:30',
                            orarioPartita: '10:00',
                            tipo: 'Amichevole'
                        },
                        players: ['10 AZZURRI LUCA', '4 NERI ANTONIO']
                    },
                    {
                        id: 'demo-3',
                        createdAt: new Date(2024, 1, 1, 16, 0).toISOString(),
                        details: {
                            avversario: '🏆 Torneo Cittadino',
                            campo: 'Stadio Principale',
                            data: '2024-02-05',
                            orarioConvocazione: '15:30',
                            orarioPartita: '16:00',
                            tipo: 'Torneo'
                        },
                        players: ['6 BLU MARCO', '5 GIALLI FRANCESCO', '8 ROSA ANDREA']
                    }
                ];

                // Set demo convocation history for attendance filtering
                convocationHistory = [...demoHistory];

                if (demoHistory.length === 0) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">Nessuna convocazione registrata. (Modalità Demo)</p>';
                    return;
                }

                demoHistory.forEach(data => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                    const createdAt = new Date(data.createdAt);
                    const formattedDate = createdAt.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
                    const formattedTime = createdAt.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

                    // Format match date with uppercase day of week
                    let formattedMatchDate = data.details.data;
                    if (data.details.data !== 'N/D') {
                        const matchDate = new Date(data.details.data + 'T00:00:00');
                        const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                        const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                        const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                        formattedMatchDate = `${dayOfWeek} ${dateString}`;
                    }

                    item.innerHTML = `
                        <div class="font-bold text-lg mb-2 text-gray-800">${data.details.avversario}</div>
                        <div class="text-sm text-gray-600 mb-2">
                            <p>Salvataggio: ${formattedDate} alle ${formattedTime}</p>
                            <p>🏟️Campo: ${data.details.campo}</p>
                            <p>📅 Data Partita: ${formattedMatchDate}</p>
                            <p>🕒 Orario Convocazione: ${data.details.orarioConvocazione}</p>
                            <p>🕒 Orario Partita: ${data.details.orarioPartita}</p>
                            <p>Tipo: ${data.details.tipo || 'N/D'}</p>
                            <p>👤 Mister Partita: ${data.details.misterPartita || 'N/D'}</p>
                            <p>👤 Mister Tipo: ${data.details.misterTipo || 'N/D'}</p>
                        </div>
                        <div class="text-sm text-gray-700">
                            <p class="font-semibold mb-1">Giocatori:</p>
                            <ul class="list-disc list-inside space-y-0.5">
                                ${data.players.map(p => {
                                    if (typeof p === 'string') {
                                        return `<li>${p}</li>`;
                                    } else {
                                        return `<li>${p.numero} ${p.nome}</li>`;
                                    }
                                }).join('')}
                            </ul>
                        </div>
                        <div class="mt-3 flex gap-2">
                            ${canShareHistory() ? `<button class="share-history-btn bg-blue-500 hover:bg-blue-700 text-white text-xs px-3 py-1 rounded" data-convocation='${safeJSONStringify(data)}'>Condividi</button>` : ''}
                            ${canAccessDistinta() ? `<button class="distinta-history-btn bg-green-500 hover:bg-green-700 text-white text-xs px-3 py-1 rounded" data-convocation='${safeJSONStringify(data)}'>Distinta</button>` : ''}
                            ${isDirigente() ? `<button class="delete-history-btn bg-red-500 hover:bg-red-700 text-white text-xs px-3 py-1 rounded" data-docid="${data.id}">Elimina (Demo)</button>` : ''}
                        </div>
                        <div class="mt-2 text-xs text-blue-600 italic">Modalità Demo - Dati di esempio</div>
                    `;
                    historyList.appendChild(item);
                });

                // Add demo event handlers
                const shareButtons = historyList.querySelectorAll('.share-history-btn');
                shareButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const convocationData = safeJSONParse(btn.getAttribute('data-convocation'));
                        if (convocationData) {
                            generateHistoryShareImage(convocationData);
                        } else {
                            showMessage("Errore nel recupero dei dati per la condivisione.", "text-red-600");
                        }
                    });
                });

                const deleteButtons = historyList.querySelectorAll('.delete-history-btn');
                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        alert('Modalità Demo - La funzione di eliminazione non è disponibile');
                    });
                });
                
                // Update filtered attendance tables after loading demo history data
                updateAttendanceTables();
            }

            // Demo version for loadAttendance when Firebase is not available
            function loadAttendanceDemo() {
                attendanceList.innerHTML = '';
                // Create sample demo attendance data based on demo players
                const demoPlayers = ['1 DEMO MARIO', '2 TEST LUIGI', '3 EXAMPLE GIUSEPPE', '4 SAMPLE ANTONIO'];
                const demoAttendanceData = {
                    '1 DEMO MARIO': 15,
                    '2 TEST LUIGI': 12,
                    '3 EXAMPLE GIUSEPPE': 8,
                    '4 SAMPLE ANTONIO': 5,
                    '10 AZZURRI LUCA': 18,
                    '2 BIANCHI LUIGI': 14,
                    '6 BLU MARCO': 11,
                    '5 GIALLI FRANCESCO': 9,
                    '9 GRIGIO PAOLO': 7,
                    '4 NERI ANTONIO': 13,
                    '8 ROSA ANDREA': 6,
                    '1 ROSSI MARIO': 16,
                    '3 VERDI GIUSEPPE': 10,
                    '7 VIOLA STEFANO': 4
                };
                
                const playersToShow = companyPlayers.length > 0 ? companyPlayers : demoPlayers;
                const sortedPlayers = playersToShow.map(p => {
                    // Handle both old string format and new object format
                    let playerName, playerKey;
                    if (typeof p === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerName = p;
                        playerKey = p;
                    } else {
                        // New format: object with numero, nome, etc.
                        playerName = `${p.numero} ${p.nome}`;
                        playerKey = playerName; // Use the display name as key for compatibility
                    }
                    
                    return {
                        name: playerName,
                        count: demoAttendanceData[playerKey] || 0
                    };
                }).sort((a, b) => b.count - a.count);

                sortedPlayers.forEach(player => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${player.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${player.count} <span class="text-xs text-blue-600">(Demo)</span></td>
                    `;
                    attendanceList.appendChild(row);
                });
                
                // Update filtered attendance tables for demo mode
                updateAttendanceTables();
                
                // Re-render players to apply already-called-today styling
                if (userRole === 'mister') {
                    renderPlayers();
                }
            }

            function renderPlayers() {
                playersList.innerHTML = '';
                const playersToRender = companyPlayers.length > 0 ? companyPlayers : players;
                playersToRender.forEach(player => {
                    const li = document.createElement('li');
                    
                    // Handle both old string format and new object format
                    let displayName, playerKey;
                    if (typeof player === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        displayName = player;
                        playerKey = player;
                    } else {
                        // New format: object with numero, nome, etc.
                        displayName = `${player.numero} ${player.nome}`;
                        playerKey = displayName; // Use the display name as key for compatibility
                    }
                    
                    li.textContent = displayName;
                    li.className = 'player-item p-3 bg-white text-gray-800 rounded-lg shadow-sm border border-gray-200';
                    li.dataset.player = playerKey;
                    
                    // Check if player was already called up today FIRST (highest priority for Mister view)
                    if (userRole === 'mister' && isPlayerCalledToday(playerKey)) {
                        li.classList.add('already-called-today');
                    }
                    // Check for unavailable players (only if not already called today)
                    else if (unavailablePlayers.has(playerKey)) {
                        const status = unavailablePlayers.get(playerKey);
                        if (status === 'Infortunato' || status === 'Squalificato') {
                            li.classList.add('selected-marco-black');
                        } else if (status === 'Non disponibile Sabato' || status === 'Non disponibile Domenica') {
                            li.classList.add('selected-marco-purple');
                        } else if (status === 'Solo 2 allenamenti' || status === 'Solo 1 allenamento') {
                            li.classList.add('selected-marco-orange');
                        } else if (status === 'Zero allenamenti' || status === 'Non disponibile Weekend') {
                            li.classList.add('selected-marco');
                        } else {
                            li.classList.add('selected-marco');
                        }
                    }

                    li.addEventListener('click', () => {
                        if (userRole === 'mister') {
                            if (unavailablePlayers.has(playerKey)) {
                                const status = unavailablePlayers.get(playerKey);
                                showUnavailablePlayerModal(playerKey, status);
                                return; // Don't allow selection of unavailable players (unless forzato)
                            }
                            
                            // Check if player was already called up today
                            if (isPlayerCalledToday(playerKey)) {
                                showAlreadyCalledModal(playerKey);
                                return; // Show confirmation modal instead of direct selection
                            }
                            
                            li.classList.toggle('selected-mister');
                            updateSelectedPlayersLiveList(playerKey, li.classList.contains('selected-mister'));
                        } else if (isDirigente()) {
                            tempPlayerName = playerKey;
                            showModal();
                        }
                    });
                    playersList.appendChild(li);
                });
            }

            function updateSelectedPlayersLiveList(playerName, isSelected) {
                const liveId = `live-${playerName.replace(/\s+/g, '-')}`;
                if (isSelected) {
                    const newLi = document.createElement('li');
                    newLi.textContent = playerName;
                    newLi.id = liveId;
                    newLi.className = "font-medium p-1";
                    selectedPlayersLiveList.appendChild(newLi);
                } else {
                    const playerToRemove = document.getElementById(liveId);
                    if (playerToRemove) {
                        playerToRemove.remove();
                    }
                }
                
                // Update title with player count
                updateSelectedPlayersTitle();
            }
            
            function updateSelectedPlayersTitle() {
                const count = selectedPlayersLiveList.children.length;
                if (selectedPlayersTitle) {
                    selectedPlayersTitle.textContent = `Giocatori Convocati (${count})`;
                }
            }

            function getSelectedPlayers() {
                if (userRole === 'mister') {
                    return Array.from(document.querySelectorAll('.player-item.selected-mister')).map(item => item.textContent);
                }
                return Array.from(unavailablePlayers.keys());
            }

            function getMatchDetails() {
                return {
                    campo: document.getElementById('campo').value || 'N/D',
                    avversario: document.getElementById('avversario').value || 'N/D',
                    data: document.getElementById('data-partita').value || 'N/D',
                    orarioConvocazione: document.getElementById('orario-convocazione').value || 'N/D',
                    orarioPartita: document.getElementById('orario-partita').value || 'N/D',
                    tipo: document.getElementById('tipo-partita').value || 'N/D',
                    misterPartita: document.getElementById('mister-partita').value || 'N/D',
                    misterTipo: document.getElementById('mister-tipo').value || 'N/D',
                };
            }

            // Helper function to reset Mister's selections without confirmation dialog
            function resetMisterSelectionsWithoutConfirm() {
                if (userRole === 'mister') {
                    // Clear only Mister's selected players from UI
                    const selectedPlayers = document.querySelectorAll('.player-item.selected-mister');
                    selectedPlayers.forEach(player => {
                        player.classList.remove('selected-mister');
                    });

                    // Clear the live selected players list
                    if (selectedPlayersLiveList) {
                        selectedPlayersLiveList.innerHTML = '';
                        updateSelectedPlayersTitle();
                    }

                    // Clear match details form
                    const campos = ['campo', 'avversario', 'data-partita', 'orario-convocazione', 'orario-partita'];
                    campos.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            field.value = '';
                            // Reset avversario field styling if it was modified for Torneo
                            if (fieldId === 'avversario') {
                                field.readOnly = false;
                                field.style.backgroundColor = 'white';
                                field.style.textAlign = 'left';
                                field.style.fontSize = '';
                            }
                        }
                    });
                    
                    // Reset tipo partita dropdown
                    const tipoPartita = document.getElementById('tipo-partita');
                    if (tipoPartita) {
                        tipoPartita.selectedIndex = 0;
                    }
                    
                    // Reset mister dropdowns
                    const misterPartita = document.getElementById('mister-partita');
                    const misterTipo = document.getElementById('mister-tipo');
                    if (misterPartita) {
                        misterPartita.selectedIndex = 0;
                    }
                    if (misterTipo) {
                        misterTipo.selectedIndex = 0;
                    }

                    // Clear localStorage data related to match details (keep unavailable players)
                    localStorage.removeItem('selectedPlayers');
                    localStorage.removeItem('matchDetails');

                    // Re-render players to ensure UI is clean (this preserves unavailable players styling)
                    renderPlayers();
                }
            }

            function resetPlayerSelections() {
                if (userRole === 'mister') {
                    // Mister role: only reset his selections, keep Dirigente's unavailable players
                    if (confirm('Sei sicuro di voler azzerare le tue convocazioni? Questa azione non può essere annullata.')) {
                        resetMisterSelectionsWithoutConfirm();
                        // Show success message
                        showMessage("Le tue convocazioni sono state azzerate. I giocatori non disponibili segnalati dal Dirigente sono rimasti invariati.", "text-green-600");
                    }
                } else if (isDirigente()) {
                    // Dirigente role: reset everything including unavailable players
                    if (confirm('Sei sicuro di voler azzerare tutte le selezioni e le indisponibilità? Questa azione non può essere annullata.')) {
                        // Clear all selected players from UI
                        const selectedPlayers = document.querySelectorAll('.player-item.selected-mister');
                        selectedPlayers.forEach(player => {
                            player.classList.remove('selected-mister');
                        });

                        // Clear unavailable players (for dirigente role)
                        unavailablePlayers.clear();

                        // Clear the live selected players list
                        if (selectedPlayersLiveList) {
                            selectedPlayersLiveList.innerHTML = '';
                            updateSelectedPlayersTitle();
                        }

                        // Clear match details form
                        const campos = ['campo', 'avversario', 'data-partita', 'orario-convocazione', 'orario-partita'];
                        campos.forEach(fieldId => {
                            const field = document.getElementById(fieldId);
                            if (field) {
                                field.value = '';
                                // Reset avversario field styling if it was modified for Torneo
                                if (fieldId === 'avversario') {
                                    field.readOnly = false;
                                    field.style.backgroundColor = 'white';
                                    field.style.textAlign = 'left';
                                    field.style.fontSize = '';
                                }
                            }
                        });
                        
                        // Reset tipo partita dropdown
                        const tipoPartita = document.getElementById('tipo-partita');
                        if (tipoPartita) {
                            tipoPartita.selectedIndex = 0;
                        }

                        // Clear any localStorage data related to selections
                        localStorage.removeItem('selectedPlayers');
                        localStorage.removeItem('matchDetails');

                        // Re-render players to ensure UI is clean
                        renderPlayers();

                        // Show success message
                        showMessage("Tutte le selezioni e le indisponibilità sono state azzerate.", "text-green-600");
                    }
                }
            }

            // Share handler functions
            let shareImageDataUrl = null; // Store generated image for sharing

            // Safe JSON functions for HTML attributes to prevent parsing errors
            function safeJSONStringify(obj) {
                try {
                    const jsonString = JSON.stringify(obj);
                    // Escape quotes and other special characters for HTML attributes
                    return jsonString
                        .replace(/'/g, '&#39;')  // Replace single quotes
                        .replace(/"/g, '&quot;') // Replace double quotes
                        .replace(/</g, '&lt;')   // Replace less than
                        .replace(/>/g, '&gt;')   // Replace greater than
                        .replace(/&/g, '&amp;'); // Replace ampersand (do this last)
                } catch (error) {
                    console.error('Error stringifying JSON:', error);
                    return '{}';
                }
            }

            function safeJSONParse(str) {
                try {
                    if (!str) return null;
                    // Unescape HTML entities back to original characters
                    const unescaped = str
                        .replace(/&amp;/g, '&')    // Restore ampersand (do this first)
                        .replace(/&lt;/g, '<')     // Restore less than
                        .replace(/&gt;/g, '>')     // Restore greater than
                        .replace(/&quot;/g, '"')   // Restore double quotes
                        .replace(/&#39;/g, "'");   // Restore single quotes
                    return JSON.parse(unescaped);
                } catch (error) {
                    console.error('Error parsing JSON:', error, 'Original string:', str);
                    return null;
                }
            }

            async function handleWebShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    // Prepare share data
                    const shareText = `🏟️ Convocazioni Ufficiali 🏟️\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario: ${matchDetails.orarioPartita}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\n⚽ Rosterkick`;
                    
                    // Try Web Share API with files first (for browsers that support it)
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert data URL to blob
                            const response = await fetch(shareImageDataUrl);
                            const blob = await response.blob();
                            const file = new File([blob], `convocazioni-${matchDetails.avversario}.png`, { type: 'image/png' });

                            const shareDataWithFile = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                files: [file]
                            };

                            // Check if sharing with files is supported
                            if (navigator.canShare(shareDataWithFile)) {
                                await navigator.share(shareDataWithFile);
                                hideShareModal();
                                showMessage("Convocazioni condivise con successo!", "text-green-600");
                                return;
                            }
                        } catch (fileShareError) {
                            console.log('File sharing not supported, trying text-only share');
                        }
                    }
                    
                    // Fallback to text-only Web Share API
                    if (navigator.share) {
                        try {
                            const shareDataTextOnly = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                url: window.location.href
                            };

                            await navigator.share(shareDataTextOnly);
                            hideShareModal();
                            showMessage("Testo condiviso! Condividi l'immagine manualmente se necessario.", "text-blue-600");
                            
                            // Also trigger download for user convenience
                            setTimeout(() => handleDownloadImage(), 1000);
                            return;
                        } catch (textShareError) {
                            console.log('Text sharing failed, falling back to download');
                        }
                    }
                    
                    // Final fallback: download the image
                    handleDownloadImage();
                    showMessage("Web Share non disponibile. Immagine scaricata!", "text-orange-600");
                    
                } catch (error) {
                    console.error('Errore nella condivisione:', error);
                    // If everything fails, offer download instead
                    if (shareImageDataUrl) {
                        handleDownloadImage();
                        showMessage("Errore nella condivisione. Immagine scaricata!", "text-red-600");
                    } else {
                        showMessage("Errore nella condivisione. Prova con un'altra opzione.", "text-red-600");
                    }
                }
            }

            async function handleWhatsAppShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    const text = encodeURIComponent(`🏟️ Convocazioni Ufficiali 🏟️\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario: ${matchDetails.orarioPartita}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\n⚽ Rosterkick`);
                    
                    const whatsappUrl = `https://wa.me/?text=${text}`;
                    window.open(whatsappUrl, '_blank');
                    
                    hideShareModal();
                    showMessage("Link WhatsApp aperto! Condividi l'immagine manualmente.", "text-blue-600");
                    
                    // Also trigger download for user convenience
                    setTimeout(() => handleDownloadImage(), 1000);
                } catch (error) {
                    console.error('Errore WhatsApp:', error);
                    showMessage("Errore nell'apertura di WhatsApp.", "text-red-600");
                }
            }

            async function handleTelegramShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    const text = encodeURIComponent(`🏟️ Convocazioni Ufficiali 🏟️\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario: ${matchDetails.orarioPartita}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\n⚽ Rosterkick`);
                    
                    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${text}`;
                    window.open(telegramUrl, '_blank');
                    
                    hideShareModal();
                    showMessage("Link Telegram aperto! Condividi l'immagine manualmente.", "text-blue-600");
                    
                    // Also trigger download for user convenience
                    setTimeout(() => handleDownloadImage(), 1000);
                } catch (error) {
                    console.error('Errore Telegram:', error);
                    showMessage("Errore nell'apertura di Telegram.", "text-red-600");
                }
            }

            async function handleEmailShare() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    
                    const subject = encodeURIComponent(`Convocazioni per ${matchDetails.avversario}`);
                    const body = encodeURIComponent(`Convocazioni Ufficiali\n\nPartita: ${matchDetails.avversario}\nCampo: ${matchDetails.campo}\nData: ${matchDetails.data}\nOrario Partita: ${matchDetails.orarioPartita}\nOrario Convocazione: ${matchDetails.orarioConvocazione}\n\nGiocatori convocati (${selectedPlayers.length}):\n${selectedPlayers.join('\n')}\n\nGenerato con Rosterkick`);
                    
                    const emailUrl = `mailto:?subject=${subject}&body=${body}`;
                    window.location.href = emailUrl;
                    
                    hideShareModal();
                    showMessage("Client email aperto! Aggiungi l'immagine come allegato.", "text-blue-600");
                    
                    // Also trigger download for user convenience
                    setTimeout(() => handleDownloadImage(), 1000);
                } catch (error) {
                    console.error('Errore Email:', error);
                    showMessage("Errore nell'apertura del client email.", "text-red-600");
                }
            }

            async function handleCopyLink() {
                try {
                    shareImageDataUrl = await generateShareImageData();
                    if (!shareImageDataUrl) return;

                    // Copy the data URL to clipboard
                    await navigator.clipboard.writeText(shareImageDataUrl);
                    
                    hideShareModal();
                    showMessage("Link immagine copiato negli appunti!", "text-green-600");
                } catch (error) {
                    console.error('Errore copia link:', error);
                    // Fallback: offer download instead
                    showMessage("Impossibile copiare il link. Scarico l'immagine...", "text-yellow-600");
                    handleDownloadImage();
                }
            }

            async function handleDownloadImage() {
                try {
                    if (!shareImageDataUrl) {
                        shareImageDataUrl = await generateShareImageData();
                    }
                    if (!shareImageDataUrl) return;

                    const matchDetails = getMatchDetails();
                    const link = document.createElement('a');
                    link.href = shareImageDataUrl;
                    link.download = `convocazioni-${matchDetails.avversario}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    hideShareModal();
                    showMessage("Immagine scaricata con successo!", "text-green-600");
                } catch (error) {
                    console.error('Errore download:', error);
                    showMessage("Errore nel download dell'immagine.", "text-red-600");
                }
            }

            // Helper function to generate image data without downloading
            async function generateShareImageData() {
                try {
                    const selectedPlayers = getSelectedPlayers();
                    const matchDetails = getMatchDetails();
                    const sharePlayersList = document.getElementById('share-players-list');
                    sharePlayersList.innerHTML = '';
                    document.getElementById('share-campo').textContent = matchDetails.campo;
                    document.getElementById('share-avversario').textContent = matchDetails.avversario;
                    
                    let formattedDate = 'N/D';
                    if (matchDetails.data !== 'N/D') {
                        const dateObj = new Date(matchDetails.data + 'T00:00:00'); 
                        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                        formattedDate = dateObj.toLocaleDateString('it-IT', options);
                    }
                    
                    document.getElementById('share-data-partita').textContent = formattedDate;
                    document.getElementById('share-orario-convocazione').textContent = matchDetails.orarioConvocazione;
                    document.getElementById('share-orario-partita').textContent = matchDetails.orarioPartita;
                    document.getElementById('share-tipo').textContent = matchDetails.tipo;
                    document.getElementById('share-mister-partita').textContent = matchDetails.misterPartita || 'N/D';
                    document.getElementById('share-mister-tipo').textContent = matchDetails.misterTipo || 'N/D';

                    if (selectedPlayers.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = "Nessun giocatore convocato.";
                        li.className = "text-gray-500 italic text-center";
                        sharePlayersList.appendChild(li);
                    } else {
                        selectedPlayers.forEach(player => {
                            const li = document.createElement('li');
                            if (typeof player === 'string') {
                                li.textContent = player;
                            } else {
                                li.textContent = `${player.numero} ${player.nome}`;
                            }
                            li.className = 'font-medium';
                            sharePlayersList.appendChild(li);
                        });
                    }
                    
                    const shareView = document.getElementById('share-view');
                    shareView.style.position = 'relative';
                    shareView.style.top = '0';
                    shareView.style.left = '0';
                    
                    const canvas = await html2canvas(shareView, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imageDataUrl = canvas.toDataURL("image/png");
                    
                    // Reset share view position
                    shareView.style.position = 'absolute';
                    shareView.style.top = '-9999px';
                    shareView.style.left = '-9999px';
                    
                    return imageDataUrl;
                } catch (error) {
                    console.error('Errore generazione immagine:', error);
                    showMessage("Errore nella generazione dell'immagine.", "text-red-600");
                    return null;
                }
            }

            async function generateShareImage() {
                // This function is kept for backward compatibility
                // but now it just downloads the image directly
                await handleDownloadImage();
            }

            async function generateHistoryShareImage(convocationData) {
                try {
                    // Populate share view with historical convocation data
                    const sharePlayersList = document.getElementById('share-players-list');
                    sharePlayersList.innerHTML = '';
                    document.getElementById('share-campo').textContent = convocationData.details.campo;
                    document.getElementById('share-avversario').textContent = convocationData.details.avversario;
                    
                    // Format match date with uppercase day of week for share image
                    let formattedDate = convocationData.details.data;
                    if (convocationData.details.data !== 'N/D') {
                        const matchDate = new Date(convocationData.details.data + 'T00:00:00');
                        const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                        const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                        const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                        formattedDate = `${dayOfWeek} ${dateString}`;
                    }
                    
                    document.getElementById('share-data-partita').textContent = formattedDate;
                    document.getElementById('share-orario-convocazione').textContent = convocationData.details.orarioConvocazione;
                    document.getElementById('share-orario-partita').textContent = convocationData.details.orarioPartita;
                    document.getElementById('share-tipo').textContent = convocationData.details.tipo || 'N/D';
                    document.getElementById('share-mister-partita').textContent = convocationData.details.misterPartita || 'N/D';
                    document.getElementById('share-mister-tipo').textContent = convocationData.details.misterTipo || 'N/D';

                    if (convocationData.players.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = "Nessun giocatore convocato.";
                        li.className = "text-gray-500 italic text-center";
                        sharePlayersList.appendChild(li);
                    } else {
                        convocationData.players.forEach(player => {
                            const li = document.createElement('li');
                            if (typeof player === 'string') {
                                li.textContent = player;
                            } else {
                                li.textContent = `${player.numero} ${player.nome}`;
                            }
                            li.className = 'font-medium';
                            sharePlayersList.appendChild(li);
                        });
                    }

                    // Generate image from share view
                    shareView.style.position = 'relative';
                    shareView.style.top = '0';
                    shareView.style.left = '0';
                    
                    const canvas = await html2canvas(shareView, {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imageDataUrl = canvas.toDataURL("image/png");
                    
                    // Reset share view position
                    shareView.style.position = 'absolute';
                    shareView.style.top = '-9999px';
                    shareView.style.left = '-9999px';

                    // Prepare share text for historical convocation
                    const shareText = `🏟️ Convocazioni Ufficiali 🏟️\n\nPartita: ${convocationData.details.avversario}\nCampo: ${convocationData.details.campo}\nData: ${formattedDate}\nOrario: ${convocationData.details.orarioPartita}\n\nGiocatori convocati (${convocationData.players.length}):\n${convocationData.players.join('\n')}\n\n⚽ Rosterkick`;

                    // Detect if user is on mobile device
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                     (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));

                    // Try Web Share API first (prioritize on mobile)
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert data URL to blob
                            const response = await fetch(imageDataUrl);
                            const blob = await response.blob();
                            const file = new File([blob], `convocazioni-${convocationData.details.avversario}-${new Date(convocationData.createdAt).toLocaleDateString('it-IT')}.png`, { type: 'image/png' });

                            const shareDataWithFile = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                files: [file]
                            };

                            // Check if sharing with files is supported
                            if (navigator.canShare(shareDataWithFile)) {
                                await navigator.share(shareDataWithFile);
                                showMessage("Convocazione condivisa con successo!", "text-green-600");
                                return;
                            }
                        } catch (fileShareError) {
                            console.log('File sharing not supported for history, trying text-only share');
                        }
                    }
                    
                    // Fallback to text-only Web Share API
                    if (navigator.share) {
                        try {
                            const shareDataTextOnly = {
                                title: 'Convocazioni Ufficiali',
                                text: shareText,
                                url: window.location.href
                            };

                            await navigator.share(shareDataTextOnly);
                            showMessage("Testo condiviso! Condividi l'immagine manualmente se necessario.", "text-blue-600");
                            
                            // Also trigger download for user convenience
                            setTimeout(() => downloadHistoryImage(imageDataUrl, convocationData), 1000);
                            return;
                        } catch (textShareError) {
                            console.log('Text sharing failed for history, falling back to download');
                        }
                    }
                    
                    // Final fallback: download the image
                    downloadHistoryImage(imageDataUrl, convocationData);
                    showMessage("Web Share non disponibile. Immagine scaricata!", "text-orange-600");
                    
                } catch (error) {
                    console.error('Errore nella condivisione dello storico:', error);
                    showMessage("Errore nella condivisione. Riprova più tardi.", "text-red-600");
                }
            }

            // Helper function to download history image
            function downloadHistoryImage(imageDataUrl, convocationData) {
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = `convocazioni-${convocationData.details.avversario}-${new Date(convocationData.createdAt).toLocaleDateString('it-IT')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function updateUIForRole() {
                if (userRole === 'mister') {
                    selectedPlayersTitle.textContent = "Giocatori Convocati";
                    playersListMessage.textContent = "Clicca sui nomi per selezionare i convocati.";
                    roleMessage.textContent = "Ciao Mister!! Qui puoi creare e salvare le convocazioni.";
                    roleMessage.classList.remove('hidden');
                    saveButton.textContent = "Salva Convocazione";
                    shareButton.disabled = false;
                    shareButton.style.display = ''; // Show share button for mister
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    shareButton.classList.replace('bg-gray-400', 'bg-blue-600');
                    historyButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    unavailablePlayersView.classList.remove('hidden');
                    unavailablePlayersView.style.display = ''; // Show for Mister
                    unavailablePlayersTitle.textContent = "Giocatori Non Disponibili (Segnalati dal Dirigente)";
                    matchDetailsSection.classList.remove('hidden');
                    matchDetailsSection.style.display = ''; // Show match details for Mister

                    // Show notes section for Mister (readonly)
                    notesSection.classList.remove('hidden');
                    notesEditable.classList.add('hidden');
                    notesReadonly.classList.remove('hidden');

                    // Show reset button for Mister
                    resetSelectionsButton.classList.remove('hidden');
                    
                    // Show mister selection dropdowns for Mister role
                    document.getElementById('mister-selection-1').classList.remove('hidden');
                    document.getElementById('mister-selection-2').classList.remove('hidden');
                    
                    // Populate mister dropdowns
                    populateMisterDropdowns();
                    
                    // Initialize avversario field based on current tipo-partita selection
                    const tipoPartitaSelect = document.getElementById('tipo-partita');
                    const avversarioInput = document.getElementById('avversario');
                    if (tipoPartitaSelect && avversarioInput && tipoPartitaSelect.value === 'Torneo') {
                        avversarioInput.value = '🏆';
                        avversarioInput.readOnly = true;
                        avversarioInput.style.backgroundColor = '#f9fafb';
                        avversarioInput.style.textAlign = 'center';
                        avversarioInput.style.fontSize = '1.5rem';
                    }

                    // Show ESCI button for Mister
                    esciButton.classList.remove('hidden');
                    
                    // Restore normal grid layout for mister (in case it was changed for dirigente)
                    const actionButtonsContainer = saveButton.parentElement;
                    if (!actionButtonsContainer.classList.contains('grid')) {
                        actionButtonsContainer.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'gap-4');
                        actionButtonsContainer.classList.remove('space-y-4');
                    }

                } else if (isDirigente()) {
                    selectedPlayersTitle.textContent = "";
                    playersListMessage.textContent = "Clicca sui nomi per segnalare l'indisponibilità.";
                    roleMessage.textContent = "Sei entrato come Dirigente. Puoi segnare e salvare i giocatori non disponibili.";
                    roleMessage.classList.remove('hidden');
                    saveButton.textContent = "Salva Indisponibilità";
                    shareButton.style.display = 'none'; // Hide share button completely for dirigente
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    historyButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    unavailablePlayersView.classList.remove('hidden');
                    unavailablePlayersView.style.display = ''; // Show unavailable players view for Marco
                    matchDetailsSection.classList.add('hidden');
                    matchDetailsSection.style.display = 'none'; // Hide match details for Marco
                    unavailablePlayersTitle.textContent = "Giocatori che hai segnato come non disponibili";
                    
                    // Hide mister selection dropdowns for Dirigente role
                    document.getElementById('mister-selection-1').classList.add('hidden');
                    document.getElementById('mister-selection-2').classList.add('hidden');

                    // Show notes section for Marco (editable)
                    notesSection.classList.remove('hidden');
                    notesEditable.classList.remove('hidden');
                    notesReadonly.classList.add('hidden');

                    // Show reset button for Dirigente
                    resetSelectionsButton.classList.remove('hidden');
                    
                    // Show ESCI button for Dirigente
                    esciButton.classList.remove('hidden');
                    
                    // Make SALVA INDISPONIBILITA button same width as STORICO CONVOCAZIONI for dirigente
                    // Change from grid layout to full width for save button
                    const actionButtonsContainer = saveButton.parentElement;
                    if (actionButtonsContainer.classList.contains('grid')) {
                        actionButtonsContainer.classList.remove('grid', 'grid-cols-1', 'sm:grid-cols-2', 'gap-4');
                        actionButtonsContainer.classList.add('space-y-4');
                        saveButton.classList.remove('w-full');
                        saveButton.classList.add('w-full');
                    }
                } else if (isGuestUser) {
                    // Guest user: limited functionality
                    selectedPlayersTitle.textContent = "";
                    playersListMessage.textContent = "Accesso Ospite - Solo visualizzazione.";
                    roleMessage.textContent = "Accesso ospite: puoi solo visualizzare lo storico e le presenze.";
                    roleMessage.classList.remove('hidden');
                    
                    // Hide main action buttons for guests
                    saveButton.style.display = 'none';
                    shareButton.style.display = 'none'; // Hide share button for guests
                    historyButton.disabled = false;
                    attendanceButton.disabled = false;
                    historyButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    attendanceButton.classList.replace('bg-gray-400', 'bg-purple-600');
                    
                    // Hide sections that are not relevant for guests
                    unavailablePlayersView.classList.add('hidden');
                    matchDetailsSection.classList.add('hidden');
                    notesSection.classList.add('hidden');
                    resetSelectionsButton.classList.add('hidden');
                    esciButton.classList.add('hidden');
                    
                    // Hide mister selection dropdowns for guest
                    document.getElementById('mister-selection-1').classList.add('hidden');
                    document.getElementById('mister-selection-2').classList.add('hidden');
                    
                    console.log('👤 Guest UI updated - limited functionality enabled');
                }
                
                updateNotesDisplay();
            }

            function updateUnavailablePlayersView() {
                unavailablePlayersList.innerHTML = '';
                if (unavailablePlayers.size === 0) {
                    unavailablePlayersList.innerHTML = '<li class="text-sm italic text-red-500">Nessuna disponibilità registrata.</li>';
                    return;
                }
                unavailablePlayers.forEach((status, player) => {
                    const li = document.createElement('li');
                    li.textContent = `${player}: ${status}`;
                    li.className = 'font-medium';
                    unavailablePlayersList.appendChild(li);
                });
            }

            function updateNotesDisplay() {
                if (isDirigente()) {
                    notesTextarea.value = currentNotes;
                } else if (userRole === 'mister') {
                    if (currentNotes.trim() === '') {
                        notesDisplay.innerHTML = '<span class="text-gray-500 italic">Nessuna nota registrata</span>';
                    } else {
                        notesDisplay.textContent = currentNotes;
                    }
                }
            }

            async function populateMisterDropdowns() {
                try {
                    const coaches = await loadCompanyCoaches();
                    const misterPartitaSelect = document.getElementById('mister-partita');
                    const misterTipoSelect = document.getElementById('mister-tipo');
                    
                    // Clear existing options (except the first default option)
                    misterPartitaSelect.innerHTML = '<option value="">Seleziona mister</option>';
                    misterTipoSelect.innerHTML = '<option value="">Seleziona mister</option>';
                    
                    // Populate both dropdowns with coaches
                    coaches.forEach(coach => {
                        const coachName = typeof coach === 'string' ? coach : coach.name;
                        const coachMatricola = typeof coach === 'object' && coach.matricola ? coach.matricola : '';
                        const displayText = coachMatricola ? `${coachName} (${coachMatricola})` : coachName;
                        
                        const option1 = document.createElement('option');
                        option1.value = coachName; // Use name as value for compatibility
                        option1.textContent = displayText;
                        misterPartitaSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = coachName; // Use name as value for compatibility
                        option2.textContent = displayText;
                        misterTipoSelect.appendChild(option2);
                    });
                } catch (error) {
                    console.error('Errore nel caricamento mister per i dropdown:', error);
                }
            }

            async function saveNotes() {
                if (!window.db || !window.auth.currentUser) {
                    showMessage("Errore: Firebase non è ancora pronto. Riprova tra un attimo.", "text-red-600");
                    return;
                }

                if (!isDirigente()) {
                    showMessage("Solo il Dirigente può modificare le note.", "text-red-600");
                    return;
                }

                const notesContent = notesTextarea.value.trim();
                // Use document ID path for notes like giocatori and availability
                const notesBasePath = currentCompanyDocumentId ? `societa/${currentCompanyDocumentId}` : `artifacts/${currentAppId}/public/data`;
                const notesDocRef = window.doc(window.db, `${notesBasePath}/notes`, "marco_notes");
                
                console.log(`💾 Salvando note per società document ID: ${currentCompanyDocumentId}`);
                console.log(`📂 Percorso salvataggio notes: ${notesBasePath}/notes/marco_notes`);
                
                try {
                    await window.setDoc(notesDocRef, { content: notesContent });
                    showSuccessPopup("Note salvate con successo!");
                } catch (e) {
                    console.error("Errore salvataggio note su Firestore: ", e);
                    showMessage("Errore durante il salvataggio delle note. Controlla la console.", "text-red-600");
                }
            }

            function showMessage(msg, colorClass) {
                messageArea.textContent = msg;
                messageArea.className = `mt-4 text-center text-sm font-medium ${colorClass}`;
                messageArea.style.display = 'block';
                setTimeout(() => {
                    messageArea.style.display = 'none';
                }, 5000);
            }

            function showSuccessPopup(message = "Salvataggio effettuato con successo") {
                const popup = document.getElementById('success-popup');
                const messageElement = document.getElementById('success-popup-message');
                
                messageElement.textContent = message;
                popup.classList.remove('hidden');
                
                // Auto-close after 3 seconds
                setTimeout(() => {
                    popup.classList.add('hidden');
                }, 3000);
            }

            function startApp(appId) {
                currentAppId = appId;
                
                appIdDisplay.textContent = currentAppId;
                currentAppIdDisplay.textContent = currentAppId;

                startScreen.classList.add('hidden');
                mainView.classList.remove('hidden');

                setupFirestoreListeners(currentAppId);
                renderPlayers();
                updateUIForRole();
            }

            function forgetDataAndReset() {
                localStorage.removeItem('convocazioniAppId');
                localStorage.removeItem('userRole');
                localStorage.removeItem('joinAppId');
                localStorage.removeItem('companyCode');
                localStorage.removeItem('companyData');
                window.location.reload(); 
            }

            function logoutToCompanyWelcome() {
                // Check if we're in a company context
                if (currentCompanyCode && currentCompanyData) {
                    // Remove only session-specific data, keep company data
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('convocazioniAppId');
                    
                    // Reset user role
                    userRole = null;
                    
                    // Return to company welcome screen
                    showCompanyWelcome();
                } else {
                    // If not in company context, fall back to full reset
                    forgetDataAndReset();
                }
            }

            /**
             * Checks if the company is POLIS PIEVE 2010 by checking config.nome, nome, or id
             * @param {Object} companyData - The company data object
             * @returns {boolean} - True if the company is POLIS PIEVE 2010
             */
            function isPolisPieve2010(companyData) {
                const societa = companyData?.data;
                if (!societa) return false;
                
                const configNome = societa?.config?.nome || '';
                const nome = societa?.nome || '';
                const id = societa?.id || '';
                
                const isMatch = configNome === 'POLIS PIEVE 2010' || 
                               nome === 'POLIS PIEVE 2010' || 
                               id === 'POLIS PIEVE 2010';
                
                console.log('🔍 DEBUG - isPolisPieve2010 check:', {
                    'config.nome': configNome,
                    'nome': nome,
                    'id': id,
                    'isPolisPieve2010': isMatch
                });
                
                return isMatch;
            }

            // --- Company Navigation Functions ---
            function showCompanyWelcome() {
                hideAllScreens();
                companyNameDisplay.textContent = currentCompanyData.name;
                
                // Log societa data for debugging
                console.log('📊 DEBUG - Societa data at login:', {
                    societa: currentCompanyData?.data,
                    isGuestLogin: currentCompanyData?.isGuestLogin
                });
                
                // Show/hide elements based on guest login status
                const guestRoleIndicator = document.getElementById('guest-role-indicator');
                const normalLoginButtons = document.getElementById('normal-login-buttons');
                const guestAllowedButtons = document.getElementById('guest-allowed-buttons');
                const adminButtons = document.getElementById('admin-buttons');
                
                if (currentCompanyData.isGuestLogin) {
                    // Guest login: show indicator and hide admin functions
                    guestRoleIndicator.classList.remove('hidden');
                    normalLoginButtons.classList.add('hidden');
                    adminButtons.classList.add('hidden');
                    
                    // Set guest user state
                    isGuestUser = true;
                    userRole = 'guest';
                    
                    // Show only guest-allowed buttons for guest users
                    guestAllowedButtons.classList.remove('hidden');
                    
                    // Hide training attendance button for guests by default
                    trainingAttendanceButton.classList.add('hidden');
                    
                    // Show training attendance for specific companies and guests
                    const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                    const isPolisCompany = companyName === 'POLIS';
                    // Check if company is POLIS PIEVE 2010 (checks config.nome, nome, or id)
                    const isPolisPieveCompany = isPolisPieve2010(currentCompanyData);
                    
                    if (isPolisCompany) {
                        trainingAttendanceButton.classList.remove('hidden');
                    }
                    
                    // Show/hide campionato button for POLIS PIEVE 2010 (also for guests)
                    if (isPolisPieveCompany) {
                        campionatoButton.classList.remove('hidden');
                    } else {
                        campionatoButton.classList.add('hidden');
                    }
                    
                    console.log('👤 Guest login detected - restricted UI enabled');
                } else {
                    // Normal login: hide guest indicator and show all options
                    guestRoleIndicator.classList.add('hidden');
                    normalLoginButtons.classList.remove('hidden');
                    adminButtons.classList.remove('hidden');
                    guestAllowedButtons.classList.remove('hidden');
                    
                    // Reset guest state
                    isGuestUser = false;
                    userRole = null;
                    
                    // Show/hide training attendance button based on company name for normal users
                    const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                    const isPolisCompany = companyName === 'POLIS';
                    // Check if company is POLIS PIEVE 2010 (checks config.nome, nome, or id)
                    const isPolisPieveCompany = isPolisPieve2010(currentCompanyData);
                    
                    if (isPolisCompany) {
                        trainingAttendanceButton.classList.remove('hidden');
                    } else {
                        trainingAttendanceButton.classList.add('hidden');
                    }
                    
                    // Show/hide campionato button for POLIS PIEVE 2010
                    if (isPolisPieveCompany) {
                        campionatoButton.classList.remove('hidden');
                    } else {
                        campionatoButton.classList.add('hidden');
                    }
                    
                    console.log('🏢 Normal company login - full UI enabled');
                }
                
                companyWelcomeScreen.classList.remove('hidden');
            }

            function showPasswordEntry(role) {
                hideAllScreens();
                pendingRole = role;
                rolePrompt.textContent = `Inserisci la password per ${role === 'mister' ? 'Mister' : 'Dirigente'}:`;
                passwordInput.value = '';
                passwordEntryScreen.classList.remove('hidden');
                passwordInput.focus();
            }

            function showPlayerManagement() {
                hideAllScreens();
                playerManagementScreen.classList.remove('hidden');
                hidePlayerLoadingError(); // Clear any previous error messages
                renderCompanyPlayers();
                renderCompanyCoaches();
                renderCompanyDirectors();
                updateSavePlayersButtonState();
                updateSaveCoachesButtonState();
                updateSaveDirectorsButtonState();
            }

            function hideAllScreens() {
                companyEntryScreen.classList.add('hidden');
                companyWelcomeScreen.classList.add('hidden');
                passwordEntryScreen.classList.add('hidden');
                playerManagementScreen.classList.add('hidden');
                nameEntryScreen.classList.add('hidden');
                startScreen.classList.add('hidden');
                mainView.classList.add('hidden');
                historyView.classList.add('hidden');
                attendanceView.classList.add('hidden');
                trainingAttendanceView.classList.add('hidden');
                campionatoView.classList.add('hidden');
            }

            // Firebase Realtime Database integration for training attendance
            async function fetchTrainingAttendanceFromFirebase() {
                // URL del Firebase Realtime Database per i dati delle presenze allenamenti
                const FIREBASE_URL = 'https://polis-2013-default-rtdb.europe-west1.firebasedatabase.app/presenze.json';
                // URL per il totale degli allenamenti
                const FIREBASE_TOTAL_URL = 'https://polis-2013-default-rtdb.europe-west1.firebasedatabase.app/totale_allenamenti.json';
                
                try {
                    console.log('📊 Recupero dati presenze allenamenti da Firebase Realtime Database...');
                    
                    // Effettua le richieste fetch in parallelo per ottimizzare i tempi
                    const [presenzeResponse, totaleResponse] = await Promise.all([
                        fetch(FIREBASE_URL),
                        fetch(FIREBASE_TOTAL_URL)
                    ]);
                    
                    // Controlla se le risposte sono ok
                    if (!presenzeResponse.ok) {
                        throw new Error(`Errore API Firebase presenze: ${presenzeResponse.status} - ${presenzeResponse.statusText}`);
                    }
                    
                    // Parsa i dati JSON dalle risposte
                    const firebaseData = await presenzeResponse.json();
                    let totaleAllenamenti = 0;
                    
                    // Verifica se i dati esistono
                    if (!firebaseData || typeof firebaseData !== 'object') {
                        console.warn('⚠️ Nessun dato trovato nel database Firebase');
                        
                        // Tenta di recuperare il totale allenamenti dal secondo endpoint se il primo non ha dati
                        if (totaleResponse.ok) {
                            const totaleData = await totaleResponse.json();
                            totaleAllenamenti = parseInt(totaleData) || 0;
                            console.log(`📊 Totale allenamenti recuperato da endpoint separato: ${totaleAllenamenti}`);
                        }
                        
                        return { players: [], totalTrainings: totaleAllenamenti };
                    }
                    
                    // Controlla se i dati contengono la proprietà "allenamentiTotali"
                    if (firebaseData.hasOwnProperty('allenamentiTotali')) {
                        totaleAllenamenti = parseInt(firebaseData.allenamentiTotali) || 0;
                        console.log(`📊 Totale allenamenti recuperato da proprietà allenamentiTotali: ${totaleAllenamenti}`);
                    } else if (totaleResponse.ok) {
                        // Fallback al secondo endpoint se allenamentiTotali non è presente nei dati principali
                        const totaleData = await totaleResponse.json();
                        totaleAllenamenti = parseInt(totaleData) || 0;
                        console.log(`📊 Totale allenamenti recuperato da endpoint separato: ${totaleAllenamenti}`);
                    } else {
                        console.warn('⚠️ Totale allenamenti non disponibile, usando valore predefinito 0');
                    }
                    
                    // Converte i dati Firebase nel formato atteso dall'applicazione
                    const trainingData = [];
                    
                    // Se i dati sono un oggetto con chiavi nome-giocatore e valori presenze
                    for (const [playerName, attendance] of Object.entries(firebaseData)) {
                        // Controlla che il nome sia valido e non sia "allenamentiTotali"
                        if (playerName && playerName.trim() !== '' && playerName.toLowerCase() !== 'allenamentitotali') {
                            trainingData.push({
                                name: playerName.trim(),
                                attendance: parseInt(attendance) || 0
                            });
                        }
                    }
                    
                    console.log(`✅ Recuperati con successo ${trainingData.length} record delle presenze allenamenti da Firebase`);
                    return { players: trainingData, totalTrainings: totaleAllenamenti };
                    
                } catch (error) {
                    console.error('❌ Errore nel recupero dei dati delle presenze allenamenti da Firebase:', error);
                    throw error;
                }
            }

            function renderTrainingAttendanceData(data, totalTrainings) {
                const trainingAttendanceList = document.getElementById('training-attendance-list');
                const allenamentiTotaliValue = document.getElementById('allenamenti-totali-value');
                trainingAttendanceList.innerHTML = '';
                
                // Display allenamentiTotali using the passed parameter
                if (totalTrainings && totalTrainings > 0) {
                    allenamentiTotaliValue.textContent = totalTrainings;
                } else {
                    allenamentiTotaliValue.textContent = '-';
                }
                
                if (!data || data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="2" class="px-6 py-4 text-center text-gray-500 italic">
                            Nessun dato disponibile
                        </td>
                    `;
                    trainingAttendanceList.appendChild(row);
                    return;
                }
                
                // Sort by attendance count (descending)
                data.sort((a, b) => b.attendance - a.attendance);
                
                data.forEach((player, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${player.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${player.attendance}</td>
                    `;
                    
                    trainingAttendanceList.appendChild(row);
                });
                
                // Update last update time
                const lastUpdateElement = document.getElementById('training-last-update');
                lastUpdateElement.textContent = new Date().toLocaleString('it-IT');
            }

            async function loadTrainingAttendance() {
                const loadingElement = document.getElementById('training-attendance-loading');
                const errorElement = document.getElementById('training-attendance-error');
                const contentElement = document.getElementById('training-attendance-content');
                
                // Show loading state
                loadingElement.classList.remove('hidden');
                errorElement.classList.add('hidden');
                contentElement.style.opacity = '0.5';
                
                try {
                    // Check if Firebase is available (same check as other functions)
                    if (!window.db || !window.collection || !window.onSnapshot || !window.doc) {
                        console.log('📊 Firebase not available, using demo mode for training attendance');
                        loadTrainingAttendanceDemo();
                        return;
                    }
                    
                    const result = await fetchTrainingAttendanceFromFirebase();
                    renderTrainingAttendanceData(result.players, result.totalTrainings);
                    
                    // Hide loading, show content
                    loadingElement.classList.add('hidden');
                    contentElement.style.opacity = '1';
                    
                } catch (error) {
                    console.error('Error loading training attendance:', error);
                    
                    // Show error state
                    loadingElement.classList.add('hidden');
                    errorElement.classList.remove('hidden');
                    contentElement.style.opacity = '1';
                    
                    // Show empty state in table
                    renderTrainingAttendanceData([], 0);
                }
            }

            // Demo version for loadTrainingAttendance when Firebase is not available
            function loadTrainingAttendanceDemo() {
                const loadingElement = document.getElementById('training-attendance-loading');
                const contentElement = document.getElementById('training-attendance-content');
                
                console.log('📊 Loading demo training attendance data...');
                
                // Simulate realistic demo data
                const demoTrainingData = [
                    { name: '10 ROSSI MARIO', attendance: 11 },
                    { name: '7 BIANCHI LUIGI', attendance: 9 },
                    { name: '23 VERDI GIUSEPPE', attendance: 13 },
                    { name: '4 NERI ANTONIO', attendance: 8 },
                    { name: '18 AZZURRI MARCO', attendance: 12 },
                    { name: '2 GIALLI FRANCESCO', attendance: 6 },
                    { name: '15 VIOLA STEFANO', attendance: 10 }
                ];
                
                const demoTotalTrainings = 13;
                
                // Render the demo data
                renderTrainingAttendanceData(demoTrainingData, demoTotalTrainings);
                
                // Hide loading, show content
                loadingElement.classList.add('hidden');
                contentElement.style.opacity = '1';
                
                console.log(`📊 Demo training attendance loaded: ${demoTrainingData.length} players, ${demoTotalTrainings} total trainings`);
            }

            function startApp(appId) {
                currentAppId = appId;
                
                appIdDisplay.textContent = currentAppId;
                currentAppIdDisplay.textContent = currentAppId;

                hideAllScreens();
                mainView.classList.remove('hidden');

                setupFirestoreListeners(currentAppId);
                renderPlayers();
                updateUIForRole();
            }

            function renderCompanyPlayers() {
                companyPlayersList.innerHTML = '';
                
                companyPlayers.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex items-center justify-between p-3 bg-white border border-gray-300 rounded-lg';
                    
                    let playerDisplay;
                    if (typeof player === 'string') {
                        // Old format: "10 ROSSI MARIO"
                        playerDisplay = `
                            <div class="text-gray-700">
                                <span class="font-semibold">${player}</span>
                                <span class="text-sm text-gray-500 block">Formato legacy</span>
                            </div>
                        `;
                    } else {
                        // New format: object with all fields
                        const birthDate = new Date(player.dataNascita);
                        const formattedDate = birthDate.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        
                        playerDisplay = `
                            <div class="text-gray-700">
                                <div class="font-semibold">${player.numero} ${player.nome}</div>
                                <div class="text-sm text-gray-500">
                                    📅 ${formattedDate} | 🆔 ${player.matricola}
                                </div>
                            </div>
                        `;
                    }
                    
                    playerDiv.innerHTML = `
                        ${playerDisplay}
                        <div class="flex gap-2">
                            <button onclick="editPlayer(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ✏️ Modifica
                            </button>
                            <button onclick="removePlayer(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                Rimuovi
                            </button>
                        </div>
                    `;
                    companyPlayersList.appendChild(playerDiv);
                });
                
                updateSavePlayersButtonState();
            }

            function updateSavePlayersButtonState() {
                // Enable the button only if there are players to save
                const hasPlayers = companyPlayers.length > 0;
                savePlayersButton.disabled = !hasPlayers;
                
                if (hasPlayers) {
                    savePlayersButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                } else {
                    savePlayersButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                }
            }

            window.removePlayer = async function(index) {
                if (confirm('Sei sicuro di voler rimuovere questo giocatore dalla lista?')) {
                    companyPlayers.splice(index, 1);
                    renderCompanyPlayers();
                    showMessage("Giocatore rimosso dalla lista. Ricorda di salvare!", "text-blue-600");
                }
            };

            window.editPlayer = async function(index) {
                const player = companyPlayers[index];
                
                if (typeof player === 'string') {
                    // Handle legacy format
                    const parts = player.split(' ');
                    const numero = parts[0];
                    const nome = parts.slice(1).join(' ');
                    
                    const newNumero = prompt('Numero giocatore:', numero);
                    if (newNumero === null) return; // User cancelled
                    
                    const newNome = prompt('Nome giocatore:', nome);
                    if (newNome === null) return; // User cancelled
                    
                    if (newNumero.trim() && newNome.trim()) {
                        companyPlayers[index] = `${newNumero.trim()} ${newNome.trim()}`;
                        renderCompanyPlayers();
                        showMessage("Giocatore modificato. Ricorda di salvare!", "text-green-600");
                    }
                } else {
                    // Handle new object format
                    const newNumero = prompt('Numero giocatore:', player.numero);
                    if (newNumero === null) return;
                    
                    const newNome = prompt('Nome giocatore:', player.nome);
                    if (newNome === null) return;
                    
                    const newDataNascita = prompt('Data nascita (YYYY-MM-DD):', player.dataNascita);
                    if (newDataNascita === null) return;
                    
                    const newMatricola = prompt('Matricola:', player.matricola);
                    if (newMatricola === null) return;
                    
                    if (newNumero.trim() && newNome.trim() && newDataNascita.trim() && newMatricola.trim()) {
                        companyPlayers[index] = {
                            numero: newNumero.trim(),
                            nome: newNome.trim(),
                            dataNascita: newDataNascita.trim(),
                            matricola: newMatricola.trim()
                        };
                        renderCompanyPlayers();
                        showMessage("Giocatore modificato. Ricorda di salvare!", "text-green-600");
                    }
                }
            };

            function renderCompanyCoaches() {
                companyCoachesList.innerHTML = '';
                
                companyCoaches.forEach((coach, index) => {
                    const coachDiv = document.createElement('div');
                    coachDiv.className = 'flex items-center justify-between p-2 bg-white border border-gray-300 rounded-lg';
                    
                    // Handle both old string format and new object format for backward compatibility
                    const coachName = typeof coach === 'string' ? coach : coach.name;
                    const coachMatricola = typeof coach === 'object' && coach.matricola ? coach.matricola : '';
                    
                    const coachInfoHtml = coachMatricola 
                        ? `<div class="text-gray-700">
                             <div class="font-medium">${coachName}</div>
                             <div class="text-sm text-gray-500">Matricola: ${coachMatricola}</div>
                           </div>`
                        : `<span class="text-gray-700">${coachName}</span>`;
                    
                    coachDiv.innerHTML = `
                        ${coachInfoHtml}
                        <div class="flex gap-2">
                            <button onclick="editCoach(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm transition-colors">
                                ✏️
                            </button>
                            <button onclick="removeCoach(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                                Rimuovi
                            </button>
                        </div>
                    `;
                    companyCoachesList.appendChild(coachDiv);
                });
                
                updateSaveCoachesButtonState();
            }

            function updateSaveCoachesButtonState() {
                // Enable the button only if there are coaches to save
                const hasCoaches = companyCoaches.length > 0;
                saveCoachesButton.disabled = !hasCoaches;
                
                if (hasCoaches) {
                    saveCoachesButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                } else {
                    saveCoachesButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                }
            }

            window.removeCoach = async function(index) {
                if (confirm('Sei sicuro di voler rimuovere questo mister dalla lista?')) {
                    companyCoaches.splice(index, 1);
                    renderCompanyCoaches();
                    showCoachMessage("Mister rimosso dalla lista. Ricorda di salvare!", "text-blue-600");
                }
            };

            window.editCoach = async function(index) {
                const coach = companyCoaches[index];
                
                if (typeof coach === 'string') {
                    // Handle legacy string format
                    const newName = prompt('Nome mister:', coach);
                    if (newName === null) return; // User cancelled
                    
                    if (newName.trim()) {
                        companyCoaches[index] = newName.trim();
                        renderCompanyCoaches();
                        showCoachMessage("Mister modificato. Ricorda di salvare!", "text-green-600");
                    }
                } else {
                    // Handle object format
                    const newName = prompt('Nome mister:', coach.name || '');
                    if (newName === null) return;
                    
                    const newMatricola = prompt('Matricola:', coach.matricola || '');
                    if (newMatricola === null) return;
                    
                    if (newName.trim()) {
                        companyCoaches[index] = {
                            name: newName.trim(),
                            matricola: newMatricola.trim()
                        };
                        renderCompanyCoaches();
                        showCoachMessage("Mister modificato. Ricorda di salvare!", "text-green-600");
                    }
                }
            };

            function renderCompanyDirectors() {
                companyDirectorsList.innerHTML = '';
                
                companyDirectors.forEach((director, index) => {
                    const directorDiv = document.createElement('div');
                    directorDiv.className = 'flex items-center justify-between p-2 bg-white border border-gray-300 rounded-lg';
                    
                    const fullName = `${director.name || ''} ${director.surname || ''}`.trim();
                    const directorMatricola = director.matricola || '';
                    
                    const directorInfoHtml = `<div class="text-gray-700">
                                               <div class="font-medium">${fullName}</div>
                                               <div class="text-sm text-gray-500">Matricola: ${directorMatricola}</div>
                                             </div>`;
                    
                    directorDiv.innerHTML = `
                        ${directorInfoHtml}
                        <div class="flex gap-2">
                            <button onclick="editDirector(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-sm transition-colors">
                                ✏️
                            </button>
                            <button onclick="removeDirector(${index})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                                Rimuovi
                            </button>
                        </div>
                    `;
                    companyDirectorsList.appendChild(directorDiv);
                });
                
                updateSaveDirectorsButtonState();
            }

            function updateSaveDirectorsButtonState() {
                // Enable the button only if there are directors to save
                const hasDirectors = companyDirectors.length > 0;
                saveDirectorsButton.disabled = !hasDirectors;
                
                if (hasDirectors) {
                    saveDirectorsButton.classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                } else {
                    saveDirectorsButton.classList.add('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
                }
            }

            window.removeDirector = async function(index) {
                if (confirm('Sei sicuro di voler rimuovere questo dirigente dalla lista?')) {
                    companyDirectors.splice(index, 1);
                    renderCompanyDirectors();
                    showDirectorMessage("Dirigente rimosso dalla lista. Ricorda di salvare!", "text-blue-600");
                }
            };

            window.editDirector = async function(index) {
                const director = companyDirectors[index];
                
                const newName = prompt('Nome dirigente:', director.name || '');
                if (newName === null) return; // User cancelled
                
                const newSurname = prompt('Cognome dirigente:', director.surname || '');
                if (newSurname === null) return;
                
                const newMatricola = prompt('Matricola:', director.matricola || '');
                if (newMatricola === null) return;
                
                if (newName.trim() || newSurname.trim()) {
                    companyDirectors[index] = {
                        name: newName.trim(),
                        surname: newSurname.trim(),
                        matricola: newMatricola.trim()
                    };
                    renderCompanyDirectors();
                    showDirectorMessage("Dirigente modificato. Ricorda di salvare!", "text-green-600");
                }
            };

            function showDirectorMessage(message, className) {
                saveDirectorsMessageArea.textContent = message;
                saveDirectorsMessageArea.className = `mt-2 text-center text-sm font-medium ${className}`;
                saveDirectorsMessageArea.classList.remove('hidden');
                setTimeout(() => {
                    saveDirectorsMessageArea.classList.add('hidden');
                }, 5000);
            }

            function showMessage(message, className) {
                messageArea.textContent = message;
                messageArea.className = `mt-4 text-center text-sm font-medium ${className}`;
                messageArea.classList.remove('hidden');
                setTimeout(() => {
                    messageArea.classList.add('hidden');
                }, 5000);
            }

            function showSavePlayersMessage(message, className) {
                savePlayersMessageArea.textContent = message;
                savePlayersMessageArea.className = `mt-2 mb-4 text-center text-sm font-medium ${className}`;
                savePlayersMessageArea.classList.remove('hidden');
                setTimeout(() => {
                    savePlayersMessageArea.classList.add('hidden');
                }, 5000);
            }

            function showCoachMessage(message, className) {
                saveCoachesMessageArea.textContent = message;
                saveCoachesMessageArea.className = `mt-2 text-center text-sm font-medium ${className}`;
                saveCoachesMessageArea.classList.remove('hidden');
                setTimeout(() => {
                    saveCoachesMessageArea.classList.add('hidden');
                }, 5000);
            }

            // --- Modal Functions ---
            function showModal() {
                statusModal.classList.remove('hidden', 'opacity-0');
                statusModal.classList.add('flex', 'opacity-100');
            }

            function hideModal() {
                statusModal.classList.remove('flex', 'opacity-100');
                statusModal.classList.add('hidden', 'opacity-0');
            }

            function showUnavailablePlayerModal(playerName, reason) {
                unavailablePlayerName.textContent = playerName;
                unavailablePlayerReason.textContent = reason;
                unavailablePlayerModal.classList.remove('hidden', 'opacity-0');
                unavailablePlayerModal.classList.add('flex', 'opacity-100');
                tempUnavailablePlayerName = playerName; // salva il nome per il "convoca comunque"
            }

            function hideUnavailablePlayerModal() {
                unavailablePlayerModal.classList.remove('flex', 'opacity-100');
                unavailablePlayerModal.classList.add('hidden', 'opacity-0');
                tempUnavailablePlayerName = null;
            }

            function showAlreadyCalledModal(playerName) {
                alreadyCalledPlayerName.textContent = playerName;
                alreadyCalledModal.classList.remove('hidden', 'opacity-0');
                alreadyCalledModal.classList.add('flex', 'opacity-100');
                tempAlreadyCalledPlayerName = playerName;
            }

            function hideAlreadyCalledModal() {
                alreadyCalledModal.classList.remove('flex', 'opacity-100');
                alreadyCalledModal.classList.add('hidden', 'opacity-0');
                tempAlreadyCalledPlayerName = null;
            }

            function showShareModal() {
                if (userRole !== 'mister') {
                    showMessage("Solo il Mister può condividere le convocazioni.", "text-red-600");
                    return;
                }
                
                // Check if Web Share API is supported
                const isWebShareSupported = navigator.share && navigator.canShare;
                const shareSeparator = document.getElementById('share-separator');
                
                // Detect if user is on mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                 (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
                
                if (isWebShareSupported || navigator.share) {
                    webShareButton.classList.remove('hidden');
                    if (shareSeparator) shareSeparator.classList.remove('hidden');
                    
                    // On mobile with Web Share API, make it more prominent
                    if (isMobile) {
                        webShareButton.textContent = '📱 Condividi';
                        webShareButton.classList.add('bg-green-600', 'hover:bg-green-700');
                        webShareButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    }
                } else {
                    webShareButton.classList.add('hidden');
                    if (shareSeparator) shareSeparator.classList.add('hidden');
                }
                
                shareModal.classList.remove('hidden', 'opacity-0');
                shareModal.classList.add('flex', 'opacity-100');
            }

            function hideShareModal() {
                shareModal.classList.remove('flex', 'opacity-100');
                shareModal.classList.add('hidden', 'opacity-0');
            }

            // Distinta Modal Functions
            function showDistintaLocationModal() {
                distintaLocationModal.classList.remove('hidden', 'opacity-0');
                distintaLocationModal.classList.add('flex', 'opacity-100');
            }

            function hideDistintaLocationModal() {
                distintaLocationModal.classList.remove('flex', 'opacity-100');
                distintaLocationModal.classList.add('hidden', 'opacity-0');
            }

            async function showDistintaDirigentiModal() {
                console.log('👥 DISTINTA FLOW: showDistintaDirigentiModal() called');
                console.log('🔍 Current companyDirectors length:', companyDirectors?.length || 0);
                
                // Ensure companyDirectors is loaded before populating the list
                if (companyDirectors.length === 0) {
                    console.log('📥 DISTINTA FLOW: Loading company directors...');
                    companyDirectors = await loadCompanyDirectors();
                    console.log('✅ DISTINTA FLOW: Company directors loaded, count:', companyDirectors?.length || 0);
                } else {
                    console.log('✅ DISTINTA FLOW: Company directors already loaded, count:', companyDirectors.length);
                }
                
                console.log('🎯 Company directors data:', companyDirectors);
                
                console.log('🏗️ DISTINTA FLOW: Populating dirigenti selection...');
                // Populate the dirigenti list
                populateDirigentiSelection();
                console.log('✅ DISTINTA FLOW: Dirigenti selection populated');
                
                console.log('🎭 DISTINTA FLOW: Showing dirigenti modal...');
                distintaDirigentiModal.classList.remove('hidden', 'opacity-0');
                distintaDirigentiModal.classList.add('flex', 'opacity-100');
                console.log('✅ DISTINTA FLOW: Dirigenti modal displayed');
            }

            function hideDistintaDirigentiModal() {
                distintaDirigentiModal.classList.remove('flex', 'opacity-100');
                distintaDirigentiModal.classList.add('hidden', 'opacity-0');
                // Note: selectedDirigenti is NOT cleared here to preserve selection for distinta generation
            }

            function populateDirigentiSelection() {
                dirigentiSelectionList.innerHTML = '';
                
                if (companyDirectors.length === 0) {
                    dirigentiSelectionList.innerHTML = '<p class="text-gray-500 text-center">Nessun dirigente configurato per questa società.</p>';
                    return;
                }

                companyDirectors.forEach((director, index) => {
                    const fullName = `${director.surname || ''} ${director.name || ''}`.trim() || 'Nome non specificato';
                    const checkboxId = `dirigente-${index}`;
                    
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'flex items-center p-2 border border-gray-200 rounded hover:bg-gray-50';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" class="dirigente-checkbox mr-3" data-index="${index}">
                        <label for="${checkboxId}" class="flex-1 cursor-pointer">
                            <span class="font-medium">${fullName}</span>
                            ${director.matricola ? `<span class="text-sm text-gray-500 block">Matricola: ${director.matricola}</span>` : ''}
                        </label>
                    `;
                    dirigentiSelectionList.appendChild(checkboxDiv);
                });
            }

            function showDistintaDisplayModal() {
                distintaDisplayModal.classList.remove('hidden', 'opacity-0');
                distintaDisplayModal.classList.add('flex', 'opacity-100');
            }

            function hideDistintaDisplayModal() {
                distintaDisplayModal.classList.remove('flex', 'opacity-100');
                distintaDisplayModal.classList.add('hidden', 'opacity-0');
            }

            // Distinta Generation Functions
            async function selectDistintaLocation(location) {
                console.log('📍 DISTINTA FLOW: selectDistintaLocation() called with location:', location);
                console.log('🔍 Current state before location selection:');
                console.log('   - currentDistintaData exists:', !!window.currentDistintaData);
                console.log('   - userRole:', userRole);
                console.log('   - companyDirectors loaded:', companyDirectors?.length || 0);
                
                hideDistintaLocationModal();
                selectedDistintaLocation = location;
                console.log('✅ DISTINTA FLOW: Location set to:', selectedDistintaLocation);
                
                console.log('👥 DISTINTA FLOW: About to show dirigenti modal...');
                await showDistintaDirigentiModal();
                console.log('✅ DISTINTA FLOW: Dirigenti modal should now be visible');
            }

            function confirmDirigentiSelection() {
                console.log('🔄 DISTINTA FLOW: confirmDirigentiSelection() called');
                console.log('🎯 Current state - userRole:', userRole);
                console.log('🎯 Current state - currentDistintaData exists:', !!window.currentDistintaData);
                console.log('🎯 Current state - selectedDistintaLocation:', selectedDistintaLocation);
                console.log('🎯 Current state - companyDirectors length:', companyDirectors?.length || 0);
                
                const checkboxes = document.querySelectorAll('.dirigente-checkbox:checked');
                console.log('📊 Found checked dirigente checkboxes:', checkboxes.length);
                
                if (checkboxes.length === 0) {
                    console.warn('⚠️ DISTINTA FLOW WARNING: No dirigenti selected');
                    alert('Devi selezionare almeno un dirigente per continuare.');
                    return;
                }

                selectedDirigenti = [];
                checkboxes.forEach((checkbox, index) => {
                    const dataIndex = parseInt(checkbox.getAttribute('data-index'));
                    console.log(`📋 Processing checkbox ${index}: data-index=${dataIndex}`);
                    if (companyDirectors[dataIndex]) {
                        selectedDirigenti.push(companyDirectors[dataIndex]);
                        console.log(`✅ Added dirigente: ${companyDirectors[dataIndex].name} ${companyDirectors[dataIndex].surname}`);
                    } else {
                        console.error(`❌ No dirigente found at index ${dataIndex}`);
                    }
                });

                console.log('🎯 Final selectedDirigenti:', selectedDirigenti);
                console.log('🎯 Selected dirigenti count:', selectedDirigenti.length);
                console.log('🎯 Selected dirigenti names:', selectedDirigenti.map(d => `${d.name} ${d.surname}`));

                console.log('🚪 DISTINTA FLOW: Hiding dirigenti modal...');
                hideDistintaDirigentiModal();
                
                console.log('🎯 DISTINTA FLOW: About to call generateDistinta()');
                console.log('🔍 Pre-generateDistinta state check:');
                console.log('   - currentDistintaData exists:', !!window.currentDistintaData);
                console.log('   - selectedDistintaLocation:', selectedDistintaLocation);
                console.log('   - selectedDirigenti count:', selectedDirigenti.length);
                
                generateDistinta();
            }

            function generateDistinta() {
                console.log('🚀 DISTINTA FLOW: generateDistinta() function called');
                console.log('📊 Function entry state:');
                console.log('   - currentDistintaData:', window.currentDistintaData);
                console.log('   - selectedDistintaLocation:', selectedDistintaLocation);
                console.log('   - selectedDirigenti:', selectedDirigenti);
                console.log('   - selectedDirigenti length:', selectedDirigenti?.length || 0);
                
                // Validation check 1: currentDistintaData
                if (!window.currentDistintaData) {
                    console.error('❌ DISTINTA FLOW ERROR: currentDistintaData not available');
                    console.log('🔍 window.currentDistintaData value:', window.currentDistintaData);
                    showMessage("Errore: dati convocazione non disponibili.", "text-red-600");
                    return;
                }
                console.log('✅ DISTINTA FLOW: currentDistintaData validation passed');
                
                // Validation check 2: selectedDistintaLocation
                if (!selectedDistintaLocation) {
                    console.error('❌ DISTINTA FLOW ERROR: selectedDistintaLocation not available');
                    console.log('🔍 selectedDistintaLocation value:', selectedDistintaLocation);
                    showMessage("Errore: ubicazione partita non selezionata.", "text-red-600");
                    return;
                }
                console.log('✅ DISTINTA FLOW: selectedDistintaLocation validation passed');

                // Validation check 3: selectedDirigenti
                if (selectedDirigenti.length === 0) {
                    console.error('❌ DISTINTA FLOW ERROR: no dirigenti selected');
                    console.log('🔍 selectedDirigenti:', selectedDirigenti);
                    console.log('🔍 selectedDirigenti length:', selectedDirigenti.length);
                    showMessage("Errore: nessun dirigente selezionato.", "text-red-600");
                    return;
                }
                console.log('✅ DISTINTA FLOW: selectedDirigenti validation passed');
                console.log('🎯 All validations passed, proceeding with distinta generation...');
                
                const convocationData = window.currentDistintaData;
                console.log('📋 Using convocation data for distinta generation:', convocationData);
                console.log('📍 Using location for distinta generation:', selectedDistintaLocation);
                
                console.log('🏗️ DISTINTA FLOW: Calling createDistintaContent()...');
                const content = createDistintaContent(convocationData, selectedDistintaLocation);
                console.log('✅ DISTINTA FLOW: createDistintaContent() completed');
                console.log('📄 Generated content length:', content?.length || 0);
                console.log('📄 Generated content preview (first 200 chars):', content?.substring(0, 200) || 'No content');
                
                console.log('🖼️ DISTINTA FLOW: Setting innerHTML on distintaContent element...');
                if (distintaContent) {
                    distintaContent.innerHTML = content;
                    console.log('✅ DISTINTA FLOW: distintaContent.innerHTML set successfully');
                } else {
                    console.error('❌ DISTINTA FLOW ERROR: distintaContent element not found');
                    return;
                }
                
                console.log('🎉 DISTINTA FLOW: Showing distinta display modal...');
                showDistintaDisplayModal();
                console.log('🎊 DISTINTA FLOW COMPLETE: Distinta should now be visible to user');
            }
            
            function createDistintaContent(convocationData, location) {
                console.log('🏗️ CREATE DISTINTA: createDistintaContent() called');
                console.log('📋 Input convocation data:', convocationData);
                console.log('📍 Input location:', location);
                
                // Get company info
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || 'Società Demo';
                const companyCategory = localStorage.getItem(`categoria_${currentCompanyCode}`) || '';
                console.log('🏢 Company info - name:', companyName, 'category:', companyCategory);
                
                // Get complete company information from localStorage
                let companyInfo = {};
                try {
                    const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                    if (savedInfo) {
                        companyInfo = JSON.parse(savedInfo);
                        console.log('✅ CREATE DISTINTA: Company info loaded from localStorage:', companyInfo);
                    } else {
                        console.log('ℹ️ CREATE DISTINTA: No company info in localStorage');
                    }
                } catch (error) {
                    console.warn('⚠️ CREATE DISTINTA: Could not parse company info:', error);
                }
                
                // Format match date
                console.log('📅 CREATE DISTINTA: Formatting match date...');
                let formattedMatchDate = convocationData.details.data;
                if (convocationData.details.data && convocationData.details.data !== 'N/D') {
                    const matchDate = new Date(convocationData.details.data + 'T00:00:00');
                    const dayOfWeek = matchDate.toLocaleDateString('it-IT', { weekday: 'long' }).toUpperCase();
                    const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
                    const dateString = matchDate.toLocaleDateString('it-IT', dateOptions);
                    formattedMatchDate = `${dayOfWeek} ${dateString}`;
                }
                console.log('📅 CREATE DISTINTA: Formatted match date:', formattedMatchDate);
                
                // Create player rows with proper formatting
                console.log('👥 CREATE DISTINTA: Creating player rows...');
                const playerRows = createPlayerRows(convocationData.players);
                console.log('👥 CREATE DISTINTA: Player rows created, length:', playerRows?.length || 0);
                
                // Create coach rows with only match-specific coaches
                console.log('👔 CREATE DISTINTA: Creating staff rows...');
                const staffRows = createStaffRows(convocationData);
                console.log('👔 CREATE DISTINTA: Staff rows created, length:', staffRows?.length || 0);
                
                const locationText = location === 'casa' ? 'IN CASA' : 'IN TRASFERTA';
                console.log('📍 CREATE DISTINTA: Location text:', locationText);
                
                console.log('🏗️ CREATE DISTINTA: Building HTML content...');
                
                return `
                    <div style="font-family: Arial, Helvetica, sans-serif; line-height: 1.3; font-size: 11px; width: 180mm; margin: 10mm auto; padding: 10mm;">
                        <div style="text-align: center; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 8px;">
                            <h1 style="font-size: 16px; font-weight: bold; margin: 0 0 4px 0;">${companyInfo.ragioneSociale || companyName}</h1>
                            ${companyInfo.indirizzo ? `<p style="font-size: 11px; margin: 2px 0;">${companyInfo.indirizzo}</p>` : ''}
                            ${companyInfo.telefono || companyInfo.mail ? `<p style="font-size: 11px; margin: 2px 0;">Tel: ${companyInfo.telefono || 'N/D'} - Email: ${companyInfo.mail || 'N/D'}</p>` : ''}
                            ${companyInfo.partitaIva ? `<p style="font-size: 11px; margin: 2px 0;">P.IVA: ${companyInfo.partitaIva}</p>` : ''}
                            ${companyCategory ? `<p style="font-size: 11px; margin: 3px 0;"><strong>Categoria:</strong> ${companyCategory}</p>` : ''}
                            <h2 style="font-size: 14px; font-weight: bold; margin: 5px 0;">DISTINTA UFFICIALE</h2>
                            <p style="font-size: 12px; margin: 3px 0;"><strong>Partita ${locationText}</strong></p>
                            
                            <!-- Team positioning based on home/away - Compact for PDF -->
                            <div style="margin: 8px 0; display: flex; justify-content: space-between; align-items: center; border: 2px solid #000; padding: 12px; background-color: #f8f9fa;">
                                ${location === 'casa' ? 
                                    `<div style="text-align: left; font-weight: bold; font-size: 13px; width: 45%;">${companyName.toUpperCase()}</div>
                                     <div style="text-align: center; font-weight: bold; font-size: 15px; width: 10%;">VS</div>
                                     <div style="text-align: right; font-weight: bold; font-size: 13px; width: 45%;">${(convocationData.details.avversario || 'N/D').toUpperCase()}</div>` :
                                    `<div style="text-align: left; font-weight: bold; font-size: 13px; width: 45%;">${(convocationData.details.avversario || 'N/D').toUpperCase()}</div>
                                     <div style="text-align: center; font-weight: bold; font-size: 15px; width: 10%;">VS</div>
                                     <div style="text-align: right; font-weight: bold; font-size: 13px; width: 45%;">${companyName.toUpperCase()}</div>`
                                }
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px; font-size: 11px; line-height: 1.4;">
                            <p style="margin: 2px 0;"><strong>Data:</strong> ${formattedMatchDate}</p>
                            <p style="margin: 2px 0;"><strong>Orario:</strong> ${convocationData.details.orarioPartita || 'N/D'}</p>
                            <p style="margin: 2px 0;"><strong>Campo:</strong> ${convocationData.details.campo || 'N/D'}</p>
                            
                            ${companyInfo.categoria ? `<p style="margin: 2px 0;"><strong>Categoria:</strong> ${companyInfo.categoria}</p>` : ''}
                            <p style="margin: 2px 0;"><strong>Girone:</strong> <span style="padding-left: 8px; display: inline-block; min-width: 120px;" contenteditable="true" id="editable-girone"> </span></p>
                            <p style="margin: 2px 0;"><strong>Giornata:</strong> <span style="padding-left: 8px; display: inline-block; min-width: 120px;" contenteditable="true" id="editable-giornata"> </span></p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 11px; page-break-inside: avoid;">
                            <thead>
                                <tr style="border-bottom: 2px solid #000;">
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 6%; line-height: 1.3;">N°</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 26%; line-height: 1.3;">COGNOME E NOME</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 16%; line-height: 1.3;">DATA NASCITA</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 16%; line-height: 1.3;">MATRICOLA</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 12%; line-height: 1.3;">CAPITANO</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 12%; line-height: 1.3;">AMMONITO</th>
                                    <th style="text-align: center; padding: 6px 4px; border: 1px solid #000; width: 12%; line-height: 1.3;">ESPULSO</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${playerRows}
                            </tbody>
                        </table>
                        
                        <div style="margin: 10px 0;">
                            <h3 style="font-size: 12px; font-weight: bold; margin-bottom: 6px;">STAFF TECNICO:</h3>
                            ${staffRows}
                        </div>
                        
                        <div style="margin-top: 12px; margin-bottom: 10px;">
                            <p style="font-size: 11px; text-align: justify; line-height: 1.4;">
                                Io sottoscritto dirigente accompagnatore Ufficiale, dichiaro che i giocatori sopraindicati sono regolarmente tesserati e partecipano alla gara sotto la responsabilità della Società di appartenenza giusto le norme vigenti.
                            </p>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                            <div style="text-align: center; width: 45%;">
                                <p style="border-bottom: 1px solid #000; padding-bottom: 25px; margin-bottom: 3px;"></p>
                                <p style="font-size: 11px; font-weight: bold;">FIRMA ARBITRO</p>
                            </div>
                            <div style="text-align: center; width: 45%;">
                                <p style="border-bottom: 1px solid #000; padding-bottom: 25px; margin-bottom: 3px;"></p>
                                <p style="font-size: 11px; font-weight: bold;">FIRMA DIRIGENTE</p>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('✅ CREATE DISTINTA: HTML content template generation completed successfully');
                return content;
            }
            
            function createPlayerRows(players) {
                let rows = '';
                let playerNumber = 1;
                
                // Get extended player data if available
                const extendedPlayers = getExtendedPlayerData();
                
                players.forEach(playerString => {
                    // Extract player info from the string format "NUMBER NAME"
                    const parts = playerString.split(' ');
                    const number = parts[0];
                    const name = parts.slice(1).join(' ');
                    
                    // Try to find extended data for this player
                    const extendedData = extendedPlayers.find(p => 
                        p.name === name || 
                        p.name === playerString ||
                        (p.numero && p.numero.toString() === number)
                    );
                    
                    let birthDate = '___/___/______';
                    if (extendedData?.dataNascita) {
                        // Format the birth date as DD/MM/YYYY
                        const date = new Date(extendedData.dataNascita);
                        if (!isNaN(date.getTime())) {
                            birthDate = date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        } else {
                            // If the date is already in string format, use it as is
                            birthDate = extendedData.dataNascita;
                        }
                    }
                    const matricola = extendedData?.matricola || '__________';
                    
                    rows += `
                        <tr style="border-bottom: 1px solid #000;">
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${number}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${name}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${birthDate}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;">${matricola}</td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;"></td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;"></td>
                            <td style="padding: 6px 4px; border: 1px solid #000; font-size: 11px; text-align: center; line-height: 1.3;"></td>
                        </tr>
                    `;
                });
                
                return rows;
            }
            
            function createStaffRows(convocationData) {
                let rows = '';
                
                // Function to get coach matricola by name
                function getCoachMatricola(coachName) {
                    if (!companyCoaches || !coachName) return '__________';
                    
                    const coach = companyCoaches.find(c => 
                        (typeof c === 'string' ? c : c.name) === coachName
                    );
                    
                    if (coach && typeof coach === 'object' && coach.matricola) {
                        return coach.matricola;
                    }
                    return '__________';
                }
                
                // Get match-specific coaches from convocation data
                // Look for mister information in the match details
                const misterPartita = convocationData?.details?.misterPartita;
                const misterTipo = convocationData?.details?.misterTipo;
                
                // Left side: Coaches
                let coachesRows = '';
                
                // Show both coaches as "Allenatore"
                if (misterPartita && misterPartita !== 'N/D' && misterPartita !== 'Seleziona mister') {
                    const matricola = getCoachMatricola(misterPartita);
                    coachesRows += `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Allenatore:</strong> ${misterPartita} - Matricola: ${matricola}
                        </p>
                    `;
                }
                
                if (misterTipo && misterTipo !== 'N/D' && misterTipo !== 'Seleziona mister' && misterTipo !== misterPartita) {
                    const matricola = getCoachMatricola(misterTipo);
                    coachesRows += `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Allenatore:</strong> ${misterTipo} - Matricola: ${matricola}
                        </p>
                    `;
                }
                
                // If no specific coaches are assigned, show default empty fields
                if (!coachesRows) {
                    coachesRows = `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Allenatore:</strong> ________________ - Matricola: __________
                        </p>
                    `;
                }
                
                // Right side: Directors (only selected ones)
                let directorsRows = '';
                if (selectedDirigenti && selectedDirigenti.length > 0) {
                    selectedDirigenti.forEach(director => {
                        const fullName = `${director.name || ''} ${director.surname || ''}`.trim();
                        const matricola = director.matricola || '__________';
                        directorsRows += `
                            <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                                <strong>Dirigente:</strong> ${fullName} - Matricola: ${matricola}
                            </p>
                        `;
                    });
                } else {
                    directorsRows = `
                        <p style="margin: 3px 0; font-size: 11px; line-height: 1.4;">
                            <strong>Dirigente:</strong> ________________ - Matricola: __________
                        </p>
                    `;
                }
                
                // Combine both sides with proper layout
                rows = `
                    <div style="display: flex; justify-content: space-between;">
                        <div style="width: 48%;">
                            ${coachesRows}
                        </div>
                        <div style="width: 48%;">
                            ${directorsRows}
                        </div>
                    </div>
                `;
                
                return rows;
            }
            
            function getExtendedPlayerData() {
                // Try to get full player data from various sources
                let players = [];
                
                // Try from companyPlayers first
                if (companyPlayers && companyPlayers.length > 0) {
                    players = companyPlayers;
                } else {
                    // Fallback: try to get from localStorage
                    try {
                        const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                        if (savedPlayers) {
                            players = JSON.parse(savedPlayers);
                        }
                    } catch (error) {
                        console.warn('Could not parse saved players:', error);
                    }
                }
                
                return players;
            }
            
            // Distinta Action Functions
            function copyDistintaToClipboard() {
                const content = distintaContent.innerText;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(content).then(() => {
                        showMessage("Distinta copiata negli appunti!", "text-green-600");
                    }).catch(err => {
                        console.error('Errore nel copiare negli appunti:', err);
                        fallbackCopyText(content);
                    });
                } else {
                    fallbackCopyText(content);
                }
            }
            
            function fallbackCopyText(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showMessage("Distinta copiata negli appunti!", "text-green-600");
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    showMessage("Errore nel copiare negli appunti.", "text-red-600");
                }
                
                document.body.removeChild(textArea);
            }
            
            function printDistinta() {
                const content = distintaContent.innerHTML;
                const printWindow = window.open('', '_blank');
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Distinta Ufficiale</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                margin: 20px;
                                line-height: 1.4;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                            }
                            th, td { 
                                border: 1px solid #000; 
                                padding: 8px; 
                                text-align: left; 
                            }
                            @media print {
                                body { margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            }
            
            function shareDistinta() {
                shareDistintaAsPDF();
            }
            
            async function shareDistintaAsPDF() {
                try {
                    // Generate PDF from distinta content
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Get the distinta content element
                    const element = distintaContent;
                    
                    // Use html2canvas to convert to image first, then add to PDF
                    // Optimized settings for compact A4 formatting
                    const canvas = await html2canvas(element, {
                        scale: 1.5, // Reduced scale for better single-page fit
                        backgroundColor: '#ffffff',
                        useCORS: true,
                        allowTaint: true,
                        width: element.scrollWidth,
                        height: element.scrollHeight,
                        scrollX: 0,
                        scrollY: 0
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Calculate dimensions to fit single A4 page with margins
                    const margins = 10; // Reduced margins for more space
                    const imgWidth = 210 - (margins * 2); // A4 width minus margins
                    const maxHeight = 297 - (margins * 2); // A4 height minus margins
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Scale down if content is too tall to fit on single page
                    let finalWidth = imgWidth;
                    let finalHeight = imgHeight;
                    
                    if (imgHeight > maxHeight) {
                        // Scale down to fit height
                        finalHeight = maxHeight;
                        finalWidth = (canvas.width * finalHeight) / canvas.height;
                        
                        // Center horizontally if scaled down
                        const xOffset = margins + (imgWidth - finalWidth) / 2;
                        pdf.addImage(imgData, 'PNG', xOffset, margins, finalWidth, finalHeight);
                    } else {
                        // Center vertically if content doesn't fill page
                        const yOffset = margins + (maxHeight - finalHeight) / 2;
                        pdf.addImage(imgData, 'PNG', margins, yOffset, finalWidth, finalHeight);
                    }
                    
                    // Generate filename with match details
                    const matchDate = document.getElementById('share-data-partita')?.textContent || new Date().toLocaleDateString('it-IT');
                    const opponent = document.getElementById('share-avversario')?.textContent || 'Partita';
                    const filename = `Distinta_${opponent.replace(/\s+/g, '_')}_${matchDate.replace(/\//g, '-')}.pdf`;
                    
                    // Check if device supports Web Share API with files
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert PDF to blob
                            const pdfBlob = pdf.output('blob');
                            const file = new File([pdfBlob], filename, { type: 'application/pdf' });
                            
                            const shareData = {
                                title: 'Distinta Ufficiale',
                                text: 'Distinta ufficiale della partita',
                                files: [file]
                            };
                            
                            if (navigator.canShare(shareData)) {
                                await navigator.share(shareData);
                                showMessage("Distinta PDF condivisa con successo!", "text-green-600");
                                console.log('✅ PDF shared successfully via Web Share API');
                                return;
                            }
                        } catch (webShareError) {
                            console.log('Web Share with PDF failed:', webShareError);
                        }
                    }
                    
                    // Fallback: download the PDF
                    pdf.save(filename);
                    showMessage("PDF della distinta scaricato!", "text-green-600");
                    console.log('📁 PDF downloaded:', filename);
                    
                } catch (error) {
                    console.error('❌ Error generating PDF:', error);
                    // Fallback to the old image method if PDF generation fails
                    try {
                        console.log('🔄 Falling back to image sharing...');
                        await shareDistintaAsImage();
                        showMessage("Errore PDF, condivisa come immagine!", "text-orange-600");
                    } catch (fallbackError) {
                        console.error('❌ Image fallback also failed:', fallbackError);
                        showMessage("Errore nella generazione del file. Usa 'Copia Distinta' come alternativa.", "text-red-600");
                        // Final fallback to text copy
                        copyDistintaToClipboard();
                    }
                }
            }
            
            async function shareDistintaAsImage() {
                try {
                    // Generate image from distinta content
                    const canvas = await html2canvas(distintaContent, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    });
                    
                    const imageDataUrl = canvas.toDataURL("image/png");
                    
                    // Prepare share text for distinta
                    const shareText = `📋 Distinta Ufficiale\n\n⚽ Rosterkick`;

                    // Detect if user is on mobile device
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                     (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));

                    // Try Web Share API first (prioritize on mobile)
                    if (navigator.share && navigator.canShare) {
                        try {
                            // Convert data URL to blob
                            const response = await fetch(imageDataUrl);
                            const blob = await response.blob();
                            const file = new File([blob], `distinta-ufficiale-${new Date().toLocaleDateString('it-IT')}.png`, { type: 'image/png' });

                            const shareDataWithFile = {
                                title: 'Distinta Ufficiale',
                                text: shareText,
                                files: [file]
                            };

                            // Check if sharing with files is supported
                            if (navigator.canShare(shareDataWithFile)) {
                                await navigator.share(shareDataWithFile);
                                showMessage("Distinta condivisa con successo!", "text-green-600");
                                return;
                            }
                        } catch (fileShareError) {
                            console.log('File sharing failed for distinta, trying text sharing');
                        }

                        // Try text sharing without file
                        try {
                            await navigator.share({
                                title: 'Distinta Ufficiale',
                                text: shareText
                            });
                            
                            // Download image separately since we couldn't share it directly
                            downloadDistintaImage(imageDataUrl);
                            showMessage("Condivisione avviata! L'immagine è stata scaricata separatamente.", "text-blue-600");
                            return;
                        } catch (textShareError) {
                            console.log('Text sharing failed for distinta, falling back to download');
                        }
                    }
                    
                    // Final fallback: download the image
                    downloadDistintaImage(imageDataUrl);
                    showMessage("Web Share non disponibile. Immagine della distinta scaricata!", "text-orange-600");
                    
                } catch (error) {
                    console.error('Errore nella condivisione della distinta:', error);
                    showMessage("Errore nella generazione dell'immagine. Usa il pulsante 'Copia Distinta' come alternativa.", "text-red-600");
                    // Fallback to text copy
                    copyDistintaToClipboard();
                }
            }
            
            // Helper function to download distinta image
            function downloadDistintaImage(imageDataUrl) {
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = `distinta-ufficiale-${new Date().toLocaleDateString('it-IT')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Event listeners for new company-based navigation
            verifyCompanyButton.addEventListener('click', async () => {
                const companyCode = companyCodeInput.value.trim();
                if (!companyCode) {
                    companyEntryMessageArea.textContent = "Inserisci un codice società.";
                    companyEntryMessageArea.classList.remove('hidden');
                    companyEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                    return;
                }

                try {
                    const companyData = await verifyCompanyCode(companyCode);
                    if (companyData) {
                        currentCompanyCode = companyCode;
                        window.currentCompanyCode = currentCompanyCode;
                        currentCompanyData = companyData;
                        
                        // Store document ID if available (from Firebase/cercaSocietaDaCodice)
                        if (currentCompanyData.data && currentCompanyData.data.id) {
                            currentCompanyDocumentId = currentCompanyData.data.id;
                        } else {
                            // Fallback to company code for demo mode
                            currentCompanyDocumentId = companyCode;
                        }
                        
                        // Populate passwords from data.config if available
                        if (currentCompanyData.data && currentCompanyData.data.config) {
                            currentCompanyData.passwords = {
                                ...(currentCompanyData.passwords || {}), // Keep existing passwords for backward compatibility
                                dirigente: currentCompanyData.data.config.dirigentePassword,
                                mister: currentCompanyData.data.config.misterPassword
                            };
                        }
                        
                        window.currentCompanyData = currentCompanyData;
                        companyPlayers = await loadCompanyPlayers();
                        companyCoaches = await loadCompanyCoaches();
                        companyDirectors = await loadCompanyDirectors();
                        
                        if (rememberCompanyCheckbox.checked) {
                            localStorage.setItem('companyCode', companyCode);
                            localStorage.setItem('companyData', JSON.stringify(companyData));
                            localStorage.setItem('rememberCompanyPreference', 'true');
                            // Show confirmation message
                            setTimeout(() => {
                                companyEntryMessageArea.textContent = "Codice società salvato!";
                                companyEntryMessageArea.classList.remove('hidden', 'text-red-600');
                                companyEntryMessageArea.classList.add('text-green-600');
                                setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 3000);
                            }, 500);
                        } else {
                            localStorage.removeItem('companyCode');
                            localStorage.removeItem('companyData');
                            localStorage.setItem('rememberCompanyPreference', 'false');
                        }
                        
                        // Hide any error messages
                        companyEntryMessageArea.classList.add('hidden');
                        companyEntryMessageArea.classList.remove('text-red-600');
                        
                        showCompanyWelcome();
                    } else {
                        companyEntryMessageArea.textContent = "Codice società non valido.";
                        companyEntryMessageArea.classList.remove('hidden');
                        companyEntryMessageArea.classList.add('text-red-600');
                        setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                    }
                } catch (error) {
                    companyEntryMessageArea.textContent = "Errore nella verifica. Riprova.";
                    companyEntryMessageArea.classList.remove('hidden');
                    companyEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => companyEntryMessageArea.classList.add('hidden'), 5000);
                }
            });

            enterMisterButton.addEventListener('click', () => {
                showPasswordEntry('mister');
            });

            enterDirigenteButton.addEventListener('click', () => {
                showPasswordEntry('dirigente');
            });

            viewHistoryButton.addEventListener('click', () => {
                // Use document ID as app ID (fallback to company code for demo mode)
                const companyAppId = currentCompanyDocumentId || currentCompanyCode;
                currentAppId = companyAppId;
                historyPreviousView = 'welcome'; // track that we came from welcome screen
                hideAllScreens();
                historyView.classList.remove('hidden');
                setupFirestoreListeners(companyAppId);
            });

            welcomeAttendanceButton.addEventListener('click', () => {
                // 🔍 DIAGNOSTIC LOG: Opening Riepilogo Presenze with company info from welcome screen
                console.log(`📊 [DIAGNOSTIC] Apertura Riepilogo Presenze da schermata benvenuto:`);
                console.log(`   🏢 Società corrente - Codice: ${currentCompanyCode}`);
                console.log(`   🏢 Società corrente - Document ID: ${currentCompanyDocumentId}`);
                console.log(`   🏢 Società corrente - Nome: ${currentCompanyData?.name || currentCompanyData?.data?.nome || 'N/A'}`);
                console.log(`   📋 App ID utilizzato per i dati: ${currentAppId}`);
                console.log(`   👤 Ruolo utente: ${userRole}`);
                
                // Check if company IDs are consistent
                const expectedAppId = currentCompanyDocumentId || currentCompanyCode;
                if (currentAppId !== expectedAppId) {
                    console.warn(`⚠️ [DIAGNOSTIC] INCONSISTENZA RILEVATA:`);
                    console.warn(`   App ID attuale: ${currentAppId}`);
                    console.warn(`   App ID atteso: ${expectedAppId}`);
                    console.warn(`   Correggendo l'App ID per visualizzare i dati corretti`);
                    
                    // Fix the inconsistency by updating currentAppId and refreshing listeners
                    currentAppId = expectedAppId;
                    console.log(`🔧 [DIAGNOSTIC] App ID corretto a: ${currentAppId}`);
                    
                    // Refresh Firestore listeners with correct company ID
                    setupFirestoreListeners(currentAppId);
                }
                
                attendancePreviousView = 'welcome'; // track that we came from welcome screen
                // Hide all screens and show attendance view
                hideAllScreens();
                attendanceView.classList.remove('hidden');
            });

            trainingAttendanceButton.addEventListener('click', () => {
                console.log('📊 Opening Training Attendance View...');
                hideAllScreens();
                trainingAttendanceView.classList.remove('hidden');
                loadTrainingAttendance(); // Load data when opening the view
            });

            campionatoButton.addEventListener('click', () => {
                console.log('⚽ Opening Campionato View...');
                hideAllScreens();
                campionatoView.classList.remove('hidden');
                
                // Center "Risultati" widget only for PIEVE2010 company
                const companyName = currentCompanyData?.name || currentCompanyData?.data?.nome || '';
                if (companyName === 'PIEVE2010') {
                    const risultatiContainer = document.getElementById('risultati-widget-container');
                    if (risultatiContainer) {
                        risultatiContainer.style.display = 'flex';
                        risultatiContainer.style.justifyContent = 'center';
                        risultatiContainer.style.alignItems = 'center';
                        console.log('🎯 Risultati widget centered for POLIS PIEVE 2010');
                    }
                }
            });

            managePlayersButton.addEventListener('click', () => {
                showPlayerManagement();
            });

            companyLogoutButton.addEventListener('click', () => {
                // Always remove session-specific data
                localStorage.removeItem('userRole');
                localStorage.removeItem('convocazioniAppId');
                
                // Check if user wants to remember company code
                const rememberPreference = localStorage.getItem('rememberCompanyPreference');
                if (rememberPreference !== 'true') {
                    // If user doesn't want to remember, remove company data
                    localStorage.removeItem('companyCode');
                    localStorage.removeItem('companyData');
                }
                
                // Reset application state
                currentCompanyCode = null;
                window.currentCompanyCode = currentCompanyCode;
                currentCompanyData = null;
                window.currentCompanyData = currentCompanyData;
                companyPlayers = [];
                userRole = null;
                hideAllScreens();
                companyEntryScreen.classList.remove('hidden'); // mostra schermata di login/codice società
                // Trigger login animations sequence
                setTimeout(() => startLoginAnimations(), 100);
            });

            // Common password validation function for main script
            async function handlePasswordSubmissionMain() {
                const password = passwordInput.value.trim();
                if (!password) {
                    passwordEntryMessageArea.textContent = "Inserisci la password.";
                    passwordEntryMessageArea.classList.remove('hidden');
                    passwordEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => passwordEntryMessageArea.classList.add('hidden'), 5000);
                    return;
                }

                const isValid = await verifyPassword(pendingRole, password);
                if (isValid) {
                    userRole = pendingRole;
                    localStorage.setItem('userRole', userRole);
                    
                    // 🔍 DIAGNOSTIC LOG: Login as mister/dirigente with company info
                    console.log(`🔑 [DIAGNOSTIC] Login come ${userRole}:`);
                    console.log(`   🏢 Società attiva - Codice: ${currentCompanyCode}`);
                    console.log(`   🏢 Società attiva - Document ID: ${currentCompanyDocumentId}`);
                    console.log(`   🏢 Società attiva - Nome: ${currentCompanyData?.name || currentCompanyData?.data?.nome || 'N/A'}`);
                    console.log(`   📋 App ID che verrà utilizzato: ${currentCompanyDocumentId || currentCompanyCode}`);
                    
                    // Load company players from Firebase database
                    companyPlayers = await loadCompanyPlayers();
                    companyCoaches = await loadCompanyCoaches();
                    companyDirectors = await loadCompanyDirectors();
                    
                    // Use document ID as app ID (fallback to company code for demo mode)
                    const companyAppId = currentCompanyDocumentId || currentCompanyCode;
                    localStorage.setItem('convocazioniAppId', companyAppId);
                    startApp(companyAppId);
                } else {
                    passwordEntryMessageArea.textContent = "Password errata.";
                    passwordEntryMessageArea.classList.remove('hidden');
                    passwordEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => passwordEntryMessageArea.classList.add('hidden'), 5000);
                }
            }

            confirmPasswordButton.addEventListener('click', handlePasswordSubmissionMain);

            // Handle form submission (Enter key)
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent default form submission
                handlePasswordSubmissionMain();
            });

            cancelPasswordButton.addEventListener('click', () => {
                pendingRole = null;
                passwordInput.value = '';
                showCompanyWelcome();
            });

            addPlayerButton.addEventListener('click', async () => {
                // Get values from form fields
                const numero = playerNumeroInput.value.trim();
                const nome = playerNomeInput.value.trim();
                const dataNascita = playerDataNascitaInput.value.trim();
                const matricola = playerMatricolaInput.value.trim();
                
                // Validate required fields
                if (!numero || !nome || !dataNascita || !matricola) {
                    showMessage("Tutti i campi sono obbligatori: numero, nome, data di nascita, matricola.", "text-red-600");
                    return;
                }
                
                // Check if number is already used
                const playerExists = companyPlayers.some(player => {
                    // Handle both old string format and new object format
                    if (typeof player === 'string') {
                        const playerNumber = player.split(' ')[0];
                        return playerNumber === numero;
                    } else {
                        return player.numero === numero;
                    }
                });
                
                if (playerExists) {
                    showMessage(`Giocatore con numero ${numero} già presente nella lista.`, "text-red-600");
                    return;
                }
                
                // Create player object
                const newPlayer = {
                    numero: numero,
                    nome: nome.toUpperCase(),
                    dataNascita: dataNascita,
                    matricola: matricola.toUpperCase()
                };
                
                companyPlayers.push(newPlayer);
                companyPlayers = sortPlayersByName(companyPlayers); // Keep players in alphabetical order by name
                
                // Clear form fields
                playerNumeroInput.value = '';
                playerNomeInput.value = '';
                playerDataNascitaInput.value = '';
                playerMatricolaInput.value = '';
                
                renderCompanyPlayers();
                showMessage("Giocatore aggiunto alla lista. Ricorda di salvare!", "text-blue-600");
            });

            savePlayersButton.addEventListener('click', async () => {
                if (companyPlayers.length === 0) {
                    showSavePlayersMessage("Nessun giocatore da salvare.", "text-orange-600");
                    return;
                }

                savePlayersButton.disabled = true;
                savePlayersButton.textContent = "Salvataggio in corso...";
                
                try {
                    await saveCompanyPlayers(companyPlayers);
                    showSavePlayersMessage("Giocatori salvati con successo!", "text-green-600");
                } catch (error) {
                    console.error("Errore nel salvataggio:", error);
                    showSavePlayersMessage("Errore nel salvataggio dei giocatori.", "text-red-600");
                } finally {
                    savePlayersButton.disabled = false;
                    savePlayersButton.textContent = "Salva Giocatori";
                    updateSavePlayersButtonState();
                }
            });

            backFromPlayersButton.addEventListener('click', () => {
                showCompanyWelcome();
            });
            
            topBackFromPlayersButton.addEventListener('click', () => {
                showCompanyWelcome();
            });

            // Company information event handlers
            const saveCompanyInfoButton = document.getElementById('save-company-info-button');
            const saveCompanyMessageArea = document.getElementById('save-company-message-area');
            const teamCategoriaInput = document.getElementById('team-categoria');
            const companyRagioneSocialeInput = document.getElementById('company-ragione-sociale');
            const companyIndirizzoInput = document.getElementById('company-indirizzo');
            const companyTelefonoInput = document.getElementById('company-telefono');
            const companyMailInput = document.getElementById('company-mail');
            const companyPartitaIvaInput = document.getElementById('company-partita-iva');

            // Function to save company information
            async function saveCompanyInfo() {
                if (!currentCompanyCode) {
                    console.error("Codice società non disponibile");
                    saveCompanyMessageArea.textContent = "Errore: Codice società non disponibile.";
                    saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                    saveCompanyMessageArea.classList.remove('hidden');
                    setTimeout(() => {
                        saveCompanyMessageArea.classList.add('hidden');
                    }, 5000);
                    return;
                }

                const companyInfo = {
                    categoria: teamCategoriaInput.value.trim(),
                    ragioneSociale: companyRagioneSocialeInput.value.trim(),
                    indirizzo: companyIndirizzoInput.value.trim(),
                    telefono: companyTelefonoInput.value.trim(),
                    mail: companyMailInput.value.trim(),
                    partitaIva: companyPartitaIvaInput.value.trim(),
                    lastUpdated: new Date().toISOString()
                };

                // Demo mode - save to localStorage only
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    try {
                        console.log("Demo mode: company info saved locally", companyInfo);
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        
                        saveCompanyMessageArea.textContent = "Informazioni società salvate con successo! (Modalità Demo)";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-green-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    } catch (error) {
                        console.error("Error saving company info in demo mode:", error);
                        saveCompanyMessageArea.textContent = "Errore nel salvataggio. Riprova.";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    }
                }

                // Firebase mode - save to Firebase with localStorage fallback
                if (!window.db) {
                    // Firebase not available, fallback to localStorage
                    console.log("Firebase not available, saving company info to localStorage as fallback");
                    try {
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        
                        saveCompanyMessageArea.textContent = "Informazioni società salvate localmente (Firebase non disponibile).";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-orange-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        saveCompanyMessageArea.textContent = "Errore nel salvataggio. Riprova.";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                        return;
                    }
                }

                try {
                    // Save to Firebase - company info document in subcollection
                    const companyInfoRef = window.doc(window.db, "societa", currentCompanyDocumentId, "companyInfo", "main");
                    await window.setDoc(companyInfoRef, companyInfo);
                    
                    // Also save to localStorage as backup
                    localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                    
                    console.log("✅ Company information saved to Firebase:", companyInfo);
                    
                    saveCompanyMessageArea.textContent = "Informazioni società salvate con successo su Firebase!";
                    saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-green-600";
                    saveCompanyMessageArea.classList.remove('hidden');
                    setTimeout(() => {
                        saveCompanyMessageArea.classList.add('hidden');
                    }, 5000);
                    
                } catch (firebaseError) {
                    console.error("❌ Firebase save failed, using localStorage fallback:", firebaseError);
                    // Fallback to localStorage
                    try {
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        console.log("Company info saved to localStorage as fallback");
                        
                        saveCompanyMessageArea.textContent = "Informazioni salvate localmente (errore Firebase).";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-orange-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                    } catch (fallbackError) {
                        console.error("Fallback to localStorage also failed:", fallbackError);
                        saveCompanyMessageArea.textContent = "Errore nel salvataggio. Riprova.";
                        saveCompanyMessageArea.className = "mt-2 mb-4 text-center text-sm font-medium text-red-600";
                        saveCompanyMessageArea.classList.remove('hidden');
                        setTimeout(() => {
                            saveCompanyMessageArea.classList.add('hidden');
                        }, 5000);
                    }
                }
            }

            // Function to load company information
            async function loadCompanyInfo() {
                if (!currentCompanyCode) {
                    console.log("Nessun codice società disponibile per caricare le informazioni");
                    return;
                }
                
                console.log(`🏢 Caricamento informazioni società per: ${currentCompanyCode}`);

                // Demo mode - load from localStorage only
                if (currentCompanyCode === "DEMO" || currentCompanyCode === "demo") {
                    try {
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("📁 Demo mode: company info loaded from localStorage:", companyInfo);
                        }
                    } catch (error) {
                        console.error("Error loading company info in demo mode:", error);
                    }
                    return;
                }

                // Firebase mode - load from Firebase with localStorage fallback
                if (!window.db) {
                    // Firebase not available, try localStorage fallback
                    console.log("Firebase not available, trying localStorage fallback");
                    try {
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("📁 Company info loaded from localStorage fallback:", companyInfo);
                        }
                    } catch (error) {
                        console.error("Error loading company info from localStorage fallback:", error);
                    }
                    return;
                }

                try {
                    // Try to load from Firebase first
                    const companyInfoRef = window.doc(window.db, "societa", currentCompanyDocumentId, "companyInfo", "main");
                    const companyInfoSnap = await window.getDoc(companyInfoRef);
                    
                    if (companyInfoSnap.exists()) {
                        const companyInfo = companyInfoSnap.data();
                        teamCategoriaInput.value = companyInfo.categoria || '';
                        companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                        companyIndirizzoInput.value = companyInfo.indirizzo || '';
                        companyTelefonoInput.value = companyInfo.telefono || '';
                        companyMailInput.value = companyInfo.mail || '';
                        companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                        
                        // Also save to localStorage as backup
                        localStorage.setItem(`companyInfo_${currentCompanyCode}`, JSON.stringify(companyInfo));
                        
                        console.log("✅ Company info loaded from Firebase:", companyInfo);
                    } else {
                        console.log("🔍 No company info found in Firebase, trying localStorage fallback");
                        
                        // Try localStorage fallback
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("📁 Company info loaded from localStorage fallback:", companyInfo);
                        } else {
                            console.log("ℹ️ No company info found in Firebase or localStorage - starting with empty fields");
                        }
                    }
                    
                } catch (firebaseError) {
                    console.error("❌ Firebase load failed, using localStorage fallback:", firebaseError);
                    
                    // Fallback to localStorage
                    try {
                        const savedInfo = localStorage.getItem(`companyInfo_${currentCompanyCode}`);
                        if (savedInfo) {
                            const companyInfo = JSON.parse(savedInfo);
                            teamCategoriaInput.value = companyInfo.categoria || '';
                            companyRagioneSocialeInput.value = companyInfo.ragioneSociale || '';
                            companyIndirizzoInput.value = companyInfo.indirizzo || '';
                            companyTelefonoInput.value = companyInfo.telefono || '';
                            companyMailInput.value = companyInfo.mail || '';
                            companyPartitaIvaInput.value = companyInfo.partitaIva || '';
                            
                            console.log("🔄 Fallback: company info loaded from localStorage after Firebase error");
                        }
                    } catch (parseError) {
                        console.error("❌ Error parsing localStorage fallback:", parseError);
                    }
                }
            }

            saveCompanyInfoButton.addEventListener('click', async () => {
                await saveCompanyInfo();
            });

            // Load company info when switching to player management screen
            const originalShowPlayerManagement = showPlayerManagement;
            showPlayerManagement = async function() {
                originalShowPlayerManagement.call(this);
                await loadCompanyInfo();
            };

            // Coach management event listeners
            addCoachButton.addEventListener('click', async () => {
                const coachName = newCoachInput.value.trim();
                const coachMatricola = newCoachMatricolaInput.value.trim();
                
                if (!coachName) {
                    showCoachMessage("Inserisci il nome del mister.", "text-red-600");
                    return;
                }

                if (!coachMatricola) {
                    showCoachMessage("Inserisci la matricola del mister.", "text-red-600");
                    return;
                }

                // Check if coach with same name already exists
                const existingCoach = companyCoaches.find(coach => 
                    (typeof coach === 'string' ? coach : coach.name) === coachName
                );
                if (existingCoach) {
                    showCoachMessage("Mister già presente nella lista.", "text-red-600");
                    return;
                }

                // Check if coach with same matricola already exists
                const existingMatricola = companyCoaches.find(coach => 
                    typeof coach === 'object' && coach.matricola === coachMatricola
                );
                if (existingMatricola) {
                    showCoachMessage("Matricola già presente nella lista.", "text-red-600");
                    return;
                }

                // Create coach object with name and matricola
                const coachObj = {
                    name: coachName,
                    matricola: coachMatricola
                };

                companyCoaches.push(coachObj);
                companyCoaches.sort((a, b) => {
                    const nameA = typeof a === 'string' ? a : a.name;
                    const nameB = typeof b === 'string' ? b : b.name;
                    return nameA.localeCompare(nameB);
                });
                newCoachInput.value = '';
                newCoachMatricolaInput.value = '';
                renderCompanyCoaches();
                showCoachMessage("Mister aggiunto alla lista. Ricorda di salvare!", "text-blue-600");
            });

            saveCoachesButton.addEventListener('click', async () => {
                if (companyCoaches.length === 0) {
                    showCoachMessage("Nessun mister da salvare.", "text-orange-600");
                    return;
                }

                saveCoachesButton.disabled = true;
                saveCoachesButton.textContent = "Salvataggio in corso...";
                
                try {
                    await saveCompanyCoaches(companyCoaches);
                    showCoachMessage("Mister salvati con successo!", "text-green-600");
                } catch (error) {
                    console.error("Errore nel salvataggio mister:", error);
                    showCoachMessage("Errore nel salvataggio dei mister.", "text-red-600");
                } finally {
                    saveCoachesButton.disabled = false;
                    saveCoachesButton.textContent = "Salva Mister";
                    updateSaveCoachesButtonState();
                }
            });

            // Directors event listeners
            addDirectorButton.addEventListener('click', async () => {
                const directorName = newDirectorNameInput.value.trim();
                const directorSurname = newDirectorSurnameInput.value.trim();
                const directorMatricola = newDirectorMatricolaInput.value.trim();
                
                if (!directorName) {
                    showDirectorMessage("Inserisci il nome del dirigente.", "text-red-600");
                    return;
                }

                if (!directorSurname) {
                    showDirectorMessage("Inserisci il cognome del dirigente.", "text-red-600");
                    return;
                }

                if (!directorMatricola) {
                    showDirectorMessage("Inserisci la matricola del dirigente.", "text-red-600");
                    return;
                }

                // Check if director with same name and surname already exists
                const fullName = `${directorName} ${directorSurname}`;
                const existingDirector = companyDirectors.find(director => 
                    `${director.name} ${director.surname}` === fullName
                );
                if (existingDirector) {
                    showDirectorMessage("Dirigente già presente nella lista.", "text-red-600");
                    return;
                }

                // Check if director with same matricola already exists
                const existingMatricola = companyDirectors.find(director => 
                    director.matricola === directorMatricola
                );
                if (existingMatricola) {
                    showDirectorMessage("Matricola già presente nella lista.", "text-red-600");
                    return;
                }

                // Add new director
                const directorObj = {
                    name: directorName,
                    surname: directorSurname,
                    matricola: directorMatricola
                };

                companyDirectors.push(directorObj);
                companyDirectors.sort((a, b) => {
                    const surnameCompare = (a.surname || '').localeCompare(b.surname || '');
                    if (surnameCompare !== 0) return surnameCompare;
                    return (a.name || '').localeCompare(b.name || '');
                });
                newDirectorNameInput.value = '';
                newDirectorSurnameInput.value = '';
                newDirectorMatricolaInput.value = '';
                renderCompanyDirectors();
                showDirectorMessage("Dirigente aggiunto alla lista. Ricorda di salvare!", "text-blue-600");
            });

            saveDirectorsButton.addEventListener('click', async () => {
                if (companyDirectors.length === 0) {
                    showDirectorMessage("Nessun dirigente da salvare.", "text-orange-600");
                    return;
                }

                saveDirectorsButton.disabled = true;
                saveDirectorsButton.textContent = "Salvataggio in corso...";
                
                try {
                    await saveCompanyDirectors(companyDirectors);
                    showDirectorMessage("Dirigenti salvati con successo!", "text-green-600");
                } catch (error) {
                    console.error("Errore nel salvataggio dirigenti:", error);
                    showDirectorMessage("Errore nel salvataggio dei dirigenti.", "text-red-600");
                } finally {
                    saveDirectorsButton.disabled = false;
                    saveDirectorsButton.textContent = "Salva Dirigenti";
                    updateSaveDirectorsButtonState();
                }
            });

            // Event listener for remember company checkbox
            rememberCompanyCheckbox.addEventListener('change', () => {
                if (rememberCompanyCheckbox.checked) {
                    localStorage.setItem('rememberCompanyPreference', 'true');
                } else {
                    localStorage.setItem('rememberCompanyPreference', 'false');
                    // If unchecked, remove saved company data immediately
                    localStorage.removeItem('companyCode');
                    localStorage.removeItem('companyData');
                }
            });

            // Event listeners for view switching
            enterButton.addEventListener('click', () => {
                const name = nameInput.value.trim().toLowerCase();
                if (name === 'mister' || name === 'marco') {
                    userRole = name;
                    
                    if (rememberMeCheckbox.checked) {
                        localStorage.setItem('userRole', userRole);
                    } else {
                        localStorage.removeItem('userRole');
                    }
                    
                    nameEntryScreen.classList.add('hidden');
                    const savedAppId = localStorage.getItem('convocazioniAppId');
                    if (savedAppId) {
                         startApp(savedAppId);
                    } else {
                         startScreen.classList.remove('hidden');
                    }
                } else {
                    nameEntryMessageArea.textContent = "Nome non valido.";
                    nameEntryMessageArea.classList.remove('hidden');
                    nameEntryMessageArea.classList.add('text-red-600');
                    setTimeout(() => {
                        nameEntryMessageArea.classList.add('hidden');
                    }, 5000);
                }
            });
            
            const savedJoinAppId = localStorage.getItem('joinAppId');
            if (savedJoinAppId) {
                joinAppIdInput.value = savedJoinAppId;
                rememberTeamIdCheckbox.checked = true;
            }

            createTeamButton.addEventListener('click', () => {
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('convocazioniAppId', window.appId);
                } else {
                    localStorage.removeItem('convocazioniAppId');
                }
                startApp(window.appId);
            });

            joinTeamButton.addEventListener('click', () => {
                const joinedId = joinAppIdInput.value.trim();
                if (joinedId.length > 0) {
                     if (rememberTeamIdCheckbox.checked) {
                        localStorage.setItem('joinAppId', joinedId);
                    } else {
                        localStorage.removeItem('joinAppId');
                    }
                     if (rememberMeCheckbox.checked) {
                        localStorage.setItem('convocazioniAppId', joinedId);
                    } else {
                        localStorage.removeItem('convocazioniAppId');
                    }
                    startApp(joinedId);
                } else {
                    startMessageArea.textContent = "Per favore, inserisci un ID app valido.";
                    startMessageArea.classList.remove('hidden');
                    startMessageArea.classList.add('text-red-600');
                    setTimeout(() => {
                        startMessageArea.classList.add('hidden');
                    }, 5000);
                }
            });

            forgetDataButton.addEventListener('click', forgetDataAndReset);
            changeTeamButton.addEventListener('click', logoutToCompanyWelcome);
            resetSelectionsButton.addEventListener('click', resetPlayerSelections);
            esciButton.addEventListener('click', logoutToCompanyWelcome);
            
            // Enhanced share button handler - prioritizes Web Share API on mobile
            async function handleMainShareButton() {
                if (userRole !== 'mister') {
                    showMessage("Solo il Mister può condividere le convocazioni.", "text-red-600");
                    return;
                }
                
                // Detect if user is on mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                 (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
                
                // On mobile devices, try Web Share API directly first
                if (isMobile && navigator.share) {
                    try {
                        await handleWebShare();
                        return; // Success, no need to show modal
                    } catch (error) {
                        console.log('Direct Web Share failed, showing modal:', error);
                        // Continue to show modal as fallback
                    }
                }
                
                // Default behavior: show the sharing modal
                showShareModal();
            }
            
            saveButton.addEventListener('click', saveData);
            shareButton.addEventListener('click', handleMainShareButton);
            
            // Handle tipo-partita selection change for Mister role
            const tipoPartitaSelect = document.getElementById('tipo-partita');
            const avversarioInput = document.getElementById('avversario');
            
            tipoPartitaSelect.addEventListener('change', () => {
                if (userRole === 'mister') {
                    const selectedType = tipoPartitaSelect.value;
                    if (selectedType === 'Torneo') {
                        // Clear avversario field and set trophy emoji
                        avversarioInput.value = '🏆';
                        avversarioInput.readOnly = true;
                        avversarioInput.style.backgroundColor = '#f9fafb';
                        avversarioInput.style.textAlign = 'center';
                        avversarioInput.style.fontSize = '1.5rem';
                    } else {
                        // Restore normal avversario field functionality
                        if (avversarioInput.value === '🏆') {
                            avversarioInput.value = '';
                        }
                        avversarioInput.readOnly = false;
                        avversarioInput.style.backgroundColor = 'white';
                        avversarioInput.style.textAlign = 'left';
                        avversarioInput.style.fontSize = '';
                    }
                }
            });
            historyButton.addEventListener('click', () => {
                historyPreviousView = 'main'; // track that we came from main view
                mainView.classList.add('hidden');
                historyView.classList.remove('hidden');
                attendanceView.classList.add('hidden');
            });
            attendanceButton.addEventListener('click', () => {
                // 🔍 DIAGNOSTIC LOG: Opening Riepilogo Presenze with company info
                console.log(`📊 [DIAGNOSTIC] Apertura Riepilogo Presenze:`);
                console.log(`   🏢 Società corrente - Codice: ${currentCompanyCode}`);
                console.log(`   🏢 Società corrente - Document ID: ${currentCompanyDocumentId}`);
                console.log(`   🏢 Società corrente - Nome: ${currentCompanyData?.name || currentCompanyData?.data?.nome || 'N/A'}`);
                console.log(`   📋 App ID utilizzato per i dati: ${currentAppId}`);
                console.log(`   👤 Ruolo utente: ${userRole}`);
                
                // Check if company IDs are consistent
                const expectedAppId = currentCompanyDocumentId || currentCompanyCode;
                if (currentAppId !== expectedAppId) {
                    console.warn(`⚠️ [DIAGNOSTIC] INCONSISTENZA RILEVATA:`);
                    console.warn(`   App ID attuale: ${currentAppId}`);
                    console.warn(`   App ID atteso: ${expectedAppId}`);
                    console.warn(`   Correggendo l'App ID per visualizzare i dati corretti`);
                    
                    // Fix the inconsistency by updating currentAppId and refreshing listeners
                    currentAppId = expectedAppId;
                    console.log(`🔧 [DIAGNOSTIC] App ID corretto a: ${currentAppId}`);
                    
                    // Refresh Firestore listeners with correct company ID
                    setupFirestoreListeners(currentAppId);
                }
                
                attendancePreviousView = 'main'; // track that we came from main view
                mainView.classList.add('hidden');
                historyView.classList.add('hidden');
                attendanceView.classList.remove('hidden');
            });
            backFromHistoryButton.addEventListener('click', () => {
                historyView.classList.add('hidden');
                if (historyPreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                historyPreviousView = null; // reset for next time
            });
            
            topBackFromHistoryButton.addEventListener('click', () => {
                historyView.classList.add('hidden');
                if (historyPreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                historyPreviousView = null; // reset for next time
            });
            backFromAttendanceButton.addEventListener('click', () => {
                attendanceView.classList.add('hidden');
                if (attendancePreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                attendancePreviousView = null; // reset for next time
            });
            
            topBackFromAttendanceButton.addEventListener('click', () => {
                attendanceView.classList.add('hidden');
                if (attendancePreviousView === 'welcome') {
                    // Came from welcome screen, go back to welcome
                    if (currentCompanyCode) {
                        showCompanyWelcome();
                    } else {
                        mainView.classList.remove('hidden');
                    }
                } else {
                    // Came from main view (Mister/Dirigente), go back to main view
                    mainView.classList.remove('hidden');
                }
                attendancePreviousView = null; // reset for next time
            });

            closeModalButton.addEventListener('click', hideModal);
            closeUnavailableModalButton.addEventListener('click', hideUnavailablePlayerModal);
            closeShareModalButton.addEventListener('click', hideShareModal);
            confirmAlreadyCalledButton.addEventListener('click', confirmAlreadyCalledSelection);
            cancelAlreadyCalledButton.addEventListener('click', hideAlreadyCalledModal);
            saveNotesButton.addEventListener('click', saveNotes);

            // Distinta Modal Event Listeners
            closeDistintaLocationModalButton.addEventListener('click', hideDistintaLocationModal);
            closeDistintaDirigentiModalButton.addEventListener('click', hideDistintaDirigentiModal);
            confirmDirigentiSelectionButton.addEventListener('click', confirmDirigentiSelection);
            closeDistintaDisplayModalButton.addEventListener('click', hideDistintaDisplayModal);
            distintaHomeButton.addEventListener('click', async () => await selectDistintaLocation('casa'));
            distintaAwayButton.addEventListener('click', async () => await selectDistintaLocation('trasferta'));
            copyDistintaButton.addEventListener('click', copyDistintaToClipboard);
            printDistintaButton.addEventListener('click', printDistinta);
            shareDistintaButton.addEventListener('click', shareDistinta);

            // Close modals when clicking outside of them
            statusModal.addEventListener('click', (e) => {
                if (e.target === statusModal) {
                    hideModal();
                }
            });

            unavailablePlayerModal.addEventListener('click', (e) => {
                if (e.target === unavailablePlayerModal) {
                    hideUnavailablePlayerModal();
                }
            });

            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    hideShareModal();
                }
            });

            alreadyCalledModal.addEventListener('click', (e) => {
                if (e.target === alreadyCalledModal) {
                    hideAlreadyCalledModal();
                }
            });

            distintaLocationModal.addEventListener('click', (e) => {
                if (e.target === distintaLocationModal) {
                    hideDistintaLocationModal();
                }
            });

            distintaDisplayModal.addEventListener('click', (e) => {
                if (e.target === distintaDisplayModal) {
                    hideDistintaDisplayModal();
                }
            });

            // Share modal button event listeners
            webShareButton.addEventListener('click', handleWebShare);
            whatsappShareButton.addEventListener('click', handleWhatsAppShare);
            telegramShareButton.addEventListener('click', handleTelegramShare);
            emailShareButton.addEventListener('click', handleEmailShare);
            copyLinkButton.addEventListener('click', handleCopyLink);
            downloadImageButton.addEventListener('click', handleDownloadImage);

            // PATCH: gestione status per Dirigente/Marco, incluso "Disponibile"
            statusButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const status = event.target.dataset.status;
                    const currentPlayerItem = document.querySelector(`.player-item[data-player="${tempPlayerName}"]`);
                    
                    if (status === 'Disponibile') {
                        unavailablePlayers.delete(tempPlayerName);
                        currentPlayerItem.classList.remove('selected-marco', 'selected-marco-orange', 'selected-marco-black', 'selected-marco-purple');
                    } else {
                        unavailablePlayers.set(tempPlayerName, status);
                        currentPlayerItem.classList.remove('selected-marco', 'selected-marco-orange', 'selected-marco-black', 'selected-marco-purple');
                        if (status === 'Infortunato' || status === 'Squalificato') {
                            currentPlayerItem.classList.add('selected-marco-black');
                        } else if (status === 'Non disponibile Sabato' || status === 'Non disponibile Domenica') {
                            currentPlayerItem.classList.add('selected-marco-purple');
                        } else if (status === 'Solo 2 allenamenti' || status === 'Solo 1 allenamento') {
                            currentPlayerItem.classList.add('selected-marco-orange');
                        } else if (status === 'Zero allenamenti' || status === 'Non disponibile Weekend') {
                            currentPlayerItem.classList.add('selected-marco');
                        } else {
                            currentPlayerItem.classList.add('selected-marco');
                        }
                    }
                    
                    updateUnavailablePlayersView();
                    hideModal();
                    tempPlayerName = null;
                });
            });

            // *** MODIFICA: Gestione pulsante "Convoca ugualmente" ***
            convocaComunqueButton.addEventListener('click', () => {
                // Seleziona il giocatore come convocato anche se non disponibile
                if (typeof tempUnavailablePlayerName === 'string' && tempUnavailablePlayerName.length > 0) {
                    const playerItem = document.querySelector(`.player-item[data-player="${tempUnavailablePlayerName}"]`);
                    if (playerItem) {
                        playerItem.classList.add('selected-mister');
                        updateSelectedPlayersLiveList(tempUnavailablePlayerName, true);
                    }
                }
                hideUnavailablePlayerModal();
            });

            // *** NUOVA: Gestione conferma giocatore già convocato oggi ***
            function confirmAlreadyCalledSelection() {
                if (typeof tempAlreadyCalledPlayerName === 'string' && tempAlreadyCalledPlayerName.length > 0) {
                    const playerItem = document.querySelector(`.player-item[data-player="${tempAlreadyCalledPlayerName}"]`);
                    if (playerItem) {
                        playerItem.classList.add('selected-mister');
                        updateSelectedPlayersLiveList(tempAlreadyCalledPlayerName, true);
                    }
                }
                hideAlreadyCalledModal();
            }

            function copyAppId() {
                const tempInput = document.createElement('textarea');
                tempInput.value = appIdDisplay.textContent;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    const success = document.execCommand('copy');
                    if (success) {
                        const originalText = appIdDisplay.textContent;
                        appIdDisplay.textContent = 'Copiato!';
                        setTimeout(() => {
                            appIdDisplay.textContent = originalText;
                        }, 1000);
                    } else {
                        console.error('Errore nella copia: document.execCommand("copy") failed.');
                        showMessage("Impossibile copiare. Il browser non lo supporta.", "text-red-600");
                    }
                } catch (err) {
                    console.error('Errore nella copia: ', err);
                    showMessage("Errore durante la copia. Controlla la console.", "text-red-600");
                } finally {
                    document.body.removeChild(tempInput);
                }
            }
            window.copyAppId = copyAppId;

            // Debug function to display saved players for current company
            async function debugMostraGiocatoriSalvati() {
                console.log('🔍 DEBUG - Funzione debugMostraGiocatoriSalvati() avviata');
                
                if (!currentCompanyCode) {
                    console.log('❌ DEBUG - Nessuna società selezionata (currentCompanyCode è null/undefined)');
                    console.log("💡 DEBUG - Per utilizzare questa funzione, prima seleziona una società nell'applicazione");
                    return;
                }
                
                console.log(`🏢 DEBUG - Società selezionata: ${currentCompanyCode}`);
                
                // Check if Firebase is available
                if (!window.db) {
                    console.log('❌ DEBUG - Firebase non disponibile, controllo localStorage...');
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            const players = JSON.parse(savedPlayers);
                            console.log(`📁 DEBUG - Giocatori trovati in localStorage (${players.length}):`, players);
                        } catch (error) {
                            console.error('❌ DEBUG - Errore nel parsing dei dati localStorage:', error);
                        }
                    } else {
                        console.log('❌ DEBUG - Nessun dato trovato in localStorage');
                    }
                    return;
                }
                
                try {
                    console.log(`🔥 DEBUG - Tentativo di lettura da Firebase subcollection...`);
                    console.log(`📄 DEBUG - Leggendo subcollection: societa/${currentCompanyDocumentId}/giocatori`);
                    console.log(`🏷️ DEBUG - Codice società inserito (campo 'codici'): ${currentCompanyCode}`);
                    
                    // Read from Firebase societa subcollection using document ID
                    const playersCollectionRef = window.collection(window.db, "societa", currentCompanyDocumentId, "giocatori");
                    const playersSnapshot = await window.getDocs(playersCollectionRef);
                    
                    if (!playersSnapshot.empty) {
                        const players = [];
                        const playerDetails = [];
                        playersSnapshot.forEach((doc) => {
                            const playerData = doc.data();
                            const playerName = playerData.name || playerData.nome || doc.id;
                            players.push(playerName);
                            playerDetails.push({
                                id: doc.id,
                                name: playerName,
                                data: playerData
                            });
                        });
                        
                        console.log('✅ DEBUG - Subcollection giocatori trovata in Firebase');
                        console.log(`👥 DEBUG - Giocatori salvati nella subcollection (${players.length}):`);
                        
                        // Sort players by name only for consistent display
                        sortPlayersByName(players);
                        console.log('📋 DEBUG - Lista giocatori (ordinata alfabeticamente per nome):', players);
                        
                        // Print each player with index for better readability
                        players.forEach((player, index) => {
                            console.log(`   ${index + 1}. ${player}`);
                        });
                        
                        console.log('📊 DEBUG - Dettagli completi dei documenti nella subcollection:', playerDetails);
                    } else {
                        console.log(`📝 DEBUG - Subcollection societa/${currentCompanyDocumentId}/giocatori vuota o non trovata`);
                        console.log('💡 DEBUG - Verifica che la subcollection esista e contenga documenti');
                    }
                } catch (error) {
                    console.error('💥 DEBUG - Errore durante la lettura dalla subcollection Firebase:', error);
                    console.log('🔄 DEBUG - Tentativo di fallback su localStorage...');
                    
                    // Fallback to localStorage
                    const savedPlayers = localStorage.getItem(`players_${currentCompanyCode}`);
                    if (savedPlayers) {
                        try {
                            const players = JSON.parse(savedPlayers);
                            console.log(`📁 DEBUG - Fallback: Giocatori trovati in localStorage (${players.length}):`, players);
                        } catch (parseError) {
                            console.error('❌ DEBUG - Errore nel parsing del fallback localStorage:', parseError);
                        }
                    } else {
                        console.log('❌ DEBUG - Nessun fallback disponibile in localStorage');
                    }
                }
                
                console.log('🔍 DEBUG - Funzione debugMostraGiocatoriSalvati() completata');
            }
            
            // Expose debug function globally for console access
            window.debugMostraGiocatoriSalvati = debugMostraGiocatoriSalvati;

            // Training attendance event listeners
            const backFromTrainingAttendanceButton = document.getElementById('back-from-training-attendance-button');
            const topBackFromTrainingAttendanceButton = document.getElementById('top-back-from-training-attendance-button');
            const refreshTrainingButton = document.getElementById('refresh-training-button');

            backFromTrainingAttendanceButton.addEventListener('click', () => {
                trainingAttendanceView.classList.add('hidden');
                // Always go back to company welcome screen since training attendance is only available from there
                if (currentCompanyCode) {
                    showCompanyWelcome();
                } else {
                    mainView.classList.remove('hidden');
                }
            });
            
            topBackFromTrainingAttendanceButton.addEventListener('click', () => {
                trainingAttendanceView.classList.add('hidden');
                // Always go back to company welcome screen since training attendance is only available from there
                if (currentCompanyCode) {
                    showCompanyWelcome();
                } else {
                    mainView.classList.remove('hidden');
                }
            });

            refreshTrainingButton.addEventListener('click', () => {
                loadTrainingAttendance();
            });
            
            // Campionato event listeners
            const backFromCampionatoButton = document.getElementById('back-from-campionato-button');
            
            backFromCampionatoButton.addEventListener('click', () => {
                campionatoView.classList.add('hidden');
                // Always go back to company welcome screen since campionato is only available from there
                if (currentCompanyCode) {
                    showCompanyWelcome();
                } else {
                    mainView.classList.remove('hidden');
                }
            });
        });
    </script>
</body>
</html>































