<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test V9.52 - Firebase Cloud Messaging Implementation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-success { background-color: #10b981; color: white; }
        .status-warning { background-color: #f59e0b; color: white; }
        .status-error { background-color: #ef4444; color: white; }
        .code-block {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border-left: 3px solid #3b82f6;
            background-color: #f1f5f9;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800">üîî Test FCM Implementation</h1>
                    <p class="text-gray-600 mt-2">Versione V9.52 - Firebase Cloud Messaging</p>
                </div>
                <div class="text-right">
                    <span class="status-badge status-success">V9.52</span>
                    <p class="text-sm text-gray-500 mt-2">12 Gennaio 2025</p>
                </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
                <p class="text-gray-700 leading-relaxed">
                    Questa pagina di test verifica l'implementazione completa delle notifiche push con Firebase Cloud Messaging.
                </p>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä System Status</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üåê Browser Support</h3>
                    <div id="browser-support" class="space-y-2"></div>
                </div>
                
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üîß Service Workers</h3>
                    <div id="service-workers" class="space-y-2"></div>
                </div>
                
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üîî Notification Permission</h3>
                    <div id="notification-permission" class="space-y-2"></div>
                </div>
                
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üîë FCM Token</h3>
                    <div id="fcm-token-status" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Test Actions -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üß™ Test Actions</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button onclick="requestPermission()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    üì¨ Request Permission
                </button>
                
                <button onclick="getToken()" 
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    üîë Get FCM Token
                </button>
                
                <button onclick="testLocalNotification()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    üîî Test Local Notification
                </button>
                
                <button onclick="checkServiceWorkers()" 
                        class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    üîÑ Check Service Workers
                </button>
                
                <button onclick="copyToken()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    üìã Copy Token
                </button>
                
                <button onclick="clearLogs()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    üóëÔ∏è Clear Logs
                </button>
            </div>
        </div>

        <!-- File Verification -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìÅ File Verification</h2>
            
            <div class="space-y-3">
                <div class="flex items-center justify-between border-b border-gray-200 pb-2">
                    <span class="font-semibold">firebase-messaging-sw.js</span>
                    <span id="file-fcm-sw" class="status-badge">Checking...</span>
                </div>
                <div class="flex items-center justify-between border-b border-gray-200 pb-2">
                    <span class="font-semibold">manifest.json (v9.52)</span>
                    <span id="file-manifest" class="status-badge">Checking...</span>
                </div>
                <div class="flex items-center justify-between border-b border-gray-200 pb-2">
                    <span class="font-semibold">service-worker.js (v9.52)</span>
                    <span id="file-sw" class="status-badge">Checking...</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="font-semibold">index.html (Firebase Messaging SDK)</span>
                    <span id="file-index" class="status-badge status-success">Present</span>
                </div>
            </div>
        </div>

        <!-- Token Display -->
        <div id="token-display" class="bg-white rounded-xl shadow-2xl p-8 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üîë FCM Token</h2>
            <div class="code-block">
                <pre id="token-text" class="whitespace-pre-wrap break-all"></pre>
            </div>
            <p class="text-sm text-gray-500 mt-2">
                Usa questo token per testare le notifiche dalla Firebase Console.
            </p>
        </div>

        <!-- Test Logs -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìù Test Logs</h2>
            <div id="logs" class="space-y-1 max-h-96 overflow-y-auto">
                <!-- Logs will be added here -->
            </div>
        </div>

        <!-- Implementation Details -->
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìö Implementation Details</h2>
            
            <div class="space-y-6">
                <div>
                    <h3 class="font-bold text-lg text-gray-800 mb-2">‚úÖ Files Added</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        <li><code class="bg-gray-100 px-2 py-1 rounded">firebase-messaging-sw.js</code> - Service worker per notifiche in background</li>
                        <li><code class="bg-gray-100 px-2 py-1 rounded">CHANGELOG_V9.52.md</code> - Documentazione completa modifiche</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-bold text-lg text-gray-800 mb-2">üîÑ Files Modified</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        <li><code class="bg-gray-100 px-2 py-1 rounded">index.html</code> - Aggiunto Firebase Messaging SDK e script FCM (~180 righe)</li>
                        <li><code class="bg-gray-100 px-2 py-1 rounded">service-worker.js</code> - Cache version v9.52, aggiunto firebase-messaging-sw.js</li>
                        <li><code class="bg-gray-100 px-2 py-1 rounded">manifest.json</code> - Version V9.52</li>
                        <li><code class="bg-gray-100 px-2 py-1 rounded">PWA_DOCUMENTATION.md</code> - Aggiunta sezione completa FCM (~300 righe)</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-bold text-lg text-gray-800 mb-2">üéØ Features Implemented</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        <li>Notification permission request flow</li>
                        <li>FCM token generation and management</li>
                        <li>Foreground message handling (onMessage)</li>
                        <li>Background message handling (firebase-messaging-sw.js)</li>
                        <li>Token storage in Firestore (fcm_tokens collection)</li>
                        <li>Notification click handling</li>
                        <li>Test functions for development</li>
                        <li>Complete documentation and examples</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-bold text-lg text-gray-800 mb-2">‚ö†Ô∏è Setup Required</h3>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                        <p class="text-yellow-800 font-semibold mb-2">Prima di usare in produzione:</p>
                        <ol class="list-decimal list-inside space-y-1 text-yellow-700">
                            <li>Sostituire <code class="bg-yellow-100 px-2 py-1 rounded">YOUR_VAPID_KEY_HERE</code> in index.html con chiave VAPID reale da Firebase Console</li>
                            <li>Implementare e deployare Cloud Function per invio notifiche</li>
                            <li>Testare su dispositivi reali (Android, iOS, Desktop)</li>
                            <li>Configurare regole Firestore per fcm_tokens collection</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backend Integration -->
        <div class="bg-white rounded-xl shadow-2xl p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üîå Backend Integration Example</h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="font-bold text-gray-800 mb-2">Cloud Function (functions/index.js):</h3>
                    <div class="code-block">
<pre>exports.sendConvocationNotification = functions.firestore
    .document('convocations_history/{convocationId}')
    .onCreate(async (snap, context) => {
        const convocation = snap.data();
        const companyCode = convocation.companyCode;
        
        // Get FCM tokens
        const tokensSnapshot = await admin.firestore()
            .collection('fcm_tokens')
            .doc(companyCode)
            .collection('tokens')
            .get();
        
        const tokens = tokensSnapshot.docs.map(doc => doc.data().token);
        
        // Send notifications
        const response = await admin.messaging().sendMulticast({
            notification: {
                title: 'Nuova Convocazione Rosterkick',
                body: `${convocation.matchType} - ${convocation.formattedDate}`,
            },
            data: {
                convocationId: context.params.convocationId,
                type: 'new_convocation'
            },
            tokens: tokens
        });
        
        console.log(`‚úÖ ${response.successCount}/${tokens.length} sent`);
        return response;
    });</pre>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-gray-800 mb-2">Deploy:</h3>
                    <div class="code-block">
<pre>cd functions
npm install firebase-admin firebase-functions
cd ..
firebase deploy --only functions</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-600">
            <p class="font-semibold">‚úÖ Test Page V9.52 - Firebase Cloud Messaging</p>
            <p class="text-sm mt-1">Rosterkick Convocazioni - 12 Gennaio 2025</p>
        </div>
    </div>

    <script>
        let fcmToken = null;

        // Initialize page
        window.addEventListener('load', () => {
            log('‚úÖ Test page loaded', 'success');
            checkBrowserSupport();
            checkServiceWorkers();
            checkNotificationPermission();
            verifyFiles();
        });

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString('it-IT');
            let emoji = 'üìù';
            if (type === 'success') emoji = '‚úÖ';
            if (type === 'error') emoji = '‚ùå';
            if (type === 'warning') emoji = '‚ö†Ô∏è';
            
            logEntry.innerHTML = `<span class="text-gray-500 text-sm">[${timestamp}]</span> ${emoji} ${message}`;
            logsDiv.insertBefore(logEntry, logsDiv.firstChild);
        }

        function checkBrowserSupport() {
            const div = document.getElementById('browser-support');
            const checks = [
                { name: 'Notifications', supported: 'Notification' in window },
                { name: 'Service Worker', supported: 'serviceWorker' in navigator },
                { name: 'Push API', supported: 'PushManager' in window }
            ];

            div.innerHTML = checks.map(check => {
                const badge = check.supported ? 
                    '<span class="status-badge status-success">‚úÖ Supported</span>' :
                    '<span class="status-badge status-error">‚ùå Not Supported</span>';
                return `<div class="flex justify-between items-center">
                    <span class="text-sm">${check.name}</span>
                    ${badge}
                </div>`;
            }).join('');

            checks.forEach(check => {
                log(`Browser ${check.name}: ${check.supported ? 'Supported' : 'Not Supported'}`, 
                    check.supported ? 'success' : 'error');
            });
        }

        async function checkServiceWorkers() {
            const div = document.getElementById('service-workers');
            
            if (!('serviceWorker' in navigator)) {
                div.innerHTML = '<span class="status-badge status-error">Not Supported</span>';
                return;
            }

            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                
                if (registrations.length === 0) {
                    div.innerHTML = '<span class="status-badge status-warning">No SW registered</span>';
                    log('‚ö†Ô∏è No service workers registered', 'warning');
                } else {
                    div.innerHTML = registrations.map(reg => {
                        const scope = reg.scope.split('/').pop() || 'root';
                        return `<div class="flex justify-between items-center">
                            <span class="text-sm">${scope}</span>
                            <span class="status-badge status-success">‚úÖ Active</span>
                        </div>`;
                    }).join('');
                    log(`‚úÖ Found ${registrations.length} service worker(s)`, 'success');
                }
            } catch (error) {
                div.innerHTML = `<span class="status-badge status-error">Error: ${error.message}</span>`;
                log(`‚ùå Error checking service workers: ${error.message}`, 'error');
            }
        }

        function checkNotificationPermission() {
            const div = document.getElementById('notification-permission');
            const permission = Notification.permission;
            
            let badge = '';
            let message = '';
            
            if (permission === 'granted') {
                badge = '<span class="status-badge status-success">‚úÖ Granted</span>';
                message = 'Permission granted';
                log('‚úÖ Notification permission: granted', 'success');
            } else if (permission === 'denied') {
                badge = '<span class="status-badge status-error">‚ùå Denied</span>';
                message = 'Permission denied';
                log('‚ùå Notification permission: denied', 'error');
            } else {
                badge = '<span class="status-badge status-warning">‚ö†Ô∏è Default</span>';
                message = 'Not requested yet';
                log('‚ö†Ô∏è Notification permission: not requested', 'warning');
            }
            
            div.innerHTML = `<div class="flex justify-between items-center">
                <span class="text-sm">${message}</span>
                ${badge}
            </div>`;
        }

        async function verifyFiles() {
            // Check firebase-messaging-sw.js
            try {
                const response = await fetch('./firebase-messaging-sw.js');
                const badge = document.getElementById('file-fcm-sw');
                if (response.ok) {
                    badge.className = 'status-badge status-success';
                    badge.textContent = '‚úÖ Found';
                    log('‚úÖ firebase-messaging-sw.js found', 'success');
                } else {
                    badge.className = 'status-badge status-error';
                    badge.textContent = '‚ùå Not Found';
                    log('‚ùå firebase-messaging-sw.js not found', 'error');
                }
            } catch (error) {
                const badge = document.getElementById('file-fcm-sw');
                badge.className = 'status-badge status-error';
                badge.textContent = '‚ùå Error';
                log(`‚ùå Error checking firebase-messaging-sw.js: ${error.message}`, 'error');
            }

            // Check manifest.json
            try {
                const response = await fetch('./manifest.json');
                const badge = document.getElementById('file-manifest');
                if (response.ok) {
                    const data = await response.json();
                    if (data.version === 'V9.52') {
                        badge.className = 'status-badge status-success';
                        badge.textContent = '‚úÖ V9.52';
                        log('‚úÖ manifest.json version V9.52', 'success');
                    } else {
                        badge.className = 'status-badge status-warning';
                        badge.textContent = `‚ö†Ô∏è ${data.version}`;
                        log(`‚ö†Ô∏è manifest.json version ${data.version} (expected V9.52)`, 'warning');
                    }
                } else {
                    badge.className = 'status-badge status-error';
                    badge.textContent = '‚ùå Not Found';
                    log('‚ùå manifest.json not found', 'error');
                }
            } catch (error) {
                const badge = document.getElementById('file-manifest');
                badge.className = 'status-badge status-error';
                badge.textContent = '‚ùå Error';
                log(`‚ùå Error checking manifest.json: ${error.message}`, 'error');
            }

            // Check service-worker.js
            try {
                const response = await fetch('./service-worker.js');
                const badge = document.getElementById('file-sw');
                if (response.ok) {
                    const text = await response.text();
                    if (text.includes('v9.52')) {
                        badge.className = 'status-badge status-success';
                        badge.textContent = '‚úÖ V9.52';
                        log('‚úÖ service-worker.js cache version v9.52', 'success');
                    } else {
                        badge.className = 'status-badge status-warning';
                        badge.textContent = '‚ö†Ô∏è Old version';
                        log('‚ö†Ô∏è service-worker.js cache version not v9.52', 'warning');
                    }
                } else {
                    badge.className = 'status-badge status-error';
                    badge.textContent = '‚ùå Not Found';
                    log('‚ùå service-worker.js not found', 'error');
                }
            } catch (error) {
                const badge = document.getElementById('file-sw');
                badge.className = 'status-badge status-error';
                badge.textContent = '‚ùå Error';
                log(`‚ùå Error checking service-worker.js: ${error.message}`, 'error');
            }
        }

        async function requestPermission() {
            log('üì¨ Requesting notification permission...', 'info');
            
            if (!('Notification' in window)) {
                log('‚ùå Notifications not supported in this browser', 'error');
                alert('Il tuo browser non supporta le notifiche');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                log(`Permission result: ${permission}`, permission === 'granted' ? 'success' : 'warning');
                checkNotificationPermission();
                
                if (permission === 'granted') {
                    log('‚úÖ Permission granted! Now get FCM token', 'success');
                } else {
                    log('‚ùå Permission denied', 'error');
                }
            } catch (error) {
                log(`‚ùå Error requesting permission: ${error.message}`, 'error');
            }
        }

        async function getToken() {
            log('üîë Attempting to get FCM token...', 'info');
            
            if (Notification.permission !== 'granted') {
                log('‚ö†Ô∏è Permission not granted. Request permission first.', 'warning');
                alert('Devi prima concedere il permesso per le notifiche');
                return;
            }

            // Note: This will fail because VAPID key is not set
            log('‚ö†Ô∏è VAPID key must be configured in index.html', 'warning');
            log('üìù Check index.html line ~13115 and replace YOUR_VAPID_KEY_HERE', 'info');
            
            const tokenDisplay = document.getElementById('token-display');
            const tokenText = document.getElementById('token-text');
            const tokenStatus = document.getElementById('fcm-token-status');
            
            tokenDisplay.style.display = 'block';
            tokenText.textContent = 'VAPID key not configured.\nConfigure in index.html to generate real token.\n\nExample token format:\neJ3f...token_string...xyz (152 characters)';
            tokenStatus.innerHTML = '<span class="status-badge status-warning">‚ö†Ô∏è VAPID Not Configured</span>';
            
            log('‚ö†Ô∏è Cannot generate real token without VAPID key', 'warning');
        }

        function testLocalNotification() {
            log('üîî Testing local notification...', 'info');
            
            if (Notification.permission !== 'granted') {
                log('‚ùå Permission not granted', 'error');
                alert('Devi prima concedere il permesso per le notifiche');
                return;
            }

            try {
                const notification = new Notification('Test Notifica Rosterkick', {
                    body: 'Questa √® una notifica di test per verificare il funzionamento',
                    icon: './icon-512.png',
                    badge: './favicon-96x96.png',
                    tag: 'test-notification'
                });
                
                notification.onclick = () => {
                    log('üëÜ Notification clicked', 'success');
                    notification.close();
                };
                
                log('‚úÖ Test notification sent', 'success');
            } catch (error) {
                log(`‚ùå Error sending notification: ${error.message}`, 'error');
            }
        }

        function copyToken() {
            const tokenText = document.getElementById('token-text').textContent;
            
            if (!tokenText || tokenText.includes('VAPID key not configured')) {
                log('‚ö†Ô∏è No token to copy', 'warning');
                alert('Prima genera un token FCM');
                return;
            }

            navigator.clipboard.writeText(tokenText).then(() => {
                log('‚úÖ Token copied to clipboard', 'success');
                alert('Token copiato negli appunti!');
            }).catch(error => {
                log(`‚ùå Error copying token: ${error.message}`, 'error');
            });
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('üóëÔ∏è Logs cleared', 'info');
        }
    </script>
</body>
</html>
